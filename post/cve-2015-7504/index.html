<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>QEMU堆溢出漏洞----CVE-2015-7504 - hhdx's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="hhdx"><meta name=description content="CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。
PCNET网卡 AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。
网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。
1 2 3 4 5 6 7 8 9 10 11 12 0 16 +----------------------------------+ | EPROM | +----------------------------------+ | RDP - Data reg for CSR | +----------------------------------+ | RAP - Index reg for CSR and BCR | +----------------------------------+ | Reset reg | +----------------------------------+ | BDP - Data reg for BCR | +----------------------------------+ "><meta name=keywords content="C language,CTF,system software engineer"><meta name=generator content="Hugo 0.116.1 with theme even"><link rel=canonical href=https://hhdx.xyz/post/cve-2015-7504/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.bda6190ea12800aa36851bdb7b5cb5af46ca988222781d28b20a96aa4c1f6e68.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="QEMU堆溢出漏洞----CVE-2015-7504"><meta property="og:description" content="CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。
PCNET网卡
AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。
网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


            0                                  16
            +----------------------------------+
            |              EPROM               |
            +----------------------------------+
            |      RDP - Data reg for CSR      |
            +----------------------------------+
            | RAP - Index reg for CSR and BCR  |
            +----------------------------------+
            |           Reset reg              |
            +----------------------------------+
            |      BDP - Data reg for BCR      |
            +----------------------------------+


"><meta property="og:type" content="article"><meta property="og:url" content="https://hhdx.xyz/post/cve-2015-7504/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-12-12T10:36:40+00:00"><meta property="article:modified_time" content="2020-12-12T10:36:40+00:00"><meta itemprop=name content="QEMU堆溢出漏洞----CVE-2015-7504"><meta itemprop=description content="CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。
PCNET网卡
AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。
网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


            0                                  16
            +----------------------------------+
            |              EPROM               |
            +----------------------------------+
            |      RDP - Data reg for CSR      |
            +----------------------------------+
            | RAP - Index reg for CSR and BCR  |
            +----------------------------------+
            |           Reset reg              |
            +----------------------------------+
            |      BDP - Data reg for BCR      |
            +----------------------------------+


"><meta itemprop=datePublished content="2020-12-12T10:36:40+00:00"><meta itemprop=dateModified content="2020-12-12T10:36:40+00:00"><meta itemprop=wordCount content="3316"><meta itemprop=keywords content="QEMU,CVE,"><meta name=twitter:card content="summary"><meta name=twitter:title content="QEMU堆溢出漏洞----CVE-2015-7504"><meta name=twitter:description content="CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。
PCNET网卡
AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。
网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


            0                                  16
            +----------------------------------+
            |              EPROM               |
            +----------------------------------+
            |      RDP - Data reg for CSR      |
            +----------------------------------+
            | RAP - Index reg for CSR and BCR  |
            +----------------------------------+
            |           Reset reg              |
            +----------------------------------+
            |      BDP - Data reg for BCR      |
            +----------------------------------+


"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>hhdx's blog</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>主页</li></a><a href=/post/><li class=mobile-menu-item>归档</li></a><a href=/tags/><li class=mobile-menu-item>标签</li></a><a href=/links/><li class=mobile-menu-item>链接</li></a><a href=/underway/><li class=mobile-menu-item>施工中</li></a><a href=/about/><li class=mobile-menu-item>关于</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>hhdx's blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>主页</a></li><li class=menu-item><a class=menu-item-link href=/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=/links/>链接</a></li><li class=menu-item><a class=menu-item-link href=/underway/>施工中</a></li><li class=menu-item><a class=menu-item-link href=/about/>关于</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>QEMU堆溢出漏洞----CVE-2015-7504</h1><div class=post-meta><span class=post-time>2020-12-12</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#pcnet网卡>PCNET网卡</a></li><li><a href=#漏洞分析>漏洞分析</a></li><li><a href=#利用的流程>利用的流程</a></li><li><a href=#poc>PoC</a></li><li><a href=#tips>tips</a></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></div><div class=post-content><p>CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用<code>CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE </code>标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。</p><h2 id=pcnet网卡>PCNET网卡</h2><p>AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。</p><p>网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>            0                                  16
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            |              EPROM               |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            |      RDP - Data reg for CSR      |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            | RAP - Index reg for CSR and BCR  |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            |           Reset reg              |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            |      BDP - Data reg for BCR      |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span></code></pre></td></tr></table></div></div><p>两种寄存器都需要通过设置对应的我们要访问的RAP（寄存器地址端口）寄存器来实现对相应CSR或BCR寄存器的访问。例如，如果想要初始化或者重启网卡，得设置CSR0的bit0和bit1为1，这个操作可以通过设置RAP为0，然后设置CSR为3来实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>outw</span><span class=p>(</span><span class=mh>0x0</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>outw</span><span class=p>(</span><span class=mh>0x3</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>网卡的配置可以通过填充一个初始化结构体，并将该结构体的物理地址传送到网卡（通过设置CSR[1]和CSR[2]）来完成，结构体定义如下（通过查询qemu实现的PCNET的规范，发现这个<code>pcnet_config</code>对应的是32位IDAR的config）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>pcnet_config</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span>  <span class=n>mode</span><span class=p>;</span>      <span class=cm>/* working mode: promiscusous, looptest, etc. */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>rlen</span><span class=p>;</span>      <span class=cm>/* number of rx descriptors in log2 base */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>tlen</span><span class=p>;</span>      <span class=cm>/* number of tx descriptors in log2 base */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>mac</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>    <span class=cm>/* mac address */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>_reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>ladr</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>   <span class=cm>/* logical address filter */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>  <span class=n>rx_desc</span><span class=p>;</span>   <span class=cm>/* physical address of rx descriptor buffer */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>  <span class=n>tx_desc</span><span class=p>;</span>   <span class=cm>/* physical address of tx descriptor buffer */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://raw.githubusercontent.com/clxsh/pics/master/img/image-20201209211827489.png alt=image-20201209211827489></p><h2 id=漏洞分析>漏洞分析</h2><p>PCNET网卡在loopback测试模式中接收到大尺寸的数据包时，存在一个堆上的溢出漏洞。PCNET的仿真使用了4kB的缓冲区来存储数据包。如果接收描述符(Tx descriptor)存在<code>ADDFCS</code>标志，那么网卡将在数据包的尾部添加CRC校验码（见<code>pcnet_receive()</code>函数，<code>hw/net/pcnet.c</code>）。在接收小于4096-4字节的时候，不会出现任何问题，但如果这个数据包就是4096字节大小，那么将会在目标缓冲区溢出4个字节。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>ssize_t</span> <span class=nf>pcnet_receive</span><span class=p>(</span><span class=n>NetClientState</span> <span class=o>*</span><span class=n>nc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size_</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// .......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nf>CSR_CRST</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x8000</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PCNET_DEBUG_RMD
</span></span></span><span class=line><span class=cl><span class=cp></span>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pcnet - no buffer: RCVRC=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>CSR_RCVRC</span><span class=p>(</span><span class=n>s</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>            <span class=n>s</span><span class=o>-&gt;</span><span class=n>csr</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>|=</span> <span class=mh>0x1000</span><span class=p>;</span> <span class=cm>/* Set MISS flag */</span>
</span></span><span class=line><span class=cl>            <span class=nf>CSR_MISSC</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>src</span> <span class=o>=</span> <span class=n>s</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>hwaddr</span> <span class=n>crda</span> <span class=o>=</span> <span class=nf>CSR_CRDA</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>struct</span> <span class=n>pcnet_RMD</span> <span class=n>rmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>pktcount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>s</span><span class=o>-&gt;</span><span class=n>looptest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>memcpy</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=cm>/* no need to compute the CRC */</span>
</span></span><span class=line><span class=cl>                <span class=n>src</span><span class=p>[</span><span class=n>size</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>src</span><span class=p>[</span><span class=n>size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>src</span><span class=p>[</span><span class=n>size</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>src</span><span class=p>[</span><span class=n>size</span> <span class=o>+</span> <span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>size</span> <span class=o>+=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=o>-&gt;</span><span class=n>looptest</span> <span class=o>==</span> <span class=n>PCNET_LOOPTEST_CRC</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                       <span class=o>!</span><span class=nf>CSR_DXMTFCS</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>||</span> <span class=n>size</span> <span class=o>&lt;</span> <span class=n>MIN_BUF_SIZE</span><span class=o>+</span><span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint32_t</span> <span class=n>fcs</span> <span class=o>=</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>src</span><span class=p>[</span><span class=n>size</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=nf>CRC</span><span class=p>(</span><span class=n>fcs</span><span class=p>,</span> <span class=o>*</span><span class=n>p</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=o>*</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span><span class=n>p</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>fcs</span><span class=p>);</span>    <span class=c1>// bug here
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>size</span> <span class=o>+=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint32_t</span> <span class=n>fcs</span> <span class=o>=</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>src</span><span class=p>[</span><span class=n>size</span><span class=o>-</span><span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=nf>CRC</span><span class=p>(</span><span class=n>fcs</span><span class=p>,</span> <span class=o>*</span><span class=n>p</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>crc_err</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span><span class=n>p</span> <span class=o>!=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>fcs</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// .......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在上面的代码中变量<code>s</code>指向PCNET的主要结构<code>PCNetState_st</code>，从它的结构来看（见下）。溢出会修改它的<code>irq</code>成员的低4字节，通过对CRC的逆向，可以完全控制溢出的4字节的内容。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>PCNetState_st</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NICState</span> <span class=o>*</span><span class=n>nic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>NICConf</span> <span class=n>conf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>QEMUTimer</span> <span class=o>*</span><span class=n>poll_timer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rap</span><span class=p>,</span> <span class=n>isr</span><span class=p>,</span> <span class=n>lnkst</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>rdra</span><span class=p>,</span> <span class=n>tdra</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>prom</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>csr</span><span class=p>[</span><span class=mi>128</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>bcr</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>xmit_pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>timer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>MemoryRegion</span> <span class=n>mmio</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>];</span>  <span class=c1>// overflow here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>qemu_irq</span> <span class=n>irq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>phys_mem_read</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=n>dma_opaque</span><span class=p>,</span> <span class=n>hwaddr</span> <span class=n>addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>,</span> <span class=kt>int</span> <span class=n>do_bswap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>phys_mem_write</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=n>dma_opaque</span><span class=p>,</span> <span class=n>hwaddr</span> <span class=n>addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>,</span> <span class=kt>int</span> <span class=n>do_bswap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>dma_opaque</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tx_busy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>looptest</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>这个<code>irq</code>成员变量指向一个<code>IRQState</code>结构的指针，该结构又含有函数指针。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// include/hw/irq.h
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>IRQState</span> <span class=o>*</span><span class=n>qemu_irq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=nf>void</span> <span class=p>(</span><span class=o>*</span><span class=n>qemu_irq_handler</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=n>opaque</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>level</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// hw/core/irq.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>IRQState</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>parent_obj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>qemu_irq_handler</span> <span class=n>handler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>opaque</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>这个函数将会被调用多次。例如，在<code>pcnet_receive()</code>函数的末尾，将会调用<code>pcnet_update_irq()</code>，其中会继续调用<code>qemu_set_irq()</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// hw/core/irq.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>qemu_set_irq</span><span class=p>(</span><span class=n>qemu_irq</span> <span class=n>irq</span><span class=p>,</span> <span class=kt>int</span> <span class=n>level</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>irq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>irq</span><span class=o>-&gt;</span><span class=nf>handler</span><span class=p>(</span><span class=n>irq</span><span class=o>-&gt;</span><span class=n>opaque</span><span class=p>,</span> <span class=n>irq</span><span class=o>-&gt;</span><span class=n>n</span><span class=p>,</span> <span class=n>level</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=利用的流程>利用的流程</h2><ul><li>构造一个<code>IRQState</code>结构，其中包含一个想要执行的函数的指针（如：<code>system()</code>）</li><li>计算构造的结构的准确地址。通过前述CVE-2015-5165泄露的基地址，可以达成这个目标。</li><li>伪造一个4kB的数据包。对CRC进行逆向，使其指向构造的<code>IRQState</code>结构</li><li>发送数据包</li></ul><p>loopback接收之后：</p><ul><li>将收的数据包拷贝到缓冲区</li><li>计算数据包的CRC，添加到末尾，也就覆盖了<code>irq</code>变量的低4字节</li><li>调用<code>pcnet_update_irq()</code>函数，触发目标函数指针。</li></ul><h2 id=poc>PoC</h2><p><a href=https://github.com/clxsh/CVE/blob/main/CVE-2015-7504/poc.c>Poc</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/io.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;assert.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// page relevant
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PAGE_SHIFT 12
</span></span></span><span class=line><span class=cl><span class=cp>#define PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)
</span></span></span><span class=line><span class=cl><span class=cp>#define PFN_PRESENT (1ULL &lt;&lt; 63)
</span></span></span><span class=line><span class=cl><span class=cp>#define PAGE_PFN ((1ULL &lt;&lt; 55) - 1)
</span></span></span><span class=line><span class=cl><span class=cp>#define PAGE_MASK ((1 &lt;&lt; PAGE_SHIFT) - 1)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PAGE_ALIGNED __attribute__((aligned(PAGE_SIZE)))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PCNET_PORT 0xc140
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PCNET_BUFFER_SIZE 4096
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define DRX     0x0001
</span></span></span><span class=line><span class=cl><span class=cp>#define DTX     0x0002
</span></span></span><span class=line><span class=cl><span class=cp>#define LOOP    0x0004
</span></span></span><span class=line><span class=cl><span class=cp>#define DXMTFCS 0x0008
</span></span></span><span class=line><span class=cl><span class=cp>#define INTL    0x0040
</span></span></span><span class=line><span class=cl><span class=cp>#define DRCVPA  0x2000
</span></span></span><span class=line><span class=cl><span class=cp>#define DRCVBC  0x4000
</span></span></span><span class=line><span class=cl><span class=cp>#define PROM    0x8000
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>enum</span> <span class=n>pcnet_register</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RDP</span> <span class=o>=</span> <span class=mh>0x10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RAP</span> <span class=o>=</span> <span class=mh>0x12</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RST</span> <span class=o>=</span> <span class=mh>0x14</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define CRC(crc, ch) (crc = (crc &gt;&gt; 8) ^ crctab[(crc ^ (ch)) &amp; 0xff])
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* generated using the AUTODIN II polynomial
</span></span></span><span class=line><span class=cl><span class=cm> *	x^32 + x^26 + x^23 + x^22 + x^16 +
</span></span></span><span class=line><span class=cl><span class=cm> *	x^12 + x^11 + x^10 + x^8 + x^7 + x^5 + x^4 + x^2 + x^1 + 1
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=kt>uint32_t</span> <span class=n>crctab</span><span class=p>[</span><span class=mi>256</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x00000000</span><span class=p>,</span> <span class=mh>0x77073096</span><span class=p>,</span> <span class=mh>0xee0e612c</span><span class=p>,</span> <span class=mh>0x990951ba</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x076dc419</span><span class=p>,</span> <span class=mh>0x706af48f</span><span class=p>,</span> <span class=mh>0xe963a535</span><span class=p>,</span> <span class=mh>0x9e6495a3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x0edb8832</span><span class=p>,</span> <span class=mh>0x79dcb8a4</span><span class=p>,</span> <span class=mh>0xe0d5e91e</span><span class=p>,</span> <span class=mh>0x97d2d988</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x09b64c2b</span><span class=p>,</span> <span class=mh>0x7eb17cbd</span><span class=p>,</span> <span class=mh>0xe7b82d07</span><span class=p>,</span> <span class=mh>0x90bf1d91</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x1db71064</span><span class=p>,</span> <span class=mh>0x6ab020f2</span><span class=p>,</span> <span class=mh>0xf3b97148</span><span class=p>,</span> <span class=mh>0x84be41de</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x1adad47d</span><span class=p>,</span> <span class=mh>0x6ddde4eb</span><span class=p>,</span> <span class=mh>0xf4d4b551</span><span class=p>,</span> <span class=mh>0x83d385c7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x136c9856</span><span class=p>,</span> <span class=mh>0x646ba8c0</span><span class=p>,</span> <span class=mh>0xfd62f97a</span><span class=p>,</span> <span class=mh>0x8a65c9ec</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x14015c4f</span><span class=p>,</span> <span class=mh>0x63066cd9</span><span class=p>,</span> <span class=mh>0xfa0f3d63</span><span class=p>,</span> <span class=mh>0x8d080df5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x3b6e20c8</span><span class=p>,</span> <span class=mh>0x4c69105e</span><span class=p>,</span> <span class=mh>0xd56041e4</span><span class=p>,</span> <span class=mh>0xa2677172</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x3c03e4d1</span><span class=p>,</span> <span class=mh>0x4b04d447</span><span class=p>,</span> <span class=mh>0xd20d85fd</span><span class=p>,</span> <span class=mh>0xa50ab56b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x35b5a8fa</span><span class=p>,</span> <span class=mh>0x42b2986c</span><span class=p>,</span> <span class=mh>0xdbbbc9d6</span><span class=p>,</span> <span class=mh>0xacbcf940</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x32d86ce3</span><span class=p>,</span> <span class=mh>0x45df5c75</span><span class=p>,</span> <span class=mh>0xdcd60dcf</span><span class=p>,</span> <span class=mh>0xabd13d59</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x26d930ac</span><span class=p>,</span> <span class=mh>0x51de003a</span><span class=p>,</span> <span class=mh>0xc8d75180</span><span class=p>,</span> <span class=mh>0xbfd06116</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x21b4f4b5</span><span class=p>,</span> <span class=mh>0x56b3c423</span><span class=p>,</span> <span class=mh>0xcfba9599</span><span class=p>,</span> <span class=mh>0xb8bda50f</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x2802b89e</span><span class=p>,</span> <span class=mh>0x5f058808</span><span class=p>,</span> <span class=mh>0xc60cd9b2</span><span class=p>,</span> <span class=mh>0xb10be924</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x2f6f7c87</span><span class=p>,</span> <span class=mh>0x58684c11</span><span class=p>,</span> <span class=mh>0xc1611dab</span><span class=p>,</span> <span class=mh>0xb6662d3d</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x76dc4190</span><span class=p>,</span> <span class=mh>0x01db7106</span><span class=p>,</span> <span class=mh>0x98d220bc</span><span class=p>,</span> <span class=mh>0xefd5102a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x71b18589</span><span class=p>,</span> <span class=mh>0x06b6b51f</span><span class=p>,</span> <span class=mh>0x9fbfe4a5</span><span class=p>,</span> <span class=mh>0xe8b8d433</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x7807c9a2</span><span class=p>,</span> <span class=mh>0x0f00f934</span><span class=p>,</span> <span class=mh>0x9609a88e</span><span class=p>,</span> <span class=mh>0xe10e9818</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x7f6a0dbb</span><span class=p>,</span> <span class=mh>0x086d3d2d</span><span class=p>,</span> <span class=mh>0x91646c97</span><span class=p>,</span> <span class=mh>0xe6635c01</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x6b6b51f4</span><span class=p>,</span> <span class=mh>0x1c6c6162</span><span class=p>,</span> <span class=mh>0x856530d8</span><span class=p>,</span> <span class=mh>0xf262004e</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x6c0695ed</span><span class=p>,</span> <span class=mh>0x1b01a57b</span><span class=p>,</span> <span class=mh>0x8208f4c1</span><span class=p>,</span> <span class=mh>0xf50fc457</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x65b0d9c6</span><span class=p>,</span> <span class=mh>0x12b7e950</span><span class=p>,</span> <span class=mh>0x8bbeb8ea</span><span class=p>,</span> <span class=mh>0xfcb9887c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x62dd1ddf</span><span class=p>,</span> <span class=mh>0x15da2d49</span><span class=p>,</span> <span class=mh>0x8cd37cf3</span><span class=p>,</span> <span class=mh>0xfbd44c65</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x4db26158</span><span class=p>,</span> <span class=mh>0x3ab551ce</span><span class=p>,</span> <span class=mh>0xa3bc0074</span><span class=p>,</span> <span class=mh>0xd4bb30e2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x4adfa541</span><span class=p>,</span> <span class=mh>0x3dd895d7</span><span class=p>,</span> <span class=mh>0xa4d1c46d</span><span class=p>,</span> <span class=mh>0xd3d6f4fb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x4369e96a</span><span class=p>,</span> <span class=mh>0x346ed9fc</span><span class=p>,</span> <span class=mh>0xad678846</span><span class=p>,</span> <span class=mh>0xda60b8d0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x44042d73</span><span class=p>,</span> <span class=mh>0x33031de5</span><span class=p>,</span> <span class=mh>0xaa0a4c5f</span><span class=p>,</span> <span class=mh>0xdd0d7cc9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x5005713c</span><span class=p>,</span> <span class=mh>0x270241aa</span><span class=p>,</span> <span class=mh>0xbe0b1010</span><span class=p>,</span> <span class=mh>0xc90c2086</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x5768b525</span><span class=p>,</span> <span class=mh>0x206f85b3</span><span class=p>,</span> <span class=mh>0xb966d409</span><span class=p>,</span> <span class=mh>0xce61e49f</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x5edef90e</span><span class=p>,</span> <span class=mh>0x29d9c998</span><span class=p>,</span> <span class=mh>0xb0d09822</span><span class=p>,</span> <span class=mh>0xc7d7a8b4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x59b33d17</span><span class=p>,</span> <span class=mh>0x2eb40d81</span><span class=p>,</span> <span class=mh>0xb7bd5c3b</span><span class=p>,</span> <span class=mh>0xc0ba6cad</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xedb88320</span><span class=p>,</span> <span class=mh>0x9abfb3b6</span><span class=p>,</span> <span class=mh>0x03b6e20c</span><span class=p>,</span> <span class=mh>0x74b1d29a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xead54739</span><span class=p>,</span> <span class=mh>0x9dd277af</span><span class=p>,</span> <span class=mh>0x04db2615</span><span class=p>,</span> <span class=mh>0x73dc1683</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xe3630b12</span><span class=p>,</span> <span class=mh>0x94643b84</span><span class=p>,</span> <span class=mh>0x0d6d6a3e</span><span class=p>,</span> <span class=mh>0x7a6a5aa8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xe40ecf0b</span><span class=p>,</span> <span class=mh>0x9309ff9d</span><span class=p>,</span> <span class=mh>0x0a00ae27</span><span class=p>,</span> <span class=mh>0x7d079eb1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xf00f9344</span><span class=p>,</span> <span class=mh>0x8708a3d2</span><span class=p>,</span> <span class=mh>0x1e01f268</span><span class=p>,</span> <span class=mh>0x6906c2fe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xf762575d</span><span class=p>,</span> <span class=mh>0x806567cb</span><span class=p>,</span> <span class=mh>0x196c3671</span><span class=p>,</span> <span class=mh>0x6e6b06e7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xfed41b76</span><span class=p>,</span> <span class=mh>0x89d32be0</span><span class=p>,</span> <span class=mh>0x10da7a5a</span><span class=p>,</span> <span class=mh>0x67dd4acc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xf9b9df6f</span><span class=p>,</span> <span class=mh>0x8ebeeff9</span><span class=p>,</span> <span class=mh>0x17b7be43</span><span class=p>,</span> <span class=mh>0x60b08ed5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xd6d6a3e8</span><span class=p>,</span> <span class=mh>0xa1d1937e</span><span class=p>,</span> <span class=mh>0x38d8c2c4</span><span class=p>,</span> <span class=mh>0x4fdff252</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xd1bb67f1</span><span class=p>,</span> <span class=mh>0xa6bc5767</span><span class=p>,</span> <span class=mh>0x3fb506dd</span><span class=p>,</span> <span class=mh>0x48b2364b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xd80d2bda</span><span class=p>,</span> <span class=mh>0xaf0a1b4c</span><span class=p>,</span> <span class=mh>0x36034af6</span><span class=p>,</span> <span class=mh>0x41047a60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xdf60efc3</span><span class=p>,</span> <span class=mh>0xa867df55</span><span class=p>,</span> <span class=mh>0x316e8eef</span><span class=p>,</span> <span class=mh>0x4669be79</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xcb61b38c</span><span class=p>,</span> <span class=mh>0xbc66831a</span><span class=p>,</span> <span class=mh>0x256fd2a0</span><span class=p>,</span> <span class=mh>0x5268e236</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xcc0c7795</span><span class=p>,</span> <span class=mh>0xbb0b4703</span><span class=p>,</span> <span class=mh>0x220216b9</span><span class=p>,</span> <span class=mh>0x5505262f</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xc5ba3bbe</span><span class=p>,</span> <span class=mh>0xb2bd0b28</span><span class=p>,</span> <span class=mh>0x2bb45a92</span><span class=p>,</span> <span class=mh>0x5cb36a04</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xc2d7ffa7</span><span class=p>,</span> <span class=mh>0xb5d0cf31</span><span class=p>,</span> <span class=mh>0x2cd99e8b</span><span class=p>,</span> <span class=mh>0x5bdeae1d</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x9b64c2b0</span><span class=p>,</span> <span class=mh>0xec63f226</span><span class=p>,</span> <span class=mh>0x756aa39c</span><span class=p>,</span> <span class=mh>0x026d930a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x9c0906a9</span><span class=p>,</span> <span class=mh>0xeb0e363f</span><span class=p>,</span> <span class=mh>0x72076785</span><span class=p>,</span> <span class=mh>0x05005713</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x95bf4a82</span><span class=p>,</span> <span class=mh>0xe2b87a14</span><span class=p>,</span> <span class=mh>0x7bb12bae</span><span class=p>,</span> <span class=mh>0x0cb61b38</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x92d28e9b</span><span class=p>,</span> <span class=mh>0xe5d5be0d</span><span class=p>,</span> <span class=mh>0x7cdcefb7</span><span class=p>,</span> <span class=mh>0x0bdbdf21</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x86d3d2d4</span><span class=p>,</span> <span class=mh>0xf1d4e242</span><span class=p>,</span> <span class=mh>0x68ddb3f8</span><span class=p>,</span> <span class=mh>0x1fda836e</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x81be16cd</span><span class=p>,</span> <span class=mh>0xf6b9265b</span><span class=p>,</span> <span class=mh>0x6fb077e1</span><span class=p>,</span> <span class=mh>0x18b74777</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x88085ae6</span><span class=p>,</span> <span class=mh>0xff0f6a70</span><span class=p>,</span> <span class=mh>0x66063bca</span><span class=p>,</span> <span class=mh>0x11010b5c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x8f659eff</span><span class=p>,</span> <span class=mh>0xf862ae69</span><span class=p>,</span> <span class=mh>0x616bffd3</span><span class=p>,</span> <span class=mh>0x166ccf45</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xa00ae278</span><span class=p>,</span> <span class=mh>0xd70dd2ee</span><span class=p>,</span> <span class=mh>0x4e048354</span><span class=p>,</span> <span class=mh>0x3903b3c2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xa7672661</span><span class=p>,</span> <span class=mh>0xd06016f7</span><span class=p>,</span> <span class=mh>0x4969474d</span><span class=p>,</span> <span class=mh>0x3e6e77db</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xaed16a4a</span><span class=p>,</span> <span class=mh>0xd9d65adc</span><span class=p>,</span> <span class=mh>0x40df0b66</span><span class=p>,</span> <span class=mh>0x37d83bf0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xa9bcae53</span><span class=p>,</span> <span class=mh>0xdebb9ec5</span><span class=p>,</span> <span class=mh>0x47b2cf7f</span><span class=p>,</span> <span class=mh>0x30b5ffe9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xbdbdf21c</span><span class=p>,</span> <span class=mh>0xcabac28a</span><span class=p>,</span> <span class=mh>0x53b39330</span><span class=p>,</span> <span class=mh>0x24b4a3a6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xbad03605</span><span class=p>,</span> <span class=mh>0xcdd70693</span><span class=p>,</span> <span class=mh>0x54de5729</span><span class=p>,</span> <span class=mh>0x23d967bf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xb3667a2e</span><span class=p>,</span> <span class=mh>0xc4614ab8</span><span class=p>,</span> <span class=mh>0x5d681b02</span><span class=p>,</span> <span class=mh>0x2a6f2b94</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xb40bbe37</span><span class=p>,</span> <span class=mh>0xc30c8ea1</span><span class=p>,</span> <span class=mh>0x5a05df1b</span><span class=p>,</span> <span class=mh>0x2d02ef8d</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>pcnet_config32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span>  <span class=n>mode</span><span class=p>;</span>      <span class=cm>/* working mode: promiscusous, looptest, etc. */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>rlen</span><span class=p>;</span>      <span class=cm>/* number of rx descriptors in log2 base */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>tlen</span><span class=p>;</span>      <span class=cm>/* number of tx descriptors in log2 base */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>mac</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>    <span class=cm>/* mac address */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>_reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>ladr</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>   <span class=cm>/* logical address filter */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>  <span class=n>rx_desc</span><span class=p>;</span>   <span class=cm>/* physical address of rx descriptor buffer */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>  <span class=n>tx_desc</span><span class=p>;</span>   <span class=cm>/* physical address of tx descriptor buffer */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int16_t</span>  <span class=n>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int8_t</span>   <span class=n>status_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int8_t</span>   <span class=n>status_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>misc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>_reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>uint8_t</span> <span class=n>pcnet_packet</span><span class=p>[</span><span class=n>PCNET_BUFFER_SIZE</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=nf>gva_to_gpa</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/proc/self/pagemap&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>pme</span><span class=p>,</span> <span class=n>gfn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>offset</span> <span class=o>=</span> <span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>addr</span> <span class=o>&gt;&gt;</span> <span class=mi>9</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mi>7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>lseek</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>offset</span><span class=p>,</span> <span class=n>SEEK_SET</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>pme</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pme: 0x%llx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pme</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>pme</span> <span class=o>&amp;</span> <span class=n>PFN_PRESENT</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>gfn</span> <span class=o>=</span> <span class=n>pme</span> <span class=o>&amp;</span> <span class=n>PAGE_PFN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>gfn</span> <span class=o>&lt;&lt;</span> <span class=n>PAGE_SHIFT</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>addr</span> <span class=o>&amp;</span> <span class=n>PAGE_MASK</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>int fd;
</span></span></span><span class=line><span class=cl><span class=cm>uint32_t page_offset(uint32_t addr)
</span></span></span><span class=line><span class=cl><span class=cm>{
</span></span></span><span class=line><span class=cl><span class=cm>    return addr &amp; ((1 &lt;&lt; PAGE_SHIFT) - 1);
</span></span></span><span class=line><span class=cl><span class=cm>}
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>uint64_t gva_to_gfn(void *addr)
</span></span></span><span class=line><span class=cl><span class=cm>{
</span></span></span><span class=line><span class=cl><span class=cm>	uint64_t pme, gfn;
</span></span></span><span class=line><span class=cl><span class=cm>	size_t offset;
</span></span></span><span class=line><span class=cl><span class=cm>	offset = ((uintptr_t)addr &gt;&gt; 9) &amp; ~7;
</span></span></span><span class=line><span class=cl><span class=cm>	lseek(fd, offset, SEEK_SET);
</span></span></span><span class=line><span class=cl><span class=cm>	read(fd, &amp;pme, 8);
</span></span></span><span class=line><span class=cl><span class=cm>	if (!(pme &amp; PFN_PRESENT))
</span></span></span><span class=line><span class=cl><span class=cm>		return -1;
</span></span></span><span class=line><span class=cl><span class=cm>	gfn = pme &amp; PAGE_PFN;
</span></span></span><span class=line><span class=cl><span class=cm>	return gfn;
</span></span></span><span class=line><span class=cl><span class=cm>}
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>uint64_t gva_to_gpa(void *addr)
</span></span></span><span class=line><span class=cl><span class=cm>{
</span></span></span><span class=line><span class=cl><span class=cm>	uint64_t gfn = gva_to_gfn(addr);
</span></span></span><span class=line><span class=cl><span class=cm>	assert(gfn != -1);
</span></span></span><span class=line><span class=cl><span class=cm>	return (gfn &lt;&lt; PAGE_SHIFT) | page_offset((uint64_t)addr);
</span></span></span><span class=line><span class=cl><span class=cm>}
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>pcnet_desc_config</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buffer</span><span class=p>,</span> <span class=kt>int</span> <span class=n>is_rx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>bcnt</span> <span class=o>=</span> <span class=o>-</span><span class=n>PCNET_BUFFER_SIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>bcnt</span> <span class=o>&amp;=</span> <span class=mh>0xfff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>bcnt</span> <span class=o>|=</span> <span class=mh>0xf000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>desc</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_desc</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PCNET_BUFFER_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>desc</span><span class=o>-&gt;</span><span class=n>addr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>desc</span><span class=o>-&gt;</span><span class=n>length</span> <span class=o>=</span> <span class=n>bcnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>is_rx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// receive buffers owned by the card
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>status_2</span> <span class=o>=</span> <span class=mh>0x80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>status_2</span> <span class=o>=</span> <span class=mh>0x83</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=nf>pcnet_card_config</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_config32</span> <span class=o>*</span><span class=n>config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=k>struct</span> <span class=n>pcnet_desc</span>  <span class=o>*</span><span class=n>tx_desc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=k>struct</span> <span class=n>pcnet_desc</span>  <span class=o>*</span><span class=n>rx_desc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_config32</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>-&gt;</span><span class=n>mode</span> <span class=o>=</span> <span class=n>LOOP</span> <span class=o>|</span> <span class=n>PROM</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>-&gt;</span><span class=n>tx_desc</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=n>tx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>-&gt;</span><span class=n>rx_desc</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=n>rx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>gva_to_gpa</span><span class=p>(</span><span class=n>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// PCNET primitives
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>pcnet_packet_patch_crc</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=n>packet</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>current</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=kt>uint32_t</span> <span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>uint8_t</span> <span class=o>*</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>uint32_t</span> <span class=n>workspace</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=n>current</span><span class=p>,</span> <span class=n>target</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>workspace</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ptr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>workspace</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>crctab</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>24</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=n>ptr</span> <span class=o>+</span> <span class=mi>3</span> <span class=o>-</span> <span class=n>i</span><span class=p>))</span> <span class=n>j</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=p>((</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>ptr</span> <span class=o>-</span> <span class=n>i</span><span class=p>))</span> <span class=o>^=</span> <span class=n>crctab</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=p>(</span><span class=n>ptr</span> <span class=o>-</span> <span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^=</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>strncpy</span><span class=p>(</span><span class=n>packet</span><span class=p>,</span> <span class=n>ptr</span> <span class=o>-</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>pcnet_packet_send</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buffer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=kt>void</span> <span class=o>*</span><span class=n>packet</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>len</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>&lt;=</span> <span class=n>PCNET_BUFFER_SIZE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>memcpy</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>packet</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>status_2</span> <span class=o>|=</span> <span class=mh>0x23</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=o>-</span><span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>&amp;=</span> <span class=mh>0xfff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>|=</span> <span class=mh>0xf000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>length</span> <span class=o>=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// flip ownership to card
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>status_2</span> <span class=o>|=</span> <span class=mh>0x80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// send packet
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>outw</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>outw</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// fd = open(&#34;/proc/self/pagemap&#34;, O_RDONLY);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pcnet_config32</span> <span class=n>pcnet_config</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>pcnet_config_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>pcnet_tx_desc_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>pcnet_rx_desc_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=n>pcnet_tx_desc</span> <span class=n>PAGE_ALIGNED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=n>pcnet_rx_desc</span> <span class=n>PAGE_ALIGNED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=o>*</span><span class=n>pcnet_tx_buffer</span><span class=p>,</span> <span class=o>*</span><span class=n>pcnet_rx_buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>fcs</span> <span class=o>=</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>  <span class=o>*</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>lo</span><span class=p>,</span> <span class=n>hi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>iopl</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=nf>aligned_alloc</span><span class=p>(</span><span class=n>PAGE_SIZE</span><span class=p>,</span> <span class=n>PCNET_BUFFER_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_tx_buffer</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)</span><span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=nf>aligned_alloc</span><span class=p>(</span><span class=n>PAGE_SIZE</span><span class=p>,</span> <span class=n>PCNET_BUFFER_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_rx_buffer</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)</span><span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>pcnet_desc_config</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_tx_desc</span><span class=p>,</span> <span class=n>pcnet_tx_buffer</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>pcnet_desc_config</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_rx_desc</span><span class=p>,</span> <span class=n>pcnet_rx_buffer</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_config_mem</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>pcnet_card_config</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=o>&amp;</span><span class=n>pcnet_tx_desc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=o>&amp;</span><span class=n>pcnet_rx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_tx_desc_mem</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_tx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_rx_desc_mem</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_rx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lo</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint16_t</span><span class=p>)</span><span class=n>pcnet_config_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>hi</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint16_t</span><span class=p>)(</span><span class=n>pcnet_config_mem</span> <span class=o>&gt;&gt;</span> <span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// compute required crc
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ptr</span> <span class=o>=</span> <span class=n>pcnet_packet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>ptr</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>pcnet_packet</span><span class=p>[</span><span class=n>PCNET_BUFFER_SIZE</span> <span class=o>-</span> <span class=mi>4</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>CRC</span><span class=p>(</span><span class=n>fcs</span><span class=p>,</span> <span class=o>*</span><span class=n>ptr</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>pcnet_packet_patch_crc</span><span class=p>(</span><span class=n>ptr</span><span class=p>,</span> <span class=n>fcs</span><span class=p>,</span> <span class=nf>htonl</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// soft reset
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>inw</span><span class=p>(</span><span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RST</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// set software style
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>58</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x102</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// card config
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span>  <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=n>lo</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span>  <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//CSR_DPOLL
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// init and start
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//set CSR_SPND
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x1</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//CSR_PROM
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x8004</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//CSR_CRST
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>41</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x8000</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//clear CSR_SPND
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=mh>0x12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>pcnet_packet_send</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_tx_desc</span><span class=p>,</span> <span class=n>pcnet_tx_buffer</span><span class=p>,</span> <span class=n>pcnet_packet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>PCNET_BUFFER_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=tips>tips</h2><p>下面这个命令可以查看设备与网卡的对应关系</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ls -l /sys/class/net
</span></span></code></pre></td></tr></table></div></div><h2 id=参考>参考</h2><ol><li><a href=http://www.phrack.org/papers/vm-escape-qemu-case-study.html>VM escape QEMU Case Study</a></li><li><a href=http://jiayy.me/2019/04/15/CVE-2015-5165-7504/#cve-2015-7504-bug>qemu逃逸漏洞解析</a></li><li><a href=https://github.com/Resery/Virtualized_Learning/tree/master/Vulnerability/CVE-2015-7504>Resery/Virtualized_Learning</a></li><li><a href=https://wiki.osdev.org/AMD_PCNET>AMD PCNET osdev.org</a></li></ol></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>hhdx</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2020-12-12</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/qemu/>QEMU</a>
<a href=/tags/cve/>CVE</a></div><nav class=post-nav><a class=next href=/post/cve-2015-5165/><span class="next-text nav-default">QEMU信息泄露漏洞分析与利用----CVE-2015-5165</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="lyliuchao",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=https://github.com/clxsh class="iconfont icon-github" title=github></a>
<a href=https://www.douban.com/people/57285004/ class="iconfont icon-douban" title=douban></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2016 -
2023<span class=heart><i class="iconfont icon-heart"></i></span><span>hhdx</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js integrity=sha384-NXgwF8Kv9SSAr+jemKKcbvQsz+teULH/a5UNJvZc6kP47hZgl62M1vGnw6gHQhb1 crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-177325662-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>