<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>RISC-V 汇编概览 | hhdx's blog</title>
<meta name=keywords content="RISC-V"><meta name=description content="最近尝试跟着 rCore Tutorial 教程，使用 Rust 实现基于 RISC-V 架构的类 Unix 内核，从而在深化 OS 理解的目标上，同时入门学习 Rust 语言和 RISC-V 基础。虽然说是 RISC-V 比 x86 简单很多，但是直接跟着教程来同时学习 RISC-V 还是有点不够，经常前面记得一点零星的汇编，看到后面的代码就忘了是怎么回事了。所以尝试来整理一下 RISC-V 的汇编，希望能让看到的小伙伴快速的入门一下。本文将以 64 位为例介绍汇编语言。"><meta name=author content="hhdx"><link rel=canonical href=https://hhdx.xyz/post/riscv-assembly-intro/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://hhdx.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hhdx.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hhdx.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://hhdx.xyz/apple-touch-icon.png><link rel=mask-icon href=https://hhdx.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://hhdx.xyz/post/riscv-assembly-intro/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://hhdx.xyz/post/riscv-assembly-intro/"><meta property="og:site_name" content="hhdx's blog"><meta property="og:title" content="RISC-V 汇编概览"><meta property="og:description" content="最近尝试跟着 rCore Tutorial 教程，使用 Rust 实现基于 RISC-V 架构的类 Unix 内核，从而在深化 OS 理解的目标上，同时入门学习 Rust 语言和 RISC-V 基础。虽然说是 RISC-V 比 x86 简单很多，但是直接跟着教程来同时学习 RISC-V 还是有点不够，经常前面记得一点零星的汇编，看到后面的代码就忘了是怎么回事了。所以尝试来整理一下 RISC-V 的汇编，希望能让看到的小伙伴快速的入门一下。本文将以 64 位为例介绍汇编语言。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-08-13T14:40:28+08:00"><meta property="article:modified_time" content="2023-08-13T14:40:28+08:00"><meta property="article:tag" content="RISC-V"><meta name=twitter:card content="summary"><meta name=twitter:title content="RISC-V 汇编概览"><meta name=twitter:description content="最近尝试跟着 rCore Tutorial 教程，使用 Rust 实现基于 RISC-V 架构的类 Unix 内核，从而在深化 OS 理解的目标上，同时入门学习 Rust 语言和 RISC-V 基础。虽然说是 RISC-V 比 x86 简单很多，但是直接跟着教程来同时学习 RISC-V 还是有点不够，经常前面记得一点零星的汇编，看到后面的代码就忘了是怎么回事了。所以尝试来整理一下 RISC-V 的汇编，希望能让看到的小伙伴快速的入门一下。本文将以 64 位为例介绍汇编语言。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hhdx.xyz/post/"},{"@type":"ListItem","position":2,"name":"RISC-V 汇编概览","item":"https://hhdx.xyz/post/riscv-assembly-intro/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"RISC-V 汇编概览","name":"RISC-V 汇编概览","description":"最近尝试跟着 rCore Tutorial 教程，使用 Rust 实现基于 RISC-V 架构的类 Unix 内核，从而在深化 OS 理解的目标上，同时入门学习 Rust 语言和 RISC-V 基础。虽然说是 RISC-V 比 x86 简单很多，但是直接跟着教程来同时学习 RISC-V 还是有点不够，经常前面记得一点零星的汇编，看到后面的代码就忘了是怎么回事了。所以尝试来整理一下 RISC-V 的汇编，希望能让看到的小伙伴快速的入门一下。本文将以 64 位为例介绍汇编语言。\n","keywords":["RISC-V"],"articleBody":"最近尝试跟着 rCore Tutorial 教程，使用 Rust 实现基于 RISC-V 架构的类 Unix 内核，从而在深化 OS 理解的目标上，同时入门学习 Rust 语言和 RISC-V 基础。虽然说是 RISC-V 比 x86 简单很多，但是直接跟着教程来同时学习 RISC-V 还是有点不够，经常前面记得一点零星的汇编，看到后面的代码就忘了是怎么回事了。所以尝试来整理一下 RISC-V 的汇编，希望能让看到的小伙伴快速的入门一下。本文将以 64 位为例介绍汇编语言。\nISA 命令规范 命名格式: RV[###](abc…xyz)。\nRV: 用于标识 RISC-V 体系架构的前缀 [###]: {32, 64, 128} 用于标识处理器的字宽，也就是处理器寄存器的宽度 [abc…xyz]: 标识该处理器支持的指令集模块集合 举例: RV64I。意指 RISC-V 64 位实现，I 表示整数指令集。\n对于 x86 体系架构，它的新一代处理器不仅实现了新的 ISA 扩展，还必须实现过去所有的扩展（最近宣布了要做 x86S），称之为“增量 ISA”。RISC-V 和传统的 x86 指令不一样，是“模块化 ISA”，由 1 个基本整数指令集 + 多个可选的扩展指令集组成。\n指令集模块 基本整数 (Integer) 指令集\n唯一强制要求实现的基础指令集，其他指令集都是可选的扩展模块\n基本指令集 描述 RV32I 32 位整数指令集 RV32E RV32I 的子集，用于小型的嵌入式场景 RV64I 64 位整数指令集，兼容 RV32I RV128I 128 位整数指令集，兼容 RV64I 和 RV32I 扩展模块指令集\nRISC-V 允许可选的实现其他标准化和非标准化的指令集扩展 特定组合“IMAFD”被称为“通用 (General)”组合，用英文字母 G 表示 扩展指令集 描述 M 整数乘法 (Multiplication) 与除法指令集 A 存储器原子 (Atomic) 指令集 F 单精度 (32bit) 浮点指令集 D 双精度 (64bit) 浮点指令集 C 压缩 (Compressed) 指令集 … 其他标准和未标准化的指令集 寄存器 通用寄存器 Unprivileged Specification 定义了 32 个通用寄存器以及一个 PC。如果需要实现 F/D 扩展则需要额外支持 32 个浮点寄存器。RV32E 将 32 个通用寄存器缩减为 16 个。\n寄存器宽度由 ISA 决定，RV32 的寄存器宽度为 32 位，RV64 的寄存器宽度为 64 位。\n每个寄存器具体编程时有特定的用途以及各自的别名。由 RISC-V Application Binary Interface (ABI) 定义。\n5-bit Encoding (rx) 3-bit Compressed Encoding (rx') Register ABI Name Description Saved by Calle- 0 - x0 zero hardwired zero - 1 - x1 ra return address -R 2 - x2 sp stack pointer -E 3 - x3 gp global pointer - 4 - x4 tp thread pointer - 5 - x5 t0 temporary register 0 -R 6 - x6 t1 temporary register 1 -R 7 - x7 t2 temporary register 2 -R 8 0 x8 s0 / fp saved register 0 / frame pointer -E 9 1 x9 s1 saved register 1 -E 10 2 x10 a0 function argument 0 / return value 0 -R 11 3 x11 a1 function argument 1 / return value 1 -R 12 4 x12 a2 function argument 2 -R 13 5 x13 a3 function argument 3 -R 14 6 x14 a4 function argument 4 -R 15 7 x15 a5 function argument 5 -R 16 - x16 a6 function argument 6 -R 17 - x17 a7 function argument 7 -R 18 - x18 s2 saved register 2 -E 19 - x19 s3 saved register 3 -E 20 - x20 s4 saved register 4 -E 21 - x21 s5 saved register 5 -E 22 - x22 s6 saved register 6 -E 23 - x23 s7 saved register 7 -E 24 - x24 s8 saved register 8 -E 25 - x25 s9 saved register 9 -E 26 - x26 s10 saved register 10 -E 27 - x27 s11 saved register 11 -E 28 - x28 t3 temporary register 3 -R 29 - x29 t4 temporary register 4 -R 30 - x30 t5 temporary register 5 -R 31 - x31 t6 temporary register 6 -R Control and Status Registers (CSR) 特权级介绍查看下文。这里仅介绍 Supervior 级别下的一些 CSR 寄存器，及其部分功能。其他详见 Spec。\n不同的特权级别下，分别对应一套 Registers (CSR)，用于控制不同特权级别下处理器的工作状态。\n高特权级可以访问低级别的 CSR，反之不可以。\nRISC-V 专门定义了操作 CSR 的指令。\nSupervisor Trap Setup\nName Description sstatus Supervisor status register\n最重要的 CSR，可以从多个方面控制 S 特权级的 CPU 行为和执行状态。\nSPP 等字段给出 Trap 发生之前 CPU 处于哪个特权级 (S/U) sedeleg Supervisor exception delegation register\n当 Trap 是一个异常的时候，记录 Trap 发生之前执行的最后一条指令地址。 sideleg Supervisor interrupt delegation register sie Supervisor interrupt-enable register stvec Supervisor trap vector base address register\n控制 Trap 处理代码的入口地址 scounteren Supervisor counter enable register Supervisor Trap Handling\nName Description sscratch Supervisor scratch register 一般用来存储内核栈的地址，在 trap 开始的地方与 sp 交换，从用户栈切换到内核栈 sepc Supervisor exception program counter register scause Supervisor trap cause register\n描述 Trap 的原因 stval Supervisor trap value register\n给出 Trap 附加信息 sip Supervisor interrupt pending register Supervisor Protection and Translation\nName Description satp Supervisor address translation and protection 其他概念 HART HARdware Thread，简称为 HART。简单的可以理解为超线程。一个核心 (core) 可能会有多个 HART。\n特权级别 RISC-V 架构中一共定义了 4 种特权级：\n级别 编码 名称 0 00 用户/应用模式 (U, User/Application) 1 01 监督模式 (S, Supervisor) 2 10 虚拟监督模式 (H, Hypervisor) 3 11 机器模式 (M, Machine) 级别的数值越大，特权级越高，。从表中可以看出， M 模式处在最高的特权级，而 U 模式处于最低的特权级。在CPU硬件层面，除了M模式必须存在外，其它模式可以不存在。\n按需实现 RISC-V 特权级\nRISC-V 架构中，只有 M 模式是必须实现的，剩下的特权级则可以根据跑在 CPU 上应用的实际需求进行调整：\n简单的嵌入式应用只需要实现 M 模式； 带有一定保护能力的嵌入式系统需要实现 M/U 模式； 复杂的多任务系统则需要实现 M/S/U 模式。 汇编指令 编码格式 指令分类 指令详解 算术运算指令 逻辑运算指令 移位运算指令 内存读写指令 条件分支指令 无条件跳转指令 特权指令 csrrw rd, csr, rs: 将 csr 当前值读到 rd，然后将 rs 的值写入该 csr\n函数调用约定 参考资料 PLCT 从头写一个RISC-V OS》课程配套的资源\nRegisters - RISC-V - WikiChip\nrCore Tutorial Book 特权级机制\nRISC-V Specifications\n","wordCount":"1822","inLanguage":"zh-cn","datePublished":"2023-08-13T14:40:28+08:00","dateModified":"2023-08-13T14:40:28+08:00","author":{"@type":"Person","name":"hhdx"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hhdx.xyz/post/riscv-assembly-intro/"},"publisher":{"@type":"Organization","name":"hhdx's blog","logo":{"@type":"ImageObject","url":"https://hhdx.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hhdx.xyz/ accesskey=h title="hhdx's blog (Alt + H)">hhdx's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hhdx.xyz/ title=主页><span>主页</span></a></li><li><a href=https://hhdx.xyz/post/ title=归档><span>归档</span></a></li><li><a href=https://hhdx.xyz/tags/ title=标签><span>标签</span></a></li><li><a href=https://hhdx.xyz/underway/ title=施工中><span>施工中</span></a></li><li><a href=https://hhdx.xyz/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">RISC-V 汇编概览</h1><div class=post-meta><span title='2023-08-13 14:40:28 +0800 +0800'>August 13, 2023</span>&nbsp;·&nbsp;hhdx</div></header><div class=post-content><p>最近尝试跟着 <a href=http://rcore-os.cn/rCore-Tutorial-Book-v3/index.html>rCore Tutorial</a> 教程，使用 Rust 实现基于 RISC-V 架构的类 Unix 内核，从而在深化 OS 理解的目标上，同时入门学习 Rust 语言和 RISC-V 基础。虽然说是 RISC-V 比 x86 简单很多，但是直接跟着教程来同时学习 RISC-V 还是有点不够，经常前面记得一点零星的汇编，看到后面的代码就忘了是怎么回事了。所以尝试来整理一下 RISC-V 的汇编，希望能让看到的小伙伴快速的入门一下。本文将以 64 位为例介绍汇编语言。</p><h1 id=isa-命令规范>ISA 命令规范<a hidden class=anchor aria-hidden=true href=#isa-命令规范>#</a></h1><p>命名格式: RV[###](abc&mldr;xyz)。</p><ul><li>RV: 用于标识 RISC-V 体系架构的前缀</li><li>[###]: {32, 64, 128} 用于标识处理器的字宽，也就是处理器寄存器的宽度</li><li>[abc&mldr;xyz]: 标识该处理器支持的指令集模块集合</li></ul><p>举例: RV64I。意指 RISC-V 64 位实现，I 表示整数指令集。</p><p>对于 x86 体系架构，它的新一代处理器不仅实现了新的 ISA 扩展，还必须实现过去所有的扩展（最近宣布了要做 x86S），称之为“增量 ISA”。RISC-V 和传统的 x86 指令不一样，是“模块化 ISA”，由 1 个基本整数指令集 + 多个可选的扩展指令集组成。</p><h1 id=指令集模块>指令集模块<a hidden class=anchor aria-hidden=true href=#指令集模块>#</a></h1><ul><li><p>基本整数 (Integer) 指令集</p><p>唯一强制要求实现的基础指令集，其他指令集都是可选的扩展模块</p><table><thead><tr><th>基本指令集</th><th>描述</th></tr></thead><tbody><tr><td>RV32I</td><td>32 位整数指令集</td></tr><tr><td>RV32E</td><td>RV32I 的子集，用于小型的嵌入式场景</td></tr><tr><td>RV64I</td><td>64 位整数指令集，兼容 RV32I</td></tr><tr><td>RV128I</td><td>128 位整数指令集，兼容 RV64I 和 RV32I</td></tr></tbody></table></li><li><p>扩展模块指令集</p><ul><li>RISC-V 允许可选的实现其他标准化和非标准化的指令集扩展</li><li>特定组合“IMAFD”被称为“通用 (General)”组合，用英文字母 G 表示</li></ul><table><thead><tr><th>扩展指令集</th><th>描述</th></tr></thead><tbody><tr><td>M</td><td>整数乘法 (Multiplication) 与除法指令集</td></tr><tr><td>A</td><td>存储器原子 (Atomic) 指令集</td></tr><tr><td>F</td><td>单精度 (32bit) 浮点指令集</td></tr><tr><td>D</td><td>双精度 (64bit) 浮点指令集</td></tr><tr><td>C</td><td>压缩 (Compressed) 指令集</td></tr><tr><td>&mldr;</td><td>其他标准和未标准化的指令集</td></tr></tbody></table></li></ul><h1 id=寄存器>寄存器<a hidden class=anchor aria-hidden=true href=#寄存器>#</a></h1><h2 id=通用寄存器>通用寄存器<a hidden class=anchor aria-hidden=true href=#通用寄存器>#</a></h2><p>Unprivileged Specification 定义了 32 个通用寄存器以及一个 PC。如果需要实现 F/D 扩展则需要额外支持 32 个浮点寄存器。RV32E 将 32 个通用寄存器缩减为 16 个。</p><p>寄存器宽度由 ISA 决定，RV32 的寄存器宽度为 32 位，RV64 的寄存器宽度为 64 位。</p><p>每个寄存器具体编程时有特定的用途以及各自的别名。由 RISC-V Application Binary Interface (ABI) 定义。</p><table><thead><tr><th style=text-align:center>5-bit Encoding (rx)</th><th style=text-align:center>3-bit Compressed Encoding (rx')</th><th style=text-align:center>Register</th><th style=text-align:center><a href="https://en.wikichip.org/w/index.php?title=application_binary_interface&amp;action=edit&amp;redlink=1">ABI</a> Name</th><th style=text-align:center>Description</th><th style=text-align:center>Saved by Calle-</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>-</td><td style=text-align:center>x0</td><td style=text-align:center>zero</td><td style=text-align:center><a href=https://en.wikichip.org/wiki/zero_register>hardwired zero</a></td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>-</td><td style=text-align:center>x1</td><td style=text-align:center>ra</td><td style=text-align:center>return address</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>-</td><td style=text-align:center>x2</td><td style=text-align:center>sp</td><td style=text-align:center>stack pointer</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>-</td><td style=text-align:center>x3</td><td style=text-align:center>gp</td><td style=text-align:center>global pointer</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>4</td><td style=text-align:center>-</td><td style=text-align:center>x4</td><td style=text-align:center>tp</td><td style=text-align:center>thread pointer</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center>5</td><td style=text-align:center>-</td><td style=text-align:center>x5</td><td style=text-align:center>t0</td><td style=text-align:center>temporary register 0</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>6</td><td style=text-align:center>-</td><td style=text-align:center>x6</td><td style=text-align:center>t1</td><td style=text-align:center>temporary register 1</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>7</td><td style=text-align:center>-</td><td style=text-align:center>x7</td><td style=text-align:center>t2</td><td style=text-align:center>temporary register 2</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>8</td><td style=text-align:center>0</td><td style=text-align:center>x8</td><td style=text-align:center>s0 / fp</td><td style=text-align:center>saved register 0 / frame pointer</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>9</td><td style=text-align:center>1</td><td style=text-align:center>x9</td><td style=text-align:center>s1</td><td style=text-align:center>saved register 1</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>10</td><td style=text-align:center>2</td><td style=text-align:center>x10</td><td style=text-align:center>a0</td><td style=text-align:center>function argument 0 / return value 0</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>11</td><td style=text-align:center>3</td><td style=text-align:center>x11</td><td style=text-align:center>a1</td><td style=text-align:center>function argument 1 / return value 1</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>12</td><td style=text-align:center>4</td><td style=text-align:center>x12</td><td style=text-align:center>a2</td><td style=text-align:center>function argument 2</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>13</td><td style=text-align:center>5</td><td style=text-align:center>x13</td><td style=text-align:center>a3</td><td style=text-align:center>function argument 3</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>14</td><td style=text-align:center>6</td><td style=text-align:center>x14</td><td style=text-align:center>a4</td><td style=text-align:center>function argument 4</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>15</td><td style=text-align:center>7</td><td style=text-align:center>x15</td><td style=text-align:center>a5</td><td style=text-align:center>function argument 5</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>16</td><td style=text-align:center>-</td><td style=text-align:center>x16</td><td style=text-align:center>a6</td><td style=text-align:center>function argument 6</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>17</td><td style=text-align:center>-</td><td style=text-align:center>x17</td><td style=text-align:center>a7</td><td style=text-align:center>function argument 7</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>18</td><td style=text-align:center>-</td><td style=text-align:center>x18</td><td style=text-align:center>s2</td><td style=text-align:center>saved register 2</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>19</td><td style=text-align:center>-</td><td style=text-align:center>x19</td><td style=text-align:center>s3</td><td style=text-align:center>saved register 3</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>20</td><td style=text-align:center>-</td><td style=text-align:center>x20</td><td style=text-align:center>s4</td><td style=text-align:center>saved register 4</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>21</td><td style=text-align:center>-</td><td style=text-align:center>x21</td><td style=text-align:center>s5</td><td style=text-align:center>saved register 5</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>22</td><td style=text-align:center>-</td><td style=text-align:center>x22</td><td style=text-align:center>s6</td><td style=text-align:center>saved register 6</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>23</td><td style=text-align:center>-</td><td style=text-align:center>x23</td><td style=text-align:center>s7</td><td style=text-align:center>saved register 7</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>24</td><td style=text-align:center>-</td><td style=text-align:center>x24</td><td style=text-align:center>s8</td><td style=text-align:center>saved register 8</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>25</td><td style=text-align:center>-</td><td style=text-align:center>x25</td><td style=text-align:center>s9</td><td style=text-align:center>saved register 9</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>26</td><td style=text-align:center>-</td><td style=text-align:center>x26</td><td style=text-align:center>s10</td><td style=text-align:center>saved register 10</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>27</td><td style=text-align:center>-</td><td style=text-align:center>x27</td><td style=text-align:center>s11</td><td style=text-align:center>saved register 11</td><td style=text-align:center>-E</td></tr><tr><td style=text-align:center>28</td><td style=text-align:center>-</td><td style=text-align:center>x28</td><td style=text-align:center>t3</td><td style=text-align:center>temporary register 3</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>29</td><td style=text-align:center>-</td><td style=text-align:center>x29</td><td style=text-align:center>t4</td><td style=text-align:center>temporary register 4</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>30</td><td style=text-align:center>-</td><td style=text-align:center>x30</td><td style=text-align:center>t5</td><td style=text-align:center>temporary register 5</td><td style=text-align:center>-R</td></tr><tr><td style=text-align:center>31</td><td style=text-align:center>-</td><td style=text-align:center>x31</td><td style=text-align:center>t6</td><td style=text-align:center>temporary register 6</td><td style=text-align:center>-R</td></tr></tbody></table><h2 id=control-and-status-registers-csr>Control and Status Registers (CSR)<a hidden class=anchor aria-hidden=true href=#control-and-status-registers-csr>#</a></h2><p>特权级介绍查看<a href=#%E7%89%B9%E6%9D%83%E7%BA%A7%E5%88%AB>下文</a>。这里仅介绍 Supervior 级别下的一些 CSR 寄存器，及其部分功能。其他详见 Spec。</p><ul><li><p>不同的特权级别下，分别对应一套 Registers (CSR)，用于控制不同特权级别下处理器的工作状态。</p></li><li><p>高特权级可以访问低级别的 CSR，反之不可以。</p></li><li><p>RISC-V 专门定义了操作 CSR 的指令。</p></li></ul><p><strong>Supervisor Trap Setup</strong></p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>sstatus</td><td>Supervisor status register<br>最重要的 CSR，可以从多个方面控制 S 特权级的 CPU 行为和执行状态。<br><code>SPP</code> 等字段给出 Trap 发生之前 CPU 处于哪个特权级 (S/U)</td></tr><tr><td>sedeleg</td><td>Supervisor exception delegation register<br>当 Trap 是一个异常的时候，记录 Trap 发生之前执行的最后一条指令地址。</td></tr><tr><td>sideleg</td><td>Supervisor interrupt delegation register</td></tr><tr><td>sie</td><td>Supervisor interrupt-enable register</td></tr><tr><td>stvec</td><td>Supervisor trap vector base address register<br>控制 Trap 处理代码的入口地址</td></tr><tr><td>scounteren</td><td>Supervisor counter enable register</td></tr></tbody></table><p><strong>Supervisor Trap Handling</strong></p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>sscratch</td><td>Supervisor scratch register<br>一般用来存储内核栈的地址，在 trap 开始的地方与 sp 交换，从用户栈切换到内核栈</td></tr><tr><td>sepc</td><td>Supervisor exception program counter register</td></tr><tr><td>scause</td><td>Supervisor trap cause register<br>描述 Trap 的原因</td></tr><tr><td>stval</td><td>Supervisor trap value register<br>给出 Trap 附加信息</td></tr><tr><td>sip</td><td>Supervisor interrupt pending register</td></tr></tbody></table><p><strong>Supervisor Protection and Translation</strong></p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>satp</td><td>Supervisor address translation and protection</td></tr></tbody></table><h1 id=其他概念>其他概念<a hidden class=anchor aria-hidden=true href=#其他概念>#</a></h1><h2 id=hart>HART<a hidden class=anchor aria-hidden=true href=#hart>#</a></h2><p>HARdware Thread，简称为 HART。简单的可以理解为超线程。一个核心 (core) 可能会有多个 HART。</p><h2 id=特权级别>特权级别<a hidden class=anchor aria-hidden=true href=#特权级别>#</a></h2><p>RISC-V 架构中一共定义了 4 种特权级：</p><table><thead><tr><th>级别</th><th>编码</th><th>名称</th></tr></thead><tbody><tr><td>0</td><td>00</td><td>用户/应用模式 (U, User/Application)</td></tr><tr><td>1</td><td>01</td><td>监督模式 (S, Supervisor)</td></tr><tr><td>2</td><td>10</td><td>虚拟监督模式 (H, Hypervisor)</td></tr><tr><td>3</td><td>11</td><td>机器模式 (M, Machine)</td></tr></tbody></table><p>级别的数值越大，特权级越高，。从表中可以看出， M 模式处在最高的特权级，而 U 模式处于最低的特权级。在CPU硬件层面，除了M模式必须存在外，其它模式可以不存在。</p><p><img alt=../_images/PrivilegeStack.png loading=lazy src=https://hhdx.xyz/pics/img/PrivilegeStack.png></p><blockquote><p><strong>按需实现 RISC-V 特权级</strong></p><p>RISC-V 架构中，只有 M 模式是必须实现的，剩下的特权级则可以根据跑在 CPU 上应用的实际需求进行调整：</p><ul><li>简单的嵌入式应用只需要实现 M 模式；</li><li>带有一定保护能力的嵌入式系统需要实现 M/U 模式；</li><li>复杂的多任务系统则需要实现 M/S/U 模式。</li></ul></blockquote><h1 id=汇编指令>汇编指令<a hidden class=anchor aria-hidden=true href=#汇编指令>#</a></h1><h2 id=编码格式>编码格式<a hidden class=anchor aria-hidden=true href=#编码格式>#</a></h2><h2 id=指令分类>指令分类<a hidden class=anchor aria-hidden=true href=#指令分类>#</a></h2><h2 id=指令详解>指令详解<a hidden class=anchor aria-hidden=true href=#指令详解>#</a></h2><h3 id=算术运算指令>算术运算指令<a hidden class=anchor aria-hidden=true href=#算术运算指令>#</a></h3><h3 id=逻辑运算指令>逻辑运算指令<a hidden class=anchor aria-hidden=true href=#逻辑运算指令>#</a></h3><h3 id=移位运算指令>移位运算指令<a hidden class=anchor aria-hidden=true href=#移位运算指令>#</a></h3><h3 id=内存读写指令>内存读写指令<a hidden class=anchor aria-hidden=true href=#内存读写指令>#</a></h3><h3 id=条件分支指令>条件分支指令<a hidden class=anchor aria-hidden=true href=#条件分支指令>#</a></h3><h3 id=无条件跳转指令>无条件跳转指令<a hidden class=anchor aria-hidden=true href=#无条件跳转指令>#</a></h3><h2 id=特权指令>特权指令<a hidden class=anchor aria-hidden=true href=#特权指令>#</a></h2><p><code>csrrw rd, csr, rs</code>: 将 csr 当前值读到 rd，然后将 rs 的值写入该 csr</p><h2 id=函数调用约定>函数调用约定<a hidden class=anchor aria-hidden=true href=#函数调用约定>#</a></h2><h1 id=参考资料>参考资料<a hidden class=anchor aria-hidden=true href=#参考资料>#</a></h1><ol><li><p>PLCT <a href=https://github.com/plctlab/riscv-operating-system-mooc>从头写一个RISC-V OS》课程配套的资源</a></p></li><li><p><a href=https://en.wikichip.org/wiki/risc-v/registers>Registers - RISC-V - WikiChip</a></p></li><li><p><a href=http://rcore-os.cn/rCore-Tutorial-Book-v3/chapter2/1rv-privilege.html>rCore Tutorial Book 特权级机制</a></p></li><li><p><a href=https://riscv.org/technical/specifications/>RISC-V Specifications</a></p></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://hhdx.xyz/tags/risc-v/>RISC-V</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://hhdx.xyz/>hhdx's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>